<html>
<head>
<title>test_sql.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #2aacb8;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_sql.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">contextlib</span>
<span class="s0">from </span><span class="s1">contextlib </span><span class="s0">import </span><span class="s1">closing</span>
<span class="s0">import </span><span class="s1">csv</span>
<span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">date</span><span class="s2">,</span>
    <span class="s1">datetime</span><span class="s2">,</span>
    <span class="s1">time</span><span class="s2">,</span>
    <span class="s1">timedelta</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">StringIO</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">import </span><span class="s1">sqlite3</span>
<span class="s0">from </span><span class="s1">typing </span><span class="s0">import </span><span class="s1">TYPE_CHECKING</span>
<span class="s0">import </span><span class="s1">uuid</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">_libs </span><span class="s0">import </span><span class="s1">lib</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">compat </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">pa_version_under13p0</span><span class="s2">,</span>
    <span class="s1">pa_version_under14p1</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">compat</span><span class="s2">.</span><span class="s1">_optional </span><span class="s0">import </span><span class="s1">import_optional_dependency</span>
<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">_test_decorators </span><span class="s0">as </span><span class="s1">td</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">DataFrame</span><span class="s2">,</span>
    <span class="s1">Index</span><span class="s2">,</span>
    <span class="s1">MultiIndex</span><span class="s2">,</span>
    <span class="s1">Series</span><span class="s2">,</span>
    <span class="s1">Timestamp</span><span class="s2">,</span>
    <span class="s1">concat</span><span class="s2">,</span>
    <span class="s1">date_range</span><span class="s2">,</span>
    <span class="s1">isna</span><span class="s2">,</span>
    <span class="s1">to_datetime</span><span class="s2">,</span>
    <span class="s1">to_timedelta</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">import </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">_testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">core</span><span class="s2">.</span><span class="s1">arrays </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">ArrowStringArray</span><span class="s2">,</span>
    <span class="s1">StringArray</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">util</span><span class="s2">.</span><span class="s1">version </span><span class="s0">import </span><span class="s1">Version</span>

<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">io </span><span class="s0">import </span><span class="s1">sql</span>
<span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">io</span><span class="s2">.</span><span class="s1">sql </span><span class="s0">import </span><span class="s2">(</span>
    <span class="s1">SQLAlchemyEngine</span><span class="s2">,</span>
    <span class="s1">SQLDatabase</span><span class="s2">,</span>
    <span class="s1">SQLiteDatabase</span><span class="s2">,</span>
    <span class="s1">get_engine</span><span class="s2">,</span>
    <span class="s1">pandasSQL_builder</span><span class="s2">,</span>
    <span class="s1">read_sql_query</span><span class="s2">,</span>
    <span class="s1">read_sql_table</span><span class="s2">,</span>
<span class="s2">)</span>

<span class="s0">if </span><span class="s1">TYPE_CHECKING</span><span class="s2">:</span>
    <span class="s0">import </span><span class="s1">sqlalchemy</span>


<span class="s1">pytestmark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">filterwarnings</span><span class="s2">(</span>
    <span class="s3">&quot;ignore:Passing a BlockManager to DataFrame:DeprecationWarning&quot;</span>
<span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sql_strings</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s2">{</span>
        <span class="s3">&quot;read_parameters&quot;</span><span class="s2">: {</span>
            <span class="s3">&quot;sqlite&quot;</span><span class="s2">: </span><span class="s3">&quot;SELECT * FROM iris WHERE Name=? AND SepalLength=?&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;mysql&quot;</span><span class="s2">: </span><span class="s3">&quot;SELECT * FROM iris WHERE `Name`=%s AND `SepalLength`=%s&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;postgresql&quot;</span><span class="s2">: </span><span class="s3">'SELECT * FROM iris WHERE &quot;Name&quot;=%s AND &quot;SepalLength&quot;=%s'</span><span class="s2">,</span>
        <span class="s2">},</span>
        <span class="s3">&quot;read_named_parameters&quot;</span><span class="s2">: {</span>
            <span class="s3">&quot;sqlite&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;&quot; 
                SELECT * FROM iris WHERE Name=:name AND SepalLength=:length 
                &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;mysql&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;&quot; 
                SELECT * FROM iris WHERE 
                `Name`=%(name)s AND `SepalLength`=%(length)s 
                &quot;&quot;&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;postgresql&quot;</span><span class="s2">: </span><span class="s3">&quot;&quot;&quot; 
                SELECT * FROM iris WHERE 
                &quot;Name&quot;=%(name)s AND &quot;SepalLength&quot;=%(length)s 
                &quot;&quot;&quot;</span><span class="s2">,</span>
        <span class="s2">},</span>
        <span class="s3">&quot;read_no_parameters_with_percent&quot;</span><span class="s2">: {</span>
            <span class="s3">&quot;sqlite&quot;</span><span class="s2">: </span><span class="s3">&quot;SELECT * FROM iris WHERE Name LIKE '%'&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;mysql&quot;</span><span class="s2">: </span><span class="s3">&quot;SELECT * FROM iris WHERE `Name` LIKE '%'&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;postgresql&quot;</span><span class="s2">: </span><span class="s3">&quot;SELECT * FROM iris WHERE </span><span class="s0">\&quot;</span><span class="s3">Name</span><span class="s0">\&quot; </span><span class="s3">LIKE '%'&quot;</span><span class="s2">,</span>
        <span class="s2">},</span>
    <span class="s2">}</span>


<span class="s0">def </span><span class="s1">iris_table_metadata</span><span class="s2">():</span>
    <span class="s0">import </span><span class="s1">sqlalchemy</span>
    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s2">(</span>
        <span class="s1">Column</span><span class="s2">,</span>
        <span class="s1">Double</span><span class="s2">,</span>
        <span class="s1">Float</span><span class="s2">,</span>
        <span class="s1">MetaData</span><span class="s2">,</span>
        <span class="s1">String</span><span class="s2">,</span>
        <span class="s1">Table</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">dtype </span><span class="s2">= </span><span class="s1">Double </span><span class="s0">if </span><span class="s1">Version</span><span class="s2">(</span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">__version__</span><span class="s2">) &gt;= </span><span class="s1">Version</span><span class="s2">(</span><span class="s3">&quot;2.0.0&quot;</span><span class="s2">) </span><span class="s0">else </span><span class="s1">Float</span>
    <span class="s1">metadata </span><span class="s2">= </span><span class="s1">MetaData</span><span class="s2">()</span>
    <span class="s1">iris </span><span class="s2">= </span><span class="s1">Table</span><span class="s2">(</span>
        <span class="s3">&quot;iris&quot;</span><span class="s2">,</span>
        <span class="s1">metadata</span><span class="s2">,</span>
        <span class="s1">Column</span><span class="s2">(</span><span class="s3">&quot;SepalLength&quot;</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">),</span>
        <span class="s1">Column</span><span class="s2">(</span><span class="s3">&quot;SepalWidth&quot;</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">),</span>
        <span class="s1">Column</span><span class="s2">(</span><span class="s3">&quot;PetalLength&quot;</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">),</span>
        <span class="s1">Column</span><span class="s2">(</span><span class="s3">&quot;PetalWidth&quot;</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">),</span>
        <span class="s1">Column</span><span class="s2">(</span><span class="s3">&quot;Name&quot;</span><span class="s2">, </span><span class="s1">String</span><span class="s2">(</span><span class="s4">200</span><span class="s2">)),</span>
    <span class="s2">)</span>
    <span class="s0">return </span><span class="s1">iris</span>


<span class="s0">def </span><span class="s1">create_and_load_iris_sqlite3</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">iris_file</span><span class="s2">: </span><span class="s1">Path</span><span class="s2">):</span>
    <span class="s1">stmt </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;CREATE TABLE iris ( 
            &quot;SepalLength&quot; REAL, 
            &quot;SepalWidth&quot; REAL, 
            &quot;PetalLength&quot; REAL, 
            &quot;PetalWidth&quot; REAL, 
            &quot;Name&quot; TEXT 
        )&quot;&quot;&quot;</span>

    <span class="s1">cur </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">()</span>
    <span class="s1">cur</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">iris_file</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">newline</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">csvfile</span><span class="s2">:</span>
        <span class="s1">reader </span><span class="s2">= </span><span class="s1">csv</span><span class="s2">.</span><span class="s1">reader</span><span class="s2">(</span><span class="s1">csvfile</span><span class="s2">)</span>
        <span class="s1">next</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">)</span>
        <span class="s1">stmt </span><span class="s2">= </span><span class="s3">&quot;INSERT INTO iris VALUES(?, ?, ?, ?, ?)&quot;</span>
        <span class="s5"># ADBC requires explicit types - no implicit str -&gt; float conversion</span>
        <span class="s1">records </span><span class="s2">= []</span>
        <span class="s1">records </span><span class="s2">= [</span>
            <span class="s2">(</span>
                <span class="s1">float</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]),</span>
                <span class="s1">float</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]),</span>
                <span class="s1">float</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s4">2</span><span class="s2">]),</span>
                <span class="s1">float</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s4">3</span><span class="s2">]),</span>
                <span class="s1">row</span><span class="s2">[</span><span class="s4">4</span><span class="s2">],</span>
            <span class="s2">)</span>
            <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">reader</span>
        <span class="s2">]</span>

        <span class="s1">cur</span><span class="s2">.</span><span class="s1">executemany</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">, </span><span class="s1">records</span><span class="s2">)</span>
    <span class="s1">cur</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s1">conn</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">create_and_load_iris_postgresql</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">iris_file</span><span class="s2">: </span><span class="s1">Path</span><span class="s2">):</span>
    <span class="s1">stmt </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;CREATE TABLE iris ( 
            &quot;SepalLength&quot; DOUBLE PRECISION, 
            &quot;SepalWidth&quot; DOUBLE PRECISION, 
            &quot;PetalLength&quot; DOUBLE PRECISION, 
            &quot;PetalWidth&quot; DOUBLE PRECISION, 
            &quot;Name&quot; TEXT 
        )&quot;&quot;&quot;</span>
    <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">() </span><span class="s0">as </span><span class="s1">cur</span><span class="s2">:</span>
        <span class="s1">cur</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">iris_file</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">newline</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">csvfile</span><span class="s2">:</span>
            <span class="s1">reader </span><span class="s2">= </span><span class="s1">csv</span><span class="s2">.</span><span class="s1">reader</span><span class="s2">(</span><span class="s1">csvfile</span><span class="s2">)</span>
            <span class="s1">next</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">)</span>
            <span class="s1">stmt </span><span class="s2">= </span><span class="s3">&quot;INSERT INTO iris VALUES($1, $2, $3, $4, $5)&quot;</span>
            <span class="s5"># ADBC requires explicit types - no implicit str -&gt; float conversion</span>
            <span class="s1">records </span><span class="s2">= [</span>
                <span class="s2">(</span>
                    <span class="s1">float</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]),</span>
                    <span class="s1">float</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]),</span>
                    <span class="s1">float</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s4">2</span><span class="s2">]),</span>
                    <span class="s1">float</span><span class="s2">(</span><span class="s1">row</span><span class="s2">[</span><span class="s4">3</span><span class="s2">]),</span>
                    <span class="s1">row</span><span class="s2">[</span><span class="s4">4</span><span class="s2">],</span>
                <span class="s2">)</span>
                <span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">reader</span>
            <span class="s2">]</span>

            <span class="s1">cur</span><span class="s2">.</span><span class="s1">executemany</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">, </span><span class="s1">records</span><span class="s2">)</span>

    <span class="s1">conn</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">create_and_load_iris</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">iris_file</span><span class="s2">: </span><span class="s1">Path</span><span class="s2">):</span>
    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">insert</span>

    <span class="s1">iris </span><span class="s2">= </span><span class="s1">iris_table_metadata</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">iris_file</span><span class="s2">.</span><span class="s1">open</span><span class="s2">(</span><span class="s1">newline</span><span class="s2">=</span><span class="s0">None</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s3">&quot;utf-8&quot;</span><span class="s2">) </span><span class="s0">as </span><span class="s1">csvfile</span><span class="s2">:</span>
        <span class="s1">reader </span><span class="s2">= </span><span class="s1">csv</span><span class="s2">.</span><span class="s1">reader</span><span class="s2">(</span><span class="s1">csvfile</span><span class="s2">)</span>
        <span class="s1">header </span><span class="s2">= </span><span class="s1">next</span><span class="s2">(</span><span class="s1">reader</span><span class="s2">)</span>
        <span class="s1">params </span><span class="s2">= [</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">header</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">reader</span><span class="s2">]</span>
        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">insert</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">).</span><span class="s1">values</span><span class="s2">(</span><span class="s1">params</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">() </span><span class="s0">as </span><span class="s1">con</span><span class="s2">:</span>
            <span class="s1">iris</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s1">con</span><span class="s2">, </span><span class="s1">checkfirst</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">iris</span><span class="s2">.</span><span class="s1">create</span><span class="s2">(</span><span class="s1">bind</span><span class="s2">=</span><span class="s1">con</span><span class="s2">)</span>
            <span class="s1">con</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">create_and_load_iris_view</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">):</span>
    <span class="s1">stmt </span><span class="s2">= </span><span class="s3">&quot;CREATE VIEW iris_view AS SELECT * FROM iris&quot;</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">):</span>
        <span class="s1">cur </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">()</span>
        <span class="s1">cur</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">adbc </span><span class="s2">= </span><span class="s1">import_optional_dependency</span><span class="s2">(</span><span class="s3">&quot;adbc_driver_manager.dbapi&quot;</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s3">&quot;ignore&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">adbc </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">adbc</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">() </span><span class="s0">as </span><span class="s1">cur</span><span class="s2">:</span>
                <span class="s1">cur</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">text</span>

            <span class="s1">stmt </span><span class="s2">= </span><span class="s1">text</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">() </span><span class="s0">as </span><span class="s1">con</span><span class="s2">:</span>
                <span class="s1">con</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">types_table_metadata</span><span class="s2">(</span><span class="s1">dialect</span><span class="s2">: </span><span class="s1">str</span><span class="s2">):</span>
    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s2">(</span>
        <span class="s1">TEXT</span><span class="s2">,</span>
        <span class="s1">Boolean</span><span class="s2">,</span>
        <span class="s1">Column</span><span class="s2">,</span>
        <span class="s1">DateTime</span><span class="s2">,</span>
        <span class="s1">Float</span><span class="s2">,</span>
        <span class="s1">Integer</span><span class="s2">,</span>
        <span class="s1">MetaData</span><span class="s2">,</span>
        <span class="s1">Table</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">date_type </span><span class="s2">= </span><span class="s1">TEXT </span><span class="s0">if </span><span class="s1">dialect </span><span class="s2">== </span><span class="s3">&quot;sqlite&quot; </span><span class="s0">else </span><span class="s1">DateTime</span>
    <span class="s1">bool_type </span><span class="s2">= </span><span class="s1">Integer </span><span class="s0">if </span><span class="s1">dialect </span><span class="s2">== </span><span class="s3">&quot;sqlite&quot; </span><span class="s0">else </span><span class="s1">Boolean</span>
    <span class="s1">metadata </span><span class="s2">= </span><span class="s1">MetaData</span><span class="s2">()</span>
    <span class="s1">types </span><span class="s2">= </span><span class="s1">Table</span><span class="s2">(</span>
        <span class="s3">&quot;types&quot;</span><span class="s2">,</span>
        <span class="s1">metadata</span><span class="s2">,</span>
        <span class="s1">Column</span><span class="s2">(</span><span class="s3">&quot;TextCol&quot;</span><span class="s2">, </span><span class="s1">TEXT</span><span class="s2">),</span>
        <span class="s1">Column</span><span class="s2">(</span><span class="s3">&quot;DateCol&quot;</span><span class="s2">, </span><span class="s1">date_type</span><span class="s2">),</span>
        <span class="s1">Column</span><span class="s2">(</span><span class="s3">&quot;IntDateCol&quot;</span><span class="s2">, </span><span class="s1">Integer</span><span class="s2">),</span>
        <span class="s1">Column</span><span class="s2">(</span><span class="s3">&quot;IntDateOnlyCol&quot;</span><span class="s2">, </span><span class="s1">Integer</span><span class="s2">),</span>
        <span class="s1">Column</span><span class="s2">(</span><span class="s3">&quot;FloatCol&quot;</span><span class="s2">, </span><span class="s1">Float</span><span class="s2">),</span>
        <span class="s1">Column</span><span class="s2">(</span><span class="s3">&quot;IntCol&quot;</span><span class="s2">, </span><span class="s1">Integer</span><span class="s2">),</span>
        <span class="s1">Column</span><span class="s2">(</span><span class="s3">&quot;BoolCol&quot;</span><span class="s2">, </span><span class="s1">bool_type</span><span class="s2">),</span>
        <span class="s1">Column</span><span class="s2">(</span><span class="s3">&quot;IntColWithNull&quot;</span><span class="s2">, </span><span class="s1">Integer</span><span class="s2">),</span>
        <span class="s1">Column</span><span class="s2">(</span><span class="s3">&quot;BoolColWithNull&quot;</span><span class="s2">, </span><span class="s1">bool_type</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s0">return </span><span class="s1">types</span>


<span class="s0">def </span><span class="s1">create_and_load_types_sqlite3</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">dict</span><span class="s2">]):</span>
    <span class="s1">stmt </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;CREATE TABLE types ( 
                    &quot;TextCol&quot; TEXT, 
                    &quot;DateCol&quot; TEXT, 
                    &quot;IntDateCol&quot; INTEGER, 
                    &quot;IntDateOnlyCol&quot; INTEGER, 
                    &quot;FloatCol&quot; REAL, 
                    &quot;IntCol&quot; INTEGER, 
                    &quot;BoolCol&quot; INTEGER, 
                    &quot;IntColWithNull&quot; INTEGER, 
                    &quot;BoolColWithNull&quot; INTEGER 
                )&quot;&quot;&quot;</span>

    <span class="s1">ins_stmt </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
                INSERT INTO types 
                VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?) 
                &quot;&quot;&quot;</span>

    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">):</span>
        <span class="s1">cur </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">()</span>
        <span class="s1">cur</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
        <span class="s1">cur</span><span class="s2">.</span><span class="s1">executemany</span><span class="s2">(</span><span class="s1">ins_stmt</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">() </span><span class="s0">as </span><span class="s1">cur</span><span class="s2">:</span>
            <span class="s1">cur</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
            <span class="s1">cur</span><span class="s2">.</span><span class="s1">executemany</span><span class="s2">(</span><span class="s1">ins_stmt</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">)</span>

        <span class="s1">conn</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">create_and_load_types_postgresql</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">dict</span><span class="s2">]):</span>
    <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">() </span><span class="s0">as </span><span class="s1">cur</span><span class="s2">:</span>
        <span class="s1">stmt </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;CREATE TABLE types ( 
                        &quot;TextCol&quot; TEXT, 
                        &quot;DateCol&quot; TIMESTAMP, 
                        &quot;IntDateCol&quot; INTEGER, 
                        &quot;IntDateOnlyCol&quot; INTEGER, 
                        &quot;FloatCol&quot; DOUBLE PRECISION, 
                        &quot;IntCol&quot; INTEGER, 
                        &quot;BoolCol&quot; BOOLEAN, 
                        &quot;IntColWithNull&quot; INTEGER, 
                        &quot;BoolColWithNull&quot; BOOLEAN 
                    )&quot;&quot;&quot;</span>
        <span class="s1">cur</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

        <span class="s1">stmt </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
                INSERT INTO types 
                VALUES($1, $2::timestamp, $3, $4, $5, $6, $7, $8, $9) 
                &quot;&quot;&quot;</span>

        <span class="s1">cur</span><span class="s2">.</span><span class="s1">executemany</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">)</span>

    <span class="s1">conn</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">create_and_load_types</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">dict</span><span class="s2">], </span><span class="s1">dialect</span><span class="s2">: </span><span class="s1">str</span><span class="s2">):</span>
    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">insert</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">engine </span><span class="s0">import </span><span class="s1">Engine</span>

    <span class="s1">types </span><span class="s2">= </span><span class="s1">types_table_metadata</span><span class="s2">(</span><span class="s1">dialect</span><span class="s2">)</span>

    <span class="s1">stmt </span><span class="s2">= </span><span class="s1">insert</span><span class="s2">(</span><span class="s1">types</span><span class="s2">).</span><span class="s1">values</span><span class="s2">(</span><span class="s1">types_data</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">Engine</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
                <span class="s1">types</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">checkfirst</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                <span class="s1">types</span><span class="s2">.</span><span class="s1">create</span><span class="s2">(</span><span class="s1">bind</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
                <span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
            <span class="s1">types</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">checkfirst</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">types</span><span class="s2">.</span><span class="s1">create</span><span class="s2">(</span><span class="s1">bind</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">create_and_load_postgres_datetz</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">):</span>
    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s2">(</span>
        <span class="s1">Column</span><span class="s2">,</span>
        <span class="s1">DateTime</span><span class="s2">,</span>
        <span class="s1">MetaData</span><span class="s2">,</span>
        <span class="s1">Table</span><span class="s2">,</span>
        <span class="s1">insert</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">engine </span><span class="s0">import </span><span class="s1">Engine</span>

    <span class="s1">metadata </span><span class="s2">= </span><span class="s1">MetaData</span><span class="s2">()</span>
    <span class="s1">datetz </span><span class="s2">= </span><span class="s1">Table</span><span class="s2">(</span><span class="s3">&quot;datetz&quot;</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">Column</span><span class="s2">(</span><span class="s3">&quot;DateColWithTz&quot;</span><span class="s2">, </span><span class="s1">DateTime</span><span class="s2">(</span><span class="s1">timezone</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)))</span>
    <span class="s1">datetz_data </span><span class="s2">= [</span>
        <span class="s2">{</span>
            <span class="s3">&quot;DateColWithTz&quot;</span><span class="s2">: </span><span class="s3">&quot;2000-01-01 00:00:00-08:00&quot;</span><span class="s2">,</span>
        <span class="s2">},</span>
        <span class="s2">{</span>
            <span class="s3">&quot;DateColWithTz&quot;</span><span class="s2">: </span><span class="s3">&quot;2000-06-01 00:00:00-07:00&quot;</span><span class="s2">,</span>
        <span class="s2">},</span>
    <span class="s2">]</span>
    <span class="s1">stmt </span><span class="s2">= </span><span class="s1">insert</span><span class="s2">(</span><span class="s1">datetz</span><span class="s2">).</span><span class="s1">values</span><span class="s2">(</span><span class="s1">datetz_data</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">Engine</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
                <span class="s1">datetz</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">checkfirst</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
                <span class="s1">datetz</span><span class="s2">.</span><span class="s1">create</span><span class="s2">(</span><span class="s1">bind</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
                <span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
            <span class="s1">datetz</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">checkfirst</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s1">datetz</span><span class="s2">.</span><span class="s1">create</span><span class="s2">(</span><span class="s1">bind</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s5"># &quot;2000-01-01 00:00:00-08:00&quot; should convert to</span>
    <span class="s5"># &quot;2000-01-01 08:00:00&quot;</span>
    <span class="s5"># &quot;2000-06-01 00:00:00-07:00&quot; should convert to</span>
    <span class="s5"># &quot;2000-06-01 07:00:00&quot;</span>
    <span class="s5"># GH 6415</span>
    <span class="s1">expected_data </span><span class="s2">= [</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2000-01-01 08:00:00&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s3">&quot;UTC&quot;</span><span class="s2">),</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2000-06-01 07:00:00&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s3">&quot;UTC&quot;</span><span class="s2">),</span>
    <span class="s2">]</span>
    <span class="s0">return </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">expected_data</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;DateColWithTz&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">check_iris_frame</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">: </span><span class="s1">DataFrame</span><span class="s2">):</span>
    <span class="s1">pytype </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">dtypes</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">type</span>
    <span class="s1">row </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">pytype</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floating</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span>
        <span class="s1">row</span><span class="s2">, </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">5.1</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">, </span><span class="s4">1.4</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s3">&quot;Iris-setosa&quot;</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=</span><span class="s1">frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">shape </span><span class="s0">in </span><span class="s2">((</span><span class="s4">150</span><span class="s2">, </span><span class="s4">5</span><span class="s2">), (</span><span class="s4">8</span><span class="s2">, </span><span class="s4">5</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">count_rows</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">table_name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">):</span>
    <span class="s1">stmt </span><span class="s2">= </span><span class="s3">f&quot;SELECT count(*) AS count_1 FROM </span><span class="s0">{</span><span class="s1">table_name</span><span class="s0">}</span><span class="s3">&quot;</span>
    <span class="s1">adbc </span><span class="s2">= </span><span class="s1">import_optional_dependency</span><span class="s2">(</span><span class="s3">&quot;adbc_driver_manager.dbapi&quot;</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s3">&quot;ignore&quot;</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">):</span>
        <span class="s1">cur </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">cur</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">).</span><span class="s1">fetchone</span><span class="s2">()[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s0">elif </span><span class="s1">adbc </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">adbc</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">() </span><span class="s0">as </span><span class="s1">cur</span><span class="s2">:</span>
            <span class="s1">cur</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
            <span class="s0">return </span><span class="s1">cur</span><span class="s2">.</span><span class="s1">fetchone</span><span class="s2">()[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">create_engine</span>
        <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">engine </span><span class="s0">import </span><span class="s1">Engine</span>

        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
            <span class="s0">try</span><span class="s2">:</span>
                <span class="s1">engine </span><span class="s2">= </span><span class="s1">create_engine</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
                <span class="s0">with </span><span class="s1">engine</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
                    <span class="s0">return </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">exec_driver_sql</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">).</span><span class="s1">scalar_one</span><span class="s2">()</span>
            <span class="s0">finally</span><span class="s2">:</span>
                <span class="s1">engine</span><span class="s2">.</span><span class="s1">dispose</span><span class="s2">()</span>
        <span class="s0">elif </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">Engine</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
                <span class="s0">return </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">exec_driver_sql</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">).</span><span class="s1">scalar_one</span><span class="s2">()</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">exec_driver_sql</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">).</span><span class="s1">scalar_one</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">iris_path</span><span class="s2">(</span><span class="s1">datapath</span><span class="s2">):</span>
    <span class="s1">iris_path </span><span class="s2">= </span><span class="s1">datapath</span><span class="s2">(</span><span class="s3">&quot;io&quot;</span><span class="s2">, </span><span class="s3">&quot;data&quot;</span><span class="s2">, </span><span class="s3">&quot;csv&quot;</span><span class="s2">, </span><span class="s3">&quot;iris.csv&quot;</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">iris_path</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">types_data</span><span class="s2">():</span>
    <span class="s0">return </span><span class="s2">[</span>
        <span class="s2">{</span>
            <span class="s3">&quot;TextCol&quot;</span><span class="s2">: </span><span class="s3">&quot;first&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;DateCol&quot;</span><span class="s2">: </span><span class="s3">&quot;2000-01-03 00:00:00&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;IntDateCol&quot;</span><span class="s2">: </span><span class="s4">535852800</span><span class="s2">,</span>
            <span class="s3">&quot;IntDateOnlyCol&quot;</span><span class="s2">: </span><span class="s4">20101010</span><span class="s2">,</span>
            <span class="s3">&quot;FloatCol&quot;</span><span class="s2">: </span><span class="s4">10.10</span><span class="s2">,</span>
            <span class="s3">&quot;IntCol&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">,</span>
            <span class="s3">&quot;BoolCol&quot;</span><span class="s2">: </span><span class="s0">False</span><span class="s2">,</span>
            <span class="s3">&quot;IntColWithNull&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">,</span>
            <span class="s3">&quot;BoolColWithNull&quot;</span><span class="s2">: </span><span class="s0">False</span><span class="s2">,</span>
        <span class="s2">},</span>
        <span class="s2">{</span>
            <span class="s3">&quot;TextCol&quot;</span><span class="s2">: </span><span class="s3">&quot;first&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;DateCol&quot;</span><span class="s2">: </span><span class="s3">&quot;2000-01-04 00:00:00&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;IntDateCol&quot;</span><span class="s2">: </span><span class="s4">1356998400</span><span class="s2">,</span>
            <span class="s3">&quot;IntDateOnlyCol&quot;</span><span class="s2">: </span><span class="s4">20101212</span><span class="s2">,</span>
            <span class="s3">&quot;FloatCol&quot;</span><span class="s2">: </span><span class="s4">10.10</span><span class="s2">,</span>
            <span class="s3">&quot;IntCol&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">,</span>
            <span class="s3">&quot;BoolCol&quot;</span><span class="s2">: </span><span class="s0">False</span><span class="s2">,</span>
            <span class="s3">&quot;IntColWithNull&quot;</span><span class="s2">: </span><span class="s0">None</span><span class="s2">,</span>
            <span class="s3">&quot;BoolColWithNull&quot;</span><span class="s2">: </span><span class="s0">None</span><span class="s2">,</span>
        <span class="s2">},</span>
    <span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">types_data_frame</span><span class="s2">(</span><span class="s1">types_data</span><span class="s2">):</span>
    <span class="s1">dtypes </span><span class="s2">= {</span>
        <span class="s3">&quot;TextCol&quot;</span><span class="s2">: </span><span class="s3">&quot;str&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;DateCol&quot;</span><span class="s2">: </span><span class="s3">&quot;str&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;IntDateCol&quot;</span><span class="s2">: </span><span class="s3">&quot;int64&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;IntDateOnlyCol&quot;</span><span class="s2">: </span><span class="s3">&quot;int64&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;FloatCol&quot;</span><span class="s2">: </span><span class="s3">&quot;float&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;IntCol&quot;</span><span class="s2">: </span><span class="s3">&quot;int64&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;BoolCol&quot;</span><span class="s2">: </span><span class="s3">&quot;int64&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;IntColWithNull&quot;</span><span class="s2">: </span><span class="s3">&quot;float&quot;</span><span class="s2">,</span>
        <span class="s3">&quot;BoolColWithNull&quot;</span><span class="s2">: </span><span class="s3">&quot;float&quot;</span><span class="s2">,</span>
    <span class="s2">}</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">types_data</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">df</span><span class="s2">[</span><span class="s1">dtypes</span><span class="s2">.</span><span class="s1">keys</span><span class="s2">()].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtypes</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">test_frame1</span><span class="s2">():</span>
    <span class="s1">columns </span><span class="s2">= [</span><span class="s3">&quot;index&quot;</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s3">&quot;D&quot;</span><span class="s2">]</span>
    <span class="s1">data </span><span class="s2">= [</span>
        <span class="s2">(</span>
            <span class="s3">&quot;2000-01-03 00:00:00&quot;</span><span class="s2">,</span>
            <span class="s4">0.980268513777</span><span class="s2">,</span>
            <span class="s4">3.68573087906</span><span class="s2">,</span>
            <span class="s2">-</span><span class="s4">0.364216805298</span><span class="s2">,</span>
            <span class="s2">-</span><span class="s4">1.15973806169</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s3">&quot;2000-01-04 00:00:00&quot;</span><span class="s2">,</span>
            <span class="s4">1.04791624281</span><span class="s2">,</span>
            <span class="s2">-</span><span class="s4">0.0412318367011</span><span class="s2">,</span>
            <span class="s2">-</span><span class="s4">0.16181208307</span><span class="s2">,</span>
            <span class="s4">0.212549316967</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s3">&quot;2000-01-05 00:00:00&quot;</span><span class="s2">,</span>
            <span class="s4">0.498580885705</span><span class="s2">,</span>
            <span class="s4">0.731167677815</span><span class="s2">,</span>
            <span class="s2">-</span><span class="s4">0.537677223318</span><span class="s2">,</span>
            <span class="s4">1.34627041952</span><span class="s2">,</span>
        <span class="s2">),</span>
        <span class="s2">(</span>
            <span class="s3">&quot;2000-01-06 00:00:00&quot;</span><span class="s2">,</span>
            <span class="s4">1.12020151869</span><span class="s2">,</span>
            <span class="s4">1.56762092543</span><span class="s2">,</span>
            <span class="s4">0.00364077397681</span><span class="s2">,</span>
            <span class="s4">0.67525259227</span><span class="s2">,</span>
        <span class="s2">),</span>
    <span class="s2">]</span>
    <span class="s0">return </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">test_frame3</span><span class="s2">():</span>
    <span class="s1">columns </span><span class="s2">= [</span><span class="s3">&quot;index&quot;</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">]</span>
    <span class="s1">data </span><span class="s2">= [</span>
        <span class="s2">(</span><span class="s3">&quot;2000-01-03 00:00:00&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">**</span><span class="s4">31 </span><span class="s2">- </span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1.987670</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;2000-01-04 00:00:00&quot;</span><span class="s2">, -</span><span class="s4">29</span><span class="s2">, -</span><span class="s4">0.0412318367011</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;2000-01-05 00:00:00&quot;</span><span class="s2">, </span><span class="s4">20000</span><span class="s2">, </span><span class="s4">0.731167677815</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;2000-01-06 00:00:00&quot;</span><span class="s2">, -</span><span class="s4">290867</span><span class="s2">, </span><span class="s4">1.56762092543</span><span class="s2">),</span>
    <span class="s2">]</span>
    <span class="s0">return </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">columns</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">get_all_views</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">):</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">&quot;SELECT name FROM sqlite_master WHERE type='view'&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">view</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] </span><span class="s0">for </span><span class="s1">view </span><span class="s0">in </span><span class="s1">c</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">()]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">adbc </span><span class="s2">= </span><span class="s1">import_optional_dependency</span><span class="s2">(</span><span class="s3">&quot;adbc_driver_manager.dbapi&quot;</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s3">&quot;ignore&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">adbc </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">adbc</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">):</span>
            <span class="s1">results </span><span class="s2">= []</span>
            <span class="s1">info </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">adbc_get_objects</span><span class="s2">().</span><span class="s1">read_all</span><span class="s2">().</span><span class="s1">to_pylist</span><span class="s2">()</span>
            <span class="s0">for </span><span class="s1">catalog </span><span class="s0">in </span><span class="s1">info</span><span class="s2">:</span>
                <span class="s1">catalog</span><span class="s2">[</span><span class="s3">&quot;catalog_name&quot;</span><span class="s2">]</span>
                <span class="s0">for </span><span class="s1">schema </span><span class="s0">in </span><span class="s1">catalog</span><span class="s2">[</span><span class="s3">&quot;catalog_db_schemas&quot;</span><span class="s2">]:</span>
                    <span class="s1">schema</span><span class="s2">[</span><span class="s3">&quot;db_schema_name&quot;</span><span class="s2">]</span>
                    <span class="s0">for </span><span class="s1">table </span><span class="s0">in </span><span class="s1">schema</span><span class="s2">[</span><span class="s3">&quot;db_schema_tables&quot;</span><span class="s2">]:</span>
                        <span class="s0">if </span><span class="s1">table</span><span class="s2">[</span><span class="s3">&quot;table_type&quot;</span><span class="s2">] == </span><span class="s3">&quot;view&quot;</span><span class="s2">:</span>
                            <span class="s1">view_name </span><span class="s2">= </span><span class="s1">table</span><span class="s2">[</span><span class="s3">&quot;table_name&quot;</span><span class="s2">]</span>
                            <span class="s1">results</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">view_name</span><span class="s2">)</span>

            <span class="s0">return </span><span class="s1">results</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">inspect</span>

            <span class="s0">return </span><span class="s1">inspect</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">).</span><span class="s1">get_view_names</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">get_all_tables</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">):</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">&quot;SELECT name FROM sqlite_master WHERE type='table'&quot;</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s2">[</span><span class="s1">table</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] </span><span class="s0">for </span><span class="s1">table </span><span class="s0">in </span><span class="s1">c</span><span class="s2">.</span><span class="s1">fetchall</span><span class="s2">()]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">adbc </span><span class="s2">= </span><span class="s1">import_optional_dependency</span><span class="s2">(</span><span class="s3">&quot;adbc_driver_manager.dbapi&quot;</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s3">&quot;ignore&quot;</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">adbc </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">adbc</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">):</span>
            <span class="s1">results </span><span class="s2">= []</span>
            <span class="s1">info </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">adbc_get_objects</span><span class="s2">().</span><span class="s1">read_all</span><span class="s2">().</span><span class="s1">to_pylist</span><span class="s2">()</span>
            <span class="s0">for </span><span class="s1">catalog </span><span class="s0">in </span><span class="s1">info</span><span class="s2">:</span>
                <span class="s0">for </span><span class="s1">schema </span><span class="s0">in </span><span class="s1">catalog</span><span class="s2">[</span><span class="s3">&quot;catalog_db_schemas&quot;</span><span class="s2">]:</span>
                    <span class="s0">for </span><span class="s1">table </span><span class="s0">in </span><span class="s1">schema</span><span class="s2">[</span><span class="s3">&quot;db_schema_tables&quot;</span><span class="s2">]:</span>
                        <span class="s0">if </span><span class="s1">table</span><span class="s2">[</span><span class="s3">&quot;table_type&quot;</span><span class="s2">] == </span><span class="s3">&quot;table&quot;</span><span class="s2">:</span>
                            <span class="s1">table_name </span><span class="s2">= </span><span class="s1">table</span><span class="s2">[</span><span class="s3">&quot;table_name&quot;</span><span class="s2">]</span>
                            <span class="s1">results</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">table_name</span><span class="s2">)</span>

            <span class="s0">return </span><span class="s1">results</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">inspect</span>

            <span class="s0">return </span><span class="s1">inspect</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">).</span><span class="s1">get_table_names</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">drop_table</span><span class="s2">(</span>
    <span class="s1">table_name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s1">conn</span><span class="s2">: </span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">Connection </span><span class="s2">| </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">.</span><span class="s1">Engine </span><span class="s2">| </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">):</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">f&quot;DROP TABLE IF EXISTS </span><span class="s0">{</span><span class="s1">sql</span><span class="s2">.</span><span class="s1">_get_valid_sqlite_name</span><span class="s2">(</span><span class="s1">table_name</span><span class="s2">)</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>

    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">adbc </span><span class="s2">= </span><span class="s1">import_optional_dependency</span><span class="s2">(</span><span class="s3">&quot;adbc_driver_manager.dbapi&quot;</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s3">&quot;ignore&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">adbc </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">adbc</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">() </span><span class="s0">as </span><span class="s1">cur</span><span class="s2">:</span>
                <span class="s1">cur</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">f'DROP TABLE IF EXISTS &quot;</span><span class="s0">{</span><span class="s1">table_name</span><span class="s0">}</span><span class="s3">&quot;'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">() </span><span class="s0">as </span><span class="s1">con</span><span class="s2">:</span>
                <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">con</span><span class="s2">) </span><span class="s0">as </span><span class="s1">db</span><span class="s2">:</span>
                    <span class="s1">db</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s1">table_name</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">drop_view</span><span class="s2">(</span>
    <span class="s1">view_name</span><span class="s2">: </span><span class="s1">str</span><span class="s2">,</span>
    <span class="s1">conn</span><span class="s2">: </span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">Connection </span><span class="s2">| </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">.</span><span class="s1">Engine </span><span class="s2">| </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s0">import </span><span class="s1">sqlalchemy</span>

    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">):</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">f&quot;DROP VIEW IF EXISTS </span><span class="s0">{</span><span class="s1">sql</span><span class="s2">.</span><span class="s1">_get_valid_sqlite_name</span><span class="s2">(</span><span class="s1">view_name</span><span class="s2">)</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">adbc </span><span class="s2">= </span><span class="s1">import_optional_dependency</span><span class="s2">(</span><span class="s3">&quot;adbc_driver_manager.dbapi&quot;</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s3">&quot;ignore&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">adbc </span><span class="s0">and </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">adbc</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">() </span><span class="s0">as </span><span class="s1">cur</span><span class="s2">:</span>
                <span class="s1">cur</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">f'DROP VIEW IF EXISTS &quot;</span><span class="s0">{</span><span class="s1">view_name</span><span class="s0">}</span><span class="s3">&quot;'</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">quoted_view </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">engine</span><span class="s2">.</span><span class="s1">dialect</span><span class="s2">.</span><span class="s1">identifier_preparer</span><span class="s2">.</span><span class="s1">quote_identifier</span><span class="s2">(</span>
                <span class="s1">view_name</span>
            <span class="s2">)</span>
            <span class="s1">stmt </span><span class="s2">= </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s3">f&quot;DROP VIEW IF EXISTS </span><span class="s0">{</span><span class="s1">quoted_view</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
            <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">() </span><span class="s0">as </span><span class="s1">con</span><span class="s2">:</span>
                <span class="s1">con</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)  </span><span class="s5"># type: ignore[union-attr]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">mysql_pymysql_engine</span><span class="s2">():</span>
    <span class="s1">sqlalchemy </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">)</span>
    <span class="s1">pymysql </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;pymysql&quot;</span><span class="s2">)</span>
    <span class="s1">engine </span><span class="s2">= </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">create_engine</span><span class="s2">(</span>
        <span class="s3">&quot;mysql+pymysql://root@localhost:3306/pandas&quot;</span><span class="s2">,</span>
        <span class="s1">connect_args</span><span class="s2">={</span><span class="s3">&quot;client_flag&quot;</span><span class="s2">: </span><span class="s1">pymysql</span><span class="s2">.</span><span class="s1">constants</span><span class="s2">.</span><span class="s1">CLIENT</span><span class="s2">.</span><span class="s1">MULTI_STATEMENTS</span><span class="s2">},</span>
        <span class="s1">poolclass</span><span class="s2">=</span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">pool</span><span class="s2">.</span><span class="s1">NullPool</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">yield </span><span class="s1">engine</span>
    <span class="s0">for </span><span class="s1">view </span><span class="s0">in </span><span class="s1">get_all_views</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">drop_view</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">tbl </span><span class="s0">in </span><span class="s1">get_all_tables</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">drop_table</span><span class="s2">(</span><span class="s1">tbl</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s1">engine</span><span class="s2">.</span><span class="s1">dispose</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">mysql_pymysql_engine_iris</span><span class="s2">(</span><span class="s1">mysql_pymysql_engine</span><span class="s2">, </span><span class="s1">iris_path</span><span class="s2">):</span>
    <span class="s1">create_and_load_iris</span><span class="s2">(</span><span class="s1">mysql_pymysql_engine</span><span class="s2">, </span><span class="s1">iris_path</span><span class="s2">)</span>
    <span class="s1">create_and_load_iris_view</span><span class="s2">(</span><span class="s1">mysql_pymysql_engine</span><span class="s2">)</span>
    <span class="s0">yield </span><span class="s1">mysql_pymysql_engine</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">mysql_pymysql_engine_types</span><span class="s2">(</span><span class="s1">mysql_pymysql_engine</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">):</span>
    <span class="s1">create_and_load_types</span><span class="s2">(</span><span class="s1">mysql_pymysql_engine</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">, </span><span class="s3">&quot;mysql&quot;</span><span class="s2">)</span>
    <span class="s0">yield </span><span class="s1">mysql_pymysql_engine</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">mysql_pymysql_conn</span><span class="s2">(</span><span class="s1">mysql_pymysql_engine</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">mysql_pymysql_engine</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s0">yield </span><span class="s1">conn</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">mysql_pymysql_conn_iris</span><span class="s2">(</span><span class="s1">mysql_pymysql_engine_iris</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">mysql_pymysql_engine_iris</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s0">yield </span><span class="s1">conn</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">mysql_pymysql_conn_types</span><span class="s2">(</span><span class="s1">mysql_pymysql_engine_types</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">mysql_pymysql_engine_types</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s0">yield </span><span class="s1">conn</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">postgresql_psycopg2_engine</span><span class="s2">():</span>
    <span class="s1">sqlalchemy </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">)</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;psycopg2&quot;</span><span class="s2">)</span>
    <span class="s1">engine </span><span class="s2">= </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">create_engine</span><span class="s2">(</span>
        <span class="s3">&quot;postgresql+psycopg2://postgres:postgres@localhost:5432/pandas&quot;</span><span class="s2">,</span>
        <span class="s1">poolclass</span><span class="s2">=</span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">pool</span><span class="s2">.</span><span class="s1">NullPool</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">yield </span><span class="s1">engine</span>
    <span class="s0">for </span><span class="s1">view </span><span class="s0">in </span><span class="s1">get_all_views</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">drop_view</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">tbl </span><span class="s0">in </span><span class="s1">get_all_tables</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">drop_table</span><span class="s2">(</span><span class="s1">tbl</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s1">engine</span><span class="s2">.</span><span class="s1">dispose</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">postgresql_psycopg2_engine_iris</span><span class="s2">(</span><span class="s1">postgresql_psycopg2_engine</span><span class="s2">, </span><span class="s1">iris_path</span><span class="s2">):</span>
    <span class="s1">create_and_load_iris</span><span class="s2">(</span><span class="s1">postgresql_psycopg2_engine</span><span class="s2">, </span><span class="s1">iris_path</span><span class="s2">)</span>
    <span class="s1">create_and_load_iris_view</span><span class="s2">(</span><span class="s1">postgresql_psycopg2_engine</span><span class="s2">)</span>
    <span class="s0">yield </span><span class="s1">postgresql_psycopg2_engine</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">postgresql_psycopg2_engine_types</span><span class="s2">(</span><span class="s1">postgresql_psycopg2_engine</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">):</span>
    <span class="s1">create_and_load_types</span><span class="s2">(</span><span class="s1">postgresql_psycopg2_engine</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">, </span><span class="s3">&quot;postgres&quot;</span><span class="s2">)</span>
    <span class="s0">yield </span><span class="s1">postgresql_psycopg2_engine</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">postgresql_psycopg2_conn</span><span class="s2">(</span><span class="s1">postgresql_psycopg2_engine</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">postgresql_psycopg2_engine</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s0">yield </span><span class="s1">conn</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">postgresql_adbc_conn</span><span class="s2">():</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;adbc_driver_postgresql&quot;</span><span class="s2">)</span>
    <span class="s0">from </span><span class="s1">adbc_driver_postgresql </span><span class="s0">import </span><span class="s1">dbapi</span>

    <span class="s1">uri </span><span class="s2">= </span><span class="s3">&quot;postgresql://postgres:postgres@localhost:5432/pandas&quot;</span>
    <span class="s0">with </span><span class="s1">dbapi</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">uri</span><span class="s2">) </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s0">yield </span><span class="s1">conn</span>
        <span class="s0">for </span><span class="s1">view </span><span class="s0">in </span><span class="s1">get_all_views</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">):</span>
            <span class="s1">drop_view</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">tbl </span><span class="s0">in </span><span class="s1">get_all_tables</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">):</span>
            <span class="s1">drop_table</span><span class="s2">(</span><span class="s1">tbl</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">postgresql_adbc_iris</span><span class="s2">(</span><span class="s1">postgresql_adbc_conn</span><span class="s2">, </span><span class="s1">iris_path</span><span class="s2">):</span>
    <span class="s0">import </span><span class="s1">adbc_driver_manager </span><span class="s0">as </span><span class="s1">mgr</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">postgresql_adbc_conn</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">adbc_get_table_schema</span><span class="s2">(</span><span class="s3">&quot;iris&quot;</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">mgr</span><span class="s2">.</span><span class="s1">ProgrammingError</span><span class="s2">:</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">rollback</span><span class="s2">()</span>
        <span class="s1">create_and_load_iris_postgresql</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">iris_path</span><span class="s2">)</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">adbc_get_table_schema</span><span class="s2">(</span><span class="s3">&quot;iris_view&quot;</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">mgr</span><span class="s2">.</span><span class="s1">ProgrammingError</span><span class="s2">:  </span><span class="s5"># note arrow-adbc issue 1022</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">rollback</span><span class="s2">()</span>
        <span class="s1">create_and_load_iris_view</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">yield </span><span class="s1">conn</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">postgresql_adbc_types</span><span class="s2">(</span><span class="s1">postgresql_adbc_conn</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">):</span>
    <span class="s0">import </span><span class="s1">adbc_driver_manager </span><span class="s0">as </span><span class="s1">mgr</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">postgresql_adbc_conn</span>

    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">adbc_get_table_schema</span><span class="s2">(</span><span class="s3">&quot;types&quot;</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">mgr</span><span class="s2">.</span><span class="s1">ProgrammingError</span><span class="s2">:</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">rollback</span><span class="s2">()</span>
        <span class="s1">new_data </span><span class="s2">= [</span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()) </span><span class="s0">for </span><span class="s1">entry </span><span class="s0">in </span><span class="s1">types_data</span><span class="s2">]</span>

        <span class="s1">create_and_load_types_postgresql</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">new_data</span><span class="s2">)</span>

    <span class="s0">yield </span><span class="s1">conn</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">postgresql_psycopg2_conn_iris</span><span class="s2">(</span><span class="s1">postgresql_psycopg2_engine_iris</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">postgresql_psycopg2_engine_iris</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s0">yield </span><span class="s1">conn</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">postgresql_psycopg2_conn_types</span><span class="s2">(</span><span class="s1">postgresql_psycopg2_engine_types</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">postgresql_psycopg2_engine_types</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s0">yield </span><span class="s1">conn</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sqlite_str</span><span class="s2">():</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">name</span><span class="s2">:</span>
        <span class="s0">yield </span><span class="s3">f&quot;sqlite:///</span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s3">&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sqlite_engine</span><span class="s2">(</span><span class="s1">sqlite_str</span><span class="s2">):</span>
    <span class="s1">sqlalchemy </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">)</span>
    <span class="s1">engine </span><span class="s2">= </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">create_engine</span><span class="s2">(</span><span class="s1">sqlite_str</span><span class="s2">, </span><span class="s1">poolclass</span><span class="s2">=</span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">pool</span><span class="s2">.</span><span class="s1">NullPool</span><span class="s2">)</span>
    <span class="s0">yield </span><span class="s1">engine</span>
    <span class="s0">for </span><span class="s1">view </span><span class="s0">in </span><span class="s1">get_all_views</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">drop_view</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">tbl </span><span class="s0">in </span><span class="s1">get_all_tables</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">):</span>
        <span class="s1">drop_table</span><span class="s2">(</span><span class="s1">tbl</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s1">engine</span><span class="s2">.</span><span class="s1">dispose</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sqlite_conn</span><span class="s2">(</span><span class="s1">sqlite_engine</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">sqlite_engine</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s0">yield </span><span class="s1">conn</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sqlite_str_iris</span><span class="s2">(</span><span class="s1">sqlite_str</span><span class="s2">, </span><span class="s1">iris_path</span><span class="s2">):</span>
    <span class="s1">sqlalchemy </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">)</span>
    <span class="s1">engine </span><span class="s2">= </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">create_engine</span><span class="s2">(</span><span class="s1">sqlite_str</span><span class="s2">)</span>
    <span class="s1">create_and_load_iris</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">iris_path</span><span class="s2">)</span>
    <span class="s1">create_and_load_iris_view</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">)</span>
    <span class="s1">engine</span><span class="s2">.</span><span class="s1">dispose</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">sqlite_str</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sqlite_engine_iris</span><span class="s2">(</span><span class="s1">sqlite_engine</span><span class="s2">, </span><span class="s1">iris_path</span><span class="s2">):</span>
    <span class="s1">create_and_load_iris</span><span class="s2">(</span><span class="s1">sqlite_engine</span><span class="s2">, </span><span class="s1">iris_path</span><span class="s2">)</span>
    <span class="s1">create_and_load_iris_view</span><span class="s2">(</span><span class="s1">sqlite_engine</span><span class="s2">)</span>
    <span class="s0">yield </span><span class="s1">sqlite_engine</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sqlite_conn_iris</span><span class="s2">(</span><span class="s1">sqlite_engine_iris</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">sqlite_engine_iris</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s0">yield </span><span class="s1">conn</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sqlite_str_types</span><span class="s2">(</span><span class="s1">sqlite_str</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">):</span>
    <span class="s1">sqlalchemy </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">)</span>
    <span class="s1">engine </span><span class="s2">= </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">create_engine</span><span class="s2">(</span><span class="s1">sqlite_str</span><span class="s2">)</span>
    <span class="s1">create_and_load_types</span><span class="s2">(</span><span class="s1">engine</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">, </span><span class="s3">&quot;sqlite&quot;</span><span class="s2">)</span>
    <span class="s1">engine</span><span class="s2">.</span><span class="s1">dispose</span><span class="s2">()</span>
    <span class="s0">return </span><span class="s1">sqlite_str</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sqlite_engine_types</span><span class="s2">(</span><span class="s1">sqlite_engine</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">):</span>
    <span class="s1">create_and_load_types</span><span class="s2">(</span><span class="s1">sqlite_engine</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">, </span><span class="s3">&quot;sqlite&quot;</span><span class="s2">)</span>
    <span class="s0">yield </span><span class="s1">sqlite_engine</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sqlite_conn_types</span><span class="s2">(</span><span class="s1">sqlite_engine_types</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">sqlite_engine_types</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s0">yield </span><span class="s1">conn</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sqlite_adbc_conn</span><span class="s2">():</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;adbc_driver_sqlite&quot;</span><span class="s2">)</span>
    <span class="s0">from </span><span class="s1">adbc_driver_sqlite </span><span class="s0">import </span><span class="s1">dbapi</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">name</span><span class="s2">:</span>
        <span class="s1">uri </span><span class="s2">= </span><span class="s3">f&quot;file:</span><span class="s0">{</span><span class="s1">name</span><span class="s0">}</span><span class="s3">&quot;</span>
        <span class="s0">with </span><span class="s1">dbapi</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">uri</span><span class="s2">) </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
            <span class="s0">yield </span><span class="s1">conn</span>
            <span class="s0">for </span><span class="s1">view </span><span class="s0">in </span><span class="s1">get_all_views</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">):</span>
                <span class="s1">drop_view</span><span class="s2">(</span><span class="s1">view</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">tbl </span><span class="s0">in </span><span class="s1">get_all_tables</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">):</span>
                <span class="s1">drop_table</span><span class="s2">(</span><span class="s1">tbl</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sqlite_adbc_iris</span><span class="s2">(</span><span class="s1">sqlite_adbc_conn</span><span class="s2">, </span><span class="s1">iris_path</span><span class="s2">):</span>
    <span class="s0">import </span><span class="s1">adbc_driver_manager </span><span class="s0">as </span><span class="s1">mgr</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_adbc_conn</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">adbc_get_table_schema</span><span class="s2">(</span><span class="s3">&quot;iris&quot;</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">mgr</span><span class="s2">.</span><span class="s1">ProgrammingError</span><span class="s2">:</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">rollback</span><span class="s2">()</span>
        <span class="s1">create_and_load_iris_sqlite3</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">iris_path</span><span class="s2">)</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">adbc_get_table_schema</span><span class="s2">(</span><span class="s3">&quot;iris_view&quot;</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">mgr</span><span class="s2">.</span><span class="s1">ProgrammingError</span><span class="s2">:</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">rollback</span><span class="s2">()</span>
        <span class="s1">create_and_load_iris_view</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">yield </span><span class="s1">conn</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sqlite_adbc_types</span><span class="s2">(</span><span class="s1">sqlite_adbc_conn</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">):</span>
    <span class="s0">import </span><span class="s1">adbc_driver_manager </span><span class="s0">as </span><span class="s1">mgr</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_adbc_conn</span>
    <span class="s0">try</span><span class="s2">:</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">adbc_get_table_schema</span><span class="s2">(</span><span class="s3">&quot;types&quot;</span><span class="s2">)</span>
    <span class="s0">except </span><span class="s1">mgr</span><span class="s2">.</span><span class="s1">ProgrammingError</span><span class="s2">:</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">rollback</span><span class="s2">()</span>
        <span class="s1">new_data </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">entry </span><span class="s0">in </span><span class="s1">types_data</span><span class="s2">:</span>
            <span class="s1">entry</span><span class="s2">[</span><span class="s3">&quot;BoolCol&quot;</span><span class="s2">] = </span><span class="s1">int</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">[</span><span class="s3">&quot;BoolCol&quot;</span><span class="s2">])</span>
            <span class="s0">if </span><span class="s1">entry</span><span class="s2">[</span><span class="s3">&quot;BoolColWithNull&quot;</span><span class="s2">] </span><span class="s0">is not None</span><span class="s2">:</span>
                <span class="s1">entry</span><span class="s2">[</span><span class="s3">&quot;BoolColWithNull&quot;</span><span class="s2">] = </span><span class="s1">int</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">[</span><span class="s3">&quot;BoolColWithNull&quot;</span><span class="s2">])</span>
            <span class="s1">new_data</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()))</span>

        <span class="s1">create_and_load_types_sqlite3</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">new_data</span><span class="s2">)</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>

    <span class="s0">yield </span><span class="s1">conn</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sqlite_buildin</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">contextlib</span><span class="s2">.</span><span class="s1">closing</span><span class="s2">(</span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s3">&quot;:memory:&quot;</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">closing_conn</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">closing_conn </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
            <span class="s0">yield </span><span class="s1">conn</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sqlite_buildin_iris</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">, </span><span class="s1">iris_path</span><span class="s2">):</span>
    <span class="s1">create_and_load_iris_sqlite3</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">, </span><span class="s1">iris_path</span><span class="s2">)</span>
    <span class="s1">create_and_load_iris_view</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">)</span>
    <span class="s0">yield </span><span class="s1">sqlite_buildin</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sqlite_buildin_types</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">):</span>
    <span class="s1">types_data </span><span class="s2">= [</span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">entry</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()) </span><span class="s0">for </span><span class="s1">entry </span><span class="s0">in </span><span class="s1">types_data</span><span class="s2">]</span>
    <span class="s1">create_and_load_types_sqlite3</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">, </span><span class="s1">types_data</span><span class="s2">)</span>
    <span class="s0">yield </span><span class="s1">sqlite_buildin</span>


<span class="s1">mysql_connectable </span><span class="s2">= [</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;mysql_pymysql_engine&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;mysql_pymysql_conn&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
<span class="s2">]</span>

<span class="s1">mysql_connectable_iris </span><span class="s2">= [</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;mysql_pymysql_engine_iris&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;mysql_pymysql_conn_iris&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
<span class="s2">]</span>

<span class="s1">mysql_connectable_types </span><span class="s2">= [</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;mysql_pymysql_engine_types&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;mysql_pymysql_conn_types&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
<span class="s2">]</span>

<span class="s1">postgresql_connectable </span><span class="s2">= [</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;postgresql_psycopg2_engine&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;postgresql_psycopg2_conn&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
<span class="s2">]</span>

<span class="s1">postgresql_connectable_iris </span><span class="s2">= [</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;postgresql_psycopg2_engine_iris&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;postgresql_psycopg2_conn_iris&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
<span class="s2">]</span>

<span class="s1">postgresql_connectable_types </span><span class="s2">= [</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;postgresql_psycopg2_engine_types&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;postgresql_psycopg2_conn_types&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
<span class="s2">]</span>

<span class="s1">sqlite_connectable </span><span class="s2">= [</span>
    <span class="s3">&quot;sqlite_engine&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;sqlite_conn&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;sqlite_str&quot;</span><span class="s2">,</span>
<span class="s2">]</span>

<span class="s1">sqlite_connectable_iris </span><span class="s2">= [</span>
    <span class="s3">&quot;sqlite_engine_iris&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;sqlite_conn_iris&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;sqlite_str_iris&quot;</span><span class="s2">,</span>
<span class="s2">]</span>

<span class="s1">sqlite_connectable_types </span><span class="s2">= [</span>
    <span class="s3">&quot;sqlite_engine_types&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;sqlite_conn_types&quot;</span><span class="s2">,</span>
    <span class="s3">&quot;sqlite_str_types&quot;</span><span class="s2">,</span>
<span class="s2">]</span>

<span class="s1">sqlalchemy_connectable </span><span class="s2">= </span><span class="s1">mysql_connectable </span><span class="s2">+ </span><span class="s1">postgresql_connectable </span><span class="s2">+ </span><span class="s1">sqlite_connectable</span>

<span class="s1">sqlalchemy_connectable_iris </span><span class="s2">= (</span>
    <span class="s1">mysql_connectable_iris </span><span class="s2">+ </span><span class="s1">postgresql_connectable_iris </span><span class="s2">+ </span><span class="s1">sqlite_connectable_iris</span>
<span class="s2">)</span>

<span class="s1">sqlalchemy_connectable_types </span><span class="s2">= (</span>
    <span class="s1">mysql_connectable_types </span><span class="s2">+ </span><span class="s1">postgresql_connectable_types </span><span class="s2">+ </span><span class="s1">sqlite_connectable_types</span>
<span class="s2">)</span>

<span class="s1">adbc_connectable </span><span class="s2">= [</span>
    <span class="s3">&quot;sqlite_adbc_conn&quot;</span><span class="s2">,</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;postgresql_adbc_conn&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
<span class="s2">]</span>

<span class="s1">adbc_connectable_iris </span><span class="s2">= [</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;postgresql_adbc_iris&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;sqlite_adbc_iris&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
<span class="s2">]</span>

<span class="s1">adbc_connectable_types </span><span class="s2">= [</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;postgresql_adbc_types&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">param</span><span class="s2">(</span><span class="s3">&quot;sqlite_adbc_types&quot;</span><span class="s2">, </span><span class="s1">marks</span><span class="s2">=</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span><span class="s2">),</span>
<span class="s2">]</span>


<span class="s1">all_connectable </span><span class="s2">= </span><span class="s1">sqlalchemy_connectable </span><span class="s2">+ [</span><span class="s3">&quot;sqlite_buildin&quot;</span><span class="s2">] + </span><span class="s1">adbc_connectable</span>

<span class="s1">all_connectable_iris </span><span class="s2">= (</span>
    <span class="s1">sqlalchemy_connectable_iris </span><span class="s2">+ [</span><span class="s3">&quot;sqlite_buildin_iris&quot;</span><span class="s2">] + </span><span class="s1">adbc_connectable_iris</span>
<span class="s2">)</span>

<span class="s1">all_connectable_types </span><span class="s2">= (</span>
    <span class="s1">sqlalchemy_connectable_types </span><span class="s2">+ [</span><span class="s3">&quot;sqlite_buildin_types&quot;</span><span class="s2">] + </span><span class="s1">adbc_connectable_types</span>
<span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_dataframe_to_sql</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># GH 51086 if conn is sqlite_engine</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">test_frame1</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;append&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_dataframe_to_sql_empty</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">conn </span><span class="s2">== </span><span class="s3">&quot;postgresql_adbc_conn&quot;</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;postgres ADBC driver cannot insert index with null type&quot;</span><span class="s2">,</span>
                <span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s5"># GH 51086 if conn is sqlite_engine</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">empty_df </span><span class="s2">= </span><span class="s1">test_frame1</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[:</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s1">empty_df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;append&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_dataframe_to_sql_arrow_dtypes</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># GH 52046</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;int&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;int8[pyarrow]&quot;</span><span class="s2">),</span>
            <span class="s3">&quot;datetime&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2023</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;timestamp[ns][pyarrow]&quot;</span>
            <span class="s2">),</span>
            <span class="s3">&quot;date&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">date</span><span class="s2">(</span><span class="s4">2023</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;date32[day][pyarrow]&quot;</span><span class="s2">),</span>
            <span class="s3">&quot;timedelta&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">timedelta</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;duration[ns][pyarrow]&quot;</span><span class="s2">),</span>
            <span class="s3">&quot;string&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;string[pyarrow]&quot;</span><span class="s2">),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">conn </span><span class="s2">== </span><span class="s3">&quot;sqlite_adbc_conn&quot;</span><span class="s2">:</span>
            <span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;timedelta&quot;</span><span class="s2">])</span>
        <span class="s0">if </span><span class="s1">pa_version_under14p1</span><span class="s2">:</span>
            <span class="s1">exp_warning </span><span class="s2">= </span><span class="s1">DeprecationWarning</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;is_sparse is deprecated&quot;</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">exp_warning </span><span class="s2">= </span><span class="s0">None</span>
            <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">exp_warning </span><span class="s2">= </span><span class="s1">UserWarning</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;the 'timedelta'&quot;</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">exp_warning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">, </span><span class="s1">check_stacklevel</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_arrow&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_dataframe_to_sql_arrow_dtypes_missing</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">nulls_fixture</span><span class="s2">):</span>
    <span class="s5"># GH 52046</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;datetime&quot;</span><span class="s2">: </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2023</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s1">nulls_fixture</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;timestamp[ns][pyarrow]&quot;</span>
            <span class="s2">),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_arrow&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;method&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;multi&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_to_sql</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">method </span><span class="s2">== </span><span class="s3">&quot;multi&quot; </span><span class="s0">and </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;'method' not implemented for ADBC drivers&quot;</span><span class="s2">, </span><span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span>
            <span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame&quot;</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">method</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">count_rows</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s3">&quot;test_frame&quot;</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;mode, num_row_coef&quot;</span><span class="s2">, [(</span><span class="s3">&quot;replace&quot;</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s3">&quot;append&quot;</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)])</span>
<span class="s0">def </span><span class="s1">test_to_sql_exist</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">num_row_coef</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame&quot;</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;fail&quot;</span><span class="s2">)</span>
        <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame&quot;</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s1">mode</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">count_rows</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s3">&quot;test_frame&quot;</span><span class="s2">) == </span><span class="s1">num_row_coef </span><span class="s2">* </span><span class="s1">len</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_to_sql_exist_fail</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame&quot;</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;fail&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame&quot;</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Table 'test_frame' already exists&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame&quot;</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;fail&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_iris_query</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM iris&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">check_iris_frame</span><span class="s2">(</span><span class="s1">iris_frame</span><span class="s2">)</span>
    <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM iris&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">check_iris_frame</span><span class="s2">(</span><span class="s1">iris_frame</span><span class="s2">)</span>
    <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM iris where 0=1&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">iris_frame</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s3">&quot;SepalWidth&quot; </span><span class="s0">in </span><span class="s1">iris_frame</span><span class="s2">.</span><span class="s1">columns</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_iris_query_chunksize</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;'chunksize' not implemented for ADBC drivers&quot;</span><span class="s2">,</span>
                <span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">concat</span><span class="s2">(</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM iris&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">7</span><span class="s2">))</span>
    <span class="s1">check_iris_frame</span><span class="s2">(</span><span class="s1">iris_frame</span><span class="s2">)</span>
    <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">concat</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM iris&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">7</span><span class="s2">))</span>
    <span class="s1">check_iris_frame</span><span class="s2">(</span><span class="s1">iris_frame</span><span class="s2">)</span>
    <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">concat</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM iris where 0=1&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">7</span><span class="s2">))</span>
    <span class="s0">assert </span><span class="s1">iris_frame</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">0</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s3">&quot;SepalWidth&quot; </span><span class="s0">in </span><span class="s1">iris_frame</span><span class="s2">.</span><span class="s1">columns</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_iris_query_expression_with_parameter</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;'chunksize' not implemented for ADBC drivers&quot;</span><span class="s2">,</span>
                <span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s2">(</span>
        <span class="s1">MetaData</span><span class="s2">,</span>
        <span class="s1">Table</span><span class="s2">,</span>
        <span class="s1">create_engine</span><span class="s2">,</span>
        <span class="s1">select</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">metadata </span><span class="s2">= </span><span class="s1">MetaData</span><span class="s2">()</span>
    <span class="s1">autoload_con </span><span class="s2">= </span><span class="s1">create_engine</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">str</span><span class="s2">) </span><span class="s0">else </span><span class="s1">conn</span>
    <span class="s1">iris </span><span class="s2">= </span><span class="s1">Table</span><span class="s2">(</span><span class="s3">&quot;iris&quot;</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">autoload_with</span><span class="s2">=</span><span class="s1">autoload_con</span><span class="s2">)</span>
    <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">read_sql_query</span><span class="s2">(</span>
        <span class="s1">select</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">), </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">params</span><span class="s2">={</span><span class="s3">&quot;name&quot;</span><span class="s2">: </span><span class="s3">&quot;Iris-setosa&quot;</span><span class="s2">, </span><span class="s3">&quot;length&quot;</span><span class="s2">: </span><span class="s4">5.1</span><span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">check_iris_frame</span><span class="s2">(</span><span class="s1">iris_frame</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">str</span><span class="s2">):</span>
        <span class="s1">autoload_con</span><span class="s2">.</span><span class="s1">dispose</span><span class="s2">()</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_iris_query_string_with_parameter</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">sql_strings</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;'chunksize' not implemented for ADBC drivers&quot;</span><span class="s2">,</span>
                <span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s0">for </span><span class="s1">db</span><span class="s2">, </span><span class="s1">query </span><span class="s0">in </span><span class="s1">sql_strings</span><span class="s2">[</span><span class="s3">&quot;read_parameters&quot;</span><span class="s2">].</span><span class="s1">items</span><span class="s2">():</span>
        <span class="s0">if </span><span class="s1">db </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
            <span class="s0">break</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">KeyError</span><span class="s2">(</span><span class="s3">f&quot;No part of </span><span class="s0">{</span><span class="s1">conn</span><span class="s0">} </span><span class="s3">found in sql_strings['read_parameters']&quot;</span><span class="s2">)</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">params</span><span class="s2">=(</span><span class="s3">&quot;Iris-setosa&quot;</span><span class="s2">, </span><span class="s4">5.1</span><span class="s2">))</span>
    <span class="s1">check_iris_frame</span><span class="s2">(</span><span class="s1">iris_frame</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_iris_table</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># GH 51015 if conn = sqlite_iris_str</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;iris&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">check_iris_frame</span><span class="s2">(</span><span class="s1">iris_frame</span><span class="s2">)</span>
    <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;iris&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">check_iris_frame</span><span class="s2">(</span><span class="s1">iris_frame</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_iris_table_chunksize</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;chunksize argument NotImplemented with ADBC&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">concat</span><span class="s2">(</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;iris&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">7</span><span class="s2">))</span>
    <span class="s1">check_iris_frame</span><span class="s2">(</span><span class="s1">iris_frame</span><span class="s2">)</span>
    <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">concat</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;iris&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">7</span><span class="s2">))</span>
    <span class="s1">check_iris_frame</span><span class="s2">(</span><span class="s1">iris_frame</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_to_sql_callable</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">check </span><span class="s2">= []  </span><span class="s5"># used to double check function below is really being used</span>

    <span class="s0">def </span><span class="s1">sample</span><span class="s2">(</span><span class="s1">pd_table</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">keys</span><span class="s2">, </span><span class="s1">data_iter</span><span class="s2">):</span>
        <span class="s1">check</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">data </span><span class="s2">= [</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">data_iter</span><span class="s2">]</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">pd_table</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(), </span><span class="s1">data</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame&quot;</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">sample</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">check </span><span class="s2">== [</span><span class="s4">1</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">count_rows</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s3">&quot;test_frame&quot;</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable_types</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_default_type_conversion</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s0">if </span><span class="s1">conn_name </span><span class="s2">== </span><span class="s3">&quot;sqlite_buildin_types&quot;</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;sqlite_buildin connection does not implement read_sql_table&quot;</span>
            <span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;types&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">FloatCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floating</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">IntCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">integer</span><span class="s2">)</span>

    <span class="s5"># MySQL/sqlite has no real BOOL type</span>
    <span class="s0">if </span><span class="s3">&quot;postgresql&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">BoolCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">BoolCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">integer</span><span class="s2">)</span>

    <span class="s5"># Int column with NA values stays as float</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">IntColWithNull</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floating</span><span class="s2">)</span>

    <span class="s5"># Bool column with NA = int column with NA values =&gt; becomes float</span>
    <span class="s0">if </span><span class="s3">&quot;postgresql&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">BoolColWithNull</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">object</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">BoolColWithNull</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floating</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">mysql_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_procedure</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s5"># GH 7324</span>
    <span class="s5"># Although it is more an api test, it is added to the</span>
    <span class="s5"># mysql tests as sqlite does not have stored procedures</span>
    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">text</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">engine </span><span class="s0">import </span><span class="s1">Engine</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">]})</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_frame&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">proc </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;DROP PROCEDURE IF EXISTS get_testdb; 
 
    CREATE PROCEDURE get_testdb () 
 
    BEGIN 
        SELECT * FROM test_frame; 
    END&quot;&quot;&quot;</span>
    <span class="s1">proc </span><span class="s2">= </span><span class="s1">text</span><span class="s2">(</span><span class="s1">proc</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">Engine</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">engine_conn</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">engine_conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
                <span class="s1">engine_conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">proc</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">proc</span><span class="s2">)</span>

    <span class="s1">res1 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;CALL get_testdb();&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">res1</span><span class="s2">)</span>

    <span class="s5"># test delegation to read_sql_query</span>
    <span class="s1">res2 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;CALL get_testdb();&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">postgresql_connectable</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;expected_count&quot;</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">, </span><span class="s3">&quot;Success!&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_copy_from_callable_insertion_method</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">expected_count</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># GH 8953</span>
    <span class="s5"># Example in io.rst found under _io.sql.method</span>
    <span class="s5"># not available in sqlite, mysql</span>
    <span class="s0">def </span><span class="s1">psql_insert_copy</span><span class="s2">(</span><span class="s1">table</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">keys</span><span class="s2">, </span><span class="s1">data_iter</span><span class="s2">):</span>
        <span class="s5"># gets a DBAPI connection that can provide a cursor</span>
        <span class="s1">dbapi_conn </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">connection</span>
        <span class="s0">with </span><span class="s1">dbapi_conn</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">() </span><span class="s0">as </span><span class="s1">cur</span><span class="s2">:</span>
            <span class="s1">s_buf </span><span class="s2">= </span><span class="s1">StringIO</span><span class="s2">()</span>
            <span class="s1">writer </span><span class="s2">= </span><span class="s1">csv</span><span class="s2">.</span><span class="s1">writer</span><span class="s2">(</span><span class="s1">s_buf</span><span class="s2">)</span>
            <span class="s1">writer</span><span class="s2">.</span><span class="s1">writerows</span><span class="s2">(</span><span class="s1">data_iter</span><span class="s2">)</span>
            <span class="s1">s_buf</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>

            <span class="s1">columns </span><span class="s2">= </span><span class="s3">&quot;, &quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s3">f'&quot;</span><span class="s0">{</span><span class="s1">k</span><span class="s0">}</span><span class="s3">&quot;' </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">keys</span><span class="s2">])</span>
            <span class="s0">if </span><span class="s1">table</span><span class="s2">.</span><span class="s1">schema</span><span class="s2">:</span>
                <span class="s1">table_name </span><span class="s2">= </span><span class="s3">f&quot;</span><span class="s0">{</span><span class="s1">table</span><span class="s2">.</span><span class="s1">schema</span><span class="s0">}</span><span class="s3">.</span><span class="s0">{</span><span class="s1">table</span><span class="s2">.</span><span class="s1">name</span><span class="s0">}</span><span class="s3">&quot;</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">table_name </span><span class="s2">= </span><span class="s1">table</span><span class="s2">.</span><span class="s1">name</span>

            <span class="s1">sql_query </span><span class="s2">= </span><span class="s3">f&quot;COPY </span><span class="s0">{</span><span class="s1">table_name</span><span class="s0">} </span><span class="s3">(</span><span class="s0">{</span><span class="s1">columns</span><span class="s0">}</span><span class="s3">) FROM STDIN WITH CSV&quot;</span>
            <span class="s1">cur</span><span class="s2">.</span><span class="s1">copy_expert</span><span class="s2">(</span><span class="s1">sql</span><span class="s2">=</span><span class="s1">sql_query</span><span class="s2">, </span><span class="s1">file</span><span class="s2">=</span><span class="s1">s_buf</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">expected_count</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;col1&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;col2&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">], </span><span class="s3">&quot;col3&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;n&quot;</span><span class="s2">]})</span>
    <span class="s1">result_count </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_frame&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">psql_insert_copy</span>
    <span class="s2">)</span>
    <span class="s5"># GH 46891</span>
    <span class="s0">if </span><span class="s1">expected_count </span><span class="s0">is None</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">result_count </span><span class="s0">is None</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">result_count </span><span class="s2">== </span><span class="s1">expected_count</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_frame&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">postgresql_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_insertion_method_on_conflict_do_nothing</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># GH 15988: Example in to_sql docstring</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">dialects</span><span class="s2">.</span><span class="s1">postgresql </span><span class="s0">import </span><span class="s1">insert</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">engine </span><span class="s0">import </span><span class="s1">Engine</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">sql </span><span class="s0">import </span><span class="s1">text</span>

    <span class="s0">def </span><span class="s1">insert_on_conflict</span><span class="s2">(</span><span class="s1">table</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">keys</span><span class="s2">, </span><span class="s1">data_iter</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= [</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">data_iter</span><span class="s2">]</span>
        <span class="s1">stmt </span><span class="s2">= (</span>
            <span class="s1">insert</span><span class="s2">(</span><span class="s1">table</span><span class="s2">.</span><span class="s1">table</span><span class="s2">)</span>
            <span class="s2">.</span><span class="s1">values</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
            <span class="s2">.</span><span class="s1">on_conflict_do_nothing</span><span class="s2">(</span><span class="s1">index_elements</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">])</span>
        <span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">result</span><span class="s2">.</span><span class="s1">rowcount</span>

    <span class="s1">create_sql </span><span class="s2">= </span><span class="s1">text</span><span class="s2">(</span>
        <span class="s3">&quot;&quot;&quot; 
    CREATE TABLE test_insert_conflict ( 
        a  integer PRIMARY KEY, 
        b  numeric, 
        c  text 
    ); 
    &quot;&quot;&quot;</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">Engine</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">con</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">con</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
                <span class="s1">con</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">create_sql</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">create_sql</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2.1</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abc&quot;</span><span class="s2">))</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_insert_conflict&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;append&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span>
    <span class="s2">)</span>

    <span class="s1">df_insert </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3.2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abc&quot;</span><span class="s2">))</span>
    <span class="s1">inserted </span><span class="s2">= </span><span class="s1">df_insert</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_insert_conflict&quot;</span><span class="s2">,</span>
        <span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">,</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;append&quot;</span><span class="s2">,</span>
        <span class="s1">method</span><span class="s2">=</span><span class="s1">insert_on_conflict</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_insert_conflict&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">inserted </span><span class="s2">== </span><span class="s4">0</span>

    <span class="s5"># Cleanup</span>
    <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_insert_conflict&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_to_sql_on_public_schema</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;sqlite&quot; </span><span class="s0">in </span><span class="s1">conn </span><span class="s0">or </span><span class="s3">&quot;mysql&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;test for public schema only specific to postgresql&quot;</span>
            <span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">test_data </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2.1</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3.1</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abc&quot;</span><span class="s2">))</span>
    <span class="s1">test_data</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_public_schema&quot;</span><span class="s2">,</span>
        <span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">,</span>
        <span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;append&quot;</span><span class="s2">,</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">schema</span><span class="s2">=</span><span class="s3">&quot;public&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">df_out </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_public_schema&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s3">&quot;public&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">test_data</span><span class="s2">, </span><span class="s1">df_out</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">mysql_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_insertion_method_on_conflict_update</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># GH 14553: Example in to_sql docstring</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">dialects</span><span class="s2">.</span><span class="s1">mysql </span><span class="s0">import </span><span class="s1">insert</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">engine </span><span class="s0">import </span><span class="s1">Engine</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">sql </span><span class="s0">import </span><span class="s1">text</span>

    <span class="s0">def </span><span class="s1">insert_on_conflict</span><span class="s2">(</span><span class="s1">table</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">keys</span><span class="s2">, </span><span class="s1">data_iter</span><span class="s2">):</span>
        <span class="s1">data </span><span class="s2">= [</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">zip</span><span class="s2">(</span><span class="s1">keys</span><span class="s2">, </span><span class="s1">row</span><span class="s2">)) </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">data_iter</span><span class="s2">]</span>
        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">insert</span><span class="s2">(</span><span class="s1">table</span><span class="s2">.</span><span class="s1">table</span><span class="s2">).</span><span class="s1">values</span><span class="s2">(</span><span class="s1">data</span><span class="s2">)</span>
        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">on_duplicate_key_update</span><span class="s2">(</span><span class="s1">b</span><span class="s2">=</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">inserted</span><span class="s2">.</span><span class="s1">b</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s1">stmt</span><span class="s2">.</span><span class="s1">inserted</span><span class="s2">.</span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
        <span class="s0">return </span><span class="s1">result</span><span class="s2">.</span><span class="s1">rowcount</span>

    <span class="s1">create_sql </span><span class="s2">= </span><span class="s1">text</span><span class="s2">(</span>
        <span class="s3">&quot;&quot;&quot; 
    CREATE TABLE test_insert_conflict ( 
        a INT PRIMARY KEY, 
        b FLOAT, 
        c VARCHAR(10) 
    ); 
    &quot;&quot;&quot;</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">Engine</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">con</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">con</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
                <span class="s1">con</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">create_sql</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">create_sql</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2.1</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abc&quot;</span><span class="s2">))</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_insert_conflict&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;append&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3.2</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abc&quot;</span><span class="s2">))</span>
    <span class="s1">inserted </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_insert_conflict&quot;</span><span class="s2">,</span>
        <span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">,</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;append&quot;</span><span class="s2">,</span>
        <span class="s1">method</span><span class="s2">=</span><span class="s1">insert_on_conflict</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_insert_conflict&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">inserted </span><span class="s2">== </span><span class="s4">2</span>

    <span class="s5"># Cleanup</span>
    <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_insert_conflict&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">postgresql_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_view_postgres</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># GH 52969</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">engine </span><span class="s0">import </span><span class="s1">Engine</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">sql </span><span class="s0">import </span><span class="s1">text</span>

    <span class="s1">table_name </span><span class="s2">= </span><span class="s3">f&quot;group_</span><span class="s0">{</span><span class="s1">uuid</span><span class="s2">.</span><span class="s1">uuid4</span><span class="s2">().</span><span class="s1">hex</span><span class="s0">}</span><span class="s3">&quot;</span>
    <span class="s1">view_name </span><span class="s2">= </span><span class="s3">f&quot;group_view_</span><span class="s0">{</span><span class="s1">uuid</span><span class="s2">.</span><span class="s1">uuid4</span><span class="s2">().</span><span class="s1">hex</span><span class="s0">}</span><span class="s3">&quot;</span>

    <span class="s1">sql_stmt </span><span class="s2">= </span><span class="s1">text</span><span class="s2">(</span>
        <span class="s3">f&quot;&quot;&quot;</span>
    <span class="s3">CREATE TABLE </span><span class="s0">{</span><span class="s1">table_name</span><span class="s0">} </span><span class="s3">(</span>
        <span class="s3">group_id INTEGER,</span>
        <span class="s3">name TEXT</span>
    <span class="s3">);</span>
    <span class="s3">INSERT INTO </span><span class="s0">{</span><span class="s1">table_name</span><span class="s0">} </span><span class="s3">VALUES</span>
        <span class="s3">(1, 'name');</span>
    <span class="s3">CREATE VIEW </span><span class="s0">{</span><span class="s1">view_name</span><span class="s0">}</span>
    <span class="s3">AS</span>
    <span class="s3">SELECT * FROM </span><span class="s0">{</span><span class="s1">table_name</span><span class="s0">}</span><span class="s3">;</span>
    <span class="s3">&quot;&quot;&quot;</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">Engine</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">con</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">con</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
                <span class="s1">con</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">sql_stmt</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
            <span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">sql_stmt</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s1">view_name</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;group_id&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">], </span><span class="s3">&quot;name&quot;</span><span class="s2">: </span><span class="s3">&quot;name&quot;</span><span class="s2">})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_read_view_sqlite</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">):</span>
    <span class="s5"># GH 52969</span>
    <span class="s1">create_table </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
CREATE TABLE groups ( 
   group_id INTEGER, 
   name TEXT 
); 
&quot;&quot;&quot;</span>
    <span class="s1">insert_into </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
INSERT INTO groups VALUES 
    (1, 'name'); 
&quot;&quot;&quot;</span>
    <span class="s1">create_view </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
CREATE VIEW group_view 
AS 
SELECT * FROM groups; 
&quot;&quot;&quot;</span>
    <span class="s1">sqlite_buildin</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">create_table</span><span class="s2">)</span>
    <span class="s1">sqlite_buildin</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">insert_into</span><span class="s2">)</span>
    <span class="s1">sqlite_buildin</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">create_view</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM group_view&quot;</span><span class="s2">, </span><span class="s1">sqlite_buildin</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;group_id&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">], </span><span class="s3">&quot;name&quot;</span><span class="s2">: </span><span class="s3">&quot;name&quot;</span><span class="s2">})</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_execute_typeerror</span><span class="s2">(</span><span class="s1">sqlite_engine_iris</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;pandas.io.sql.execute requires a connection&quot;</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span>
            <span class="s1">FutureWarning</span><span class="s2">,</span>
            <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;`pandas.io.sql.execute` is deprecated and &quot;</span>
            <span class="s3">&quot;will be removed in the future version.&quot;</span><span class="s2">,</span>
        <span class="s2">):</span>
            <span class="s1">sql</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">&quot;select * from iris&quot;</span><span class="s2">, </span><span class="s1">sqlite_engine_iris</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_execute_deprecated</span><span class="s2">(</span><span class="s1">sqlite_conn_iris</span><span class="s2">):</span>
    <span class="s5"># GH50185</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span>
        <span class="s1">FutureWarning</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;`pandas.io.sql.execute` is deprecated and &quot;</span>
        <span class="s3">&quot;will be removed in the future version.&quot;</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">&quot;select * from iris&quot;</span><span class="s2">, </span><span class="s1">sqlite_conn_iris</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">flavor</span><span class="s2">(</span><span class="s1">conn_name</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;postgresql&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s3">&quot;postgresql&quot;</span>
    <span class="s0">elif </span><span class="s3">&quot;sqlite&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s3">&quot;sqlite&quot;</span>
    <span class="s0">elif </span><span class="s3">&quot;mysql&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s3">&quot;mysql&quot;</span>

    <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">f&quot;unsupported connection: </span><span class="s0">{</span><span class="s1">conn_name</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_sql_iris_parameter</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">sql_strings</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;'params' not implemented for ADBC drivers&quot;</span><span class="s2">,</span>
                <span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">query </span><span class="s2">= </span><span class="s1">sql_strings</span><span class="s2">[</span><span class="s3">&quot;read_parameters&quot;</span><span class="s2">][</span><span class="s1">flavor</span><span class="s2">(</span><span class="s1">conn_name</span><span class="s2">)]</span>
    <span class="s1">params </span><span class="s2">= (</span><span class="s3">&quot;Iris-setosa&quot;</span><span class="s2">, </span><span class="s4">5.1</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">():</span>
            <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">read_query</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, </span><span class="s1">params</span><span class="s2">=</span><span class="s1">params</span><span class="s2">)</span>
    <span class="s1">check_iris_frame</span><span class="s2">(</span><span class="s1">iris_frame</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_sql_iris_named_parameter</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">sql_strings</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;'params' not implemented for ADBC drivers&quot;</span><span class="s2">,</span>
                <span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">query </span><span class="s2">= </span><span class="s1">sql_strings</span><span class="s2">[</span><span class="s3">&quot;read_named_parameters&quot;</span><span class="s2">][</span><span class="s1">flavor</span><span class="s2">(</span><span class="s1">conn_name</span><span class="s2">)]</span>
    <span class="s1">params </span><span class="s2">= {</span><span class="s3">&quot;name&quot;</span><span class="s2">: </span><span class="s3">&quot;Iris-setosa&quot;</span><span class="s2">, </span><span class="s3">&quot;length&quot;</span><span class="s2">: </span><span class="s4">5.1</span><span class="s2">}</span>
    <span class="s0">with </span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">():</span>
            <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">read_query</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, </span><span class="s1">params</span><span class="s2">=</span><span class="s1">params</span><span class="s2">)</span>
    <span class="s1">check_iris_frame</span><span class="s2">(</span><span class="s1">iris_frame</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_sql_iris_no_parameter_with_percent</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">sql_strings</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;mysql&quot; </span><span class="s0">in </span><span class="s1">conn </span><span class="s0">or </span><span class="s2">(</span><span class="s3">&quot;postgresql&quot; </span><span class="s0">in </span><span class="s1">conn </span><span class="s0">and </span><span class="s3">&quot;adbc&quot; </span><span class="s0">not in </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;broken test&quot;</span><span class="s2">))</span>

    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">query </span><span class="s2">= </span><span class="s1">sql_strings</span><span class="s2">[</span><span class="s3">&quot;read_no_parameters_with_percent&quot;</span><span class="s2">][</span><span class="s1">flavor</span><span class="s2">(</span><span class="s1">conn_name</span><span class="s2">)]</span>
    <span class="s0">with </span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">():</span>
            <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">read_query</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, </span><span class="s1">params</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">check_iris_frame</span><span class="s2">(</span><span class="s1">iris_frame</span><span class="s2">)</span>


<span class="s5"># -----------------------------------------------------------------------------</span>
<span class="s5"># -- Testing the public API</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_read_sql_view</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM iris_view&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">check_iris_frame</span><span class="s2">(</span><span class="s1">iris_frame</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_read_sql_with_chunksize_no_result</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;chunksize argument NotImplemented with ADBC&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">query </span><span class="s2">= </span><span class="s3">'SELECT * FROM iris_view WHERE &quot;SepalLength&quot; &lt; 0.0'</span>
    <span class="s1">with_batch </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
    <span class="s1">without_batch </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">concat</span><span class="s2">(</span><span class="s1">with_batch</span><span class="s2">), </span><span class="s1">without_batch</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_to_sql</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame1&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_frame1&quot;</span><span class="s2">)</span>

    <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame1&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame1&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_to_sql_fail</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame2&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_frame2&quot;</span><span class="s2">)</span>

    <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame2&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;fail&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame2&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Table 'test_frame2' already exists&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame2&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;fail&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_to_sql_replace</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame3&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_frame3&quot;</span><span class="s2">)</span>

    <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame3&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;fail&quot;</span><span class="s2">)</span>
    <span class="s5"># Add to table again</span>
    <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame3&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame3&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">num_entries </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">)</span>
    <span class="s1">num_rows </span><span class="s2">= </span><span class="s1">count_rows</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s3">&quot;test_frame3&quot;</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">num_rows </span><span class="s2">== </span><span class="s1">num_entries</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_to_sql_append</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame4&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_frame4&quot;</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame4&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;fail&quot;</span><span class="s2">) == </span><span class="s4">4</span>

    <span class="s5"># Add to table again</span>
    <span class="s0">assert </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame4&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;append&quot;</span><span class="s2">) == </span><span class="s4">4</span>
    <span class="s0">assert </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame4&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">num_entries </span><span class="s2">= </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">len</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">)</span>
    <span class="s1">num_rows </span><span class="s2">= </span><span class="s1">count_rows</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s3">&quot;test_frame4&quot;</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">num_rows </span><span class="s2">== </span><span class="s1">num_entries</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_to_sql_type_mapping</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame3</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame5&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_frame5&quot;</span><span class="s2">)</span>

    <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame3</span><span class="s2">, </span><span class="s3">&quot;test_frame5&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_frame5&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">test_frame3</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_to_sql_series</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_series&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_series&quot;</span><span class="s2">)</span>

    <span class="s1">s </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;int64&quot;</span><span class="s2">), </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;series&quot;</span><span class="s2">)</span>
    <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">s</span><span class="s2">, </span><span class="s3">&quot;test_series&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">s2 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_series&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">s</span><span class="s2">.</span><span class="s1">to_frame</span><span class="s2">(), </span><span class="s1">s2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_roundtrip</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame_roundtrip&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_frame_roundtrip&quot;</span><span class="s2">)</span>

    <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame_roundtrip&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_frame_roundtrip&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s5"># HACK!</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">rename</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">={</span><span class="s3">&quot;__index_level_0__&quot;</span><span class="s2">: </span><span class="s3">&quot;level_0&quot;</span><span class="s2">})</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">test_frame1</span><span class="s2">.</span><span class="s1">index</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;level_0&quot;</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_roundtrip_chunksize</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;chunksize argument NotImplemented with ADBC&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame_roundtrip&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_frame_roundtrip&quot;</span><span class="s2">)</span>

    <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
        <span class="s1">test_frame1</span><span class="s2">,</span>
        <span class="s3">&quot;test_frame_roundtrip&quot;</span><span class="s2">,</span>
        <span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">,</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">chunksize</span><span class="s2">=</span><span class="s4">2</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_frame_roundtrip&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_execute_sql</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># drop_sql = &quot;DROP TABLE IF EXISTS test&quot;  # should already be done</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandas_sql</span><span class="s2">:</span>
        <span class="s1">iris_results </span><span class="s2">= </span><span class="s1">pandas_sql</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM iris&quot;</span><span class="s2">)</span>
        <span class="s1">row </span><span class="s2">= </span><span class="s1">iris_results</span><span class="s2">.</span><span class="s1">fetchone</span><span class="s2">()</span>
        <span class="s1">iris_results</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">row</span><span class="s2">) == [</span><span class="s4">5.1</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">, </span><span class="s4">1.4</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s3">&quot;Iris-setosa&quot;</span><span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable_types</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_date_parsing</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s5"># Test date parsing in read_sql</span>
    <span class="s5"># No Parsing</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM types&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if not </span><span class="s2">(</span><span class="s3">&quot;mysql&quot; </span><span class="s0">in </span><span class="s1">conn_name </span><span class="s0">or </span><span class="s3">&quot;postgres&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">):</span>
        <span class="s0">assert not </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">DateCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM types&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">parse_dates</span><span class="s2">=[</span><span class="s3">&quot;DateCol&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">DateCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">DateCol</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
    <span class="s2">]</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span>
        <span class="s3">&quot;SELECT * FROM types&quot;</span><span class="s2">,</span>
        <span class="s1">conn</span><span class="s2">,</span>
        <span class="s1">parse_dates</span><span class="s2">={</span><span class="s3">&quot;DateCol&quot;</span><span class="s2">: </span><span class="s3">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="s2">},</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">DateCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">DateCol</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">2000</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
    <span class="s2">]</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM types&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">parse_dates</span><span class="s2">=[</span><span class="s3">&quot;IntDateCol&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">IntDateCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">IntDateCol</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">1986</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">25</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">2013</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
    <span class="s2">]</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span>
        <span class="s3">&quot;SELECT * FROM types&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">parse_dates</span><span class="s2">={</span><span class="s3">&quot;IntDateCol&quot;</span><span class="s2">: </span><span class="s3">&quot;s&quot;</span><span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">IntDateCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">IntDateCol</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">1986</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">25</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s4">2013</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">),</span>
    <span class="s2">]</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span>
        <span class="s3">&quot;SELECT * FROM types&quot;</span><span class="s2">,</span>
        <span class="s1">conn</span><span class="s2">,</span>
        <span class="s1">parse_dates</span><span class="s2">={</span><span class="s3">&quot;IntDateOnlyCol&quot;</span><span class="s2">: </span><span class="s3">&quot;%Y%m%d&quot;</span><span class="s2">},</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">IntDateOnlyCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">IntDateOnlyCol</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2010-10-10&quot;</span><span class="s2">),</span>
        <span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2010-12-12&quot;</span><span class="s2">),</span>
    <span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable_types</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;error&quot;</span><span class="s2">, [</span><span class="s3">&quot;ignore&quot;</span><span class="s2">, </span><span class="s3">&quot;raise&quot;</span><span class="s2">, </span><span class="s3">&quot;coerce&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;read_sql, text, mode&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">, </span><span class="s3">&quot;SELECT * FROM types&quot;</span><span class="s2">, (</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">, </span><span class="s3">&quot;fallback&quot;</span><span class="s2">)),</span>
        <span class="s2">(</span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">, </span><span class="s3">&quot;types&quot;</span><span class="s2">, (</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">)),</span>
        <span class="s2">(</span>
            <span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">,</span>
            <span class="s3">&quot;SELECT * FROM types&quot;</span><span class="s2">,</span>
            <span class="s2">(</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">, </span><span class="s3">&quot;fallback&quot;</span><span class="s2">),</span>
        <span class="s2">),</span>
        <span class="s2">(</span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">, </span><span class="s3">&quot;types&quot;</span><span class="s2">, (</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">)),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_custom_dateparsing_error</span><span class="s2">(</span>
    <span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">read_sql</span><span class="s2">, </span><span class="s1">text</span><span class="s2">, </span><span class="s1">mode</span><span class="s2">, </span><span class="s1">error</span><span class="s2">, </span><span class="s1">types_data_frame</span>
<span class="s2">):</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">text </span><span class="s2">== </span><span class="s3">&quot;types&quot; </span><span class="s0">and </span><span class="s1">conn_name </span><span class="s2">== </span><span class="s3">&quot;sqlite_buildin_types&quot;</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;failing combination of arguments&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">types_data_frame</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">({</span><span class="s3">&quot;DateCol&quot;</span><span class="s2">: </span><span class="s3">&quot;datetime64[ns]&quot;</span><span class="s2">})</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">read_sql</span><span class="s2">(</span>
        <span class="s1">text</span><span class="s2">,</span>
        <span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">,</span>
        <span class="s1">parse_dates</span><span class="s2">={</span>
            <span class="s3">&quot;DateCol&quot;</span><span class="s2">: {</span><span class="s3">&quot;errors&quot;</span><span class="s2">: </span><span class="s1">error</span><span class="s2">},</span>
        <span class="s2">},</span>
    <span class="s2">)</span>
    <span class="s0">if </span><span class="s3">&quot;postgres&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s5"># TODO: clean up types_data_frame fixture</span>
        <span class="s1">result</span><span class="s2">[</span><span class="s3">&quot;BoolCol&quot;</span><span class="s2">] = </span><span class="s1">result</span><span class="s2">[</span><span class="s3">&quot;BoolCol&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
        <span class="s1">result</span><span class="s2">[</span><span class="s3">&quot;BoolColWithNull&quot;</span><span class="s2">] = </span><span class="s1">result</span><span class="s2">[</span><span class="s3">&quot;BoolColWithNull&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">conn_name </span><span class="s2">== </span><span class="s3">&quot;postgresql_adbc_types&quot;</span><span class="s2">:</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;IntDateCol&quot;</span><span class="s2">: </span><span class="s3">&quot;int32&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;IntDateOnlyCol&quot;</span><span class="s2">: </span><span class="s3">&quot;int32&quot;</span><span class="s2">,</span>
                <span class="s3">&quot;IntCol&quot;</span><span class="s2">: </span><span class="s3">&quot;int32&quot;</span><span class="s2">,</span>
            <span class="s2">}</span>
        <span class="s2">)</span>

        <span class="s0">if not </span><span class="s1">pa_version_under13p0</span><span class="s2">:</span>
            <span class="s5"># TODO: is this astype safe?</span>
            <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;DateCol&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;DateCol&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;datetime64[us]&quot;</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable_types</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_date_and_index</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># Test case where same column appears in parse_date and index_col</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span>
        <span class="s3">&quot;SELECT * FROM types&quot;</span><span class="s2">,</span>
        <span class="s1">conn</span><span class="s2">,</span>
        <span class="s1">index_col</span><span class="s2">=</span><span class="s3">&quot;DateCol&quot;</span><span class="s2">,</span>
        <span class="s1">parse_dates</span><span class="s2">=[</span><span class="s3">&quot;DateCol&quot;</span><span class="s2">, </span><span class="s3">&quot;IntDateCol&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">IntDateCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_timedelta</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># see #6921</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_timedelta&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_timedelta&quot;</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">to_timedelta</span><span class="s2">(</span><span class="s1">Series</span><span class="s2">([</span><span class="s3">&quot;00:00:01&quot;</span><span class="s2">, </span><span class="s3">&quot;00:00:03&quot;</span><span class="s2">], </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;foo&quot;</span><span class="s2">)).</span><span class="s1">to_frame</span><span class="s2">()</span>

    <span class="s0">if </span><span class="s1">conn_name </span><span class="s2">== </span><span class="s3">&quot;sqlite_adbc_conn&quot;</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;sqlite ADBC driver doesn't implement timedelta&quot;</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">pa_version_under14p1</span><span class="s2">:</span>
            <span class="s1">exp_warning </span><span class="s2">= </span><span class="s1">DeprecationWarning</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">exp_warning </span><span class="s2">= </span><span class="s0">None</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">exp_warning </span><span class="s2">= </span><span class="s1">UserWarning</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">exp_warning</span><span class="s2">, </span><span class="s1">check_stacklevel</span><span class="s2">=</span><span class="s0">False</span><span class="s2">):</span>
        <span class="s1">result_count </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_timedelta&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result_count </span><span class="s2">== </span><span class="s4">2</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_timedelta&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s1">conn_name </span><span class="s2">== </span><span class="s3">&quot;postgresql_adbc_conn&quot;</span><span class="s2">:</span>
        <span class="s5"># TODO: Postgres stores an INTERVAL, which ADBC reads as a Month-Day-Nano</span>
        <span class="s5"># Interval; the default pandas type mapper maps this to a DateOffset</span>
        <span class="s5"># but maybe we should try and restore the timedelta here?</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s1">pd</span><span class="s2">.</span><span class="s1">DateOffset</span><span class="s2">(</span><span class="s1">months</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">days</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">microseconds</span><span class="s2">=</span><span class="s4">1000000</span><span class="s2">, </span><span class="s1">nanoseconds</span><span class="s2">=</span><span class="s4">0</span><span class="s2">),</span>
                <span class="s1">pd</span><span class="s2">.</span><span class="s1">DateOffset</span><span class="s2">(</span><span class="s1">months</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">days</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">microseconds</span><span class="s2">=</span><span class="s4">3000000</span><span class="s2">, </span><span class="s1">nanoseconds</span><span class="s2">=</span><span class="s4">0</span><span class="s2">),</span>
            <span class="s2">],</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;foo&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;foo&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;int64&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">[</span><span class="s3">&quot;foo&quot;</span><span class="s2">], </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_complex_raises</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1 </span><span class="s2">+ </span><span class="s4">1j</span><span class="s2">, </span><span class="s4">2j</span><span class="s2">]})</span>

    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;datatypes not supported&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Complex datatypes not supported&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s3">&quot;test_complex&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">is None</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;index_name,index_label,expected&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s5"># no index name, defaults to 'index'</span>
        <span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;index&quot;</span><span class="s2">),</span>
        <span class="s5"># specifying index_label</span>
        <span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;other_label&quot;</span><span class="s2">, </span><span class="s3">&quot;other_label&quot;</span><span class="s2">),</span>
        <span class="s5"># using the index name</span>
        <span class="s2">(</span><span class="s3">&quot;index_name&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;index_name&quot;</span><span class="s2">),</span>
        <span class="s5"># has index name, but specifying index_label</span>
        <span class="s2">(</span><span class="s3">&quot;index_name&quot;</span><span class="s2">, </span><span class="s3">&quot;other_label&quot;</span><span class="s2">, </span><span class="s3">&quot;other_label&quot;</span><span class="s2">),</span>
        <span class="s5"># index name is integer</span>
        <span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s3">&quot;0&quot;</span><span class="s2">),</span>
        <span class="s5"># index name is None but index label is integer</span>
        <span class="s2">(</span><span class="s0">None</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;0&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_to_sql_index_label</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">index_name</span><span class="s2">, </span><span class="s1">index_label</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;index_label argument NotImplemented with ADBC&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_index_label&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_index_label&quot;</span><span class="s2">)</span>

    <span class="s1">temp_frame </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;col1&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)})</span>
    <span class="s1">temp_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s1">index_name</span>
    <span class="s1">query </span><span class="s2">= </span><span class="s3">&quot;SELECT * FROM test_index_label&quot;</span>
    <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">temp_frame</span><span class="s2">, </span><span class="s3">&quot;test_index_label&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index_label</span><span class="s2">=</span><span class="s1">index_label</span><span class="s2">)</span>
    <span class="s1">frame </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">expected</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_to_sql_index_label_multiindex</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s0">if </span><span class="s3">&quot;mysql&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;MySQL can fail using TEXT without length as key&quot;</span><span class="s2">, </span><span class="s1">strict</span><span class="s2">=</span><span class="s0">False</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s0">elif </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;index_label argument NotImplemented with ADBC&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_index_label&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_index_label&quot;</span><span class="s2">)</span>

    <span class="s1">expected_row_count </span><span class="s2">= </span><span class="s4">4</span>
    <span class="s1">temp_frame </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;col1&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)},</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">MultiIndex</span><span class="s2">.</span><span class="s1">from_product</span><span class="s2">([(</span><span class="s3">&quot;A0&quot;</span><span class="s2">, </span><span class="s3">&quot;A1&quot;</span><span class="s2">), (</span><span class="s3">&quot;B0&quot;</span><span class="s2">, </span><span class="s3">&quot;B1&quot;</span><span class="s2">)]),</span>
    <span class="s2">)</span>

    <span class="s5"># no index name, defaults to 'level_0' and 'level_1'</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">temp_frame</span><span class="s2">, </span><span class="s3">&quot;test_index_label&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">expected_row_count</span>
    <span class="s1">frame </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_index_label&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s3">&quot;level_0&quot;</span>
    <span class="s0">assert </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] == </span><span class="s3">&quot;level_1&quot;</span>

    <span class="s5"># specifying index_label</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
        <span class="s1">temp_frame</span><span class="s2">,</span>
        <span class="s3">&quot;test_index_label&quot;</span><span class="s2">,</span>
        <span class="s1">conn</span><span class="s2">,</span>
        <span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">,</span>
        <span class="s1">index_label</span><span class="s2">=[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">expected_row_count</span>
    <span class="s1">frame </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_index_label&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[:</span><span class="s4">2</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">]</span>

    <span class="s5"># using the index name</span>
    <span class="s1">temp_frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">names </span><span class="s2">= [</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">]</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">temp_frame</span><span class="s2">, </span><span class="s3">&quot;test_index_label&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">expected_row_count</span>
    <span class="s1">frame </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_index_label&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[:</span><span class="s4">2</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">]</span>

    <span class="s5"># has index name, but specifying index_label</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
        <span class="s1">temp_frame</span><span class="s2">,</span>
        <span class="s3">&quot;test_index_label&quot;</span><span class="s2">,</span>
        <span class="s1">conn</span><span class="s2">,</span>
        <span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">,</span>
        <span class="s1">index_label</span><span class="s2">=[</span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s3">&quot;D&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">expected_row_count</span>
    <span class="s1">frame </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_index_label&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">[:</span><span class="s4">2</span><span class="s2">].</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s3">&quot;D&quot;</span><span class="s2">]</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Length of 'index_label' should match number of levels, which is 2&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
            <span class="s1">temp_frame</span><span class="s2">,</span>
            <span class="s3">&quot;test_index_label&quot;</span><span class="s2">,</span>
            <span class="s1">conn</span><span class="s2">,</span>
            <span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">,</span>
            <span class="s1">index_label</span><span class="s2">=</span><span class="s3">&quot;C&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_multiindex_roundtrip</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_multiindex_roundtrip&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_multiindex_roundtrip&quot;</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">.</span><span class="s1">from_records</span><span class="s2">(</span>
        <span class="s2">[(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2.1</span><span class="s2">, </span><span class="s3">&quot;line1&quot;</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s3">&quot;line2&quot;</span><span class="s2">)],</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s3">&quot;C&quot;</span><span class="s2">],</span>
        <span class="s1">index</span><span class="s2">=[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>

    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_multiindex_roundtrip&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span>
        <span class="s3">&quot;SELECT * FROM test_multiindex_roundtrip&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index_col</span><span class="s2">=[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">result</span><span class="s2">, </span><span class="s1">check_index_type</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;dtype&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s0">None</span><span class="s2">,</span>
        <span class="s1">int</span><span class="s2">,</span>
        <span class="s1">float</span><span class="s2">,</span>
        <span class="s2">{</span><span class="s3">&quot;A&quot;</span><span class="s2">: </span><span class="s1">int</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">: </span><span class="s1">float</span><span class="s2">},</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_dtype_argument</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">):</span>
    <span class="s5"># GH10285 Add dtype argument to read_sql_query</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_dtype_argument&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_dtype_argument&quot;</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1.2</span><span class="s2">, </span><span class="s4">3.4</span><span class="s2">], [</span><span class="s4">5.6</span><span class="s2">, </span><span class="s4">7.8</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_dtype_argument&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">) == </span><span class="s4">2</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s3">&quot;postgres&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s1">query </span><span class="s2">= </span><span class="s3">'SELECT &quot;A&quot;, &quot;B&quot; FROM test_dtype_argument'</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">query </span><span class="s2">= </span><span class="s3">&quot;SELECT A, B FROM test_dtype_argument&quot;</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_integer_col_names</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
    <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;test_frame_integer_col_names&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_get_schema</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;'get_schema' not implemented for ADBC drivers&quot;</span><span class="s2">,</span>
                <span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">create_sql </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">get_schema</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s3">&quot;CREATE&quot; </span><span class="s0">in </span><span class="s1">create_sql</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_get_schema_with_schema</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s5"># GH28486</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;'get_schema' not implemented for ADBC drivers&quot;</span><span class="s2">,</span>
                <span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">create_sql </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">get_schema</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s3">&quot;pypi&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s3">&quot;CREATE TABLE pypi.&quot; </span><span class="s0">in </span><span class="s1">create_sql</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_get_schema_dtypes</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;'get_schema' not implemented for ADBC drivers&quot;</span><span class="s2">,</span>
                <span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">float_frame </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">1.2</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">2.1</span><span class="s2">, </span><span class="s4">2.2</span><span class="s2">]})</span>

    <span class="s0">if </span><span class="s1">conn_name </span><span class="s2">== </span><span class="s3">&quot;sqlite_buildin&quot;</span><span class="s2">:</span>
        <span class="s1">dtype </span><span class="s2">= </span><span class="s3">&quot;INTEGER&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">Integer</span>

        <span class="s1">dtype </span><span class="s2">= </span><span class="s1">Integer</span>
    <span class="s1">create_sql </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">get_schema</span><span class="s2">(</span><span class="s1">float_frame</span><span class="s2">, </span><span class="s3">&quot;test&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">={</span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">dtype</span><span class="s2">})</span>
    <span class="s0">assert </span><span class="s3">&quot;CREATE&quot; </span><span class="s0">in </span><span class="s1">create_sql</span>
    <span class="s0">assert </span><span class="s3">&quot;INTEGER&quot; </span><span class="s0">in </span><span class="s1">create_sql</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_get_schema_keys</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;'get_schema' not implemented for ADBC drivers&quot;</span><span class="s2">,</span>
                <span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">frame </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;Col1&quot;</span><span class="s2">: [</span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">1.2</span><span class="s2">], </span><span class="s3">&quot;Col2&quot;</span><span class="s2">: [</span><span class="s4">2.1</span><span class="s2">, </span><span class="s4">2.2</span><span class="s2">]})</span>
    <span class="s1">create_sql </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">get_schema</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">, </span><span class="s3">&quot;test&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">keys</span><span class="s2">=</span><span class="s3">&quot;Col1&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s3">&quot;mysql&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s1">constraint_sentence </span><span class="s2">= </span><span class="s3">&quot;CONSTRAINT test_pk PRIMARY KEY (`Col1`)&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">constraint_sentence </span><span class="s2">= </span><span class="s3">'CONSTRAINT test_pk PRIMARY KEY (&quot;Col1&quot;)'</span>
    <span class="s0">assert </span><span class="s1">constraint_sentence </span><span class="s0">in </span><span class="s1">create_sql</span>

    <span class="s5"># multiple columns as key (GH10385)</span>
    <span class="s1">create_sql </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">get_schema</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">keys</span><span class="s2">=[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">])</span>
    <span class="s0">if </span><span class="s3">&quot;mysql&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s1">constraint_sentence </span><span class="s2">= </span><span class="s3">&quot;CONSTRAINT test_pk PRIMARY KEY (`A`, `B`)&quot;</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">constraint_sentence </span><span class="s2">= </span><span class="s3">'CONSTRAINT test_pk PRIMARY KEY (&quot;A&quot;, &quot;B&quot;)'</span>
    <span class="s0">assert </span><span class="s1">constraint_sentence </span><span class="s0">in </span><span class="s1">create_sql</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_chunksize_read</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;chunksize argument NotImplemented with ADBC&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_chunksize&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_chunksize&quot;</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">22</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)), </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;abcde&quot;</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_chunksize&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s5"># reading the query in one time</span>
    <span class="s1">res1 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;select * from test_chunksize&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s5"># reading the query in chunks with read_sql_query</span>
    <span class="s1">res2 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">()</span>
    <span class="s1">i </span><span class="s2">= </span><span class="s4">0</span>
    <span class="s1">sizes </span><span class="s2">= [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>

    <span class="s0">for </span><span class="s1">chunk </span><span class="s0">in </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;select * from test_chunksize&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">5</span><span class="s2">):</span>
        <span class="s1">res2 </span><span class="s2">= </span><span class="s1">concat</span><span class="s2">([</span><span class="s1">res2</span><span class="s2">, </span><span class="s1">chunk</span><span class="s2">], </span><span class="s1">ignore_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">) == </span><span class="s1">sizes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
        <span class="s1">i </span><span class="s2">+= </span><span class="s4">1</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">)</span>

    <span class="s5"># reading the query in chunks with read_sql_query</span>
    <span class="s0">if </span><span class="s1">conn_name </span><span class="s2">== </span><span class="s3">&quot;sqlite_buildin&quot;</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">NotImplementedError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">):</span>
            <span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_chunksize&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">res3 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">()</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s1">sizes </span><span class="s2">= [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>

        <span class="s0">for </span><span class="s1">chunk </span><span class="s0">in </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_chunksize&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">5</span><span class="s2">):</span>
            <span class="s1">res3 </span><span class="s2">= </span><span class="s1">concat</span><span class="s2">([</span><span class="s1">res3</span><span class="s2">, </span><span class="s1">chunk</span><span class="s2">], </span><span class="s1">ignore_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">chunk</span><span class="s2">) == </span><span class="s1">sizes</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s1">i </span><span class="s2">+= </span><span class="s4">1</span>

        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res1</span><span class="s2">, </span><span class="s1">res3</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_categorical</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">conn </span><span class="s2">== </span><span class="s3">&quot;postgresql_adbc_conn&quot;</span><span class="s2">:</span>
        <span class="s1">adbc </span><span class="s2">= </span><span class="s1">import_optional_dependency</span><span class="s2">(</span><span class="s3">&quot;adbc_driver_postgresql&quot;</span><span class="s2">, </span><span class="s1">errors</span><span class="s2">=</span><span class="s3">&quot;ignore&quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">adbc </span><span class="s0">is not None and </span><span class="s1">Version</span><span class="s2">(</span><span class="s1">adbc</span><span class="s2">.</span><span class="s1">__version__</span><span class="s2">) &lt; </span><span class="s1">Version</span><span class="s2">(</span><span class="s3">&quot;0.9.0&quot;</span><span class="s2">):</span>
            <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
                <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                    <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;categorical dtype not implemented for ADBC postgres driver&quot;</span><span class="s2">,</span>
                    <span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
                <span class="s2">)</span>
            <span class="s2">)</span>
    <span class="s5"># GH8624</span>
    <span class="s5"># test that categorical gets written correctly as dense column</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_categorical&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_categorical&quot;</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;person_id&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
            <span class="s3">&quot;person_name&quot;</span><span class="s2">: [</span><span class="s3">&quot;John P. Doe&quot;</span><span class="s2">, </span><span class="s3">&quot;Jane Dove&quot;</span><span class="s2">, </span><span class="s3">&quot;John P. Doe&quot;</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df2</span><span class="s2">[</span><span class="s3">&quot;person_name&quot;</span><span class="s2">] = </span><span class="s1">df2</span><span class="s2">[</span><span class="s3">&quot;person_name&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;category&quot;</span><span class="s2">)</span>

    <span class="s1">df2</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_categorical&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_categorical&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_unicode_column_name</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># GH 11431</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_unicode&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_unicode&quot;</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;</span><span class="s0">\xe9</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">])</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_unicode&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_escaped_table_name</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># GH 13206</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;d1187b08-4943-4c8d-a7f6&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;d1187b08-4943-4c8d-a7f6&quot;</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">0.2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">5.6</span><span class="s2">]})</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;d1187b08-4943-4c8d-a7f6&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s3">&quot;postgres&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s1">query </span><span class="s2">= </span><span class="s3">'SELECT * FROM &quot;d1187b08-4943-4c8d-a7f6&quot;'</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">query </span><span class="s2">= </span><span class="s3">&quot;SELECT * FROM `d1187b08-4943-4c8d-a7f6`&quot;</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_api_read_sql_duplicate_columns</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># GH#53117</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">pa </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">)</span>
        <span class="s0">if not </span><span class="s2">(</span>
            <span class="s1">Version</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">__version__</span><span class="s2">) &gt;= </span><span class="s1">Version</span><span class="s2">(</span><span class="s3">&quot;16.0&quot;</span><span class="s2">)</span>
            <span class="s0">and </span><span class="s1">conn </span><span class="s0">in </span><span class="s2">[</span><span class="s3">&quot;sqlite_adbc_conn&quot;</span><span class="s2">, </span><span class="s3">&quot;postgresql_adbc_conn&quot;</span><span class="s2">]</span>
        <span class="s2">):</span>
            <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
                <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                    <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;pyarrow-&gt;pandas throws ValueError&quot;</span><span class="s2">, </span><span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span>
                <span class="s2">)</span>
            <span class="s2">)</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_table&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;test_table&quot;</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">], </span><span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">})</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_table&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;SELECT a, b, a +1 as a, c FROM test_table&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]],</span>
        <span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">],</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_table_columns</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s5"># test columns argument in read_table</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s0">if </span><span class="s1">conn_name </span><span class="s2">== </span><span class="s3">&quot;sqlite_buildin&quot;</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;Not Implemented&quot;</span><span class="s2">))</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">cols </span><span class="s2">= [</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">]</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_frame&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">cols</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == </span><span class="s1">cols</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_table_index_col</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s5"># test columns argument in read_table</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s0">if </span><span class="s1">conn_name </span><span class="s2">== </span><span class="s3">&quot;sqlite_buildin&quot;</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;Not Implemented&quot;</span><span class="s2">))</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_frame&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index_col</span><span class="s2">=</span><span class="s3">&quot;index&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">names </span><span class="s2">== [</span><span class="s3">&quot;index&quot;</span><span class="s2">]</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_frame&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index_col</span><span class="s2">=[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">names </span><span class="s2">== [</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">]</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span>
        <span class="s3">&quot;test_frame&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index_col</span><span class="s2">=[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s3">&quot;D&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">names </span><span class="s2">== [</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">() == [</span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s3">&quot;D&quot;</span><span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_sql_delegate</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">conn </span><span class="s2">== </span><span class="s3">&quot;sqlite_buildin_iris&quot;</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;sqlite_buildin connection does not implement read_sql_table&quot;</span>
            <span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">iris_frame1 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM iris&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">iris_frame2 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM iris&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">iris_frame1</span><span class="s2">, </span><span class="s1">iris_frame2</span><span class="s2">)</span>

    <span class="s1">iris_frame1 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;iris&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">iris_frame2 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;iris&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">iris_frame1</span><span class="s2">, </span><span class="s1">iris_frame2</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_not_reflect_all_tables</span><span class="s2">(</span><span class="s1">sqlite_conn</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_conn</span>
    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">text</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">engine </span><span class="s0">import </span><span class="s1">Engine</span>

    <span class="s5"># create invalid table</span>
    <span class="s1">query_list </span><span class="s2">= [</span>
        <span class="s1">text</span><span class="s2">(</span><span class="s3">&quot;CREATE TABLE invalid (x INTEGER, y UNKNOWN);&quot;</span><span class="s2">),</span>
        <span class="s1">text</span><span class="s2">(</span><span class="s3">&quot;CREATE TABLE other_table (x INTEGER, y INTEGER);&quot;</span><span class="s2">),</span>
    <span class="s2">]</span>

    <span class="s0">for </span><span class="s1">query </span><span class="s0">in </span><span class="s1">query_list</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">Engine</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
                <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
                    <span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">query</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
                <span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">query</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;other_table&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM other_table&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_warning_case_insensitive_table_name</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s0">if </span><span class="s1">conn_name </span><span class="s2">== </span><span class="s3">&quot;sqlite_buildin&quot; </span><span class="s0">or </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;Does not raise warning&quot;</span><span class="s2">))</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s5"># see gh-7815</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span>
        <span class="s1">UserWarning</span><span class="s2">,</span>
        <span class="s1">match</span><span class="s2">=(</span>
            <span class="s3">r&quot;The provided table name 'TABLE1' is not found exactly as such in &quot;</span>
            <span class="s3">r&quot;the database after writing the table, possibly due to case &quot;</span>
            <span class="s3">r&quot;sensitivity issues. Consider using lower case table names.&quot;</span>
        <span class="s2">),</span>
    <span class="s2">):</span>
        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">db</span><span class="s2">:</span>
            <span class="s1">db</span><span class="s2">.</span><span class="s1">check_case_sensitive</span><span class="s2">(</span><span class="s3">&quot;TABLE1&quot;</span><span class="s2">, </span><span class="s3">&quot;&quot;</span><span class="s2">)</span>

    <span class="s5"># Test that the warning is certainly NOT triggered in a normal case.</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">test_frame1</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;CaseSensitive&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sqlalchemy_type_mapping</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">TIMESTAMP</span>

    <span class="s5"># Test Timestamp objects (no datetime64 because of timezone) (GH9085)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">([</span><span class="s3">&quot;2014-12-12 01:54&quot;</span><span class="s2">, </span><span class="s3">&quot;2014-12-11 02:54&quot;</span><span class="s2">], </span><span class="s1">utc</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)}</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">db</span><span class="s2">:</span>
        <span class="s1">table </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLTable</span><span class="s2">(</span><span class="s3">&quot;test_type&quot;</span><span class="s2">, </span><span class="s1">db</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">=</span><span class="s1">df</span><span class="s2">)</span>
        <span class="s5"># GH 9086: TIMESTAMP is the suggested type for datetimes with timezones</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">table</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">c</span><span class="s2">[</span><span class="s3">&quot;time&quot;</span><span class="s2">].</span><span class="s1">type</span><span class="s2">, </span><span class="s1">TIMESTAMP</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;integer, expected&quot;</span><span class="s2">,</span>
    <span class="s2">[</span>
        <span class="s2">(</span><span class="s3">&quot;int8&quot;</span><span class="s2">, </span><span class="s3">&quot;SMALLINT&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;Int8&quot;</span><span class="s2">, </span><span class="s3">&quot;SMALLINT&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;uint8&quot;</span><span class="s2">, </span><span class="s3">&quot;SMALLINT&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;UInt8&quot;</span><span class="s2">, </span><span class="s3">&quot;SMALLINT&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;int16&quot;</span><span class="s2">, </span><span class="s3">&quot;SMALLINT&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;Int16&quot;</span><span class="s2">, </span><span class="s3">&quot;SMALLINT&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;uint16&quot;</span><span class="s2">, </span><span class="s3">&quot;INTEGER&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;UInt16&quot;</span><span class="s2">, </span><span class="s3">&quot;INTEGER&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;int32&quot;</span><span class="s2">, </span><span class="s3">&quot;INTEGER&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;Int32&quot;</span><span class="s2">, </span><span class="s3">&quot;INTEGER&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;uint32&quot;</span><span class="s2">, </span><span class="s3">&quot;BIGINT&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;UInt32&quot;</span><span class="s2">, </span><span class="s3">&quot;BIGINT&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;int64&quot;</span><span class="s2">, </span><span class="s3">&quot;BIGINT&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s3">&quot;Int64&quot;</span><span class="s2">, </span><span class="s3">&quot;BIGINT&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s1">int</span><span class="s2">, </span><span class="s3">&quot;BIGINT&quot; </span><span class="s0">if </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">).</span><span class="s1">name </span><span class="s2">== </span><span class="s3">&quot;int64&quot; </span><span class="s0">else </span><span class="s3">&quot;INTEGER&quot;</span><span class="s2">),</span>
    <span class="s2">],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sqlalchemy_integer_mapping</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">integer</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">):</span>
    <span class="s5"># GH35076 Map pandas integer to optimal SQLAlchemy integer type</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">integer</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">db</span><span class="s2">:</span>
        <span class="s1">table </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLTable</span><span class="s2">(</span><span class="s3">&quot;test_type&quot;</span><span class="s2">, </span><span class="s1">db</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">=</span><span class="s1">df</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">str</span><span class="s2">(</span><span class="s1">table</span><span class="s2">.</span><span class="s1">table</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">a</span><span class="s2">.</span><span class="s1">type</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">expected</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;integer&quot;</span><span class="s2">, [</span><span class="s3">&quot;uint64&quot;</span><span class="s2">, </span><span class="s3">&quot;UInt64&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_sqlalchemy_integer_overload_mapping</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">integer</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s5"># GH35076 Map pandas integer to optimal SQLAlchemy integer type</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">integer</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">db</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span>
            <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Unsigned 64 bit integer datatype is not supported&quot;</span>
        <span class="s2">):</span>
            <span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLTable</span><span class="s2">(</span><span class="s3">&quot;test_type&quot;</span><span class="s2">, </span><span class="s1">db</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">=</span><span class="s1">df</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_database_uri_string</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">)</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s5"># Test read_sql and .to_sql method with a database URI (GH10654)</span>
    <span class="s5"># db_uri = 'sqlite:///:memory:' # raises</span>
    <span class="s5"># sqlalchemy.exc.OperationalError: (sqlite3.OperationalError) near</span>
    <span class="s5"># &quot;iris&quot;: syntax error [SQL: 'iris']</span>
    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">name</span><span class="s2">:</span>
        <span class="s1">db_uri </span><span class="s2">= </span><span class="s3">&quot;sqlite:///&quot; </span><span class="s2">+ </span><span class="s1">name</span>
        <span class="s1">table </span><span class="s2">= </span><span class="s3">&quot;iris&quot;</span>
        <span class="s1">test_frame1</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">table</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">db_uri</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">test_frame2 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s1">table</span><span class="s2">, </span><span class="s1">db_uri</span><span class="s2">)</span>
        <span class="s1">test_frame3 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s1">table</span><span class="s2">, </span><span class="s1">db_uri</span><span class="s2">)</span>
        <span class="s1">query </span><span class="s2">= </span><span class="s3">&quot;SELECT * FROM iris&quot;</span>
        <span class="s1">test_frame4 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, </span><span class="s1">db_uri</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s1">test_frame2</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s1">test_frame3</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s1">test_frame4</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">td</span><span class="s2">.</span><span class="s1">skip_if_installed</span><span class="s2">(</span><span class="s3">&quot;pg8000&quot;</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_pg8000_sqlalchemy_passthrough_error</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">)</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s5"># using driver that will not be installed on CI to trigger error</span>
    <span class="s5"># in sqlalchemy.create_engine -&gt; test passing of this error to user</span>
    <span class="s1">db_uri </span><span class="s2">= </span><span class="s3">&quot;postgresql+pg8000://user:pass@host/dbname&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;pg8000&quot;</span><span class="s2">):</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;select * from table&quot;</span><span class="s2">, </span><span class="s1">db_uri</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_query_by_text_obj</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># WIP : GH10846</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">text</span>

    <span class="s0">if </span><span class="s3">&quot;postgres&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s1">name_text </span><span class="s2">= </span><span class="s1">text</span><span class="s2">(</span><span class="s3">'select * from iris where &quot;Name&quot;=:name'</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">name_text </span><span class="s2">= </span><span class="s1">text</span><span class="s2">(</span><span class="s3">&quot;select * from iris where name=:name&quot;</span><span class="s2">)</span>
    <span class="s1">iris_df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s1">name_text</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">params</span><span class="s2">={</span><span class="s3">&quot;name&quot;</span><span class="s2">: </span><span class="s3">&quot;Iris-versicolor&quot;</span><span class="s2">})</span>
    <span class="s1">all_names </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">iris_df</span><span class="s2">[</span><span class="s3">&quot;Name&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">all_names </span><span class="s2">== {</span><span class="s3">&quot;Iris-versicolor&quot;</span><span class="s2">}</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_query_by_select_obj</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s5"># WIP : GH10846</span>
    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s2">(</span>
        <span class="s1">bindparam</span><span class="s2">,</span>
        <span class="s1">select</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">iris </span><span class="s2">= </span><span class="s1">iris_table_metadata</span><span class="s2">()</span>
    <span class="s1">name_select </span><span class="s2">= </span><span class="s1">select</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">).</span><span class="s1">where</span><span class="s2">(</span><span class="s1">iris</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">Name </span><span class="s2">== </span><span class="s1">bindparam</span><span class="s2">(</span><span class="s3">&quot;name&quot;</span><span class="s2">))</span>
    <span class="s1">iris_df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s1">name_select</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">params</span><span class="s2">={</span><span class="s3">&quot;name&quot;</span><span class="s2">: </span><span class="s3">&quot;Iris-setosa&quot;</span><span class="s2">})</span>
    <span class="s1">all_names </span><span class="s2">= </span><span class="s1">set</span><span class="s2">(</span><span class="s1">iris_df</span><span class="s2">[</span><span class="s3">&quot;Name&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">all_names </span><span class="s2">== {</span><span class="s3">&quot;Iris-setosa&quot;</span><span class="s2">}</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_column_with_percentage</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># GH 37157</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s0">if </span><span class="s1">conn_name </span><span class="s2">== </span><span class="s3">&quot;sqlite_buildin&quot;</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;Not Implemented&quot;</span><span class="s2">))</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;%_variation&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]})</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_column_percentage&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s1">res </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_column_percentage&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_sql_open_close</span><span class="s2">(</span><span class="s1">test_frame3</span><span class="s2">):</span>
    <span class="s5"># Test if the IO in the database still work if the connection closed</span>
    <span class="s5"># between the writing and reading (as in many real situations).</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">ensure_clean</span><span class="s2">() </span><span class="s0">as </span><span class="s1">name</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">closing</span><span class="s2">(</span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame3</span><span class="s2">, </span><span class="s3">&quot;test_frame3_legacy&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">4</span>

        <span class="s0">with </span><span class="s1">closing</span><span class="s2">(</span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s1">name</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
            <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_frame3_legacy;&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">test_frame3</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">td</span><span class="s2">.</span><span class="s1">skip_if_installed</span><span class="s2">(</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_con_string_import_error</span><span class="s2">():</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s3">&quot;mysql://root@localhost/pandas&quot;</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Using URI string without sqlalchemy installed&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ImportError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM iris&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">td</span><span class="s2">.</span><span class="s1">skip_if_installed</span><span class="s2">(</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_con_unknown_dbapi2_class_does_not_error_without_sql_alchemy_installed</span><span class="s2">():</span>
    <span class="s0">class </span><span class="s1">MockSqliteConnection</span><span class="s2">:</span>
        <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">) </span><span class="s1">-&gt; </span><span class="s0">None</span><span class="s2">:</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">Connection</span><span class="s2">(*</span><span class="s1">args</span><span class="s2">, **</span><span class="s1">kwargs</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">__getattr__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">name</span><span class="s2">):</span>
            <span class="s0">return </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">name</span><span class="s2">)</span>

        <span class="s0">def </span><span class="s1">close</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
            <span class="s1">self</span><span class="s2">.</span><span class="s1">conn</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>

    <span class="s0">with </span><span class="s1">contextlib</span><span class="s2">.</span><span class="s1">closing</span><span class="s2">(</span><span class="s1">MockSqliteConnection</span><span class="s2">(</span><span class="s3">&quot;:memory:&quot;</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">UserWarning</span><span class="s2">):</span>
            <span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;SELECT 1&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_sqlite_read_sql_delegate</span><span class="s2">(</span><span class="s1">sqlite_buildin_iris</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_buildin_iris</span>
    <span class="s1">iris_frame1 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM iris&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">iris_frame2 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM iris&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">iris_frame1</span><span class="s2">, </span><span class="s1">iris_frame2</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Execution failed on sql 'iris': near </span><span class="s0">\&quot;</span><span class="s3">iris</span><span class="s0">\&quot;</span><span class="s3">: syntax error&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">sql</span><span class="s2">.</span><span class="s1">DatabaseError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;iris&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_get_schema2</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s5"># without providing a connection object (available for backwards comp)</span>
    <span class="s1">create_sql </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">get_schema</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s3">&quot;CREATE&quot; </span><span class="s0">in </span><span class="s1">create_sql</span>


<span class="s0">def </span><span class="s1">test_sqlite_type_mapping</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">):</span>
    <span class="s5"># Test Timestamp objects (no datetime64 because of timezone) (GH9085)</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_buildin</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;time&quot;</span><span class="s2">: </span><span class="s1">to_datetime</span><span class="s2">([</span><span class="s3">&quot;2014-12-12 01:54&quot;</span><span class="s2">, </span><span class="s3">&quot;2014-12-11 02:54&quot;</span><span class="s2">], </span><span class="s1">utc</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)}</span>
    <span class="s2">)</span>
    <span class="s1">db </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLiteDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">table </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLiteTable</span><span class="s2">(</span><span class="s3">&quot;test_type&quot;</span><span class="s2">, </span><span class="s1">db</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">=</span><span class="s1">df</span><span class="s2">)</span>
    <span class="s1">schema </span><span class="s2">= </span><span class="s1">table</span><span class="s2">.</span><span class="s1">sql_schema</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">schema</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">col</span><span class="s2">.</span><span class="s1">split</span><span class="s2">()[</span><span class="s4">0</span><span class="s2">].</span><span class="s1">strip</span><span class="s2">(</span><span class="s3">'&quot;'</span><span class="s2">) == </span><span class="s3">&quot;time&quot;</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">col</span><span class="s2">.</span><span class="s1">split</span><span class="s2">()[</span><span class="s4">1</span><span class="s2">] == </span><span class="s3">&quot;TIMESTAMP&quot;</span>


<span class="s5"># -----------------------------------------------------------------------------</span>
<span class="s5"># -- Database flavor specific tests</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_create_table</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">conn </span><span class="s2">== </span><span class="s3">&quot;sqlite_str&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">&quot;sqlite_str has no inspection system&quot;</span><span class="s2">)</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">inspect</span>

    <span class="s1">temp_frame </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;one&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">], </span><span class="s3">&quot;two&quot;</span><span class="s2">: [</span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">]})</span>
    <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">temp_frame</span><span class="s2">, </span><span class="s3">&quot;temp_frame&quot;</span><span class="s2">) == </span><span class="s4">4</span>

    <span class="s1">insp </span><span class="s2">= </span><span class="s1">inspect</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">insp</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;temp_frame&quot;</span><span class="s2">)</span>

    <span class="s5"># Cleanup</span>
    <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;temp_frame&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_drop_table</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">conn </span><span class="s2">== </span><span class="s3">&quot;sqlite_str&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">&quot;sqlite_str has no inspection system&quot;</span><span class="s2">)</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">inspect</span>

    <span class="s1">temp_frame </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;one&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">], </span><span class="s3">&quot;two&quot;</span><span class="s2">: [</span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">]})</span>
    <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">():</span>
            <span class="s0">assert </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">temp_frame</span><span class="s2">, </span><span class="s3">&quot;temp_frame&quot;</span><span class="s2">) == </span><span class="s4">4</span>

        <span class="s1">insp </span><span class="s2">= </span><span class="s1">inspect</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">insp</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;temp_frame&quot;</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">():</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;temp_frame&quot;</span><span class="s2">)</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">insp</span><span class="s2">.</span><span class="s1">clear_cache</span><span class="s2">()  </span><span class="s5"># needed with SQLAlchemy 2.0, unavailable prior</span>
        <span class="s0">except </span><span class="s1">AttributeError</span><span class="s2">:</span>
            <span class="s0">pass</span>
        <span class="s0">assert not </span><span class="s1">insp</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;temp_frame&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_roundtrip</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">conn </span><span class="s2">== </span><span class="s3">&quot;sqlite_str&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">&quot;sqlite_str has no inspection system&quot;</span><span class="s2">)</span>

    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">pandasSQL </span><span class="s2">= </span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">():</span>
        <span class="s0">assert </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame_roundtrip&quot;</span><span class="s2">) == </span><span class="s4">4</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">read_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_frame_roundtrip&quot;</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">rename</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">={</span><span class="s3">&quot;__index_level_0__&quot;</span><span class="s2">: </span><span class="s3">&quot;level_0&quot;</span><span class="s2">})</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">set_index</span><span class="s2">(</span><span class="s3">&quot;level_0&quot;</span><span class="s2">, </span><span class="s1">inplace</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s5"># result.index.astype(int)</span>

    <span class="s1">result</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s0">None</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_execute_sql</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">():</span>
            <span class="s1">iris_results </span><span class="s2">= </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM iris&quot;</span><span class="s2">)</span>
            <span class="s1">row </span><span class="s2">= </span><span class="s1">iris_results</span><span class="s2">.</span><span class="s1">fetchone</span><span class="s2">()</span>
            <span class="s1">iris_results</span><span class="s2">.</span><span class="s1">close</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">row</span><span class="s2">) == [</span><span class="s4">5.1</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">, </span><span class="s4">1.4</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s3">&quot;Iris-setosa&quot;</span><span class="s2">]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sqlalchemy_read_table</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;iris&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">check_iris_frame</span><span class="s2">(</span><span class="s1">iris_frame</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sqlalchemy_read_table_columns</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">iris_frame </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span>
        <span class="s3">&quot;iris&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;SepalLength&quot;</span><span class="s2">, </span><span class="s3">&quot;SepalLength&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_index_equal</span><span class="s2">(</span><span class="s1">iris_frame</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">, </span><span class="s1">Index</span><span class="s2">([</span><span class="s3">&quot;SepalLength&quot;</span><span class="s2">, </span><span class="s3">&quot;SepalLength__1&quot;</span><span class="s2">]))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable_iris</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_read_table_absent_raises</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Table this_doesnt_exist not found&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;this_doesnt_exist&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable_types</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_sqlalchemy_default_type_conversion</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s0">if </span><span class="s1">conn_name </span><span class="s2">== </span><span class="s3">&quot;sqlite_str&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">&quot;types tables not created in sqlite_str fixture&quot;</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s3">&quot;mysql&quot; </span><span class="s0">in </span><span class="s1">conn_name </span><span class="s0">or </span><span class="s3">&quot;sqlite&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;boolean dtype not inferred properly&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;types&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">FloatCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floating</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">IntCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">integer</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">BoolCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">bool_</span><span class="s2">)</span>

    <span class="s5"># Int column with NA values stays as float</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">IntColWithNull</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">floating</span><span class="s2">)</span>
    <span class="s5"># Bool column with NA values becomes object</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">BoolColWithNull</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">object</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_bigint</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># int64 should be converted to BigInteger, GH7433</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">={</span><span class="s3">&quot;i64&quot;</span><span class="s2">: [</span><span class="s4">2</span><span class="s2">**</span><span class="s4">62</span><span class="s2">]})</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_bigint&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">1</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_bigint&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable_types</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_default_date_load</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s0">if </span><span class="s1">conn_name </span><span class="s2">== </span><span class="s3">&quot;sqlite_str&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">&quot;types tables not created in sqlite_str fixture&quot;</span><span class="s2">)</span>
    <span class="s0">elif </span><span class="s3">&quot;sqlite&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;sqlite does not read date properly&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;types&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">DateCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">postgresql_connectable</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;parse_dates&quot;</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, [</span><span class="s3">&quot;DateColWithTz&quot;</span><span class="s2">]])</span>
<span class="s0">def </span><span class="s1">test_datetime_with_timezone_query</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">parse_dates</span><span class="s2">):</span>
    <span class="s5"># edge case that converts postgresql datetime with time zone types</span>
    <span class="s5"># to datetime64[ns,psycopg2.tz.FixedOffsetTimezone..], which is ok</span>
    <span class="s5"># but should be more natural, so coerce to datetime64[ns] for now</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">create_and_load_postgres_datetz</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s5"># GH11216</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;select * from datetz&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">parse_dates</span><span class="s2">=</span><span class="s1">parse_dates</span><span class="s2">)</span>
    <span class="s1">col </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">DateColWithTz</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">col</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">postgresql_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_datetime_with_timezone_query_chunksize</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">create_and_load_postgres_datetz</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">concat</span><span class="s2">(</span>
        <span class="s1">list</span><span class="s2">(</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;select * from datetz&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">chunksize</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)),</span>
        <span class="s1">ignore_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">col </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">DateColWithTz</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">col</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">postgresql_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_datetime_with_timezone_table</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">create_and_load_postgres_datetz</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;datetz&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">to_frame</span><span class="s2">())</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_datetime_with_timezone_roundtrip</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s5"># GH 9086</span>
    <span class="s5"># Write datetimetz data to a db and read it back</span>
    <span class="s5"># For dbs that support timestamps with timezones, should get back UTC</span>
    <span class="s5"># otherwise naive data should be returned</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;A&quot;</span><span class="s2">: </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2013-01-01 09:00:00&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s2">)}</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_datetime_tz&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">3</span>

    <span class="s0">if </span><span class="s3">&quot;postgresql&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s5"># SQLAlchemy &quot;timezones&quot; (i.e. offsets) are coerced to UTC</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">].</span><span class="s1">dt</span><span class="s2">.</span><span class="s1">tz_convert</span><span class="s2">(</span><span class="s3">&quot;UTC&quot;</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s5"># Otherwise, timestamps are returned as local, naive</span>
        <span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">] = </span><span class="s1">expected</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">].</span><span class="s1">dt</span><span class="s2">.</span><span class="s1">tz_localize</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_datetime_tz&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_datetime_tz&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s3">&quot;sqlite&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s5"># read_sql_query does not return datetime type like read_sql_table</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">], </span><span class="s1">str</span><span class="s2">)</span>
        <span class="s1">result</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">] = </span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s1">result</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_out_of_bounds_datetime</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># GH 26761</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">data </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;date&quot;</span><span class="s2">: </span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">9999</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)}, </span><span class="s1">index</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">data</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_datetime_obb&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">1</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_datetime_obb&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([</span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NaT</span><span class="s2">], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;date&quot;</span><span class="s2">])</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_naive_datetimeindex_roundtrip</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># GH 23510</span>
    <span class="s5"># Ensure that a naive DatetimeIndex isn't converted to UTC</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">dates </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2018-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;6h&quot;</span><span class="s2">).</span><span class="s1">_with_freq</span><span class="s2">(</span><span class="s0">None</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;nums&quot;</span><span class="s2">: </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)}, </span><span class="s1">index</span><span class="s2">=</span><span class="s1">dates</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">expected</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;foo_table&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index_label</span><span class="s2">=</span><span class="s3">&quot;info_date&quot;</span><span class="s2">) == </span><span class="s4">5</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;foo_table&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index_col</span><span class="s2">=</span><span class="s3">&quot;info_date&quot;</span><span class="s2">)</span>
    <span class="s5"># result index with gain a name from a set_index operation; expected</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">, </span><span class="s1">check_names</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable_types</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_date_parsing</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># No Parsing</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;types&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">expected_type </span><span class="s2">= </span><span class="s1">object </span><span class="s0">if </span><span class="s3">&quot;sqlite&quot; </span><span class="s0">in </span><span class="s1">conn_name </span><span class="s0">else </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">DateCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">expected_type</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;types&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">parse_dates</span><span class="s2">=[</span><span class="s3">&quot;DateCol&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">DateCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;types&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">parse_dates</span><span class="s2">={</span><span class="s3">&quot;DateCol&quot;</span><span class="s2">: </span><span class="s3">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="s2">})</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">DateCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span>
        <span class="s3">&quot;types&quot;</span><span class="s2">,</span>
        <span class="s1">conn</span><span class="s2">,</span>
        <span class="s1">parse_dates</span><span class="s2">={</span><span class="s3">&quot;DateCol&quot;</span><span class="s2">: {</span><span class="s3">&quot;format&quot;</span><span class="s2">: </span><span class="s3">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="s2">}},</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">DateCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;types&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">parse_dates</span><span class="s2">=[</span><span class="s3">&quot;IntDateCol&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">IntDateCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;types&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">parse_dates</span><span class="s2">={</span><span class="s3">&quot;IntDateCol&quot;</span><span class="s2">: </span><span class="s3">&quot;s&quot;</span><span class="s2">})</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">IntDateCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">)</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;types&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">parse_dates</span><span class="s2">={</span><span class="s3">&quot;IntDateCol&quot;</span><span class="s2">: {</span><span class="s3">&quot;unit&quot;</span><span class="s2">: </span><span class="s3">&quot;s&quot;</span><span class="s2">}})</span>
    <span class="s0">assert </span><span class="s1">issubclass</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">IntDateCol</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">.</span><span class="s1">type</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_datetime</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;A&quot;</span><span class="s2">: </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2013-01-01 09:00:00&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">), </span><span class="s3">&quot;B&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">3.0</span><span class="s2">)}</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_datetime&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">) == </span><span class="s4">3</span>

    <span class="s5"># with read_table -&gt; type information from schema used</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_datetime&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>

    <span class="s5"># with read_sql -&gt; no type information -&gt; sqlite has no native</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_datetime&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">result</span><span class="s2">.</span><span class="s1">drop</span><span class="s2">(</span><span class="s3">&quot;index&quot;</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s3">&quot;sqlite&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">], </span><span class="s1">str</span><span class="s2">)</span>
        <span class="s1">result</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">] = </span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s1">result</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">])</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_datetime_NaT</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;A&quot;</span><span class="s2">: </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2013-01-01 09:00:00&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">3</span><span class="s2">), </span><span class="s3">&quot;B&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">3.0</span><span class="s2">)}</span>
    <span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_datetime&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">3</span>

    <span class="s5"># with read_table -&gt; type information from schema used</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_datetime&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>

    <span class="s5"># with read_sql -&gt; no type information -&gt; sqlite has no native</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_datetime&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s3">&quot;sqlite&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">], </span><span class="s1">str</span><span class="s2">)</span>
        <span class="s1">result</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">] = </span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s1">result</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">], </span><span class="s1">errors</span><span class="s2">=</span><span class="s3">&quot;coerce&quot;</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_datetime_date</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># test support for datetime.date</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([</span><span class="s1">date</span><span class="s2">(</span><span class="s4">2014</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s1">date</span><span class="s2">(</span><span class="s4">2014</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_date&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">2</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_date&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">res</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">]</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">to_datetime</span><span class="s2">(</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;a&quot;</span><span class="s2">])</span>
    <span class="s5"># comes back as datetime64</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_series_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_datetime_time</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">sqlite_buildin</span><span class="s2">):</span>
    <span class="s5"># test support for datetime.time</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([</span><span class="s1">time</span><span class="s2">(</span><span class="s4">9</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), </span><span class="s1">time</span><span class="s2">(</span><span class="s4">9</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">30</span><span class="s2">)], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_time&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">2</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_time&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>

    <span class="s5"># GH8341</span>
    <span class="s5"># first, use the fallback to have the sqlite adapter put in place</span>
    <span class="s1">sqlite_conn </span><span class="s2">= </span><span class="s1">sqlite_buildin</span>
    <span class="s0">assert </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;test_time2&quot;</span><span class="s2">, </span><span class="s1">sqlite_conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">2</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_time2&quot;</span><span class="s2">, </span><span class="s1">sqlite_conn</span><span class="s2">)</span>
    <span class="s1">ref </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">map</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">_</span><span class="s2">: </span><span class="s1">_</span><span class="s2">.</span><span class="s1">strftime</span><span class="s2">(</span><span class="s3">&quot;%H:%M:%S.%f&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)  </span><span class="s5"># check if adapter is in place</span>
    <span class="s5"># then test if sqlalchemy is unaffected by the sqlite adapter</span>
    <span class="s0">assert </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s3">&quot;test_time3&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">2</span>
    <span class="s0">if </span><span class="s3">&quot;sqlite&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_time3&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s1">ref </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">map</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">_</span><span class="s2">: </span><span class="s1">_</span><span class="s2">.</span><span class="s1">strftime</span><span class="s2">(</span><span class="s3">&quot;%H:%M:%S.%f&quot;</span><span class="s2">))</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">ref</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_time3&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_mixed_dtype_insert</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># see GH6509</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">s1 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s4">2</span><span class="s2">**</span><span class="s4">25 </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int32</span><span class="s2">)</span>
    <span class="s1">s2 </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s4">0.0</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float32</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;s1&quot;</span><span class="s2">: </span><span class="s1">s1</span><span class="s2">, </span><span class="s3">&quot;s2&quot;</span><span class="s2">: </span><span class="s1">s2</span><span class="s2">})</span>

    <span class="s5"># write and read again</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_read_write&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">1</span>
    <span class="s1">df2 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_read_write&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df2</span><span class="s2">, </span><span class="s1">check_dtype</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">check_exact</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_nan_numeric</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># NaNs in numeric float column</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;B&quot;</span><span class="s2">: [</span><span class="s4">0.2</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">5.6</span><span class="s2">]})</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_nan&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">3</span>

    <span class="s5"># with read_table</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_nan&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>

    <span class="s5"># with read_sql</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_nan&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_nan_fullcolumn</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># full NaN column (numeric float column)</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;B&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]})</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_nan&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">3</span>

    <span class="s5"># with read_table</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_nan&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>

    <span class="s5"># with read_sql -&gt; not type info from table -&gt; stays None</span>
    <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;B&quot;</span><span class="s2">] = </span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;B&quot;</span><span class="s2">].</span><span class="s1">astype</span><span class="s2">(</span><span class="s3">&quot;object&quot;</span><span class="s2">)</span>
    <span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;B&quot;</span><span class="s2">] = </span><span class="s0">None</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_nan&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_nan_string</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># NaNs in string column</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;A&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;B&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">]})</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_nan&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">3</span>

    <span class="s5"># NaNs are coming back as None</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">loc</span><span class="s2">[</span><span class="s4">2</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">] = </span><span class="s0">None</span>

    <span class="s5"># with read_table</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_nan&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>

    <span class="s5"># with read_sql</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_nan&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">df</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_to_sql_save_index</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;ADBC implementation does not create index&quot;</span><span class="s2">, </span><span class="s1">strict</span><span class="s2">=</span><span class="s0">True</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">.</span><span class="s1">from_records</span><span class="s2">(</span>
        <span class="s2">[(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2.1</span><span class="s2">, </span><span class="s3">&quot;line1&quot;</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s3">&quot;line2&quot;</span><span class="s2">)], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">, </span><span class="s3">&quot;C&quot;</span><span class="s2">], </span><span class="s1">index</span><span class="s2">=[</span><span class="s3">&quot;A&quot;</span><span class="s2">]</span>
    <span class="s2">)</span>

    <span class="s1">tbl_name </span><span class="s2">= </span><span class="s3">&quot;test_to_sql_saves_index&quot;</span>
    <span class="s0">with </span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">():</span>
            <span class="s0">assert </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">tbl_name</span><span class="s2">) == </span><span class="s4">2</span>

    <span class="s0">if </span><span class="s1">conn_name </span><span class="s0">in </span><span class="s2">{</span><span class="s3">&quot;sqlite_buildin&quot;</span><span class="s2">, </span><span class="s3">&quot;sqlite_str&quot;</span><span class="s2">}:</span>
        <span class="s1">ixs </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span>
            <span class="s3">&quot;SELECT * FROM sqlite_master WHERE type = 'index' &quot;</span>
            <span class="s3">f&quot;AND tbl_name = '</span><span class="s0">{</span><span class="s1">tbl_name</span><span class="s0">}</span><span class="s3">'&quot;</span><span class="s2">,</span>
            <span class="s1">conn</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">ix_cols </span><span class="s2">= []</span>
        <span class="s0">for </span><span class="s1">ix_name </span><span class="s0">in </span><span class="s1">ixs</span><span class="s2">.</span><span class="s1">name</span><span class="s2">:</span>
            <span class="s1">ix_info </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">f&quot;PRAGMA index_info(</span><span class="s0">{</span><span class="s1">ix_name</span><span class="s0">}</span><span class="s3">)&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
            <span class="s1">ix_cols</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">ix_info</span><span class="s2">.</span><span class="s1">name</span><span class="s2">.</span><span class="s1">tolist</span><span class="s2">())</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">inspect</span>

        <span class="s1">insp </span><span class="s2">= </span><span class="s1">inspect</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

        <span class="s1">ixs </span><span class="s2">= </span><span class="s1">insp</span><span class="s2">.</span><span class="s1">get_indexes</span><span class="s2">(</span><span class="s1">tbl_name</span><span class="s2">)</span>
        <span class="s1">ix_cols </span><span class="s2">= [</span><span class="s1">i</span><span class="s2">[</span><span class="s3">&quot;column_names&quot;</span><span class="s2">] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">ixs</span><span class="s2">]</span>

    <span class="s0">assert </span><span class="s1">ix_cols </span><span class="s2">== [[</span><span class="s3">&quot;A&quot;</span><span class="s2">]]</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_transactions</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">stmt </span><span class="s2">= </span><span class="s3">&quot;CREATE TABLE test_trans (A INT, B TEXT)&quot;</span>
    <span class="s0">if </span><span class="s1">conn_name </span><span class="s2">!= </span><span class="s3">&quot;sqlite_buildin&quot; </span><span class="s0">and </span><span class="s3">&quot;adbc&quot; </span><span class="s0">not in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">text</span>

        <span class="s1">stmt </span><span class="s2">= </span><span class="s1">text</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">() </span><span class="s0">as </span><span class="s1">trans</span><span class="s2">:</span>
            <span class="s1">trans</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_transaction_rollback</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">() </span><span class="s0">as </span><span class="s1">trans</span><span class="s2">:</span>
            <span class="s1">stmt </span><span class="s2">= </span><span class="s3">&quot;CREATE TABLE test_trans (A INT, B TEXT)&quot;</span>
            <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn_name </span><span class="s0">or </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">pandasSQL</span><span class="s2">, </span><span class="s1">SQLiteDatabase</span><span class="s2">):</span>
                <span class="s1">trans</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">text</span>

                <span class="s1">stmt </span><span class="s2">= </span><span class="s1">text</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>
                <span class="s1">trans</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">stmt</span><span class="s2">)</span>

        <span class="s0">class </span><span class="s1">DummyException</span><span class="s2">(</span><span class="s1">Exception</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s5"># Make sure when transaction is rolled back, no rows get inserted</span>
        <span class="s1">ins_sql </span><span class="s2">= </span><span class="s3">&quot;INSERT INTO test_trans (A,B) VALUES (1, 'blah')&quot;</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">pandasSQL</span><span class="s2">, </span><span class="s1">SQLDatabase</span><span class="s2">):</span>
            <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">text</span>

            <span class="s1">ins_sql </span><span class="s2">= </span><span class="s1">text</span><span class="s2">(</span><span class="s1">ins_sql</span><span class="s2">)</span>
        <span class="s0">try</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">() </span><span class="s0">as </span><span class="s1">trans</span><span class="s2">:</span>
                <span class="s1">trans</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">ins_sql</span><span class="s2">)</span>
                <span class="s0">raise </span><span class="s1">DummyException</span><span class="s2">(</span><span class="s3">&quot;error&quot;</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">DummyException</span><span class="s2">:</span>
            <span class="s5"># ignore raised exception</span>
            <span class="s0">pass</span>
        <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">():</span>
            <span class="s1">res </span><span class="s2">= </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">read_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_trans&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">res</span><span class="s2">) == </span><span class="s4">0</span>

        <span class="s5"># Make sure when transaction is committed, rows do get inserted</span>
        <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">() </span><span class="s0">as </span><span class="s1">trans</span><span class="s2">:</span>
            <span class="s1">trans</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">ins_sql</span><span class="s2">)</span>
            <span class="s1">res2 </span><span class="s2">= </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">read_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_trans&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">res2</span><span class="s2">) == </span><span class="s4">1</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_get_schema_create_table</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame3</span><span class="s2">):</span>
    <span class="s5"># Use a dataframe without a bool column, since MySQL converts bool to</span>
    <span class="s5"># TINYINT (which read_sql_table returns as an int and causes a dtype</span>
    <span class="s5"># mismatch)</span>
    <span class="s0">if </span><span class="s1">conn </span><span class="s2">== </span><span class="s3">&quot;sqlite_str&quot;</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;test does not support sqlite_str fixture&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s1">text</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">engine </span><span class="s0">import </span><span class="s1">Engine</span>

    <span class="s1">tbl </span><span class="s2">= </span><span class="s3">&quot;test_get_schema_create_table&quot;</span>
    <span class="s1">create_sql </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">get_schema</span><span class="s2">(</span><span class="s1">test_frame3</span><span class="s2">, </span><span class="s1">tbl</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">blank_test_df </span><span class="s2">= </span><span class="s1">test_frame3</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[:</span><span class="s4">0</span><span class="s2">]</span>

    <span class="s1">create_sql </span><span class="s2">= </span><span class="s1">text</span><span class="s2">(</span><span class="s1">create_sql</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">Engine</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">newcon</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">newcon</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
                <span class="s1">newcon</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">create_sql</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">create_sql</span><span class="s2">)</span>
    <span class="s1">returned_df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s1">tbl</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">returned_df</span><span class="s2">, </span><span class="s1">blank_test_df</span><span class="s2">, </span><span class="s1">check_index_type</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_dtype</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">conn </span><span class="s2">== </span><span class="s3">&quot;sqlite_str&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">&quot;sqlite_str has no inspection system&quot;</span><span class="s2">)</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s2">(</span>
        <span class="s1">TEXT</span><span class="s2">,</span>
        <span class="s1">String</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">schema </span><span class="s0">import </span><span class="s1">MetaData</span>

    <span class="s1">cols </span><span class="s2">= [</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">]</span>
    <span class="s1">data </span><span class="s2">= [(</span><span class="s4">0.8</span><span class="s2">, </span><span class="s0">True</span><span class="s2">), (</span><span class="s4">0.9</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)]</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">cols</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;dtype_test&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">) == </span><span class="s4">2</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;dtype_test2&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">={</span><span class="s3">&quot;B&quot;</span><span class="s2">: </span><span class="s1">TEXT</span><span class="s2">}) == </span><span class="s4">2</span>
    <span class="s1">meta </span><span class="s2">= </span><span class="s1">MetaData</span><span class="s2">()</span>
    <span class="s1">meta</span><span class="s2">.</span><span class="s1">reflect</span><span class="s2">(</span><span class="s1">bind</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">sqltype </span><span class="s2">= </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">tables</span><span class="s2">[</span><span class="s3">&quot;dtype_test2&quot;</span><span class="s2">].</span><span class="s1">columns</span><span class="s2">[</span><span class="s3">&quot;B&quot;</span><span class="s2">].</span><span class="s1">type</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">sqltype</span><span class="s2">, </span><span class="s1">TEXT</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;The type of B is not a SQLAlchemy type&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;error&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">={</span><span class="s3">&quot;B&quot;</span><span class="s2">: </span><span class="s1">str</span><span class="s2">})</span>

    <span class="s5"># GH9083</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;dtype_test3&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">={</span><span class="s3">&quot;B&quot;</span><span class="s2">: </span><span class="s1">String</span><span class="s2">(</span><span class="s4">10</span><span class="s2">)}) == </span><span class="s4">2</span>
    <span class="s1">meta</span><span class="s2">.</span><span class="s1">reflect</span><span class="s2">(</span><span class="s1">bind</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">sqltype </span><span class="s2">= </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">tables</span><span class="s2">[</span><span class="s3">&quot;dtype_test3&quot;</span><span class="s2">].</span><span class="s1">columns</span><span class="s2">[</span><span class="s3">&quot;B&quot;</span><span class="s2">].</span><span class="s1">type</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">sqltype</span><span class="s2">, </span><span class="s1">String</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">sqltype</span><span class="s2">.</span><span class="s1">length </span><span class="s2">== </span><span class="s4">10</span>

    <span class="s5"># single dtype</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;single_dtype_test&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">TEXT</span><span class="s2">) == </span><span class="s4">2</span>
    <span class="s1">meta</span><span class="s2">.</span><span class="s1">reflect</span><span class="s2">(</span><span class="s1">bind</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">sqltypea </span><span class="s2">= </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">tables</span><span class="s2">[</span><span class="s3">&quot;single_dtype_test&quot;</span><span class="s2">].</span><span class="s1">columns</span><span class="s2">[</span><span class="s3">&quot;A&quot;</span><span class="s2">].</span><span class="s1">type</span>
    <span class="s1">sqltypeb </span><span class="s2">= </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">tables</span><span class="s2">[</span><span class="s3">&quot;single_dtype_test&quot;</span><span class="s2">].</span><span class="s1">columns</span><span class="s2">[</span><span class="s3">&quot;B&quot;</span><span class="s2">].</span><span class="s1">type</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">sqltypea</span><span class="s2">, </span><span class="s1">TEXT</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">sqltypeb</span><span class="s2">, </span><span class="s1">TEXT</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_notna_dtype</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">conn </span><span class="s2">== </span><span class="s3">&quot;sqlite_str&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">&quot;sqlite_str has no inspection system&quot;</span><span class="s2">)</span>

    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s2">(</span>
        <span class="s1">Boolean</span><span class="s2">,</span>
        <span class="s1">DateTime</span><span class="s2">,</span>
        <span class="s1">Float</span><span class="s2">,</span>
        <span class="s1">Integer</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">schema </span><span class="s0">import </span><span class="s1">MetaData</span>

    <span class="s1">cols </span><span class="s2">= {</span>
        <span class="s3">&quot;Bool&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]),</span>
        <span class="s3">&quot;Date&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2012</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s0">None</span><span class="s2">]),</span>
        <span class="s3">&quot;Int&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;object&quot;</span><span class="s2">),</span>
        <span class="s3">&quot;Float&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1.1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]),</span>
    <span class="s2">}</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">)</span>

    <span class="s1">tbl </span><span class="s2">= </span><span class="s3">&quot;notna_dtype_test&quot;</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">tbl</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">) == </span><span class="s4">2</span>
    <span class="s1">_ </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s1">tbl</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">meta </span><span class="s2">= </span><span class="s1">MetaData</span><span class="s2">()</span>
    <span class="s1">meta</span><span class="s2">.</span><span class="s1">reflect</span><span class="s2">(</span><span class="s1">bind</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">my_type </span><span class="s2">= </span><span class="s1">Integer </span><span class="s0">if </span><span class="s3">&quot;mysql&quot; </span><span class="s0">in </span><span class="s1">conn_name </span><span class="s0">else </span><span class="s1">Boolean</span>
    <span class="s1">col_dict </span><span class="s2">= </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">tables</span><span class="s2">[</span><span class="s1">tbl</span><span class="s2">].</span><span class="s1">columns</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">col_dict</span><span class="s2">[</span><span class="s3">&quot;Bool&quot;</span><span class="s2">].</span><span class="s1">type</span><span class="s2">, </span><span class="s1">my_type</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">col_dict</span><span class="s2">[</span><span class="s3">&quot;Date&quot;</span><span class="s2">].</span><span class="s1">type</span><span class="s2">, </span><span class="s1">DateTime</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">col_dict</span><span class="s2">[</span><span class="s3">&quot;Int&quot;</span><span class="s2">].</span><span class="s1">type</span><span class="s2">, </span><span class="s1">Integer</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">col_dict</span><span class="s2">[</span><span class="s3">&quot;Float&quot;</span><span class="s2">].</span><span class="s1">type</span><span class="s2">, </span><span class="s1">Float</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_double_precision</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">conn </span><span class="s2">== </span><span class="s3">&quot;sqlite_str&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">&quot;sqlite_str has no inspection system&quot;</span><span class="s2">)</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s2">(</span>
        <span class="s1">BigInteger</span><span class="s2">,</span>
        <span class="s1">Float</span><span class="s2">,</span>
        <span class="s1">Integer</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">schema </span><span class="s0">import </span><span class="s1">MetaData</span>

    <span class="s1">V </span><span class="s2">= </span><span class="s4">1.23456789101112131415</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;f32&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s1">V</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;float32&quot;</span><span class="s2">),</span>
            <span class="s3">&quot;f64&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s1">V</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;float64&quot;</span><span class="s2">),</span>
            <span class="s3">&quot;f64_as_f32&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s1">V</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;float64&quot;</span><span class="s2">),</span>
            <span class="s3">&quot;i32&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;int32&quot;</span><span class="s2">),</span>
            <span class="s3">&quot;i64&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;int64&quot;</span><span class="s2">),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>

    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_dtypes&quot;</span><span class="s2">,</span>
            <span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">,</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">,</span>
            <span class="s1">dtype</span><span class="s2">={</span><span class="s3">&quot;f64_as_f32&quot;</span><span class="s2">: </span><span class="s1">Float</span><span class="s2">(</span><span class="s1">precision</span><span class="s2">=</span><span class="s4">23</span><span class="s2">)},</span>
        <span class="s2">)</span>
        <span class="s2">== </span><span class="s4">1</span>
    <span class="s2">)</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_dtypes&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s5"># check precision of float64</span>
    <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">round</span><span class="s2">(</span><span class="s1">df</span><span class="s2">[</span><span class="s3">&quot;f64&quot;</span><span class="s2">].</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s4">14</span><span class="s2">) == </span><span class="s1">np</span><span class="s2">.</span><span class="s1">round</span><span class="s2">(</span><span class="s1">res</span><span class="s2">[</span><span class="s3">&quot;f64&quot;</span><span class="s2">].</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s4">14</span><span class="s2">)</span>

    <span class="s5"># check sql types</span>
    <span class="s1">meta </span><span class="s2">= </span><span class="s1">MetaData</span><span class="s2">()</span>
    <span class="s1">meta</span><span class="s2">.</span><span class="s1">reflect</span><span class="s2">(</span><span class="s1">bind</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">col_dict </span><span class="s2">= </span><span class="s1">meta</span><span class="s2">.</span><span class="s1">tables</span><span class="s2">[</span><span class="s3">&quot;test_dtypes&quot;</span><span class="s2">].</span><span class="s1">columns</span>
    <span class="s0">assert </span><span class="s1">str</span><span class="s2">(</span><span class="s1">col_dict</span><span class="s2">[</span><span class="s3">&quot;f32&quot;</span><span class="s2">].</span><span class="s1">type</span><span class="s2">) == </span><span class="s1">str</span><span class="s2">(</span><span class="s1">col_dict</span><span class="s2">[</span><span class="s3">&quot;f64_as_f32&quot;</span><span class="s2">].</span><span class="s1">type</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">col_dict</span><span class="s2">[</span><span class="s3">&quot;f32&quot;</span><span class="s2">].</span><span class="s1">type</span><span class="s2">, </span><span class="s1">Float</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">col_dict</span><span class="s2">[</span><span class="s3">&quot;f64&quot;</span><span class="s2">].</span><span class="s1">type</span><span class="s2">, </span><span class="s1">Float</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">col_dict</span><span class="s2">[</span><span class="s3">&quot;i32&quot;</span><span class="s2">].</span><span class="s1">type</span><span class="s2">, </span><span class="s1">Integer</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">col_dict</span><span class="s2">[</span><span class="s3">&quot;i64&quot;</span><span class="s2">].</span><span class="s1">type</span><span class="s2">, </span><span class="s1">BigInteger</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_connectable_issue_example</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s5"># This tests the example raised in issue</span>
    <span class="s5"># https://github.com/pandas-dev/pandas/issues/10104</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">engine </span><span class="s0">import </span><span class="s1">Engine</span>

    <span class="s0">def </span><span class="s1">test_select</span><span class="s2">(</span><span class="s1">connection</span><span class="s2">):</span>
        <span class="s1">query </span><span class="s2">= </span><span class="s3">&quot;SELECT test_foo_data FROM test_foo_data&quot;</span>
        <span class="s0">return </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">connection</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_append</span><span class="s2">(</span><span class="s1">connection</span><span class="s2">, </span><span class="s1">data</span><span class="s2">):</span>
        <span class="s1">data</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_foo_data&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">connection</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;append&quot;</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_connectable</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">):</span>
        <span class="s5"># https://github.com/sqlalchemy/sqlalchemy/commit/</span>
        <span class="s5"># 00b5c10846e800304caa86549ab9da373b42fa5d#r48323973</span>
        <span class="s1">foo_data </span><span class="s2">= </span><span class="s1">test_select</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s1">test_append</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">foo_data</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">main</span><span class="s2">(</span><span class="s1">connectable</span><span class="s2">):</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">connectable</span><span class="s2">, </span><span class="s1">Engine</span><span class="s2">):</span>
            <span class="s0">with </span><span class="s1">connectable</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
                <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
                    <span class="s1">test_connectable</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">test_connectable</span><span class="s2">(</span><span class="s1">connectable</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;test_foo_data&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]}).</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_foo_data&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s2">== </span><span class="s4">3</span>
    <span class="s2">)</span>
    <span class="s1">main</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
    <span class="s3">&quot;input&quot;</span><span class="s2">,</span>
    <span class="s2">[{</span><span class="s3">&quot;foo&quot;</span><span class="s2">: [</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]}, {</span><span class="s3">&quot;foo&quot;</span><span class="s2">: [-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]}, {</span><span class="s3">&quot;foo&quot;</span><span class="s2">: [-</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">], </span><span class="s3">&quot;infe0&quot;</span><span class="s2">: [</span><span class="s3">&quot;bar&quot;</span><span class="s2">]}],</span>
<span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_to_sql_with_negative_npinf</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">input</span><span class="s2">):</span>
    <span class="s5"># GH 34431</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">input</span><span class="s2">)</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s3">&quot;mysql&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s5"># GH 36465</span>
        <span class="s5"># The input {&quot;foo&quot;: [-np.inf], &quot;infe0&quot;: [&quot;bar&quot;]} does not raise any error</span>
        <span class="s5"># for pymysql version &gt;= 0.10</span>
        <span class="s5"># TODO(GH#36465): remove this version check after GH 36465 is fixed</span>
        <span class="s1">pymysql </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;pymysql&quot;</span><span class="s2">)</span>

        <span class="s0">if </span><span class="s1">Version</span><span class="s2">(</span><span class="s1">pymysql</span><span class="s2">.</span><span class="s1">__version__</span><span class="s2">) &lt; </span><span class="s1">Version</span><span class="s2">(</span><span class="s3">&quot;1.0.3&quot;</span><span class="s2">) </span><span class="s0">and </span><span class="s3">&quot;infe0&quot; </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">:</span>
            <span class="s1">mark </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;GH 36465&quot;</span><span class="s2">)</span>
            <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span><span class="s1">mark</span><span class="s2">)</span>

        <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;inf cannot be used with MySQL&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;foobar&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;foobar&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">1</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;foobar&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">res</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_temporary_table</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">conn </span><span class="s2">== </span><span class="s3">&quot;sqlite_str&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s3">&quot;test does not work with str connection&quot;</span><span class="s2">)</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s2">(</span>
        <span class="s1">Column</span><span class="s2">,</span>
        <span class="s1">Integer</span><span class="s2">,</span>
        <span class="s1">Unicode</span><span class="s2">,</span>
        <span class="s1">select</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">orm </span><span class="s0">import </span><span class="s2">(</span>
        <span class="s1">Session</span><span class="s2">,</span>
        <span class="s1">declarative_base</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">test_data </span><span class="s2">= </span><span class="s3">&quot;Hello, World!&quot;</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;spam&quot;</span><span class="s2">: [</span><span class="s1">test_data</span><span class="s2">]})</span>
    <span class="s1">Base </span><span class="s2">= </span><span class="s1">declarative_base</span><span class="s2">()</span>

    <span class="s0">class </span><span class="s1">Temporary</span><span class="s2">(</span><span class="s1">Base</span><span class="s2">):</span>
        <span class="s1">__tablename__ </span><span class="s2">= </span><span class="s3">&quot;temp_test&quot;</span>
        <span class="s1">__table_args__ </span><span class="s2">= {</span><span class="s3">&quot;prefixes&quot;</span><span class="s2">: [</span><span class="s3">&quot;TEMPORARY&quot;</span><span class="s2">]}</span>
        <span class="s1">id </span><span class="s2">= </span><span class="s1">Column</span><span class="s2">(</span><span class="s1">Integer</span><span class="s2">, </span><span class="s1">primary_key</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">spam </span><span class="s2">= </span><span class="s1">Column</span><span class="s2">(</span><span class="s1">Unicode</span><span class="s2">(</span><span class="s4">30</span><span class="s2">), </span><span class="s1">nullable</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">Session</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">session</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">session</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
            <span class="s1">conn </span><span class="s2">= </span><span class="s1">session</span><span class="s2">.</span><span class="s1">connection</span><span class="s2">()</span>
            <span class="s1">Temporary</span><span class="s2">.</span><span class="s1">__table__</span><span class="s2">.</span><span class="s1">create</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
            <span class="s1">session</span><span class="s2">.</span><span class="s1">add</span><span class="s2">(</span><span class="s1">Temporary</span><span class="s2">(</span><span class="s1">spam</span><span class="s2">=</span><span class="s1">test_data</span><span class="s2">))</span>
            <span class="s1">session</span><span class="s2">.</span><span class="s1">flush</span><span class="s2">()</span>
            <span class="s1">df </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s1">sql</span><span class="s2">=</span><span class="s1">select</span><span class="s2">(</span><span class="s1">Temporary</span><span class="s2">.</span><span class="s1">spam</span><span class="s2">), </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_invalid_engine</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">conn </span><span class="s2">== </span><span class="s3">&quot;sqlite_buildin&quot; </span><span class="s0">or </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;SQLiteDatabase/ADBCDatabase does not raise for bad engine&quot;</span>
            <span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;engine must be one of 'auto', 'sqlalchemy'&quot;</span>
    <span class="s0">with </span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame1&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s3">&quot;bad_engine&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_to_sql_with_sql_engine</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;`to_sql` with the `engine` param&quot;&quot;&quot;</span>
    <span class="s5"># mostly copied from this class's `_to_sql()` method</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">():</span>
            <span class="s0">assert </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame1&quot;</span><span class="s2">, </span><span class="s1">engine</span><span class="s2">=</span><span class="s3">&quot;auto&quot;</span><span class="s2">) == </span><span class="s4">4</span>
            <span class="s0">assert </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame1&quot;</span><span class="s2">)</span>

    <span class="s1">num_entries </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">)</span>
    <span class="s1">num_rows </span><span class="s2">= </span><span class="s1">count_rows</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s3">&quot;test_frame1&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">num_rows </span><span class="s2">== </span><span class="s1">num_entries</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">sqlalchemy_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_options_sqlalchemy</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s5"># use the set option</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;io.sql.engine&quot;</span><span class="s2">, </span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">():</span>
                <span class="s0">assert </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame1&quot;</span><span class="s2">) == </span><span class="s4">4</span>
                <span class="s0">assert </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame1&quot;</span><span class="s2">)</span>

        <span class="s1">num_entries </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">)</span>
        <span class="s1">num_rows </span><span class="s2">= </span><span class="s1">count_rows</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s3">&quot;test_frame1&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">num_rows </span><span class="s2">== </span><span class="s1">num_entries</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_options_auto</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">test_frame1</span><span class="s2">):</span>
    <span class="s5"># use the set option</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;io.sql.engine&quot;</span><span class="s2">, </span><span class="s3">&quot;auto&quot;</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">():</span>
                <span class="s0">assert </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">, </span><span class="s3">&quot;test_frame1&quot;</span><span class="s2">) == </span><span class="s4">4</span>
                <span class="s0">assert </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;test_frame1&quot;</span><span class="s2">)</span>

        <span class="s1">num_entries </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">test_frame1</span><span class="s2">)</span>
        <span class="s1">num_rows </span><span class="s2">= </span><span class="s1">count_rows</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s3">&quot;test_frame1&quot;</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">num_rows </span><span class="s2">== </span><span class="s1">num_entries</span>


<span class="s0">def </span><span class="s1">test_options_get_engine</span><span class="s2">():</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">get_engine</span><span class="s2">(</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">), </span><span class="s1">SQLAlchemyEngine</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;io.sql.engine&quot;</span><span class="s2">, </span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">get_engine</span><span class="s2">(</span><span class="s3">&quot;auto&quot;</span><span class="s2">), </span><span class="s1">SQLAlchemyEngine</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">get_engine</span><span class="s2">(</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">), </span><span class="s1">SQLAlchemyEngine</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;io.sql.engine&quot;</span><span class="s2">, </span><span class="s3">&quot;auto&quot;</span><span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">get_engine</span><span class="s2">(</span><span class="s3">&quot;auto&quot;</span><span class="s2">), </span><span class="s1">SQLAlchemyEngine</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">get_engine</span><span class="s2">(</span><span class="s3">&quot;sqlalchemy&quot;</span><span class="s2">), </span><span class="s1">SQLAlchemyEngine</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_get_engine_auto_error_message</span><span class="s2">():</span>
    <span class="s5"># Expect different error messages from get_engine(engine=&quot;auto&quot;)</span>
    <span class="s5"># if engines aren't installed vs. are installed but bad version</span>
    <span class="s0">pass</span>
    <span class="s5"># TODO(GH#36893) fill this in when we add more engines</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;func&quot;</span><span class="s2">, [</span><span class="s3">&quot;read_sql&quot;</span><span class="s2">, </span><span class="s3">&quot;read_sql_query&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_read_sql_dtype_backend</span><span class="s2">(</span>
    <span class="s1">conn</span><span class="s2">,</span>
    <span class="s1">request</span><span class="s2">,</span>
    <span class="s1">string_storage</span><span class="s2">,</span>
    <span class="s1">func</span><span class="s2">,</span>
    <span class="s1">dtype_backend</span><span class="s2">,</span>
    <span class="s1">dtype_backend_data</span><span class="s2">,</span>
    <span class="s1">dtype_backend_expected</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s5"># GH#50048</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">table </span><span class="s2">= </span><span class="s3">&quot;test&quot;</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">dtype_backend_data</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">table</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;mode.string_storage&quot;</span><span class="s2">, </span><span class="s1">string_storage</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">, </span><span class="s1">func</span><span class="s2">)(</span>
            <span class="s3">f&quot;Select * from </span><span class="s0">{</span><span class="s1">table</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">dtype_backend</span><span class="s2">=</span><span class="s1">dtype_backend</span>
        <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">dtype_backend_expected</span><span class="s2">(</span><span class="s1">string_storage</span><span class="s2">, </span><span class="s1">dtype_backend</span><span class="s2">, </span><span class="s1">conn_name</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s5"># adbc does not support chunksize argument</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;adbc does not support chunksize argument&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;mode.string_storage&quot;</span><span class="s2">, </span><span class="s1">string_storage</span><span class="s2">):</span>
        <span class="s1">iterator </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">, </span><span class="s1">func</span><span class="s2">)(</span>
            <span class="s3">f&quot;Select * from </span><span class="s0">{</span><span class="s1">table</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">,</span>
            <span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">,</span>
            <span class="s1">dtype_backend</span><span class="s2">=</span><span class="s1">dtype_backend</span><span class="s2">,</span>
            <span class="s1">chunksize</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">dtype_backend_expected</span><span class="s2">(</span><span class="s1">string_storage</span><span class="s2">, </span><span class="s1">dtype_backend</span><span class="s2">, </span><span class="s1">conn_name</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">result </span><span class="s0">in </span><span class="s1">iterator</span><span class="s2">:</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;func&quot;</span><span class="s2">, [</span><span class="s3">&quot;read_sql&quot;</span><span class="s2">, </span><span class="s3">&quot;read_sql_table&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_read_sql_dtype_backend_table</span><span class="s2">(</span>
    <span class="s1">conn</span><span class="s2">,</span>
    <span class="s1">request</span><span class="s2">,</span>
    <span class="s1">string_storage</span><span class="s2">,</span>
    <span class="s1">func</span><span class="s2">,</span>
    <span class="s1">dtype_backend</span><span class="s2">,</span>
    <span class="s1">dtype_backend_data</span><span class="s2">,</span>
    <span class="s1">dtype_backend_expected</span><span class="s2">,</span>
<span class="s2">):</span>
    <span class="s0">if </span><span class="s3">&quot;sqlite&quot; </span><span class="s0">in </span><span class="s1">conn </span><span class="s0">and </span><span class="s3">&quot;adbc&quot; </span><span class="s0">not in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">applymarker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span>
                <span class="s1">reason</span><span class="s2">=(</span>
                    <span class="s3">&quot;SQLite actually returns proper boolean values via &quot;</span>
                    <span class="s3">&quot;read_sql_table, but before pytest refactor was skipped&quot;</span>
                <span class="s2">)</span>
            <span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s5"># GH#50048</span>
    <span class="s1">conn_name </span><span class="s2">= </span><span class="s1">conn</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">table </span><span class="s2">= </span><span class="s3">&quot;test&quot;</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">dtype_backend_data</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">table</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;mode.string_storage&quot;</span><span class="s2">, </span><span class="s1">string_storage</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">, </span><span class="s1">func</span><span class="s2">)(</span><span class="s1">table</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">dtype_backend</span><span class="s2">=</span><span class="s1">dtype_backend</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">dtype_backend_expected</span><span class="s2">(</span><span class="s1">string_storage</span><span class="s2">, </span><span class="s1">dtype_backend</span><span class="s2">, </span><span class="s1">conn_name</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
        <span class="s5"># adbc does not support chunksize argument</span>
        <span class="s0">return</span>

    <span class="s0">with </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;mode.string_storage&quot;</span><span class="s2">, </span><span class="s1">string_storage</span><span class="s2">):</span>
        <span class="s1">iterator </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">, </span><span class="s1">func</span><span class="s2">)(</span>
            <span class="s1">table</span><span class="s2">,</span>
            <span class="s1">conn</span><span class="s2">,</span>
            <span class="s1">dtype_backend</span><span class="s2">=</span><span class="s1">dtype_backend</span><span class="s2">,</span>
            <span class="s1">chunksize</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s1">expected </span><span class="s2">= </span><span class="s1">dtype_backend_expected</span><span class="s2">(</span><span class="s1">string_storage</span><span class="s2">, </span><span class="s1">dtype_backend</span><span class="s2">, </span><span class="s1">conn_name</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">result </span><span class="s0">in </span><span class="s1">iterator</span><span class="s2">:</span>
            <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;func&quot;</span><span class="s2">, [</span><span class="s3">&quot;read_sql&quot;</span><span class="s2">, </span><span class="s3">&quot;read_sql_table&quot;</span><span class="s2">, </span><span class="s3">&quot;read_sql_query&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_read_sql_invalid_dtype_backend_table</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">dtype_backend_data</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">table </span><span class="s2">= </span><span class="s3">&quot;test&quot;</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">dtype_backend_data</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">table</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s3">&quot;dtype_backend numpy is invalid, only 'numpy_nullable' and &quot;</span>
        <span class="s3">&quot;'pyarrow' are allowed.&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">getattr</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">, </span><span class="s1">func</span><span class="s2">)(</span><span class="s1">table</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">dtype_backend</span><span class="s2">=</span><span class="s3">&quot;numpy&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">dtype_backend_data</span><span class="s2">() </span><span class="s1">-&gt; DataFrame</span><span class="s2">:</span>
    <span class="s0">return </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;Int64&quot;</span><span class="s2">),</span>
            <span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;Int64&quot;</span><span class="s2">),</span>
            <span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;Float64&quot;</span><span class="s2">),</span>
            <span class="s3">&quot;d&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;Float64&quot;</span><span class="s2">),</span>
            <span class="s3">&quot;e&quot;</span><span class="s2">: [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
            <span class="s3">&quot;f&quot;</span><span class="s2">: [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">],</span>
            <span class="s3">&quot;g&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">],</span>
            <span class="s3">&quot;h&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
        <span class="s2">}</span>
    <span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">dtype_backend_expected</span><span class="s2">():</span>
    <span class="s0">def </span><span class="s1">func</span><span class="s2">(</span><span class="s1">storage</span><span class="s2">, </span><span class="s1">dtype_backend</span><span class="s2">, </span><span class="s1">conn_name</span><span class="s2">) </span><span class="s1">-&gt; DataFrame</span><span class="s2">:</span>
        <span class="s1">string_array</span><span class="s2">: </span><span class="s1">StringArray </span><span class="s2">| </span><span class="s1">ArrowStringArray</span>
        <span class="s1">string_array_na</span><span class="s2">: </span><span class="s1">StringArray </span><span class="s2">| </span><span class="s1">ArrowStringArray</span>
        <span class="s0">if </span><span class="s1">storage </span><span class="s2">== </span><span class="s3">&quot;python&quot;</span><span class="s2">:</span>
            <span class="s1">string_array </span><span class="s2">= </span><span class="s1">StringArray</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">))</span>
            <span class="s1">string_array_na </span><span class="s2">= </span><span class="s1">StringArray</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NA</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">object_</span><span class="s2">))</span>

        <span class="s0">elif </span><span class="s1">dtype_backend </span><span class="s2">== </span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">:</span>
            <span class="s1">pa </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">)</span>
            <span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">arrays </span><span class="s0">import </span><span class="s1">ArrowExtensionArray</span>

            <span class="s1">string_array </span><span class="s2">= </span><span class="s1">ArrowExtensionArray</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]))  </span><span class="s5"># type: ignore[assignment]</span>
            <span class="s1">string_array_na </span><span class="s2">= </span><span class="s1">ArrowExtensionArray</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]))  </span><span class="s5"># type: ignore[assignment]</span>

        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">pa </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">)</span>
            <span class="s1">string_array </span><span class="s2">= </span><span class="s1">ArrowStringArray</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s3">&quot;c&quot;</span><span class="s2">]))</span>
            <span class="s1">string_array_na </span><span class="s2">= </span><span class="s1">ArrowStringArray</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]))</span>

        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
            <span class="s2">{</span>
                <span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;Int64&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;Int64&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;c&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1.5</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;Float64&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;d&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;Float64&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;e&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">NA</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;boolean&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;f&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;boolean&quot;</span><span class="s2">),</span>
                <span class="s3">&quot;g&quot;</span><span class="s2">: </span><span class="s1">string_array</span><span class="s2">,</span>
                <span class="s3">&quot;h&quot;</span><span class="s2">: </span><span class="s1">string_array_na</span><span class="s2">,</span>
            <span class="s2">}</span>
        <span class="s2">)</span>
        <span class="s0">if </span><span class="s1">dtype_backend </span><span class="s2">== </span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">:</span>
            <span class="s1">pa </span><span class="s2">= </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">)</span>

            <span class="s0">from </span><span class="s1">pandas</span><span class="s2">.</span><span class="s1">arrays </span><span class="s0">import </span><span class="s1">ArrowExtensionArray</span>

            <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
                <span class="s2">{</span>
                    <span class="s1">col</span><span class="s2">: </span><span class="s1">ArrowExtensionArray</span><span class="s2">(</span><span class="s1">pa</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span><span class="s1">df</span><span class="s2">[</span><span class="s1">col</span><span class="s2">], </span><span class="s1">from_pandas</span><span class="s2">=</span><span class="s0">True</span><span class="s2">))</span>
                    <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span>
                <span class="s2">}</span>
            <span class="s2">)</span>

        <span class="s0">if </span><span class="s3">&quot;mysql&quot; </span><span class="s0">in </span><span class="s1">conn_name </span><span class="s0">or </span><span class="s3">&quot;sqlite&quot; </span><span class="s0">in </span><span class="s1">conn_name</span><span class="s2">:</span>
            <span class="s0">if </span><span class="s1">dtype_backend </span><span class="s2">== </span><span class="s3">&quot;numpy_nullable&quot;</span><span class="s2">:</span>
                <span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">({</span><span class="s3">&quot;e&quot;</span><span class="s2">: </span><span class="s3">&quot;Int64&quot;</span><span class="s2">, </span><span class="s3">&quot;f&quot;</span><span class="s2">: </span><span class="s3">&quot;Int64&quot;</span><span class="s2">})</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">df </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">({</span><span class="s3">&quot;e&quot;</span><span class="s2">: </span><span class="s3">&quot;int64[pyarrow]&quot;</span><span class="s2">, </span><span class="s3">&quot;f&quot;</span><span class="s2">: </span><span class="s3">&quot;int64[pyarrow]&quot;</span><span class="s2">})</span>

        <span class="s0">return </span><span class="s1">df</span>

    <span class="s0">return </span><span class="s1">func</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_chunksize_empty_dtypes</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">):</span>
    <span class="s5"># GH#50245</span>
    <span class="s0">if </span><span class="s3">&quot;adbc&quot; </span><span class="s0">in </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">request</span><span class="s2">.</span><span class="s1">node</span><span class="s2">.</span><span class="s1">add_marker</span><span class="s2">(</span>
            <span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s3">&quot;chunksize argument NotImplemented with ADBC&quot;</span><span class="s2">)</span>
        <span class="s2">)</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">dtypes </span><span class="s2">= {</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s3">&quot;int64&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s3">&quot;object&quot;</span><span class="s2">}</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">]).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">dtypes</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">result </span><span class="s0">in </span><span class="s1">read_sql_query</span><span class="s2">(</span>
        <span class="s3">&quot;SELECT * FROM test&quot;</span><span class="s2">,</span>
        <span class="s1">conn</span><span class="s2">,</span>
        <span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtypes</span><span class="s2">,</span>
        <span class="s1">chunksize</span><span class="s2">=</span><span class="s4">1</span><span class="s2">,</span>
    <span class="s2">):</span>
        <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;conn&quot;</span><span class="s2">, </span><span class="s1">all_connectable</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;dtype_backend&quot;</span><span class="s2">, [</span><span class="s1">lib</span><span class="s2">.</span><span class="s1">no_default</span><span class="s2">, </span><span class="s3">&quot;numpy_nullable&quot;</span><span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;func&quot;</span><span class="s2">, [</span><span class="s3">&quot;read_sql&quot;</span><span class="s2">, </span><span class="s3">&quot;read_sql_query&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_read_sql_dtype</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">request</span><span class="s2">, </span><span class="s1">func</span><span class="s2">, </span><span class="s1">dtype_backend</span><span class="s2">):</span>
    <span class="s5"># GH#50797</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">request</span><span class="s2">.</span><span class="s1">getfixturevalue</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">table </span><span class="s2">= </span><span class="s3">&quot;test&quot;</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s4">5</span><span class="s2">})</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">table</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">)</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">getattr</span><span class="s2">(</span><span class="s1">pd</span><span class="s2">, </span><span class="s1">func</span><span class="s2">)(</span>
        <span class="s3">f&quot;Select * from </span><span class="s0">{</span><span class="s1">table</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">,</span>
        <span class="s1">conn</span><span class="s2">,</span>
        <span class="s1">dtype</span><span class="s2">={</span><span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">},</span>
        <span class="s1">dtype_backend</span><span class="s2">=</span><span class="s1">dtype_backend</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">),</span>
            <span class="s3">&quot;b&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">(</span>
                <span class="s2">[</span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">],</span>
                <span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;int64&quot; </span><span class="s0">if not </span><span class="s1">dtype_backend </span><span class="s2">== </span><span class="s3">&quot;numpy_nullable&quot; </span><span class="s0">else </span><span class="s3">&quot;Int64&quot;</span><span class="s2">,</span>
            <span class="s2">),</span>
        <span class="s2">}</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_keyword_deprecation</span><span class="s2">(</span><span class="s1">sqlite_engine</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_engine</span>
    <span class="s5"># GH 54397</span>
    <span class="s1">msg </span><span class="s2">= (</span>
        <span class="s3">&quot;Starting with pandas version 3.0 all arguments of to_sql except for the &quot;</span>
        <span class="s3">&quot;arguments 'name' and 'con' will be keyword-only.&quot;</span>
    <span class="s2">)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([{</span><span class="s3">&quot;A&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">, </span><span class="s3">&quot;C&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">}, {</span><span class="s3">&quot;A&quot;</span><span class="s2">: </span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">: </span><span class="s4">2</span><span class="s2">, </span><span class="s3">&quot;C&quot;</span><span class="s2">: </span><span class="s4">3</span><span class="s2">}])</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s3">&quot;example&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s1">FutureWarning</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s3">&quot;example&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_bigint_warning</span><span class="s2">(</span><span class="s1">sqlite_engine</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_engine</span>
    <span class="s5"># test no warning for BIGINT (to support int64) is raised (GH7433)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;int64&quot;</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_bigintwarning&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">2</span>

    <span class="s0">with </span><span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_produces_warning</span><span class="s2">(</span><span class="s0">None</span><span class="s2">):</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_bigintwarning&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_valueerror_exception</span><span class="s2">(</span><span class="s1">sqlite_engine</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_engine</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;col1&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;col2&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]})</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Empty table name specified&quot;</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_row_object_is_named_tuple</span><span class="s2">(</span><span class="s1">sqlite_engine</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_engine</span>
    <span class="s5"># GH 40682</span>
    <span class="s5"># Test for the is_named_tuple() function</span>
    <span class="s5"># Placed here due to its usage of sqlalchemy</span>

    <span class="s0">from </span><span class="s1">sqlalchemy </span><span class="s0">import </span><span class="s2">(</span>
        <span class="s1">Column</span><span class="s2">,</span>
        <span class="s1">Integer</span><span class="s2">,</span>
        <span class="s1">String</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">orm </span><span class="s0">import </span><span class="s2">(</span>
        <span class="s1">declarative_base</span><span class="s2">,</span>
        <span class="s1">sessionmaker</span><span class="s2">,</span>
    <span class="s2">)</span>

    <span class="s1">BaseModel </span><span class="s2">= </span><span class="s1">declarative_base</span><span class="s2">()</span>

    <span class="s0">class </span><span class="s1">Test</span><span class="s2">(</span><span class="s1">BaseModel</span><span class="s2">):</span>
        <span class="s1">__tablename__ </span><span class="s2">= </span><span class="s3">&quot;test_frame&quot;</span>
        <span class="s1">id </span><span class="s2">= </span><span class="s1">Column</span><span class="s2">(</span><span class="s1">Integer</span><span class="s2">, </span><span class="s1">primary_key</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">string_column </span><span class="s2">= </span><span class="s1">Column</span><span class="s2">(</span><span class="s1">String</span><span class="s2">(</span><span class="s4">50</span><span class="s2">))</span>

    <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
        <span class="s1">BaseModel</span><span class="s2">.</span><span class="s1">metadata</span><span class="s2">.</span><span class="s1">create_all</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">Session </span><span class="s2">= </span><span class="s1">sessionmaker</span><span class="s2">(</span><span class="s1">bind</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">Session</span><span class="s2">() </span><span class="s0">as </span><span class="s1">session</span><span class="s2">:</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;id&quot;</span><span class="s2">: [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s3">&quot;string_column&quot;</span><span class="s2">: [</span><span class="s3">&quot;hello&quot;</span><span class="s2">, </span><span class="s3">&quot;world&quot;</span><span class="s2">]})</span>
        <span class="s0">assert </span><span class="s2">(</span>
            <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_frame&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">)</span>
            <span class="s2">== </span><span class="s4">2</span>
        <span class="s2">)</span>
        <span class="s1">session</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>
        <span class="s1">test_query </span><span class="s2">= </span><span class="s1">session</span><span class="s2">.</span><span class="s1">query</span><span class="s2">(</span><span class="s1">Test</span><span class="s2">.</span><span class="s1">id</span><span class="s2">, </span><span class="s1">Test</span><span class="s2">.</span><span class="s1">string_column</span><span class="s2">)</span>
        <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">test_query</span><span class="s2">)</span>

    <span class="s0">assert </span><span class="s1">list</span><span class="s2">(</span><span class="s1">df</span><span class="s2">.</span><span class="s1">columns</span><span class="s2">) == [</span><span class="s3">&quot;id&quot;</span><span class="s2">, </span><span class="s3">&quot;string_column&quot;</span><span class="s2">]</span>


<span class="s0">def </span><span class="s1">test_read_sql_string_inference</span><span class="s2">(</span><span class="s1">sqlite_engine</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_engine</span>
    <span class="s5"># GH#54430</span>
    <span class="s1">pytest</span><span class="s2">.</span><span class="s1">importorskip</span><span class="s2">(</span><span class="s3">&quot;pyarrow&quot;</span><span class="s2">)</span>
    <span class="s1">table </span><span class="s2">= </span><span class="s3">&quot;test&quot;</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s3">&quot;x&quot;</span><span class="s2">, </span><span class="s3">&quot;y&quot;</span><span class="s2">]})</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">table</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">option_context</span><span class="s2">(</span><span class="s3">&quot;future.infer_string&quot;</span><span class="s2">, </span><span class="s0">True</span><span class="s2">):</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s1">table</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s1">dtype </span><span class="s2">= </span><span class="s3">&quot;string[pyarrow_numpy]&quot;</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">{</span><span class="s3">&quot;a&quot;</span><span class="s2">: [</span><span class="s3">&quot;x&quot;</span><span class="s2">, </span><span class="s3">&quot;y&quot;</span><span class="s2">]}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">([</span><span class="s3">&quot;a&quot;</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">dtype</span><span class="s2">)</span>
    <span class="s2">)</span>

    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_roundtripping_datetimes</span><span class="s2">(</span><span class="s1">sqlite_engine</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_engine</span>
    <span class="s5"># GH#54877</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;t&quot;</span><span class="s2">: [</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2020</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">31</span><span class="s2">, </span><span class="s4">12</span><span class="s2">)]}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;datetime64[ns]&quot;</span><span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s3">&quot;test&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;select * from test&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">).</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s3">&quot;2020-12-31 12:00:00.000000&quot;</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">fixture</span>
<span class="s0">def </span><span class="s1">sqlite_builtin_detect_types</span><span class="s2">():</span>
    <span class="s0">with </span><span class="s1">contextlib</span><span class="s2">.</span><span class="s1">closing</span><span class="s2">(</span>
        <span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s3">&quot;:memory:&quot;</span><span class="s2">, </span><span class="s1">detect_types</span><span class="s2">=</span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">PARSE_DECLTYPES</span><span class="s2">)</span>
    <span class="s2">) </span><span class="s0">as </span><span class="s1">closing_conn</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">closing_conn </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
            <span class="s0">yield </span><span class="s1">conn</span>


<span class="s0">def </span><span class="s1">test_roundtripping_datetimes_detect_types</span><span class="s2">(</span><span class="s1">sqlite_builtin_detect_types</span><span class="s2">):</span>
    <span class="s5"># https://github.com/pandas-dev/pandas/issues/55554</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_builtin_detect_types</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;t&quot;</span><span class="s2">: [</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2020</span><span class="s2">, </span><span class="s4">12</span><span class="s2">, </span><span class="s4">31</span><span class="s2">, </span><span class="s4">12</span><span class="s2">)]}, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;datetime64[ns]&quot;</span><span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s3">&quot;test&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;select * from test&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">).</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">result </span><span class="s2">== </span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2020-12-31 12:00:00.000000&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span>
<span class="s0">def </span><span class="s1">test_psycopg2_schema_support</span><span class="s2">(</span><span class="s1">postgresql_psycopg2_engine</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">postgresql_psycopg2_engine</span>

    <span class="s5"># only test this for postgresql (schema's not supported in</span>
    <span class="s5"># mysql/sqlite)</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;col1&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;col2&quot;</span><span class="s2">: [</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">], </span><span class="s3">&quot;col3&quot;</span><span class="s2">: [</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;n&quot;</span><span class="s2">]})</span>

    <span class="s5"># create a schema</span>
    <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">con</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">con</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
            <span class="s1">con</span><span class="s2">.</span><span class="s1">exec_driver_sql</span><span class="s2">(</span><span class="s3">&quot;DROP SCHEMA IF EXISTS other CASCADE;&quot;</span><span class="s2">)</span>
            <span class="s1">con</span><span class="s2">.</span><span class="s1">exec_driver_sql</span><span class="s2">(</span><span class="s3">&quot;CREATE SCHEMA other;&quot;</span><span class="s2">)</span>

    <span class="s5"># write dataframe to different schema's</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_schema_public&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">2</span>
    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_schema_public_explicit&quot;</span><span class="s2">,</span>
            <span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">,</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">schema</span><span class="s2">=</span><span class="s3">&quot;public&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s2">== </span><span class="s4">2</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_schema_other&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s3">&quot;other&quot;</span><span class="s2">) == </span><span class="s4">2</span>
    <span class="s2">)</span>

    <span class="s5"># read dataframes back in</span>
    <span class="s1">res1 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_schema_public&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">res1</span><span class="s2">)</span>
    <span class="s1">res2 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_schema_public_explicit&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">)</span>
    <span class="s1">res3 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_schema_public_explicit&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s3">&quot;public&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">res3</span><span class="s2">)</span>
    <span class="s1">res4 </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_schema_other&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s3">&quot;other&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">res4</span><span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Table test_schema_other not found&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_schema_other&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s3">&quot;public&quot;</span><span class="s2">)</span>

    <span class="s5"># different if_exists options</span>

    <span class="s5"># create a schema</span>
    <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">con</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">con</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
            <span class="s1">con</span><span class="s2">.</span><span class="s1">exec_driver_sql</span><span class="s2">(</span><span class="s3">&quot;DROP SCHEMA IF EXISTS other CASCADE;&quot;</span><span class="s2">)</span>
            <span class="s1">con</span><span class="s2">.</span><span class="s1">exec_driver_sql</span><span class="s2">(</span><span class="s3">&quot;CREATE SCHEMA other;&quot;</span><span class="s2">)</span>

    <span class="s5"># write dataframe with different if_exists options</span>
    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_schema_other&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s3">&quot;other&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">2</span>
    <span class="s2">)</span>
    <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_schema_other&quot;</span><span class="s2">,</span>
        <span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">,</span>
        <span class="s1">schema</span><span class="s2">=</span><span class="s3">&quot;other&quot;</span><span class="s2">,</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_schema_other&quot;</span><span class="s2">,</span>
            <span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">,</span>
            <span class="s1">schema</span><span class="s2">=</span><span class="s3">&quot;other&quot;</span><span class="s2">,</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
            <span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;append&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s2">== </span><span class="s4">2</span>
    <span class="s2">)</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql_table</span><span class="s2">(</span><span class="s3">&quot;test_schema_other&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">, </span><span class="s1">schema</span><span class="s2">=</span><span class="s3">&quot;other&quot;</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">concat</span><span class="s2">([</span><span class="s1">df</span><span class="s2">, </span><span class="s1">df</span><span class="s2">], </span><span class="s1">ignore_index</span><span class="s2">=</span><span class="s0">True</span><span class="s2">), </span><span class="s1">res</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">db</span>
<span class="s0">def </span><span class="s1">test_self_join_date_columns</span><span class="s2">(</span><span class="s1">postgresql_psycopg2_engine</span><span class="s2">):</span>
    <span class="s5"># GH 44421</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">postgresql_psycopg2_engine</span>
    <span class="s0">from </span><span class="s1">sqlalchemy</span><span class="s2">.</span><span class="s1">sql </span><span class="s0">import </span><span class="s1">text</span>

    <span class="s1">create_table </span><span class="s2">= </span><span class="s1">text</span><span class="s2">(</span>
        <span class="s3">&quot;&quot;&quot; 
    CREATE TABLE person 
    ( 
        id serial constraint person_pkey primary key, 
        created_dt timestamp with time zone 
    ); 
 
    INSERT INTO person 
        VALUES (1, '2021-01-01T00:00:00Z'); 
    &quot;&quot;&quot;</span>
    <span class="s2">)</span>
    <span class="s0">with </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">() </span><span class="s0">as </span><span class="s1">con</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">con</span><span class="s2">.</span><span class="s1">begin</span><span class="s2">():</span>
            <span class="s1">con</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">create_table</span><span class="s2">)</span>

    <span class="s1">sql_query </span><span class="s2">= (</span>
        <span class="s3">'SELECT * FROM &quot;person&quot; AS p1 INNER JOIN &quot;person&quot; AS p2 ON p1.id = p2.id;'</span>
    <span class="s2">)</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">pd</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s1">sql_query</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s1">Timestamp</span><span class="s2">(</span><span class="s3">&quot;2021&quot;</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s3">&quot;UTC&quot;</span><span class="s2">)] * </span><span class="s4">2</span><span class="s2">], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;id&quot;</span><span class="s2">, </span><span class="s3">&quot;created_dt&quot;</span><span class="s2">] * </span><span class="s4">2</span>
    <span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>

    <span class="s5"># Cleanup</span>
    <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">need_transaction</span><span class="s2">=</span><span class="s0">True</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;person&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_create_and_drop_table</span><span class="s2">(</span><span class="s1">sqlite_engine</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_engine</span>
    <span class="s1">temp_frame </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;one&quot;</span><span class="s2">: [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">], </span><span class="s3">&quot;two&quot;</span><span class="s2">: [</span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">3.0</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">]})</span>
    <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">SQLDatabase</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandasSQL</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">():</span>
            <span class="s0">assert </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">temp_frame</span><span class="s2">, </span><span class="s3">&quot;drop_test_frame&quot;</span><span class="s2">) == </span><span class="s4">4</span>

        <span class="s0">assert </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;drop_test_frame&quot;</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">run_transaction</span><span class="s2">():</span>
            <span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">drop_table</span><span class="s2">(</span><span class="s3">&quot;drop_test_frame&quot;</span><span class="s2">)</span>

        <span class="s0">assert not </span><span class="s1">pandasSQL</span><span class="s2">.</span><span class="s1">has_table</span><span class="s2">(</span><span class="s3">&quot;drop_test_frame&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_sqlite_datetime_date</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_buildin</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([</span><span class="s1">date</span><span class="s2">(</span><span class="s4">2014</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s1">date</span><span class="s2">(</span><span class="s4">2014</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_date&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">2</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_date&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s5"># comes back as strings</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">df</span><span class="s2">.</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">str</span><span class="s2">))</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s3">&quot;tz_aware&quot;</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_sqlite_datetime_time</span><span class="s2">(</span><span class="s1">tz_aware</span><span class="s2">, </span><span class="s1">sqlite_buildin</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_buildin</span>
    <span class="s5"># test support for datetime.time, GH #8341</span>
    <span class="s0">if not </span><span class="s1">tz_aware</span><span class="s2">:</span>
        <span class="s1">tz_times </span><span class="s2">= [</span><span class="s1">time</span><span class="s2">(</span><span class="s4">9</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), </span><span class="s1">time</span><span class="s2">(</span><span class="s4">9</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">30</span><span class="s2">)]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">tz_dt </span><span class="s2">= </span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2013-01-01 09:00:00&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">=</span><span class="s3">&quot;US/Pacific&quot;</span><span class="s2">)</span>
        <span class="s1">tz_times </span><span class="s2">= </span><span class="s1">Series</span><span class="s2">(</span><span class="s1">tz_dt</span><span class="s2">.</span><span class="s1">to_pydatetime</span><span class="s2">()).</span><span class="s1">map</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">dt</span><span class="s2">: </span><span class="s1">dt</span><span class="s2">.</span><span class="s1">timetz</span><span class="s2">())</span>

    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">tz_times</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">])</span>

    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_time&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">2</span>
    <span class="s1">res </span><span class="s2">= </span><span class="s1">read_sql_query</span><span class="s2">(</span><span class="s3">&quot;SELECT * FROM test_time&quot;</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>
    <span class="s5"># comes back as strings</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">df</span><span class="s2">.</span><span class="s1">map</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">_</span><span class="s2">: </span><span class="s1">_</span><span class="s2">.</span><span class="s1">strftime</span><span class="s2">(</span><span class="s3">&quot;%H:%M:%S.%f&quot;</span><span class="s2">))</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">res</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">get_sqlite_column_type</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">table</span><span class="s2">, </span><span class="s1">column</span><span class="s2">):</span>
    <span class="s1">recs </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">f&quot;PRAGMA table_info(</span><span class="s0">{</span><span class="s1">table</span><span class="s0">}</span><span class="s3">)&quot;</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">cid</span><span class="s2">, </span><span class="s1">name</span><span class="s2">, </span><span class="s1">ctype</span><span class="s2">, </span><span class="s1">not_null</span><span class="s2">, </span><span class="s1">default</span><span class="s2">, </span><span class="s1">pk </span><span class="s0">in </span><span class="s1">recs</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">name </span><span class="s2">== </span><span class="s1">column</span><span class="s2">:</span>
            <span class="s0">return </span><span class="s1">ctype</span>
    <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">f&quot;Table </span><span class="s0">{</span><span class="s1">table</span><span class="s0">}</span><span class="s3">, column </span><span class="s0">{</span><span class="s1">column</span><span class="s0">} </span><span class="s3">not found&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_sqlite_test_dtype</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_buildin</span>
    <span class="s1">cols </span><span class="s2">= [</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">]</span>
    <span class="s1">data </span><span class="s2">= [(</span><span class="s4">0.8</span><span class="s2">, </span><span class="s0">True</span><span class="s2">), (</span><span class="s4">0.9</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)]</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">columns</span><span class="s2">=</span><span class="s1">cols</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;dtype_test&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">) == </span><span class="s4">2</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;dtype_test2&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">={</span><span class="s3">&quot;B&quot;</span><span class="s2">: </span><span class="s3">&quot;STRING&quot;</span><span class="s2">}) == </span><span class="s4">2</span>

    <span class="s5"># sqlite stores Boolean values as INTEGER</span>
    <span class="s0">assert </span><span class="s1">get_sqlite_column_type</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s3">&quot;dtype_test&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">) == </span><span class="s3">&quot;INTEGER&quot;</span>

    <span class="s0">assert </span><span class="s1">get_sqlite_column_type</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s3">&quot;dtype_test2&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">) == </span><span class="s3">&quot;STRING&quot;</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">r&quot;B \(&lt;class 'bool'&gt;\) not a string&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;error&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">={</span><span class="s3">&quot;B&quot;</span><span class="s2">: </span><span class="s1">bool</span><span class="s2">})</span>

    <span class="s5"># single dtype</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;single_dtype_test&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;STRING&quot;</span><span class="s2">) == </span><span class="s4">2</span>
    <span class="s0">assert </span><span class="s1">get_sqlite_column_type</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s3">&quot;single_dtype_test&quot;</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">) == </span><span class="s3">&quot;STRING&quot;</span>
    <span class="s0">assert </span><span class="s1">get_sqlite_column_type</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s3">&quot;single_dtype_test&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">) == </span><span class="s3">&quot;STRING&quot;</span>


<span class="s0">def </span><span class="s1">test_sqlite_notna_dtype</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">):</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_buildin</span>
    <span class="s1">cols </span><span class="s2">= {</span>
        <span class="s3">&quot;Bool&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s0">True</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]),</span>
        <span class="s3">&quot;Date&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s1">datetime</span><span class="s2">(</span><span class="s4">2012</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s0">None</span><span class="s2">]),</span>
        <span class="s3">&quot;Int&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">], </span><span class="s1">dtype</span><span class="s2">=</span><span class="s3">&quot;object&quot;</span><span class="s2">),</span>
        <span class="s3">&quot;Float&quot;</span><span class="s2">: </span><span class="s1">Series</span><span class="s2">([</span><span class="s4">1.1</span><span class="s2">, </span><span class="s0">None</span><span class="s2">]),</span>
    <span class="s2">}</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span><span class="s1">cols</span><span class="s2">)</span>

    <span class="s1">tbl </span><span class="s2">= </span><span class="s3">&quot;notna_dtype_test&quot;</span>
    <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">tbl</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">) == </span><span class="s4">2</span>

    <span class="s0">assert </span><span class="s1">get_sqlite_column_type</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">tbl</span><span class="s2">, </span><span class="s3">&quot;Bool&quot;</span><span class="s2">) == </span><span class="s3">&quot;INTEGER&quot;</span>
    <span class="s0">assert </span><span class="s1">get_sqlite_column_type</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">tbl</span><span class="s2">, </span><span class="s3">&quot;Date&quot;</span><span class="s2">) == </span><span class="s3">&quot;TIMESTAMP&quot;</span>
    <span class="s0">assert </span><span class="s1">get_sqlite_column_type</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">tbl</span><span class="s2">, </span><span class="s3">&quot;Int&quot;</span><span class="s2">) == </span><span class="s3">&quot;INTEGER&quot;</span>
    <span class="s0">assert </span><span class="s1">get_sqlite_column_type</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">, </span><span class="s1">tbl</span><span class="s2">, </span><span class="s3">&quot;Float&quot;</span><span class="s2">) == </span><span class="s3">&quot;REAL&quot;</span>


<span class="s0">def </span><span class="s1">test_sqlite_illegal_names</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">):</span>
    <span class="s5"># For sqlite, these should work fine</span>
    <span class="s1">conn </span><span class="s2">= </span><span class="s1">sqlite_buildin</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s3">&quot;b&quot;</span><span class="s2">])</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Empty table or column name specified&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">ndx</span><span class="s2">, </span><span class="s1">weird_name </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span>
        <span class="s2">[</span>
            <span class="s3">&quot;test_weird_name]&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;test_weird_name[&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;test_weird_name`&quot;</span><span class="s2">,</span>
            <span class="s3">'test_weird_name&quot;'</span><span class="s2">,</span>
            <span class="s3">&quot;test_weird_name'&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;_b.test_weird_name_01-30&quot;</span><span class="s2">,</span>
            <span class="s3">'&quot;_b.test_weird_name_01-30&quot;'</span><span class="s2">,</span>
            <span class="s3">&quot;99beginswithnumber&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;12345&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;</span><span class="s0">\xe9</span><span class="s3">&quot;</span><span class="s2">,</span>
        <span class="s2">]</span>
    <span class="s2">):</span>
        <span class="s0">assert </span><span class="s1">df</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">weird_name</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">) == </span><span class="s4">2</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">table_exists</span><span class="s2">(</span><span class="s1">weird_name</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>

        <span class="s1">df2 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;a&quot;</span><span class="s2">, </span><span class="s1">weird_name</span><span class="s2">])</span>
        <span class="s1">c_tbl </span><span class="s2">= </span><span class="s3">f&quot;test_weird_col_name</span><span class="s0">{</span><span class="s1">ndx</span><span class="s0">:</span><span class="s3">d</span><span class="s0">}</span><span class="s3">&quot;</span>
        <span class="s0">assert </span><span class="s1">df2</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">name</span><span class="s2">=</span><span class="s1">c_tbl</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">) == </span><span class="s4">2</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">table_exists</span><span class="s2">(</span><span class="s1">c_tbl</span><span class="s2">, </span><span class="s1">conn</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">format_query</span><span class="s2">(</span><span class="s1">sql</span><span class="s2">, *</span><span class="s1">args</span><span class="s2">):</span>
    <span class="s1">_formatters </span><span class="s2">= {</span>
        <span class="s1">datetime</span><span class="s2">: </span><span class="s3">&quot;'{}'&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">,</span>
        <span class="s1">str</span><span class="s2">: </span><span class="s3">&quot;'{}'&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">,</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">str_</span><span class="s2">: </span><span class="s3">&quot;'{}'&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">,</span>
        <span class="s1">bytes</span><span class="s2">: </span><span class="s3">&quot;'{}'&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">,</span>
        <span class="s1">float</span><span class="s2">: </span><span class="s3">&quot;{:.8f}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">,</span>
        <span class="s1">int</span><span class="s2">: </span><span class="s3">&quot;{:d}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">,</span>
        <span class="s1">type</span><span class="s2">(</span><span class="s0">None</span><span class="s2">): </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s3">&quot;NULL&quot;</span><span class="s2">,</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">: </span><span class="s3">&quot;{:.10f}&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">,</span>
        <span class="s1">bool</span><span class="s2">: </span><span class="s3">&quot;'{!s}'&quot;</span><span class="s2">.</span><span class="s1">format</span><span class="s2">,</span>
    <span class="s2">}</span>
    <span class="s1">processed_args </span><span class="s2">= []</span>
    <span class="s0">for </span><span class="s1">arg </span><span class="s0">in </span><span class="s1">args</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">, </span><span class="s1">float</span><span class="s2">) </span><span class="s0">and </span><span class="s1">isna</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">):</span>
            <span class="s1">arg </span><span class="s2">= </span><span class="s0">None</span>

        <span class="s1">formatter </span><span class="s2">= </span><span class="s1">_formatters</span><span class="s2">[</span><span class="s1">type</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">)]</span>
        <span class="s1">processed_args</span><span class="s2">.</span><span class="s1">append</span><span class="s2">(</span><span class="s1">formatter</span><span class="s2">(</span><span class="s1">arg</span><span class="s2">))</span>

    <span class="s0">return </span><span class="s1">sql </span><span class="s2">% </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">processed_args</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">tquery</span><span class="s2">(</span><span class="s1">query</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s0">None</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Replace removed sql.tquery function&quot;&quot;&quot;</span>
    <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">con</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandas_sql</span><span class="s2">:</span>
        <span class="s1">res </span><span class="s2">= </span><span class="s1">pandas_sql</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">query</span><span class="s2">).</span><span class="s1">fetchall</span><span class="s2">()</span>
    <span class="s0">return None if </span><span class="s1">res </span><span class="s0">is None else </span><span class="s1">list</span><span class="s2">(</span><span class="s1">res</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_xsqlite_basic</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">):</span>
    <span class="s1">frame </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)),</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ABCD&quot;</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2000-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;B&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_table&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">10</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;select * from test_table&quot;</span><span class="s2">, </span><span class="s1">sqlite_buildin</span><span class="s2">)</span>

    <span class="s5"># HACK! Change this once indexes are handled properly.</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">index</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s1">frame</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">)</span>

    <span class="s1">frame</span><span class="s2">[</span><span class="s3">&quot;txt&quot;</span><span class="s2">] = [</span><span class="s3">&quot;a&quot;</span><span class="s2">] * </span><span class="s1">len</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">)</span>
    <span class="s1">frame2 </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">new_idx </span><span class="s2">= </span><span class="s1">Index</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">frame2</span><span class="s2">)), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">int64</span><span class="s2">) + </span><span class="s4">10</span>
    <span class="s1">frame2</span><span class="s2">[</span><span class="s3">&quot;Idx&quot;</span><span class="s2">] = </span><span class="s1">new_idx</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">frame2</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;test_table2&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">10</span>
    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;select * from test_table2&quot;</span><span class="s2">, </span><span class="s1">sqlite_buildin</span><span class="s2">, </span><span class="s1">index_col</span><span class="s2">=</span><span class="s3">&quot;Idx&quot;</span><span class="s2">)</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">new_idx</span>
    <span class="s1">expected</span><span class="s2">.</span><span class="s1">index</span><span class="s2">.</span><span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;Idx&quot;</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">expected</span><span class="s2">, </span><span class="s1">result</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_xsqlite_write_row_by_row</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">):</span>
    <span class="s1">frame </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)),</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ABCD&quot;</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2000-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;B&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">frame</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>
    <span class="s1">create_sql </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">get_schema</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">, </span><span class="s3">&quot;test&quot;</span><span class="s2">)</span>
    <span class="s1">cur </span><span class="s2">= </span><span class="s1">sqlite_buildin</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">()</span>
    <span class="s1">cur</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">create_sql</span><span class="s2">)</span>

    <span class="s1">ins </span><span class="s2">= </span><span class="s3">&quot;INSERT INTO test VALUES (%s, %s, %s, %s)&quot;</span>
    <span class="s0">for </span><span class="s1">_</span><span class="s2">, </span><span class="s1">row </span><span class="s0">in </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">iterrows</span><span class="s2">():</span>
        <span class="s1">fmt_sql </span><span class="s2">= </span><span class="s1">format_query</span><span class="s2">(</span><span class="s1">ins</span><span class="s2">, *</span><span class="s1">row</span><span class="s2">)</span>
        <span class="s1">tquery</span><span class="s2">(</span><span class="s1">fmt_sql</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">)</span>

    <span class="s1">sqlite_buildin</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;select * from test&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">)</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">index</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-3</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_xsqlite_execute</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">):</span>
    <span class="s1">frame </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)),</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ABCD&quot;</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2000-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;B&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">create_sql </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">get_schema</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">, </span><span class="s3">&quot;test&quot;</span><span class="s2">)</span>
    <span class="s1">cur </span><span class="s2">= </span><span class="s1">sqlite_buildin</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">()</span>
    <span class="s1">cur</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">create_sql</span><span class="s2">)</span>
    <span class="s1">ins </span><span class="s2">= </span><span class="s3">&quot;INSERT INTO test VALUES (?, ?, ?, ?)&quot;</span>

    <span class="s1">row </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">iloc</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandas_sql</span><span class="s2">:</span>
        <span class="s1">pandas_sql</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">ins</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">row</span><span class="s2">))</span>
    <span class="s1">sqlite_buildin</span><span class="s2">.</span><span class="s1">commit</span><span class="s2">()</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;select * from test&quot;</span><span class="s2">, </span><span class="s1">sqlite_buildin</span><span class="s2">)</span>
    <span class="s1">result</span><span class="s2">.</span><span class="s1">index </span><span class="s2">= </span><span class="s1">frame</span><span class="s2">.</span><span class="s1">index</span><span class="s2">[:</span><span class="s4">1</span><span class="s2">]</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">frame</span><span class="s2">[:</span><span class="s4">1</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">test_xsqlite_schema</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">):</span>
    <span class="s1">frame </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">(</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">2</span><span class="s2">).</span><span class="s1">standard_normal</span><span class="s2">((</span><span class="s4">10</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)),</span>
        <span class="s1">columns</span><span class="s2">=</span><span class="s1">Index</span><span class="s2">(</span><span class="s1">list</span><span class="s2">(</span><span class="s3">&quot;ABCD&quot;</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">object</span><span class="s2">),</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s1">date_range</span><span class="s2">(</span><span class="s3">&quot;2000-01-01&quot;</span><span class="s2">, </span><span class="s1">periods</span><span class="s2">=</span><span class="s4">10</span><span class="s2">, </span><span class="s1">freq</span><span class="s2">=</span><span class="s3">&quot;B&quot;</span><span class="s2">),</span>
    <span class="s2">)</span>
    <span class="s1">create_sql </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">get_schema</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">, </span><span class="s3">&quot;test&quot;</span><span class="s2">)</span>
    <span class="s1">lines </span><span class="s2">= </span><span class="s1">create_sql</span><span class="s2">.</span><span class="s1">splitlines</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">lines</span><span class="s2">:</span>
        <span class="s1">tokens </span><span class="s2">= </span><span class="s1">line</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">&quot; &quot;</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">tokens</span><span class="s2">) == </span><span class="s4">2 </span><span class="s0">and </span><span class="s1">tokens</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s3">&quot;A&quot;</span><span class="s2">:</span>
            <span class="s0">assert </span><span class="s1">tokens</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] == </span><span class="s3">&quot;DATETIME&quot;</span>

    <span class="s1">create_sql </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">get_schema</span><span class="s2">(</span><span class="s1">frame</span><span class="s2">, </span><span class="s3">&quot;test&quot;</span><span class="s2">, </span><span class="s1">keys</span><span class="s2">=[</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">])</span>
    <span class="s1">lines </span><span class="s2">= </span><span class="s1">create_sql</span><span class="s2">.</span><span class="s1">splitlines</span><span class="s2">()</span>
    <span class="s0">assert </span><span class="s3">'PRIMARY KEY (&quot;A&quot;, &quot;B&quot;)' </span><span class="s0">in </span><span class="s1">create_sql</span>
    <span class="s1">cur </span><span class="s2">= </span><span class="s1">sqlite_buildin</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">()</span>
    <span class="s1">cur</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">create_sql</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_xsqlite_execute_fail</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">):</span>
    <span class="s1">create_sql </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
    CREATE TABLE test 
    ( 
    a TEXT, 
    b TEXT, 
    c REAL, 
    PRIMARY KEY (a, b) 
    ); 
    &quot;&quot;&quot;</span>
    <span class="s1">cur </span><span class="s2">= </span><span class="s1">sqlite_buildin</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">()</span>
    <span class="s1">cur</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">create_sql</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandas_sql</span><span class="s2">:</span>
        <span class="s1">pandas_sql</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">'INSERT INTO test VALUES(&quot;foo&quot;, &quot;bar&quot;, 1.234)'</span><span class="s2">)</span>
        <span class="s1">pandas_sql</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">'INSERT INTO test VALUES(&quot;foo&quot;, &quot;baz&quot;, 2.567)'</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">sql</span><span class="s2">.</span><span class="s1">DatabaseError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s3">&quot;Execution failed on sql&quot;</span><span class="s2">):</span>
            <span class="s1">pandas_sql</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">'INSERT INTO test VALUES(&quot;foo&quot;, &quot;bar&quot;, 7)'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_xsqlite_execute_closed_connection</span><span class="s2">():</span>
    <span class="s1">create_sql </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot; 
    CREATE TABLE test 
    ( 
    a TEXT, 
    b TEXT, 
    c REAL, 
    PRIMARY KEY (a, b) 
    ); 
    &quot;&quot;&quot;</span>
    <span class="s0">with </span><span class="s1">contextlib</span><span class="s2">.</span><span class="s1">closing</span><span class="s2">(</span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">connect</span><span class="s2">(</span><span class="s3">&quot;:memory:&quot;</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">conn</span><span class="s2">:</span>
        <span class="s1">cur </span><span class="s2">= </span><span class="s1">conn</span><span class="s2">.</span><span class="s1">cursor</span><span class="s2">()</span>
        <span class="s1">cur</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s1">create_sql</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">pandasSQL_builder</span><span class="s2">(</span><span class="s1">conn</span><span class="s2">) </span><span class="s0">as </span><span class="s1">pandas_sql</span><span class="s2">:</span>
            <span class="s1">pandas_sql</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">'INSERT INTO test VALUES(&quot;foo&quot;, &quot;bar&quot;, 1.234)'</span><span class="s2">)</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Cannot operate on a closed database.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">sqlite3</span><span class="s2">.</span><span class="s1">ProgrammingError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">tquery</span><span class="s2">(</span><span class="s3">&quot;select * from test&quot;</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">conn</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_xsqlite_keyword_as_column_names</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">):</span>
    <span class="s1">df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;From&quot;</span><span class="s2">: </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">5</span><span class="s2">)})</span>
    <span class="s0">assert </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">df</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;testkeywords&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">5</span>


<span class="s0">def </span><span class="s1">test_xsqlite_onecolumn_of_integer</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">):</span>
    <span class="s5"># GH 3628</span>
    <span class="s5"># a column_of_integers dataframe should transfer well to sql</span>

    <span class="s1">mono_df </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">columns</span><span class="s2">=[</span><span class="s3">&quot;c0&quot;</span><span class="s2">])</span>
    <span class="s0">assert </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span><span class="s1">mono_df</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;mono_df&quot;</span><span class="s2">, </span><span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">) == </span><span class="s4">2</span>
    <span class="s5"># computing the sum via sql</span>
    <span class="s1">con_x </span><span class="s2">= </span><span class="s1">sqlite_buildin</span>
    <span class="s1">the_sum </span><span class="s2">= </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">my_c0</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] </span><span class="s0">for </span><span class="s1">my_c0 </span><span class="s0">in </span><span class="s1">con_x</span><span class="s2">.</span><span class="s1">execute</span><span class="s2">(</span><span class="s3">&quot;select * from mono_df&quot;</span><span class="s2">))</span>
    <span class="s5"># it should not fail, and gives 3 ( Issue #3628 )</span>
    <span class="s0">assert </span><span class="s1">the_sum </span><span class="s2">== </span><span class="s4">3</span>

    <span class="s1">result </span><span class="s2">= </span><span class="s1">sql</span><span class="s2">.</span><span class="s1">read_sql</span><span class="s2">(</span><span class="s3">&quot;select * from mono_df&quot;</span><span class="s2">, </span><span class="s1">con_x</span><span class="s2">)</span>
    <span class="s1">tm</span><span class="s2">.</span><span class="s1">assert_frame_equal</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">mono_df</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_xsqlite_if_exists</span><span class="s2">(</span><span class="s1">sqlite_buildin</span><span class="s2">):</span>
    <span class="s1">df_if_exists_1 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;col1&quot;</span><span class="s2">: [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s3">&quot;col2&quot;</span><span class="s2">: [</span><span class="s3">&quot;A&quot;</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">]})</span>
    <span class="s1">df_if_exists_2 </span><span class="s2">= </span><span class="s1">DataFrame</span><span class="s2">({</span><span class="s3">&quot;col1&quot;</span><span class="s2">: [</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">], </span><span class="s3">&quot;col2&quot;</span><span class="s2">: [</span><span class="s3">&quot;C&quot;</span><span class="s2">, </span><span class="s3">&quot;D&quot;</span><span class="s2">, </span><span class="s3">&quot;E&quot;</span><span class="s2">]})</span>
    <span class="s1">table_name </span><span class="s2">= </span><span class="s3">&quot;table_if_exists&quot;</span>
    <span class="s1">sql_select </span><span class="s2">= </span><span class="s3">f&quot;SELECT * FROM </span><span class="s0">{</span><span class="s1">table_name</span><span class="s0">}</span><span class="s3">&quot;</span>

    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;'notvalidvalue' is not valid for if_exists&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
            <span class="s1">frame</span><span class="s2">=</span><span class="s1">df_if_exists_1</span><span class="s2">,</span>
            <span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">,</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">table_name</span><span class="s2">,</span>
            <span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;notvalidvalue&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s1">drop_table</span><span class="s2">(</span><span class="s1">table_name</span><span class="s2">, </span><span class="s1">sqlite_buildin</span><span class="s2">)</span>

    <span class="s5"># test if_exists='fail'</span>
    <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
        <span class="s1">frame</span><span class="s2">=</span><span class="s1">df_if_exists_1</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">, </span><span class="s1">name</span><span class="s2">=</span><span class="s1">table_name</span><span class="s2">, </span><span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;fail&quot;</span>
    <span class="s2">)</span>
    <span class="s1">msg </span><span class="s2">= </span><span class="s3">&quot;Table 'table_if_exists' already exists&quot;</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">msg</span><span class="s2">):</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
            <span class="s1">frame</span><span class="s2">=</span><span class="s1">df_if_exists_1</span><span class="s2">,</span>
            <span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">,</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">table_name</span><span class="s2">,</span>
            <span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;fail&quot;</span><span class="s2">,</span>
        <span class="s2">)</span>
    <span class="s5"># test if_exists='replace'</span>
    <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
        <span class="s1">frame</span><span class="s2">=</span><span class="s1">df_if_exists_1</span><span class="s2">,</span>
        <span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">,</span>
        <span class="s1">name</span><span class="s2">=</span><span class="s1">table_name</span><span class="s2">,</span>
        <span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">,</span>
        <span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">tquery</span><span class="s2">(</span><span class="s1">sql_select</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">) == [(</span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">)]</span>
    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
            <span class="s1">frame</span><span class="s2">=</span><span class="s1">df_if_exists_2</span><span class="s2">,</span>
            <span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">,</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">table_name</span><span class="s2">,</span>
            <span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;replace&quot;</span><span class="s2">,</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s2">== </span><span class="s4">3</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">tquery</span><span class="s2">(</span><span class="s1">sql_select</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">) == [(</span><span class="s4">3</span><span class="s2">, </span><span class="s3">&quot;C&quot;</span><span class="s2">), (</span><span class="s4">4</span><span class="s2">, </span><span class="s3">&quot;D&quot;</span><span class="s2">), (</span><span class="s4">5</span><span class="s2">, </span><span class="s3">&quot;E&quot;</span><span class="s2">)]</span>
    <span class="s1">drop_table</span><span class="s2">(</span><span class="s1">table_name</span><span class="s2">, </span><span class="s1">sqlite_buildin</span><span class="s2">)</span>

    <span class="s5"># test if_exists='append'</span>
    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
            <span class="s1">frame</span><span class="s2">=</span><span class="s1">df_if_exists_1</span><span class="s2">,</span>
            <span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">,</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">table_name</span><span class="s2">,</span>
            <span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;fail&quot;</span><span class="s2">,</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s2">== </span><span class="s4">2</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">tquery</span><span class="s2">(</span><span class="s1">sql_select</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">) == [(</span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">)]</span>
    <span class="s0">assert </span><span class="s2">(</span>
        <span class="s1">sql</span><span class="s2">.</span><span class="s1">to_sql</span><span class="s2">(</span>
            <span class="s1">frame</span><span class="s2">=</span><span class="s1">df_if_exists_2</span><span class="s2">,</span>
            <span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">,</span>
            <span class="s1">name</span><span class="s2">=</span><span class="s1">table_name</span><span class="s2">,</span>
            <span class="s1">if_exists</span><span class="s2">=</span><span class="s3">&quot;append&quot;</span><span class="s2">,</span>
            <span class="s1">index</span><span class="s2">=</span><span class="s0">False</span><span class="s2">,</span>
        <span class="s2">)</span>
        <span class="s2">== </span><span class="s4">3</span>
    <span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">tquery</span><span class="s2">(</span><span class="s1">sql_select</span><span class="s2">, </span><span class="s1">con</span><span class="s2">=</span><span class="s1">sqlite_buildin</span><span class="s2">) == [</span>
        <span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s3">&quot;A&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s3">&quot;B&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s3">&quot;C&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">4</span><span class="s2">, </span><span class="s3">&quot;D&quot;</span><span class="s2">),</span>
        <span class="s2">(</span><span class="s4">5</span><span class="s2">, </span><span class="s3">&quot;E&quot;</span><span class="s2">),</span>
    <span class="s2">]</span>
    <span class="s1">drop_table</span><span class="s2">(</span><span class="s1">table_name</span><span class="s2">, </span><span class="s1">sqlite_buildin</span><span class="s2">)</span>
</pre>
</body>
</html>