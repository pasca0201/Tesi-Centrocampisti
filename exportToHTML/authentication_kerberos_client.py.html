<html>
<head>
<title>authentication_kerberos_client.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #7a7e85;}
.s1 { color: #bcbec4;}
.s2 { color: #5f826b; font-style: italic;}
.s3 { color: #cf8e6d;}
.s4 { color: #bcbec4;}
.s5 { color: #6aab73;}
.s6 { color: #2aacb8;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
authentication_kerberos_client.py</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright (c) 2023, 2024, Oracle and/or its affiliates.</span>
<span class="s0">#</span>
<span class="s0"># This program is free software; you can redistribute it and/or modify</span>
<span class="s0"># it under the terms of the GNU General Public License, version 2.0, as</span>
<span class="s0"># published by the Free Software Foundation.</span>
<span class="s0">#</span>
<span class="s0"># This program is designed to work with certain software (including</span>
<span class="s0"># but not limited to OpenSSL) that is licensed under separate terms,</span>
<span class="s0"># as designated in a particular file or component or in included license</span>
<span class="s0"># documentation. The authors of MySQL hereby grant you an</span>
<span class="s0"># additional permission to link the program and your derivative works</span>
<span class="s0"># with the separately licensed software that they have either included with</span>
<span class="s0"># the program or referenced in the documentation.</span>
<span class="s0">#</span>
<span class="s0"># Without limiting anything contained in the foregoing, this file,</span>
<span class="s0"># which is part of MySQL Connector/Python, is also subject to the</span>
<span class="s0"># Universal FOSS Exception, version 1.0, a copy of which can be found at</span>
<span class="s0"># http://oss.oracle.com/licenses/universal-foss-exception.</span>
<span class="s0">#</span>
<span class="s0"># This program is distributed in the hope that it will be useful, but</span>
<span class="s0"># WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="s0"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="s0"># See the GNU General Public License, version 2.0, for more details.</span>
<span class="s0">#</span>
<span class="s0"># You should have received a copy of the GNU General Public License</span>
<span class="s0"># along with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="s0"># 51 Franklin St, Fifth Floor, Boston, MA 02110-1301  USA</span>

<span class="s0"># mypy: disable-error-code=&quot;str-bytes-safe,misc&quot;</span>

<span class="s2">&quot;&quot;&quot;Kerberos Authentication Plugin.&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">getpass</span>
<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">struct</span>

<span class="s3">from </span><span class="s1">abc </span><span class="s3">import </span><span class="s1">abstractmethod</span>
<span class="s3">from </span><span class="s1">pathlib </span><span class="s3">import </span><span class="s1">Path</span>
<span class="s3">from </span><span class="s1">typing </span><span class="s3">import </span><span class="s1">TYPE_CHECKING</span><span class="s4">, </span><span class="s1">Any</span><span class="s4">, </span><span class="s1">Optional</span><span class="s4">, </span><span class="s1">Tuple</span>

<span class="s3">from </span><span class="s4">..</span><span class="s1">authentication </span><span class="s3">import </span><span class="s1">ERR_STATUS</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">errors </span><span class="s3">import </span><span class="s1">InterfaceError</span><span class="s4">, </span><span class="s1">ProgrammingError</span>
<span class="s3">from </span><span class="s4">..</span><span class="s1">logger </span><span class="s3">import </span><span class="s1">logger</span>

<span class="s3">if </span><span class="s1">TYPE_CHECKING</span><span class="s4">:</span>
    <span class="s3">from </span><span class="s4">..</span><span class="s1">network </span><span class="s3">import </span><span class="s1">MySQLSocket</span>

<span class="s3">try</span><span class="s4">:</span>
    <span class="s3">import </span><span class="s1">gssapi</span>
<span class="s3">except </span><span class="s1">ImportError</span><span class="s4">:</span>
    <span class="s1">gssapi </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s3">if </span><span class="s1">os</span><span class="s4">.</span><span class="s1">name </span><span class="s4">!= </span><span class="s5">&quot;nt&quot;</span><span class="s4">:</span>
        <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span>
            <span class="s5">&quot;Module gssapi is required for GSSAPI authentication &quot;</span>
            <span class="s5">&quot;mechanism but was not found. Unable to authenticate &quot;</span>
            <span class="s5">&quot;with the server&quot;</span>
        <span class="s4">) </span><span class="s3">from None</span>

<span class="s3">try</span><span class="s4">:</span>
    <span class="s3">import </span><span class="s1">sspi</span>
    <span class="s3">import </span><span class="s1">sspicon</span>
<span class="s3">except </span><span class="s1">ImportError</span><span class="s4">:</span>
    <span class="s1">sspi </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s1">sspicon </span><span class="s4">= </span><span class="s3">None</span>

<span class="s3">from </span><span class="s4">. </span><span class="s3">import </span><span class="s1">MySQLAuthPlugin</span>

<span class="s1">AUTHENTICATION_PLUGIN_CLASS </span><span class="s4">= (</span>
    <span class="s5">&quot;MySQLSSPIKerberosAuthPlugin&quot; </span><span class="s3">if </span><span class="s1">os</span><span class="s4">.</span><span class="s1">name </span><span class="s4">== </span><span class="s5">&quot;nt&quot; </span><span class="s3">else </span><span class="s5">&quot;MySQLKerberosAuthPlugin&quot;</span>
<span class="s4">)</span>


<span class="s3">class </span><span class="s1">MySQLBaseKerberosAuthPlugin</span><span class="s4">(</span><span class="s1">MySQLAuthPlugin</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Base class for the MySQL Kerberos authentication plugin.&quot;&quot;&quot;</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">name</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Plugin official name.&quot;&quot;&quot;</span>
        <span class="s3">return </span><span class="s5">&quot;authentication_kerberos_client&quot;</span>

    <span class="s4">@</span><span class="s1">property</span>
    <span class="s3">def </span><span class="s1">requires_ssl</span><span class="s4">(</span><span class="s1">self</span><span class="s4">) </span><span class="s1">-&gt; bool</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Signals whether or not SSL is required.&quot;&quot;&quot;</span>
        <span class="s3">return False</span>

    <span class="s4">@</span><span class="s1">abstractmethod</span>
    <span class="s3">def </span><span class="s1">auth_continue</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">tgt_auth_challenge</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">]</span>
    <span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">], </span><span class="s1">bool</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Continue with the Kerberos TGT service request. 
 
        With the TGT authentication service given response generate a TGT 
        service request. This method must be invoked sequentially (in a loop) 
        until the security context is completed and an empty response needs to 
        be send to acknowledge the server. 
 
        Args: 
            tgt_auth_challenge: the challenge for the negotiation. 
 
        Returns: 
            tuple (bytearray TGS service request, 
            bool True if context is completed otherwise False). 
        &quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">auth_switch_response</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">sock</span><span class="s4">: </span><span class="s5">&quot;MySQLSocket&quot;</span><span class="s4">, </span><span class="s1">auth_data</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">: </span><span class="s1">Any</span>
    <span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Handles server's `auth switch request` response. 
 
        Args: 
            sock: Pointer to the socket connection. 
            auth_data: Plugin provided data (extracted from a packet 
                       representing an `auth switch request` response). 
            kwargs: Custom configuration to be passed to the auth plugin 
                    when invoked. The parameters defined here will override the ones 
                    defined in the auth plugin itself. 
 
        Returns: 
            packet: Last server's response after back-and-forth 
                    communication. 
        &quot;&quot;&quot;</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# auth_data: %s&quot;</span><span class="s4">, </span><span class="s1">auth_data</span><span class="s4">)</span>
        <span class="s1">response </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">auth_response</span><span class="s4">(</span><span class="s1">auth_data</span><span class="s4">, </span><span class="s1">ignore_auth_data</span><span class="s4">=</span><span class="s3">False</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">)</span>
        <span class="s3">if </span><span class="s1">response </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">&quot;Got a NULL auth response&quot;</span><span class="s4">)</span>

        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# request: %s size: %s&quot;</span><span class="s4">, </span><span class="s1">response</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">response</span><span class="s4">))</span>
        <span class="s1">sock</span><span class="s4">.</span><span class="s1">send</span><span class="s4">(</span><span class="s1">response</span><span class="s4">)</span>

        <span class="s1">packet </span><span class="s4">= </span><span class="s1">sock</span><span class="s4">.</span><span class="s1">recv</span><span class="s4">()</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# server response packet: %s&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">packet </span><span class="s4">!= </span><span class="s1">ERR_STATUS</span><span class="s4">:</span>
            <span class="s1">rcode_size </span><span class="s4">= </span><span class="s6">5  </span><span class="s0"># Reader size for the response status code</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# Continue with GSSAPI authentication&quot;</span><span class="s4">)</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# Response header: %s&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">[: </span><span class="s1">rcode_size </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">])</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# Response size: %s&quot;</span><span class="s4">, </span><span class="s1">len</span><span class="s4">(</span><span class="s1">packet</span><span class="s4">))</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# Negotiate a service request&quot;</span><span class="s4">)</span>
            <span class="s1">complete </span><span class="s4">= </span><span class="s3">False</span>
            <span class="s1">tries </span><span class="s4">= </span><span class="s6">0</span>

            <span class="s3">while not </span><span class="s1">complete </span><span class="s3">and </span><span class="s1">tries </span><span class="s4">&lt; </span><span class="s6">5</span><span class="s4">:</span>
                <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;%s Attempt %s %s&quot;</span><span class="s4">, </span><span class="s5">&quot;-&quot; </span><span class="s4">* </span><span class="s6">20</span><span class="s4">, </span><span class="s1">tries </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">, </span><span class="s5">&quot;-&quot; </span><span class="s4">* </span><span class="s6">20</span><span class="s4">)</span>
                <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;&lt;&lt; Server response: %s&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">)</span>
                <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;# Response code: %s&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">[: </span><span class="s1">rcode_size </span><span class="s4">+ </span><span class="s6">1</span><span class="s4">])</span>
                <span class="s1">token</span><span class="s4">, </span><span class="s1">complete </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">auth_continue</span><span class="s4">(</span><span class="s1">packet</span><span class="s4">[</span><span class="s1">rcode_size</span><span class="s4">:])</span>
                <span class="s3">if </span><span class="s1">token</span><span class="s4">:</span>
                    <span class="s1">sock</span><span class="s4">.</span><span class="s1">send</span><span class="s4">(</span><span class="s1">token</span><span class="s4">)</span>
                <span class="s3">if </span><span class="s1">complete</span><span class="s4">:</span>
                    <span class="s3">break</span>
                <span class="s1">packet </span><span class="s4">= </span><span class="s1">sock</span><span class="s4">.</span><span class="s1">recv</span><span class="s4">()</span>

                <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;&gt;&gt; Response to server: %s&quot;</span><span class="s4">, </span><span class="s1">token</span><span class="s4">)</span>
                <span class="s1">tries </span><span class="s4">+= </span><span class="s6">1</span>

            <span class="s3">if not </span><span class="s1">complete</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span>
                    <span class="s5">f&quot;Unable to fulfill server request after </span><span class="s3">{</span><span class="s1">tries</span><span class="s3">} </span><span class="s5">&quot;</span>
                    <span class="s5">f&quot;attempts. Last server response: </span><span class="s3">{</span><span class="s1">packet</span><span class="s3">}</span><span class="s5">&quot;</span>
                <span class="s4">)</span>

            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span>
                <span class="s5">&quot;Last response from server: %s length: %d&quot;</span><span class="s4">,</span>
                <span class="s1">packet</span><span class="s4">,</span>
                <span class="s1">len</span><span class="s4">(</span><span class="s1">packet</span><span class="s4">),</span>
            <span class="s4">)</span>

            <span class="s0"># Receive OK packet from server.</span>
            <span class="s1">packet </span><span class="s4">= </span><span class="s1">sock</span><span class="s4">.</span><span class="s1">recv</span><span class="s4">()</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;&lt;&lt; Ok packet from server: %s&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">)</span>

        <span class="s3">return </span><span class="s1">bytes</span><span class="s4">(</span><span class="s1">packet</span><span class="s4">)</span>


<span class="s0"># pylint: disable=c-extension-no-member,no-member</span>
<span class="s3">class </span><span class="s1">MySQLKerberosAuthPlugin</span><span class="s4">(</span><span class="s1">MySQLBaseKerberosAuthPlugin</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Implement the MySQL Kerberos authentication plugin.&quot;&quot;&quot;</span>

    <span class="s1">context</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">SecurityContext</span><span class="s4">] = </span><span class="s3">None</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">get_user_from_credentials</span><span class="s4">() </span><span class="s1">-&gt; str</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Get user from credentials without realm.&quot;&quot;&quot;</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">creds </span><span class="s4">= </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">Credentials</span><span class="s4">(</span><span class="s1">usage</span><span class="s4">=</span><span class="s5">&quot;initiate&quot;</span><span class="s4">)</span>
            <span class="s1">user </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">creds</span><span class="s4">.</span><span class="s1">name</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">user</span><span class="s4">.</span><span class="s1">find</span><span class="s4">(</span><span class="s5">&quot;@&quot;</span><span class="s4">) != -</span><span class="s6">1</span><span class="s4">:</span>
                <span class="s1">user</span><span class="s4">, </span><span class="s1">_ </span><span class="s4">= </span><span class="s1">user</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s5">&quot;@&quot;</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>
            <span class="s3">return </span><span class="s1">user</span>
        <span class="s3">except </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">raw</span><span class="s4">.</span><span class="s1">misc</span><span class="s4">.</span><span class="s1">GSSError</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">getpass</span><span class="s4">.</span><span class="s1">getuser</span><span class="s4">()</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">get_store</span><span class="s4">() </span><span class="s1">-&gt; dict</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Get a credentials store dictionary. 
 
        Returns: 
            dict: Credentials store dictionary with the krb5 ccache name. 
 
        Raises: 
            InterfaceError: If 'KRB5CCNAME' environment variable is empty. 
        &quot;&quot;&quot;</span>
        <span class="s1">krb5ccname </span><span class="s4">= </span><span class="s1">os</span><span class="s4">.</span><span class="s1">environ</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span>
            <span class="s5">&quot;KRB5CCNAME&quot;</span><span class="s4">,</span>
            <span class="s4">(</span>
                <span class="s5">f&quot;/tmp/krb5cc_</span><span class="s3">{</span><span class="s1">os</span><span class="s4">.</span><span class="s1">getuid</span><span class="s4">()</span><span class="s3">}</span><span class="s5">&quot;</span>
                <span class="s3">if </span><span class="s1">os</span><span class="s4">.</span><span class="s1">name </span><span class="s4">== </span><span class="s5">&quot;posix&quot;</span>
                <span class="s3">else </span><span class="s1">Path</span><span class="s4">(</span><span class="s5">&quot;%TEMP%&quot;</span><span class="s4">).</span><span class="s1">joinpath</span><span class="s4">(</span><span class="s5">&quot;krb5cc&quot;</span><span class="s4">)</span>
            <span class="s4">),</span>
        <span class="s4">)</span>
        <span class="s3">if not </span><span class="s1">krb5ccname</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span>
                <span class="s5">&quot;The 'KRB5CCNAME' environment variable is set to empty&quot;</span>
            <span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Using krb5 ccache name: FILE:%s&quot;</span><span class="s4">, </span><span class="s1">krb5ccname</span><span class="s4">)</span>
        <span class="s1">store </span><span class="s4">= {</span><span class="s7">b&quot;ccache&quot;</span><span class="s4">: </span><span class="s5">f&quot;FILE:</span><span class="s3">{</span><span class="s1">krb5ccname</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">)}</span>
        <span class="s3">return </span><span class="s1">store</span>

    <span class="s3">def </span><span class="s1">_acquire_cred_with_password</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">upn</span><span class="s4">: </span><span class="s1">str</span><span class="s4">) </span><span class="s1">-&gt; gssapi</span><span class="s4">.</span><span class="s1">raw</span><span class="s4">.</span><span class="s1">creds</span><span class="s4">.</span><span class="s1">Creds</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Acquire and store credentials through provided password. 
 
        Args: 
            upn (str): User Principal Name. 
 
        Returns: 
            gssapi.raw.creds.Creds: GSSAPI credentials. 
        &quot;&quot;&quot;</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Attempt to acquire credentials through provided password&quot;</span><span class="s4">)</span>
        <span class="s1">user </span><span class="s4">= </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">(</span><span class="s1">upn</span><span class="s4">, </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">NameType</span><span class="s4">.</span><span class="s1">user</span><span class="s4">)</span>
        <span class="s1">password </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_password</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">(</span><span class="s5">&quot;utf-8&quot;</span><span class="s4">)</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">acquire_cred_result </span><span class="s4">= </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">raw</span><span class="s4">.</span><span class="s1">acquire_cred_with_password</span><span class="s4">(</span>
                <span class="s1">user</span><span class="s4">, </span><span class="s1">password</span><span class="s4">, </span><span class="s1">usage</span><span class="s4">=</span><span class="s5">&quot;initiate&quot;</span>
            <span class="s4">)</span>
            <span class="s1">creds </span><span class="s4">= </span><span class="s1">acquire_cred_result</span><span class="s4">.</span><span class="s1">creds</span>
            <span class="s1">gssapi</span><span class="s4">.</span><span class="s1">raw</span><span class="s4">.</span><span class="s1">store_cred_into</span><span class="s4">(</span>
                <span class="s1">self</span><span class="s4">.</span><span class="s1">get_store</span><span class="s4">(),</span>
                <span class="s1">creds</span><span class="s4">=</span><span class="s1">creds</span><span class="s4">,</span>
                <span class="s1">mech</span><span class="s4">=</span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">MechType</span><span class="s4">.</span><span class="s1">kerberos</span><span class="s4">,</span>
                <span class="s1">overwrite</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
                <span class="s1">set_default</span><span class="s4">=</span><span class="s3">True</span><span class="s4">,</span>
            <span class="s4">)</span>
        <span class="s3">except </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">raw</span><span class="s4">.</span><span class="s1">misc</span><span class="s4">.</span><span class="s1">GSSError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span>
                <span class="s5">f&quot;Unable to acquire credentials with the given password: </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span>
            <span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>
        <span class="s3">return </span><span class="s1">creds</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_parse_auth_data</span><span class="s4">(</span><span class="s1">packet</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Parse authentication data. 
 
        Get the SPN and REALM from the authentication data packet. 
 
        Format: 
            SPN string length two bytes &lt;B1&gt; &lt;B2&gt; + 
            SPN string + 
            UPN realm string length two bytes &lt;B1&gt; &lt;B2&gt; + 
            UPN realm string 
 
        Returns: 
            tuple: With 'spn' and 'realm'. 
        &quot;&quot;&quot;</span>
        <span class="s1">spn_len </span><span class="s4">= </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">unpack</span><span class="s4">(</span><span class="s5">&quot;&lt;H&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">[:</span><span class="s6">2</span><span class="s4">])[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">packet </span><span class="s4">= </span><span class="s1">packet</span><span class="s4">[</span><span class="s6">2</span><span class="s4">:]</span>

        <span class="s1">spn </span><span class="s4">= </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">unpack</span><span class="s4">(</span><span class="s5">f&quot;&lt;</span><span class="s3">{</span><span class="s1">spn_len</span><span class="s3">}</span><span class="s5">s&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">[:</span><span class="s1">spn_len</span><span class="s4">])[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">packet </span><span class="s4">= </span><span class="s1">packet</span><span class="s4">[</span><span class="s1">spn_len</span><span class="s4">:]</span>

        <span class="s1">realm_len </span><span class="s4">= </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">unpack</span><span class="s4">(</span><span class="s5">&quot;&lt;H&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">[:</span><span class="s6">2</span><span class="s4">])[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">realm </span><span class="s4">= </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">unpack</span><span class="s4">(</span><span class="s5">f&quot;&lt;</span><span class="s3">{</span><span class="s1">realm_len</span><span class="s3">}</span><span class="s5">s&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">[</span><span class="s6">2</span><span class="s4">:])[</span><span class="s6">0</span><span class="s4">]</span>

        <span class="s3">return </span><span class="s1">spn</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(), </span><span class="s1">realm</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">auth_response</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">auth_data</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">: </span><span class="s1">Any</span>
    <span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Prepare the first message to the server.&quot;&quot;&quot;</span>
        <span class="s1">spn </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">realm </span><span class="s4">= </span><span class="s3">None</span>

        <span class="s3">if </span><span class="s1">auth_data </span><span class="s3">and not </span><span class="s1">kwargs</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">&quot;ignore_auth_data&quot;</span><span class="s4">, </span><span class="s3">True</span><span class="s4">):</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">spn</span><span class="s4">, </span><span class="s1">realm </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_parse_auth_data</span><span class="s4">(</span><span class="s1">auth_data</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">error </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">InterruptedError</span><span class="s4">(</span><span class="s5">f&quot;Invalid authentication data: </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

        <span class="s3">if </span><span class="s1">spn </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">return </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_password</span><span class="s4">.</span><span class="s1">encode</span><span class="s4">() + </span><span class="s7">b&quot;</span><span class="s3">\x00</span><span class="s7">&quot;</span>

        <span class="s1">upn </span><span class="s4">= </span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_username</span><span class="s3">}</span><span class="s5">@</span><span class="s3">{</span><span class="s1">realm</span><span class="s3">}</span><span class="s5">&quot; </span><span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_username </span><span class="s3">else None</span>

        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Service Principal: %s&quot;</span><span class="s4">, </span><span class="s1">spn</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Realm: %s&quot;</span><span class="s4">, </span><span class="s1">realm</span><span class="s4">)</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s0"># Attempt to retrieve credentials from cache file</span>
            <span class="s1">creds</span><span class="s4">: </span><span class="s1">Any </span><span class="s4">= </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">Credentials</span><span class="s4">(</span><span class="s1">usage</span><span class="s4">=</span><span class="s5">&quot;initiate&quot;</span><span class="s4">)</span>
            <span class="s1">creds_upn </span><span class="s4">= </span><span class="s1">str</span><span class="s4">(</span><span class="s1">creds</span><span class="s4">.</span><span class="s1">name</span><span class="s4">)</span>

            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Cached credentials found&quot;</span><span class="s4">)</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Cached credentials UPN: %s&quot;</span><span class="s4">, </span><span class="s1">creds_upn</span><span class="s4">)</span>

            <span class="s0"># Remove the realm from user</span>
            <span class="s3">if </span><span class="s1">creds_upn</span><span class="s4">.</span><span class="s1">find</span><span class="s4">(</span><span class="s5">&quot;@&quot;</span><span class="s4">) != -</span><span class="s6">1</span><span class="s4">:</span>
                <span class="s1">creds_user</span><span class="s4">, </span><span class="s1">creds_realm </span><span class="s4">= </span><span class="s1">creds_upn</span><span class="s4">.</span><span class="s1">split</span><span class="s4">(</span><span class="s5">&quot;@&quot;</span><span class="s4">, </span><span class="s6">1</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s1">creds_user </span><span class="s4">= </span><span class="s1">creds_upn</span>
                <span class="s1">creds_realm </span><span class="s4">= </span><span class="s3">None</span>

            <span class="s1">upn </span><span class="s4">= </span><span class="s5">f&quot;</span><span class="s3">{</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_username</span><span class="s3">}</span><span class="s5">@</span><span class="s3">{</span><span class="s1">realm</span><span class="s3">}</span><span class="s5">&quot; </span><span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_username </span><span class="s3">else </span><span class="s1">creds_upn</span>

            <span class="s0"># The user from cached credentials matches with the given user?</span>
            <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_username </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_username </span><span class="s4">!= </span><span class="s1">creds_user</span><span class="s4">:</span>
                <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span>
                    <span class="s5">&quot;The user from cached credentials doesn't match with the &quot;</span>
                    <span class="s5">&quot;given user&quot;</span>
                <span class="s4">)</span>
                <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_password </span><span class="s3">is not None</span><span class="s4">:</span>
                    <span class="s1">creds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_acquire_cred_with_password</span><span class="s4">(</span><span class="s1">upn</span><span class="s4">)</span>
            <span class="s3">if </span><span class="s1">creds_realm </span><span class="s3">and </span><span class="s1">creds_realm </span><span class="s4">!= </span><span class="s1">realm </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_password </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">creds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_acquire_cred_with_password</span><span class="s4">(</span><span class="s1">upn</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">raw</span><span class="s4">.</span><span class="s1">exceptions</span><span class="s4">.</span><span class="s1">ExpiredCredentialsError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">upn </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_password </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">creds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_acquire_cred_with_password</span><span class="s4">(</span><span class="s1">upn</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">f&quot;Credentials has expired: </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>
        <span class="s3">except </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">raw</span><span class="s4">.</span><span class="s1">misc</span><span class="s4">.</span><span class="s1">GSSError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">if </span><span class="s1">upn </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_password </span><span class="s3">is not None</span><span class="s4">:</span>
                <span class="s1">creds </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_acquire_cred_with_password</span><span class="s4">(</span><span class="s1">upn</span><span class="s4">)</span>
            <span class="s3">else</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span>
                    <span class="s5">f&quot;Unable to retrieve cached credentials error: </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span>
                <span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

        <span class="s1">flags </span><span class="s4">= (</span>
            <span class="s1">gssapi</span><span class="s4">.</span><span class="s1">RequirementFlag</span><span class="s4">.</span><span class="s1">mutual_authentication</span><span class="s4">,</span>
            <span class="s1">gssapi</span><span class="s4">.</span><span class="s1">RequirementFlag</span><span class="s4">.</span><span class="s1">extended_error</span><span class="s4">,</span>
            <span class="s1">gssapi</span><span class="s4">.</span><span class="s1">RequirementFlag</span><span class="s4">.</span><span class="s1">delegate_to_peer</span><span class="s4">,</span>
        <span class="s4">)</span>
        <span class="s1">name </span><span class="s4">= </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">Name</span><span class="s4">(</span><span class="s1">spn</span><span class="s4">, </span><span class="s1">name_type</span><span class="s4">=</span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">NameType</span><span class="s4">.</span><span class="s1">kerberos_principal</span><span class="s4">)</span>
        <span class="s1">cname </span><span class="s4">= </span><span class="s1">name</span><span class="s4">.</span><span class="s1">canonicalize</span><span class="s4">(</span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">MechType</span><span class="s4">.</span><span class="s1">kerberos</span><span class="s4">)</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">context </span><span class="s4">= </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">SecurityContext</span><span class="s4">(</span>
            <span class="s1">name</span><span class="s4">=</span><span class="s1">cname</span><span class="s4">, </span><span class="s1">creds</span><span class="s4">=</span><span class="s1">creds</span><span class="s4">, </span><span class="s1">flags</span><span class="s4">=</span><span class="s1">sum</span><span class="s4">(</span><span class="s1">flags</span><span class="s4">), </span><span class="s1">usage</span><span class="s4">=</span><span class="s5">&quot;initiate&quot;</span>
        <span class="s4">)</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">initial_client_token</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">context</span><span class="s4">.</span><span class="s1">step</span><span class="s4">()</span>
        <span class="s3">except </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">raw</span><span class="s4">.</span><span class="s1">misc</span><span class="s4">.</span><span class="s1">GSSError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">f&quot;Unable to initiate security context: </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Initial client token: %s&quot;</span><span class="s4">, </span><span class="s1">initial_client_token</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">initial_client_token</span>

    <span class="s3">def </span><span class="s1">auth_continue</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">tgt_auth_challenge</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">]</span>
    <span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">], </span><span class="s1">bool</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Continue with the Kerberos TGT service request. 
 
        With the TGT authentication service given response generate a TGT 
        service request. This method must be invoked sequentially (in a loop) 
        until the security context is completed and an empty response needs to 
        be send to acknowledge the server. 
 
        Args: 
            tgt_auth_challenge: the challenge for the negotiation. 
 
        Returns: 
            tuple (bytearray TGS service request, 
            bool True if context is completed otherwise False). 
        &quot;&quot;&quot;</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;tgt_auth challenge: %s&quot;</span><span class="s4">, </span><span class="s1">tgt_auth_challenge</span><span class="s4">)</span>

        <span class="s1">resp</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">] = </span><span class="s1">self</span><span class="s4">.</span><span class="s1">context</span><span class="s4">.</span><span class="s1">step</span><span class="s4">(</span><span class="s1">tgt_auth_challenge</span><span class="s4">)</span>

        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Context step response: %s&quot;</span><span class="s4">, </span><span class="s1">resp</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Context completed?: %s&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">context</span><span class="s4">.</span><span class="s1">complete</span><span class="s4">)</span>

        <span class="s3">return </span><span class="s1">resp</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">context</span><span class="s4">.</span><span class="s1">complete</span>

    <span class="s3">def </span><span class="s1">auth_accept_close_handshake</span><span class="s4">(</span><span class="s1">self</span><span class="s4">, </span><span class="s1">message</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">) </span><span class="s1">-&gt; bytes</span><span class="s4">:</span>
        <span class="s2">&quot;&quot;&quot;Accept handshake and generate closing handshake message for server. 
 
        This method verifies the server authenticity from the given message 
        and included signature and generates the closing handshake for the 
        server. 
 
        When this method is invoked the security context is already established 
        and the client and server can send GSSAPI formated secure messages. 
 
        To finish the authentication handshake the server sends a message 
        with the security layer availability and the maximum buffer size. 
 
        Since the connector only uses the GSSAPI authentication mechanism to 
        authenticate the user with the server, the server will verify clients 
        message signature and terminate the GSSAPI authentication and send two 
        messages; an authentication acceptance b'\x01\x00\x00\x08\x01' and a 
        OK packet (that must be received after sent the returned message from 
        this method). 
 
        Args: 
            message: a wrapped gssapi message from the server. 
 
        Returns: 
            bytearray (closing handshake message to be send to the server). 
        &quot;&quot;&quot;</span>
        <span class="s3">if not </span><span class="s1">self</span><span class="s4">.</span><span class="s1">context</span><span class="s4">.</span><span class="s1">complete</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span><span class="s5">&quot;Security context is not completed&quot;</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Server message: %s&quot;</span><span class="s4">, </span><span class="s1">message</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;GSSAPI flags in use: %s&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">context</span><span class="s4">.</span><span class="s1">actual_flags</span><span class="s4">)</span>
        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">unwraped </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">context</span><span class="s4">.</span><span class="s1">unwrap</span><span class="s4">(</span><span class="s1">message</span><span class="s4">)</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Unwraped: %s&quot;</span><span class="s4">, </span><span class="s1">unwraped</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">gssapi</span><span class="s4">.</span><span class="s1">raw</span><span class="s4">.</span><span class="s1">exceptions</span><span class="s4">.</span><span class="s1">BadMICError </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Unable to unwrap server message: %s&quot;</span><span class="s4">, </span><span class="s1">err</span><span class="s4">)</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">f&quot;Unable to unwrap server message: </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Unwrapped server message: %s&quot;</span><span class="s4">, </span><span class="s1">unwraped</span><span class="s4">)</span>
        <span class="s0"># The message contents for the clients closing message:</span>
        <span class="s0">#   - security level 1 byte, must be always 1.</span>
        <span class="s0">#   - conciliated buffer size 3 bytes, without importance as no</span>
        <span class="s0">#     further GSSAPI messages will be sends.</span>
        <span class="s1">response </span><span class="s4">= </span><span class="s1">bytearray</span><span class="s4">(</span><span class="s7">b&quot;</span><span class="s3">\x01\x00\x00\00</span><span class="s7">&quot;</span><span class="s4">)</span>
        <span class="s0"># Closing handshake must not be encrypted.</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Message response: %s&quot;</span><span class="s4">, </span><span class="s1">response</span><span class="s4">)</span>
        <span class="s1">wraped </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">context</span><span class="s4">.</span><span class="s1">wrap</span><span class="s4">(</span><span class="s1">response</span><span class="s4">, </span><span class="s1">encrypt</span><span class="s4">=</span><span class="s3">False</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span>
            <span class="s5">&quot;Wrapped message response: %s, length: %d&quot;</span><span class="s4">,</span>
            <span class="s1">wraped</span><span class="s4">[</span><span class="s6">0</span><span class="s4">],</span>
            <span class="s1">len</span><span class="s4">(</span><span class="s1">wraped</span><span class="s4">[</span><span class="s6">0</span><span class="s4">]),</span>
        <span class="s4">)</span>

        <span class="s3">return </span><span class="s1">wraped</span><span class="s4">.</span><span class="s1">message</span>


<span class="s3">class </span><span class="s1">MySQLSSPIKerberosAuthPlugin</span><span class="s4">(</span><span class="s1">MySQLBaseKerberosAuthPlugin</span><span class="s4">):</span>
    <span class="s2">&quot;&quot;&quot;Implement the MySQL Kerberos authentication plugin with Windows SSPI&quot;&quot;&quot;</span>

    <span class="s1">context</span><span class="s4">: </span><span class="s1">Any </span><span class="s4">= </span><span class="s3">None</span>
    <span class="s1">clientauth</span><span class="s4">: </span><span class="s1">Any </span><span class="s4">= </span><span class="s3">None</span>

    <span class="s4">@</span><span class="s1">staticmethod</span>
    <span class="s3">def </span><span class="s1">_parse_auth_data</span><span class="s4">(</span><span class="s1">packet</span><span class="s4">: </span><span class="s1">bytes</span><span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">str</span><span class="s4">, </span><span class="s1">str</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Parse authentication data. 
 
        Get the SPN and REALM from the authentication data packet. 
 
        Format: 
            SPN string length two bytes &lt;B1&gt; &lt;B2&gt; + 
            SPN string + 
            UPN realm string length two bytes &lt;B1&gt; &lt;B2&gt; + 
            UPN realm string 
 
        Returns: 
            tuple: With 'spn' and 'realm'. 
        &quot;&quot;&quot;</span>
        <span class="s1">spn_len </span><span class="s4">= </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">unpack</span><span class="s4">(</span><span class="s5">&quot;&lt;H&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">[:</span><span class="s6">2</span><span class="s4">])[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">packet </span><span class="s4">= </span><span class="s1">packet</span><span class="s4">[</span><span class="s6">2</span><span class="s4">:]</span>

        <span class="s1">spn </span><span class="s4">= </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">unpack</span><span class="s4">(</span><span class="s5">f&quot;&lt;</span><span class="s3">{</span><span class="s1">spn_len</span><span class="s3">}</span><span class="s5">s&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">[:</span><span class="s1">spn_len</span><span class="s4">])[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">packet </span><span class="s4">= </span><span class="s1">packet</span><span class="s4">[</span><span class="s1">spn_len</span><span class="s4">:]</span>

        <span class="s1">realm_len </span><span class="s4">= </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">unpack</span><span class="s4">(</span><span class="s5">&quot;&lt;H&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">[:</span><span class="s6">2</span><span class="s4">])[</span><span class="s6">0</span><span class="s4">]</span>
        <span class="s1">realm </span><span class="s4">= </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">unpack</span><span class="s4">(</span><span class="s5">f&quot;&lt;</span><span class="s3">{</span><span class="s1">realm_len</span><span class="s3">}</span><span class="s5">s&quot;</span><span class="s4">, </span><span class="s1">packet</span><span class="s4">[</span><span class="s6">2</span><span class="s4">:])[</span><span class="s6">0</span><span class="s4">]</span>

        <span class="s3">return </span><span class="s1">spn</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">(), </span><span class="s1">realm</span><span class="s4">.</span><span class="s1">decode</span><span class="s4">()</span>

    <span class="s3">def </span><span class="s1">auth_response</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">auth_data</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">] = </span><span class="s3">None</span><span class="s4">, **</span><span class="s1">kwargs</span><span class="s4">: </span><span class="s1">Any</span>
    <span class="s4">) </span><span class="s1">-&gt; Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Prepare the first message to the server. 
 
        Args: 
            kwargs: 
                ignore_auth_data (bool): if True, the provided auth data is ignored. 
        &quot;&quot;&quot;</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;auth_response for sspi&quot;</span><span class="s4">)</span>
        <span class="s1">spn </span><span class="s4">= </span><span class="s3">None</span>
        <span class="s1">realm </span><span class="s4">= </span><span class="s3">None</span>

        <span class="s3">if </span><span class="s1">auth_data </span><span class="s3">and not </span><span class="s1">kwargs</span><span class="s4">.</span><span class="s1">get</span><span class="s4">(</span><span class="s5">&quot;ignore_auth_data&quot;</span><span class="s4">, </span><span class="s3">True</span><span class="s4">):</span>
            <span class="s3">try</span><span class="s4">:</span>
                <span class="s1">spn</span><span class="s4">, </span><span class="s1">realm </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_parse_auth_data</span><span class="s4">(</span><span class="s1">auth_data</span><span class="s4">)</span>
            <span class="s3">except </span><span class="s1">struct</span><span class="s4">.</span><span class="s1">error </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
                <span class="s3">raise </span><span class="s1">InterruptedError</span><span class="s4">(</span><span class="s5">f&quot;Invalid authentication data: </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Service Principal: %s&quot;</span><span class="s4">, </span><span class="s1">spn</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Realm: %s&quot;</span><span class="s4">, </span><span class="s1">realm</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">sspicon </span><span class="s3">is None or </span><span class="s1">sspi </span><span class="s3">is None</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">ProgrammingError</span><span class="s4">(</span>
                <span class="s5">'Package &quot;pywin32&quot; (Python for Win32 (pywin32) extensions)'</span>
                <span class="s5">&quot; is not installed.&quot;</span>
            <span class="s4">)</span>

        <span class="s1">flags </span><span class="s4">= (</span><span class="s1">sspicon</span><span class="s4">.</span><span class="s1">ISC_REQ_MUTUAL_AUTH</span><span class="s4">, </span><span class="s1">sspicon</span><span class="s4">.</span><span class="s1">ISC_REQ_DELEGATE</span><span class="s4">)</span>

        <span class="s3">if </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_username </span><span class="s3">and </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_password</span><span class="s4">:</span>
            <span class="s1">_auth_info </span><span class="s4">= (</span><span class="s1">self</span><span class="s4">.</span><span class="s1">_username</span><span class="s4">, </span><span class="s1">realm</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">_password</span><span class="s4">)</span>
        <span class="s3">else</span><span class="s4">:</span>
            <span class="s1">_auth_info </span><span class="s4">= </span><span class="s3">None</span>

        <span class="s1">targetspn </span><span class="s4">= </span><span class="s1">spn</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;targetspn: %s&quot;</span><span class="s4">, </span><span class="s1">targetspn</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;_auth_info is None: %s&quot;</span><span class="s4">, </span><span class="s1">_auth_info </span><span class="s3">is None</span><span class="s4">)</span>

        <span class="s0"># The Security Support Provider Interface (SSPI) is an interface</span>
        <span class="s0"># that allows us to choose from a set of SSPs available in the</span>
        <span class="s0"># system; the idea of SSPI is to keep interface consistent no</span>
        <span class="s0"># matter what back end (a.k.a., SSP) we choose.</span>

        <span class="s0"># When using SSPI we should not use Kerberos directly as SSP,</span>
        <span class="s0"># as remarked in [2], but we can use it indirectly via another</span>
        <span class="s0"># SSP named Negotiate that acts as an application layer between</span>
        <span class="s0"># SSPI and the other SSPs [1].</span>

        <span class="s0"># Negotiate can select between Kerberos and NTLM on the fly;</span>
        <span class="s0"># it chooses Kerberos unless it cannot be used by one of the</span>
        <span class="s0"># systems involved in the authentication or the calling</span>
        <span class="s0"># application did not provide sufficient information to use</span>
        <span class="s0"># Kerberos.</span>

        <span class="s0"># prefix: https://docs.microsoft.com/en-us/windows/win32/secauthn</span>
        <span class="s0"># [1] prefix/microsoft-negotiate?source=recommendations</span>
        <span class="s0"># [2] prefix/microsoft-kerberos?source=recommendations</span>
        <span class="s1">self</span><span class="s4">.</span><span class="s1">clientauth </span><span class="s4">= </span><span class="s1">sspi</span><span class="s4">.</span><span class="s1">ClientAuth</span><span class="s4">(</span>
            <span class="s5">&quot;Negotiate&quot;</span><span class="s4">,</span>
            <span class="s1">targetspn</span><span class="s4">=</span><span class="s1">targetspn</span><span class="s4">,</span>
            <span class="s1">auth_info</span><span class="s4">=</span><span class="s1">_auth_info</span><span class="s4">,</span>
            <span class="s1">scflags</span><span class="s4">=</span><span class="s1">sum</span><span class="s4">(</span><span class="s1">flags</span><span class="s4">),</span>
            <span class="s1">datarep</span><span class="s4">=</span><span class="s1">sspicon</span><span class="s4">.</span><span class="s1">SECURITY_NETWORK_DREP</span><span class="s4">,</span>
        <span class="s4">)</span>

        <span class="s3">try</span><span class="s4">:</span>
            <span class="s1">data </span><span class="s4">= </span><span class="s3">None</span>
            <span class="s1">err</span><span class="s4">, </span><span class="s1">out_buf </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">clientauth</span><span class="s4">.</span><span class="s1">authorize</span><span class="s4">(</span><span class="s1">data</span><span class="s4">)</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Context step err: %s&quot;</span><span class="s4">, </span><span class="s1">err</span><span class="s4">)</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Context step out_buf: %s&quot;</span><span class="s4">, </span><span class="s1">out_buf</span><span class="s4">)</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Context completed?: %s&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">clientauth</span><span class="s4">.</span><span class="s1">authenticated</span><span class="s4">)</span>
            <span class="s1">initial_client_token </span><span class="s4">= </span><span class="s1">out_buf</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">Buffer</span>
            <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;pkg_info: %s&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">clientauth</span><span class="s4">.</span><span class="s1">pkg_info</span><span class="s4">)</span>
        <span class="s3">except </span><span class="s1">Exception </span><span class="s3">as </span><span class="s1">err</span><span class="s4">:</span>
            <span class="s3">raise </span><span class="s1">InterfaceError</span><span class="s4">(</span><span class="s5">f&quot;Unable to initiate security context: </span><span class="s3">{</span><span class="s1">err</span><span class="s3">}</span><span class="s5">&quot;</span><span class="s4">) </span><span class="s3">from </span><span class="s1">err</span>

        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Initial client token: %s&quot;</span><span class="s4">, </span><span class="s1">initial_client_token</span><span class="s4">)</span>
        <span class="s3">return </span><span class="s1">initial_client_token</span>

    <span class="s3">def </span><span class="s1">auth_continue</span><span class="s4">(</span>
        <span class="s1">self</span><span class="s4">, </span><span class="s1">tgt_auth_challenge</span><span class="s4">: </span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">]</span>
    <span class="s4">) </span><span class="s1">-&gt; Tuple</span><span class="s4">[</span><span class="s1">Optional</span><span class="s4">[</span><span class="s1">bytes</span><span class="s4">], </span><span class="s1">bool</span><span class="s4">]:</span>
        <span class="s2">&quot;&quot;&quot;Continue with the Kerberos TGT service request. 
 
        With the TGT authentication service given response generate a TGT 
        service request. This method must be invoked sequentially (in a loop) 
        until the security context is completed and an empty response needs to 
        be send to acknowledge the server. 
 
        Args: 
            tgt_auth_challenge: the challenge for the negotiation. 
 
        Returns: 
            tuple (bytearray TGS service request, 
            bool True if context is completed otherwise False). 
        &quot;&quot;&quot;</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;tgt_auth challenge: %s&quot;</span><span class="s4">, </span><span class="s1">tgt_auth_challenge</span><span class="s4">)</span>

        <span class="s1">err</span><span class="s4">, </span><span class="s1">out_buf </span><span class="s4">= </span><span class="s1">self</span><span class="s4">.</span><span class="s1">clientauth</span><span class="s4">.</span><span class="s1">authorize</span><span class="s4">(</span><span class="s1">tgt_auth_challenge</span><span class="s4">)</span>

        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Context step err: %s&quot;</span><span class="s4">, </span><span class="s1">err</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Context step out_buf: %s&quot;</span><span class="s4">, </span><span class="s1">out_buf</span><span class="s4">)</span>
        <span class="s1">resp </span><span class="s4">= </span><span class="s1">out_buf</span><span class="s4">[</span><span class="s6">0</span><span class="s4">].</span><span class="s1">Buffer</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Context step resp: %s&quot;</span><span class="s4">, </span><span class="s1">resp</span><span class="s4">)</span>
        <span class="s1">logger</span><span class="s4">.</span><span class="s1">debug</span><span class="s4">(</span><span class="s5">&quot;Context completed?: %s&quot;</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">clientauth</span><span class="s4">.</span><span class="s1">authenticated</span><span class="s4">)</span>

        <span class="s3">return </span><span class="s1">resp</span><span class="s4">, </span><span class="s1">self</span><span class="s4">.</span><span class="s1">clientauth</span><span class="s4">.</span><span class="s1">authenticated</span>
</pre>
</body>
</html>