<html>
<head>
<title>test_backend_svg.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #2aacb8;}
.s4 { color: #6aab73;}
.s5 { color: #7a7e85;}
.s6 { color: #5f826b; font-style: italic;}
.s7 { color: #a5c261;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_backend_svg.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">datetime</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">BytesIO</span>
<span class="s0">from </span><span class="s1">pathlib </span><span class="s0">import </span><span class="s1">Path</span>
<span class="s0">import </span><span class="s1">xml</span><span class="s2">.</span><span class="s1">etree</span><span class="s2">.</span><span class="s1">ElementTree</span>
<span class="s0">import </span><span class="s1">xml</span><span class="s2">.</span><span class="s1">parsers</span><span class="s2">.</span><span class="s1">expat</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>

<span class="s0">import </span><span class="s1">matplotlib </span><span class="s0">as </span><span class="s1">mpl</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">figure </span><span class="s0">import </span><span class="s1">Figure</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">text </span><span class="s0">import </span><span class="s1">Text</span>
<span class="s0">import </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">decorators </span><span class="s0">import </span><span class="s1">check_figures_equal</span><span class="s2">, </span><span class="s1">image_comparison</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">testing</span><span class="s2">.</span><span class="s1">_markers </span><span class="s0">import </span><span class="s1">needs_usetex</span>
<span class="s0">from </span><span class="s1">matplotlib </span><span class="s0">import </span><span class="s1">font_manager </span><span class="s0">as </span><span class="s1">fm</span>
<span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">offsetbox </span><span class="s0">import </span><span class="s2">(</span><span class="s1">OffsetImage</span><span class="s2">, </span><span class="s1">AnnotationBbox</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_visibility</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">4 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">, </span><span class="s3">50</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">yerr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones_like</span><span class="s2">(</span><span class="s1">y</span><span class="s2">)</span>

    <span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">c </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">errorbar</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">yerr</span><span class="s2">=</span><span class="s1">yerr</span><span class="s2">, </span><span class="s1">fmt</span><span class="s2">=</span><span class="s4">'ko'</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">artist </span><span class="s0">in </span><span class="s1">b</span><span class="s2">:</span>
        <span class="s1">artist</span><span class="s2">.</span><span class="s1">set_visible</span><span class="s2">(</span><span class="s0">False</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">)</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">()</span>

    <span class="s1">parser </span><span class="s2">= </span><span class="s1">xml</span><span class="s2">.</span><span class="s1">parsers</span><span class="s2">.</span><span class="s1">expat</span><span class="s2">.</span><span class="s1">ParserCreate</span><span class="s2">()</span>
    <span class="s1">parser</span><span class="s2">.</span><span class="s1">Parse</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)  </span><span class="s5"># this will raise ExpatError if the svg is invalid</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'fill_black_with_alpha.svg'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_fill_black_with_alpha</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">(</span><span class="s1">x</span><span class="s2">=[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0.1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">y</span><span class="s2">=[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s1">c</span><span class="s2">=</span><span class="s4">'k'</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">=</span><span class="s3">0.1</span><span class="s2">, </span><span class="s1">s</span><span class="s2">=</span><span class="s3">10000</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'noscale'</span><span class="s2">], </span><span class="s1">remove_text</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_noscale</span><span class="s2">():</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">meshgrid</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(-</span><span class="s3">5</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">1</span><span class="s2">))</span>
    <span class="s1">Z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">Y </span><span class="s2">** </span><span class="s3">2</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">(</span><span class="s1">Z</span><span class="s2">, </span><span class="s1">cmap</span><span class="s2">=</span><span class="s4">'gray'</span><span class="s2">, </span><span class="s1">interpolation</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_text_urls</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>

    <span class="s1">test_url </span><span class="s2">= </span><span class="s4">&quot;http://test_text_urls.matplotlib.org&quot;</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">suptitle</span><span class="s2">(</span><span class="s4">&quot;test_text_urls&quot;</span><span class="s2">, </span><span class="s1">url</span><span class="s2">=</span><span class="s1">test_url</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">)</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">()</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s4">f'&lt;a xlink:href=&quot;</span><span class="s0">{</span><span class="s1">test_url</span><span class="s0">}</span><span class="s4">&quot;&gt;'</span>
    <span class="s0">assert </span><span class="s1">expected </span><span class="s0">in </span><span class="s1">buf</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'bold_font_output.svg'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_bold_font_output</span><span class="s2">():</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s4">'nonbold-xlabel'</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s4">'bold-ylabel'</span><span class="s2">, </span><span class="s1">fontweight</span><span class="s2">=</span><span class="s4">'bold'</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s4">'bold-title'</span><span class="s2">, </span><span class="s1">fontweight</span><span class="s2">=</span><span class="s4">'bold'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">'bold_font_output_with_none_fonttype.svg'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_bold_font_output_with_none_fonttype</span><span class="s2">():</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">'svg.fonttype'</span><span class="s2">] = </span><span class="s4">'none'</span>
    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">10</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlabel</span><span class="s2">(</span><span class="s4">'nonbold-xlabel'</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylabel</span><span class="s2">(</span><span class="s4">'bold-ylabel'</span><span class="s2">, </span><span class="s1">fontweight</span><span class="s2">=</span><span class="s4">'bold'</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_title</span><span class="s2">(</span><span class="s4">'bold-title'</span><span class="s2">, </span><span class="s1">fontweight</span><span class="s2">=</span><span class="s4">'bold'</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">tol</span><span class="s2">=</span><span class="s3">20</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_rasterized</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">100</span><span class="s2">) * (</span><span class="s3">2.3</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)</span>

    <span class="s1">ax_ref </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">&quot;-&quot;</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">&quot;r&quot;</span><span class="s2">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s3">10</span><span class="s2">)</span>
    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">+</span><span class="s3">1</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">&quot;-&quot;</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s3">10</span><span class="s2">)</span>

    <span class="s1">ax_test </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">&quot;-&quot;</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">&quot;r&quot;</span><span class="s2">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">+</span><span class="s3">1</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">&quot;-&quot;</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">()</span>
<span class="s0">def </span><span class="s1">test_rasterized_ordering</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">100</span><span class="s2">) * (</span><span class="s3">2.3</span><span class="s2">)</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)</span>

    <span class="s1">ax_ref </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(-</span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">1.1</span><span class="s2">)</span>
    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">&quot;-&quot;</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">&quot;r&quot;</span><span class="s2">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">+</span><span class="s3">1</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">&quot;-&quot;</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">+</span><span class="s3">2</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">&quot;-&quot;</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">&quot;g&quot;</span><span class="s2">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">+</span><span class="s3">3</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">&quot;-&quot;</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">&quot;m&quot;</span><span class="s2">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">ax_test </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(-</span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">1.1</span><span class="s2">)</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">&quot;-&quot;</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">&quot;r&quot;</span><span class="s2">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">zorder</span><span class="s2">=</span><span class="s3">1.1</span><span class="s2">)</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">+</span><span class="s3">2</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">&quot;-&quot;</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">&quot;g&quot;</span><span class="s2">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">zorder</span><span class="s2">=</span><span class="s3">1.3</span><span class="s2">)</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">+</span><span class="s3">3</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">&quot;-&quot;</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">&quot;m&quot;</span><span class="s2">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">zorder</span><span class="s2">=</span><span class="s3">1.4</span><span class="s2">)</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">+</span><span class="s3">1</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">&quot;-&quot;</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s1">lw</span><span class="s2">=</span><span class="s3">10</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">, </span><span class="s1">zorder</span><span class="s2">=</span><span class="s3">1.2</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">check_figures_equal</span><span class="s2">(</span><span class="s1">tol</span><span class="s2">=</span><span class="s3">5</span><span class="s2">, </span><span class="s1">extensions</span><span class="s2">=[</span><span class="s4">'svg'</span><span class="s2">, </span><span class="s4">'pdf'</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_prevent_rasterization</span><span class="s2">(</span><span class="s1">fig_test</span><span class="s2">, </span><span class="s1">fig_ref</span><span class="s2">):</span>
    <span class="s1">loc </span><span class="s2">= [</span><span class="s3">0.05</span><span class="s2">, </span><span class="s3">0.05</span><span class="s2">]</span>

    <span class="s1">ax_ref </span><span class="s2">= </span><span class="s1">fig_ref</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s1">loc</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]], [</span><span class="s1">loc</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]], </span><span class="s1">marker</span><span class="s2">=</span><span class="s4">&quot;x&quot;</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">&quot;black&quot;</span><span class="s2">, </span><span class="s1">zorder</span><span class="s2">=</span><span class="s3">2</span><span class="s2">)</span>

    <span class="s1">b </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">offsetbox</span><span class="s2">.</span><span class="s1">TextArea</span><span class="s2">(</span><span class="s4">&quot;X&quot;</span><span class="s2">)</span>
    <span class="s1">abox </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">offsetbox</span><span class="s2">.</span><span class="s1">AnnotationBbox</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">, </span><span class="s1">zorder</span><span class="s2">=</span><span class="s3">2.1</span><span class="s2">)</span>
    <span class="s1">ax_ref</span><span class="s2">.</span><span class="s1">add_artist</span><span class="s2">(</span><span class="s1">abox</span><span class="s2">)</span>

    <span class="s1">ax_test </span><span class="s2">= </span><span class="s1">fig_test</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s1">loc</span><span class="s2">[</span><span class="s3">0</span><span class="s2">]], [</span><span class="s1">loc</span><span class="s2">[</span><span class="s3">1</span><span class="s2">]], </span><span class="s1">marker</span><span class="s2">=</span><span class="s4">&quot;x&quot;</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s4">&quot;black&quot;</span><span class="s2">, </span><span class="s1">zorder</span><span class="s2">=</span><span class="s3">2</span><span class="s2">,</span>
                 <span class="s1">rasterized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s1">b </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">offsetbox</span><span class="s2">.</span><span class="s1">TextArea</span><span class="s2">(</span><span class="s4">&quot;X&quot;</span><span class="s2">)</span>
    <span class="s1">abox </span><span class="s2">= </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">offsetbox</span><span class="s2">.</span><span class="s1">AnnotationBbox</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">loc</span><span class="s2">, </span><span class="s1">zorder</span><span class="s2">=</span><span class="s3">2.1</span><span class="s2">)</span>
    <span class="s1">ax_test</span><span class="s2">.</span><span class="s1">add_artist</span><span class="s2">(</span><span class="s1">abox</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_count_bitmaps</span><span class="s2">():</span>
    <span class="s0">def </span><span class="s1">count_tag</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">, </span><span class="s1">tag</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
            <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">)</span>
            <span class="s1">buf </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">()</span>
        <span class="s0">return </span><span class="s1">buf</span><span class="s2">.</span><span class="s1">count</span><span class="s2">(</span><span class="s4">f&quot;&lt;</span><span class="s0">{</span><span class="s1">tag</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">)</span>

    <span class="s5"># No rasterized elements</span>
    <span class="s1">fig1 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax1 </span><span class="s2">= </span><span class="s1">fig1</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">set_axis_off</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">5</span><span class="s2">):</span>
        <span class="s1">ax1</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">20</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s1">n</span><span class="s2">], </span><span class="s4">&quot;b-&quot;</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">count_tag</span><span class="s2">(</span><span class="s1">fig1</span><span class="s2">, </span><span class="s4">&quot;image&quot;</span><span class="s2">) == </span><span class="s3">0</span>
    <span class="s0">assert </span><span class="s1">count_tag</span><span class="s2">(</span><span class="s1">fig1</span><span class="s2">, </span><span class="s4">&quot;path&quot;</span><span class="s2">) == </span><span class="s3">6  </span><span class="s5"># axis patch plus lines</span>

    <span class="s5"># rasterized can be merged</span>
    <span class="s1">fig2 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax2 </span><span class="s2">= </span><span class="s1">fig2</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">set_axis_off</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">5</span><span class="s2">):</span>
        <span class="s1">ax2</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">20</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s1">n</span><span class="s2">], </span><span class="s4">&quot;b-&quot;</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">count_tag</span><span class="s2">(</span><span class="s1">fig2</span><span class="s2">, </span><span class="s4">&quot;image&quot;</span><span class="s2">) == </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">count_tag</span><span class="s2">(</span><span class="s1">fig2</span><span class="s2">, </span><span class="s4">&quot;path&quot;</span><span class="s2">) == </span><span class="s3">1  </span><span class="s5"># axis patch</span>

    <span class="s5"># rasterized can't be merged without affecting draw order</span>
    <span class="s1">fig3 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax3 </span><span class="s2">= </span><span class="s1">fig3</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">ax3</span><span class="s2">.</span><span class="s1">set_axis_off</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">5</span><span class="s2">):</span>
        <span class="s1">ax3</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">20</span><span class="s2">], [</span><span class="s1">n</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s4">&quot;b-&quot;</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ax3</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">20</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s1">n</span><span class="s2">], </span><span class="s4">&quot;b-&quot;</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">count_tag</span><span class="s2">(</span><span class="s1">fig3</span><span class="s2">, </span><span class="s4">&quot;image&quot;</span><span class="s2">) == </span><span class="s3">5</span>
    <span class="s0">assert </span><span class="s1">count_tag</span><span class="s2">(</span><span class="s1">fig3</span><span class="s2">, </span><span class="s4">&quot;path&quot;</span><span class="s2">) == </span><span class="s3">6</span>

    <span class="s5"># rasterized whole axes</span>
    <span class="s1">fig4 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax4 </span><span class="s2">= </span><span class="s1">fig4</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">ax4</span><span class="s2">.</span><span class="s1">set_axis_off</span><span class="s2">()</span>
    <span class="s1">ax4</span><span class="s2">.</span><span class="s1">set_rasterized</span><span class="s2">(</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">5</span><span class="s2">):</span>
        <span class="s1">ax4</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">20</span><span class="s2">], [</span><span class="s1">n</span><span class="s2">, </span><span class="s3">0</span><span class="s2">], </span><span class="s4">&quot;b-&quot;</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">ax4</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">20</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s1">n</span><span class="s2">], </span><span class="s4">&quot;b-&quot;</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">count_tag</span><span class="s2">(</span><span class="s1">fig4</span><span class="s2">, </span><span class="s4">&quot;image&quot;</span><span class="s2">) == </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">count_tag</span><span class="s2">(</span><span class="s1">fig4</span><span class="s2">, </span><span class="s4">&quot;path&quot;</span><span class="s2">) == </span><span class="s3">1</span>

    <span class="s5"># rasterized can be merged, but inhibited by suppressComposite</span>
    <span class="s1">fig5 </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">fig5</span><span class="s2">.</span><span class="s1">suppressComposite </span><span class="s2">= </span><span class="s0">True</span>
    <span class="s1">ax5 </span><span class="s2">= </span><span class="s1">fig5</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">)</span>
    <span class="s1">ax5</span><span class="s2">.</span><span class="s1">set_axis_off</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s3">5</span><span class="s2">):</span>
        <span class="s1">ax5</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">20</span><span class="s2">], [</span><span class="s3">0</span><span class="s2">, </span><span class="s1">n</span><span class="s2">], </span><span class="s4">&quot;b-&quot;</span><span class="s2">, </span><span class="s1">rasterized</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">count_tag</span><span class="s2">(</span><span class="s1">fig5</span><span class="s2">, </span><span class="s4">&quot;image&quot;</span><span class="s2">) == </span><span class="s3">5</span>
    <span class="s0">assert </span><span class="s1">count_tag</span><span class="s2">(</span><span class="s1">fig5</span><span class="s2">, </span><span class="s4">&quot;path&quot;</span><span class="s2">) == </span><span class="s3">1  </span><span class="s5"># axis patch</span>


<span class="s5"># Use Computer Modern Sans Serif, not Helvetica (which has no \textwon).</span>
<span class="s2">@</span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">style</span><span class="s2">.</span><span class="s1">context</span><span class="s2">(</span><span class="s4">'default'</span><span class="s2">)</span>
<span class="s2">@</span><span class="s1">needs_usetex</span>
<span class="s0">def </span><span class="s1">test_unicode_won</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">Figure</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s3">.5</span><span class="s2">, </span><span class="s3">.5</span><span class="s2">, </span><span class="s4">r'\textwon'</span><span class="s2">, </span><span class="s1">usetex</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">)</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">()</span>

    <span class="s1">tree </span><span class="s2">= </span><span class="s1">xml</span><span class="s2">.</span><span class="s1">etree</span><span class="s2">.</span><span class="s1">ElementTree</span><span class="s2">.</span><span class="s1">fromstring</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
    <span class="s1">ns </span><span class="s2">= </span><span class="s4">'http://www.w3.org/2000/svg'</span>
    <span class="s1">won_id </span><span class="s2">= </span><span class="s4">'SFSS3583-8e'</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">tree</span><span class="s2">.</span><span class="s1">findall</span><span class="s2">(</span><span class="s4">f'.//</span><span class="s0">{{{</span><span class="s1">ns</span><span class="s0">}}}</span><span class="s4">path[@d][@id=&quot;</span><span class="s0">{</span><span class="s1">won_id</span><span class="s0">}</span><span class="s4">&quot;]'</span><span class="s2">)) == </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s4">f'#</span><span class="s0">{</span><span class="s1">won_id</span><span class="s0">}</span><span class="s4">' </span><span class="s0">in </span><span class="s1">tree</span><span class="s2">.</span><span class="s1">find</span><span class="s2">(</span><span class="s4">f'.//</span><span class="s0">{{{</span><span class="s1">ns</span><span class="s0">}}}</span><span class="s4">use'</span><span class="s2">).</span><span class="s1">attrib</span><span class="s2">.</span><span class="s1">values</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">test_svgnone_with_data_coordinates</span><span class="s2">():</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">.</span><span class="s1">update</span><span class="s2">({</span><span class="s4">'svg.fonttype'</span><span class="s2">: </span><span class="s4">'none'</span><span class="s2">, </span><span class="s4">'font.stretch'</span><span class="s2">: </span><span class="s4">'condensed'</span><span class="s2">})</span>
    <span class="s1">expected </span><span class="s2">= </span><span class="s4">'Unlikely to appear by chance'</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s4">'2019-06-30'</span><span class="s2">), </span><span class="s3">1</span><span class="s2">, </span><span class="s1">expected</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_xlim</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s4">'2019-01-01'</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">datetime64</span><span class="s2">(</span><span class="s4">'2019-12-31'</span><span class="s2">))</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">set_ylim</span><span class="s2">(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">)</span>
        <span class="s1">fd</span><span class="s2">.</span><span class="s1">seek</span><span class="s2">(</span><span class="s3">0</span><span class="s2">)</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">read</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">()</span>

    <span class="s0">assert </span><span class="s1">expected </span><span class="s0">in </span><span class="s1">buf </span><span class="s0">and </span><span class="s4">&quot;condensed&quot; </span><span class="s0">in </span><span class="s1">buf</span>


<span class="s0">def </span><span class="s1">test_gid</span><span class="s2">():</span>
    <span class="s6">&quot;&quot;&quot;Test that object gid appears in output svg.&quot;&quot;&quot;</span>
    <span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">offsetbox </span><span class="s0">import </span><span class="s1">OffsetBox</span>
    <span class="s0">from </span><span class="s1">matplotlib</span><span class="s2">.</span><span class="s1">axis </span><span class="s0">import </span><span class="s1">Tick</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>

    <span class="s1">ax1 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s3">131</span><span class="s2">)</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">imshow</span><span class="s2">([[</span><span class="s3">1.</span><span class="s2">, </span><span class="s3">2.</span><span class="s2">], [</span><span class="s3">2.</span><span class="s2">, </span><span class="s3">3.</span><span class="s2">]], </span><span class="s1">aspect</span><span class="s2">=</span><span class="s4">&quot;auto&quot;</span><span class="s2">)</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], </span><span class="s1">label</span><span class="s2">=</span><span class="s4">&quot;myscatter&quot;</span><span class="s2">)</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s2">], </span><span class="s1">label</span><span class="s2">=</span><span class="s4">&quot;myplot&quot;</span><span class="s2">)</span>
    <span class="s1">ax1</span><span class="s2">.</span><span class="s1">legend</span><span class="s2">()</span>
    <span class="s1">ax1a </span><span class="s2">= </span><span class="s1">ax1</span><span class="s2">.</span><span class="s1">twinx</span><span class="s2">()</span>
    <span class="s1">ax1a</span><span class="s2">.</span><span class="s1">bar</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>

    <span class="s1">ax2 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s3">132</span><span class="s2">, </span><span class="s1">projection</span><span class="s2">=</span><span class="s4">&quot;polar&quot;</span><span class="s2">)</span>
    <span class="s1">ax2</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">])</span>

    <span class="s1">ax3 </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">(</span><span class="s3">133</span><span class="s2">, </span><span class="s1">projection</span><span class="s2">=</span><span class="s4">&quot;3d&quot;</span><span class="s2">)</span>
    <span class="s1">ax3</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">], [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">])</span>

    <span class="s1">fig</span><span class="s2">.</span><span class="s1">canvas</span><span class="s2">.</span><span class="s1">draw</span><span class="s2">()</span>

    <span class="s1">gdic </span><span class="s2">= {}</span>
    <span class="s0">for </span><span class="s1">idx</span><span class="s2">, </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">fig</span><span class="s2">.</span><span class="s1">findobj</span><span class="s2">(</span><span class="s1">include_self</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)):</span>
        <span class="s0">if </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">get_visible</span><span class="s2">():</span>
            <span class="s1">gid </span><span class="s2">= </span><span class="s4">f&quot;test123</span><span class="s0">{</span><span class="s1">obj</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">.</span><span class="s1">__name__</span><span class="s0">}</span><span class="s4">_</span><span class="s0">{</span><span class="s1">idx</span><span class="s0">}</span><span class="s4">&quot;</span>
            <span class="s1">gdic</span><span class="s2">[</span><span class="s1">gid</span><span class="s2">] = </span><span class="s1">obj</span>
            <span class="s1">obj</span><span class="s2">.</span><span class="s1">set_gid</span><span class="s2">(</span><span class="s1">gid</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">)</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">()</span>

    <span class="s0">def </span><span class="s1">include</span><span class="s2">(</span><span class="s1">gid</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
        <span class="s5"># we need to exclude certain objects which will not appear in the svg</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">OffsetBox</span><span class="s2">):</span>
            <span class="s0">return False</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">Text</span><span class="s2">):</span>
            <span class="s0">if </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">get_text</span><span class="s2">() == </span><span class="s4">&quot;&quot;</span><span class="s2">:</span>
                <span class="s0">return False</span>
            <span class="s0">elif </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">axes </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s0">return False</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">Line2D</span><span class="s2">):</span>
            <span class="s1">xdata</span><span class="s2">, </span><span class="s1">ydata </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">get_data</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">len</span><span class="s2">(</span><span class="s1">xdata</span><span class="s2">) == </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ydata</span><span class="s2">) == </span><span class="s3">1</span><span class="s2">:</span>
                <span class="s0">return False</span>
            <span class="s0">elif not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s4">&quot;axes&quot;</span><span class="s2">) </span><span class="s0">or </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">axes </span><span class="s0">is None</span><span class="s2">:</span>
                <span class="s0">return False</span>
        <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">obj</span><span class="s2">, </span><span class="s1">Tick</span><span class="s2">):</span>
            <span class="s1">loc </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">get_loc</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">loc </span><span class="s2">== </span><span class="s3">0</span><span class="s2">:</span>
                <span class="s0">return False</span>
            <span class="s1">vi </span><span class="s2">= </span><span class="s1">obj</span><span class="s2">.</span><span class="s1">get_view_interval</span><span class="s2">()</span>
            <span class="s0">if </span><span class="s1">loc </span><span class="s2">&lt; </span><span class="s1">min</span><span class="s2">(</span><span class="s1">vi</span><span class="s2">) </span><span class="s0">or </span><span class="s1">loc </span><span class="s2">&gt; </span><span class="s1">max</span><span class="s2">(</span><span class="s1">vi</span><span class="s2">):</span>
                <span class="s0">return False</span>
        <span class="s0">return True</span>

    <span class="s0">for </span><span class="s1">gid</span><span class="s2">, </span><span class="s1">obj </span><span class="s0">in </span><span class="s1">gdic</span><span class="s2">.</span><span class="s1">items</span><span class="s2">():</span>
        <span class="s0">if </span><span class="s1">include</span><span class="s2">(</span><span class="s1">gid</span><span class="s2">, </span><span class="s1">obj</span><span class="s2">):</span>
            <span class="s0">assert </span><span class="s1">gid </span><span class="s0">in </span><span class="s1">buf</span>


<span class="s0">def </span><span class="s1">test_savefig_tight</span><span class="s2">():</span>
    <span class="s5"># Check that the draw-disabled renderer correctly disables open/close_group</span>
    <span class="s5"># as well.</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">BytesIO</span><span class="s2">(), </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;svgz&quot;</span><span class="s2">, </span><span class="s1">bbox_inches</span><span class="s2">=</span><span class="s4">&quot;tight&quot;</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_url</span><span class="s2">():</span>
    <span class="s5"># Test that object url appears in output svg.</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>

    <span class="s5"># collections</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">])</span>
    <span class="s1">s</span><span class="s2">.</span><span class="s1">set_urls</span><span class="s2">([</span><span class="s4">'https://example.com/foo'</span><span class="s2">, </span><span class="s4">'https://example.com/bar'</span><span class="s2">, </span><span class="s0">None</span><span class="s2">])</span>

    <span class="s5"># Line2D</span>
    <span class="s1">p</span><span class="s2">, = </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">plot</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">6</span><span class="s2">, </span><span class="s3">5</span><span class="s2">])</span>
    <span class="s1">p</span><span class="s2">.</span><span class="s1">set_url</span><span class="s2">(</span><span class="s4">'https://example.com/baz'</span><span class="s2">)</span>

    <span class="s1">b </span><span class="s2">= </span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">)</span>
    <span class="s1">b </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s2">[</span><span class="s7">b'foo'</span><span class="s2">, </span><span class="s7">b'bar'</span><span class="s2">, </span><span class="s7">b'baz'</span><span class="s2">]:</span>
        <span class="s0">assert </span><span class="s7">b'https://example.com/' </span><span class="s2">+ </span><span class="s1">v </span><span class="s0">in </span><span class="s1">b</span>


<span class="s0">def </span><span class="s1">test_url_tick</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setenv</span><span class="s2">(</span><span class="s4">'SOURCE_DATE_EPOCH'</span><span class="s2">, </span><span class="s4">'19680801'</span><span class="s2">)</span>

    <span class="s1">fig1</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">])</span>
    <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">tick </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">get_major_ticks</span><span class="s2">()):</span>
        <span class="s1">tick</span><span class="s2">.</span><span class="s1">set_url</span><span class="s2">(</span><span class="s4">f'https://example.com/</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">'</span><span class="s2">)</span>

    <span class="s1">fig2</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">scatter</span><span class="s2">([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">], [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s2">])</span>
    <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">tick </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">get_major_ticks</span><span class="s2">()):</span>
        <span class="s1">tick</span><span class="s2">.</span><span class="s1">label1</span><span class="s2">.</span><span class="s1">set_url</span><span class="s2">(</span><span class="s4">f'https://example.com/</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">'</span><span class="s2">)</span>
        <span class="s1">tick</span><span class="s2">.</span><span class="s1">label2</span><span class="s2">.</span><span class="s1">set_url</span><span class="s2">(</span><span class="s4">f'https://example.com/</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">'</span><span class="s2">)</span>

    <span class="s1">b1 </span><span class="s2">= </span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">fig1</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">b1</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">)</span>
    <span class="s1">b1 </span><span class="s2">= </span><span class="s1">b1</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">()</span>

    <span class="s1">b2 </span><span class="s2">= </span><span class="s1">BytesIO</span><span class="s2">()</span>
    <span class="s1">fig2</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">b2</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">)</span>
    <span class="s1">b2 </span><span class="s2">= </span><span class="s1">b2</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">()</span>

    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">yaxis</span><span class="s2">.</span><span class="s1">get_major_ticks</span><span class="s2">())):</span>
        <span class="s0">assert </span><span class="s4">f'https://example.com/</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s4">'</span><span class="s2">.</span><span class="s1">encode</span><span class="s2">(</span><span class="s4">'ascii'</span><span class="s2">) </span><span class="s0">in </span><span class="s1">b1</span>
    <span class="s0">assert </span><span class="s1">b1 </span><span class="s2">== </span><span class="s1">b2</span>


<span class="s0">def </span><span class="s1">test_svg_default_metadata</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s5"># Values have been predefined for 'Creator', 'Date', 'Format', and 'Type'.</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setenv</span><span class="s2">(</span><span class="s4">'SOURCE_DATE_EPOCH'</span><span class="s2">, </span><span class="s4">'19680801'</span><span class="s2">)</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">)</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">()</span>

    <span class="s5"># Creator</span>
    <span class="s0">assert </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">__version__ </span><span class="s0">in </span><span class="s1">buf</span>
    <span class="s5"># Date</span>
    <span class="s0">assert </span><span class="s4">'1970-08-16' </span><span class="s0">in </span><span class="s1">buf</span>
    <span class="s5"># Format</span>
    <span class="s0">assert </span><span class="s4">'image/svg+xml' </span><span class="s0">in </span><span class="s1">buf</span>
    <span class="s5"># Type</span>
    <span class="s0">assert </span><span class="s4">'StillImage' </span><span class="s0">in </span><span class="s1">buf</span>

    <span class="s5"># Now make sure all the default metadata can be cleared.</span>
    <span class="s0">with </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">={</span><span class="s4">'Date'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">'Creator'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">,</span>
                                                <span class="s4">'Format'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">'Type'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">})</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">()</span>

    <span class="s5"># Creator</span>
    <span class="s0">assert </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">__version__ </span><span class="s0">not in </span><span class="s1">buf</span>
    <span class="s5"># Date</span>
    <span class="s0">assert </span><span class="s4">'1970-08-16' </span><span class="s0">not in </span><span class="s1">buf</span>
    <span class="s5"># Format</span>
    <span class="s0">assert </span><span class="s4">'image/svg+xml' </span><span class="s0">not in </span><span class="s1">buf</span>
    <span class="s5"># Type</span>
    <span class="s0">assert </span><span class="s4">'StillImage' </span><span class="s0">not in </span><span class="s1">buf</span>


<span class="s0">def </span><span class="s1">test_svg_clear_default_metadata</span><span class="s2">(</span><span class="s1">monkeypatch</span><span class="s2">):</span>
    <span class="s5"># Makes sure that setting a default metadata to `None`</span>
    <span class="s5"># removes the corresponding tag from the metadata.</span>
    <span class="s1">monkeypatch</span><span class="s2">.</span><span class="s1">setenv</span><span class="s2">(</span><span class="s4">'SOURCE_DATE_EPOCH'</span><span class="s2">, </span><span class="s4">'19680801'</span><span class="s2">)</span>

    <span class="s1">metadata_contains </span><span class="s2">= {</span><span class="s4">'creator'</span><span class="s2">: </span><span class="s1">mpl</span><span class="s2">.</span><span class="s1">__version__</span><span class="s2">, </span><span class="s4">'date'</span><span class="s2">: </span><span class="s4">'1970-08-16'</span><span class="s2">,</span>
                         <span class="s4">'format'</span><span class="s2">: </span><span class="s4">'image/svg+xml'</span><span class="s2">, </span><span class="s4">'type'</span><span class="s2">: </span><span class="s4">'StillImage'</span><span class="s2">}</span>

    <span class="s1">SVGNS </span><span class="s2">= </span><span class="s4">'{http://www.w3.org/2000/svg}'</span>
    <span class="s1">RDFNS </span><span class="s2">= </span><span class="s4">'{http://www.w3.org/1999/02/22-rdf-syntax-ns#}'</span>
    <span class="s1">CCNS </span><span class="s2">= </span><span class="s4">'{http://creativecommons.org/ns#}'</span>
    <span class="s1">DCNS </span><span class="s2">= </span><span class="s4">'{http://purl.org/dc/elements/1.1/}'</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s1">metadata_contains</span><span class="s2">:</span>
        <span class="s0">with </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
            <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">={</span><span class="s1">name</span><span class="s2">.</span><span class="s1">title</span><span class="s2">(): </span><span class="s0">None</span><span class="s2">})</span>
            <span class="s1">buf </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">()</span>

        <span class="s1">root </span><span class="s2">= </span><span class="s1">xml</span><span class="s2">.</span><span class="s1">etree</span><span class="s2">.</span><span class="s1">ElementTree</span><span class="s2">.</span><span class="s1">fromstring</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
        <span class="s1">work</span><span class="s2">, = </span><span class="s1">root</span><span class="s2">.</span><span class="s1">findall</span><span class="s2">(</span><span class="s4">f'./</span><span class="s0">{</span><span class="s1">SVGNS</span><span class="s0">}</span><span class="s4">metadata/</span><span class="s0">{</span><span class="s1">RDFNS</span><span class="s0">}</span><span class="s4">RDF/</span><span class="s0">{</span><span class="s1">CCNS</span><span class="s0">}</span><span class="s4">Work'</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">metadata_contains</span><span class="s2">:</span>
            <span class="s1">data </span><span class="s2">= </span><span class="s1">work</span><span class="s2">.</span><span class="s1">findall</span><span class="s2">(</span><span class="s4">f'./</span><span class="s0">{</span><span class="s1">DCNS</span><span class="s0">}{</span><span class="s1">key</span><span class="s0">}</span><span class="s4">'</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">key </span><span class="s2">== </span><span class="s1">name</span><span class="s2">:</span>
                <span class="s5"># The one we cleared is not there</span>
                <span class="s0">assert not </span><span class="s1">data</span>
                <span class="s0">continue</span>
            <span class="s5"># Everything else should be there</span>
            <span class="s1">data</span><span class="s2">, = </span><span class="s1">data</span>
            <span class="s1">xmlstr </span><span class="s2">= </span><span class="s1">xml</span><span class="s2">.</span><span class="s1">etree</span><span class="s2">.</span><span class="s1">ElementTree</span><span class="s2">.</span><span class="s1">tostring</span><span class="s2">(</span><span class="s1">data</span><span class="s2">, </span><span class="s1">encoding</span><span class="s2">=</span><span class="s4">&quot;unicode&quot;</span><span class="s2">)</span>
            <span class="s0">assert </span><span class="s1">metadata_contains</span><span class="s2">[</span><span class="s1">key</span><span class="s2">] </span><span class="s0">in </span><span class="s1">xmlstr</span>


<span class="s0">def </span><span class="s1">test_svg_clear_all_metadata</span><span class="s2">():</span>
    <span class="s5"># Makes sure that setting all default metadata to `None`</span>
    <span class="s5"># removes the metadata tag from the output.</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">={</span><span class="s4">'Date'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">'Creator'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">,</span>
                                                <span class="s4">'Format'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">, </span><span class="s4">'Type'</span><span class="s2">: </span><span class="s0">None</span><span class="s2">})</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">()</span>

    <span class="s1">SVGNS </span><span class="s2">= </span><span class="s4">'{http://www.w3.org/2000/svg}'</span>

    <span class="s1">root </span><span class="s2">= </span><span class="s1">xml</span><span class="s2">.</span><span class="s1">etree</span><span class="s2">.</span><span class="s1">ElementTree</span><span class="s2">.</span><span class="s1">fromstring</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
    <span class="s0">assert not </span><span class="s1">root</span><span class="s2">.</span><span class="s1">findall</span><span class="s2">(</span><span class="s4">f'./</span><span class="s0">{</span><span class="s1">SVGNS</span><span class="s0">}</span><span class="s4">metadata'</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_svg_metadata</span><span class="s2">():</span>
    <span class="s1">single_value </span><span class="s2">= [</span><span class="s4">'Coverage'</span><span class="s2">, </span><span class="s4">'Identifier'</span><span class="s2">, </span><span class="s4">'Language'</span><span class="s2">, </span><span class="s4">'Relation'</span><span class="s2">, </span><span class="s4">'Source'</span><span class="s2">,</span>
                    <span class="s4">'Title'</span><span class="s2">, </span><span class="s4">'Type'</span><span class="s2">]</span>
    <span class="s1">multi_value </span><span class="s2">= [</span><span class="s4">'Contributor'</span><span class="s2">, </span><span class="s4">'Creator'</span><span class="s2">, </span><span class="s4">'Keywords'</span><span class="s2">, </span><span class="s4">'Publisher'</span><span class="s2">, </span><span class="s4">'Rights'</span><span class="s2">]</span>
    <span class="s1">metadata </span><span class="s2">= {</span>
        <span class="s4">'Date'</span><span class="s2">: [</span><span class="s1">datetime</span><span class="s2">.</span><span class="s1">date</span><span class="s2">(</span><span class="s3">1968</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">1</span><span class="s2">),</span>
                 <span class="s1">datetime</span><span class="s2">.</span><span class="s1">datetime</span><span class="s2">(</span><span class="s3">1968</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">)],</span>
        <span class="s4">'Description'</span><span class="s2">: </span><span class="s4">'description</span><span class="s0">\n</span><span class="s4">text'</span><span class="s2">,</span>
        <span class="s2">**{</span><span class="s1">k</span><span class="s2">: </span><span class="s4">f'</span><span class="s0">{</span><span class="s1">k</span><span class="s0">} </span><span class="s4">foo' </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">single_value</span><span class="s2">},</span>
        <span class="s2">**{</span><span class="s1">k</span><span class="s2">: [</span><span class="s4">f'</span><span class="s0">{</span><span class="s1">k</span><span class="s0">} </span><span class="s4">bar'</span><span class="s2">, </span><span class="s4">f'</span><span class="s0">{</span><span class="s1">k</span><span class="s0">} </span><span class="s4">baz'</span><span class="s2">] </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">multi_value</span><span class="s2">},</span>
    <span class="s2">}</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s0">with </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">=</span><span class="s1">metadata</span><span class="s2">)</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">()</span>

    <span class="s1">SVGNS </span><span class="s2">= </span><span class="s4">'{http://www.w3.org/2000/svg}'</span>
    <span class="s1">RDFNS </span><span class="s2">= </span><span class="s4">'{http://www.w3.org/1999/02/22-rdf-syntax-ns#}'</span>
    <span class="s1">CCNS </span><span class="s2">= </span><span class="s4">'{http://creativecommons.org/ns#}'</span>
    <span class="s1">DCNS </span><span class="s2">= </span><span class="s4">'{http://purl.org/dc/elements/1.1/}'</span>

    <span class="s1">root </span><span class="s2">= </span><span class="s1">xml</span><span class="s2">.</span><span class="s1">etree</span><span class="s2">.</span><span class="s1">ElementTree</span><span class="s2">.</span><span class="s1">fromstring</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
    <span class="s1">rdf</span><span class="s2">, = </span><span class="s1">root</span><span class="s2">.</span><span class="s1">findall</span><span class="s2">(</span><span class="s4">f'./</span><span class="s0">{</span><span class="s1">SVGNS</span><span class="s0">}</span><span class="s4">metadata/</span><span class="s0">{</span><span class="s1">RDFNS</span><span class="s0">}</span><span class="s4">RDF'</span><span class="s2">)</span>

    <span class="s5"># Check things that are single entries.</span>
    <span class="s1">titles </span><span class="s2">= [</span><span class="s1">node</span><span class="s2">.</span><span class="s1">text </span><span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">root</span><span class="s2">.</span><span class="s1">findall</span><span class="s2">(</span><span class="s4">f'./</span><span class="s0">{</span><span class="s1">SVGNS</span><span class="s0">}</span><span class="s4">title'</span><span class="s2">)]</span>
    <span class="s0">assert </span><span class="s1">titles </span><span class="s2">== [</span><span class="s1">metadata</span><span class="s2">[</span><span class="s4">'Title'</span><span class="s2">]]</span>
    <span class="s1">types </span><span class="s2">= [</span><span class="s1">node</span><span class="s2">.</span><span class="s1">attrib</span><span class="s2">[</span><span class="s4">f'</span><span class="s0">{</span><span class="s1">RDFNS</span><span class="s0">}</span><span class="s4">resource'</span><span class="s2">]</span>
             <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">rdf</span><span class="s2">.</span><span class="s1">findall</span><span class="s2">(</span><span class="s4">f'./</span><span class="s0">{</span><span class="s1">CCNS</span><span class="s0">}</span><span class="s4">Work/</span><span class="s0">{</span><span class="s1">DCNS</span><span class="s0">}</span><span class="s4">type'</span><span class="s2">)]</span>
    <span class="s0">assert </span><span class="s1">types </span><span class="s2">== [</span><span class="s1">metadata</span><span class="s2">[</span><span class="s4">'Type'</span><span class="s2">]]</span>
    <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s2">[</span><span class="s4">'Description'</span><span class="s2">, *</span><span class="s1">single_value</span><span class="s2">]:</span>
        <span class="s0">if </span><span class="s1">k </span><span class="s2">== </span><span class="s4">'Type'</span><span class="s2">:</span>
            <span class="s0">continue</span>
        <span class="s1">values </span><span class="s2">= [</span><span class="s1">node</span><span class="s2">.</span><span class="s1">text</span>
                  <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">rdf</span><span class="s2">.</span><span class="s1">findall</span><span class="s2">(</span><span class="s4">f'./</span><span class="s0">{</span><span class="s1">CCNS</span><span class="s0">}</span><span class="s4">Work/</span><span class="s0">{</span><span class="s1">DCNS</span><span class="s0">}{</span><span class="s1">k</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span><span class="s0">}</span><span class="s4">'</span><span class="s2">)]</span>
        <span class="s0">assert </span><span class="s1">values </span><span class="s2">== [</span><span class="s1">metadata</span><span class="s2">[</span><span class="s1">k</span><span class="s2">]]</span>

    <span class="s5"># Check things that are multi-value entries.</span>
    <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">multi_value</span><span class="s2">:</span>
        <span class="s0">if </span><span class="s1">k </span><span class="s2">== </span><span class="s4">'Keywords'</span><span class="s2">:</span>
            <span class="s0">continue</span>
        <span class="s1">values </span><span class="s2">= [</span>
            <span class="s1">node</span><span class="s2">.</span><span class="s1">text</span>
            <span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">rdf</span><span class="s2">.</span><span class="s1">findall</span><span class="s2">(</span>
                <span class="s4">f'./</span><span class="s0">{</span><span class="s1">CCNS</span><span class="s0">}</span><span class="s4">Work/</span><span class="s0">{</span><span class="s1">DCNS</span><span class="s0">}{</span><span class="s1">k</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span><span class="s0">}</span><span class="s4">/</span><span class="s0">{</span><span class="s1">CCNS</span><span class="s0">}</span><span class="s4">Agent/</span><span class="s0">{</span><span class="s1">DCNS</span><span class="s0">}</span><span class="s4">title'</span><span class="s2">)]</span>
        <span class="s0">assert </span><span class="s1">values </span><span class="s2">== </span><span class="s1">metadata</span><span class="s2">[</span><span class="s1">k</span><span class="s2">]</span>

    <span class="s5"># Check special things.</span>
    <span class="s1">dates </span><span class="s2">= [</span><span class="s1">node</span><span class="s2">.</span><span class="s1">text </span><span class="s0">for </span><span class="s1">node </span><span class="s0">in </span><span class="s1">rdf</span><span class="s2">.</span><span class="s1">findall</span><span class="s2">(</span><span class="s4">f'./</span><span class="s0">{</span><span class="s1">CCNS</span><span class="s0">}</span><span class="s4">Work/</span><span class="s0">{</span><span class="s1">DCNS</span><span class="s0">}</span><span class="s4">date'</span><span class="s2">)]</span>
    <span class="s0">assert </span><span class="s1">dates </span><span class="s2">== [</span><span class="s4">'1968-08-01/1968-08-02T01:02:03'</span><span class="s2">]</span>

    <span class="s1">values </span><span class="s2">= [</span><span class="s1">node</span><span class="s2">.</span><span class="s1">text </span><span class="s0">for </span><span class="s1">node </span><span class="s0">in</span>
              <span class="s1">rdf</span><span class="s2">.</span><span class="s1">findall</span><span class="s2">(</span><span class="s4">f'./</span><span class="s0">{</span><span class="s1">CCNS</span><span class="s0">}</span><span class="s4">Work/</span><span class="s0">{</span><span class="s1">DCNS</span><span class="s0">}</span><span class="s4">subject/</span><span class="s0">{</span><span class="s1">RDFNS</span><span class="s0">}</span><span class="s4">Bag/</span><span class="s0">{</span><span class="s1">RDFNS</span><span class="s0">}</span><span class="s4">li'</span><span class="s2">)]</span>
    <span class="s0">assert </span><span class="s1">values </span><span class="s2">== </span><span class="s1">metadata</span><span class="s2">[</span><span class="s4">'Keywords'</span><span class="s2">]</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">&quot;multi_font_aspath.svg&quot;</span><span class="s2">], </span><span class="s1">tol</span><span class="s2">=</span><span class="s3">1.8</span><span class="s2">)</span>
<span class="s0">def </span><span class="s1">test_multi_font_type3</span><span class="s2">():</span>
    <span class="s1">fp </span><span class="s2">= </span><span class="s1">fm</span><span class="s2">.</span><span class="s1">FontProperties</span><span class="s2">(</span><span class="s1">family</span><span class="s2">=[</span><span class="s4">&quot;WenQuanYi Zen Hei&quot;</span><span class="s2">])</span>
    <span class="s0">if </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">fm</span><span class="s2">.</span><span class="s1">findfont</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">)).</span><span class="s1">name </span><span class="s2">!= </span><span class="s4">&quot;wqy-zenhei.ttc&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;Font may be missing&quot;</span><span class="s2">)</span>

    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rc</span><span class="s2">(</span><span class="s4">'font'</span><span class="s2">, </span><span class="s1">family</span><span class="s2">=[</span><span class="s4">'DejaVu Sans'</span><span class="s2">, </span><span class="s4">'WenQuanYi Zen Hei'</span><span class="s2">], </span><span class="s1">size</span><span class="s2">=</span><span class="s3">27</span><span class="s2">)</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rc</span><span class="s2">(</span><span class="s4">'svg'</span><span class="s2">, </span><span class="s1">fonttype</span><span class="s2">=</span><span class="s4">'path'</span><span class="s2">)</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s3">0.15</span><span class="s2">, </span><span class="s3">0.475</span><span class="s2">, </span><span class="s4">&quot;There are 几个汉字 in between!&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">image_comparison</span><span class="s2">([</span><span class="s4">&quot;multi_font_astext.svg&quot;</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_multi_font_type42</span><span class="s2">():</span>
    <span class="s1">fp </span><span class="s2">= </span><span class="s1">fm</span><span class="s2">.</span><span class="s1">FontProperties</span><span class="s2">(</span><span class="s1">family</span><span class="s2">=[</span><span class="s4">&quot;WenQuanYi Zen Hei&quot;</span><span class="s2">])</span>
    <span class="s0">if </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">fm</span><span class="s2">.</span><span class="s1">findfont</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">)).</span><span class="s1">name </span><span class="s2">!= </span><span class="s4">&quot;wqy-zenhei.ttc&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;Font may be missing&quot;</span><span class="s2">)</span>

    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rc</span><span class="s2">(</span><span class="s4">'svg'</span><span class="s2">, </span><span class="s1">fonttype</span><span class="s2">=</span><span class="s4">'none'</span><span class="s2">)</span>

    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rc</span><span class="s2">(</span><span class="s4">'font'</span><span class="s2">, </span><span class="s1">family</span><span class="s2">=[</span><span class="s4">'DejaVu Sans'</span><span class="s2">, </span><span class="s4">'WenQuanYi Zen Hei'</span><span class="s2">], </span><span class="s1">size</span><span class="s2">=</span><span class="s3">27</span><span class="s2">)</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s3">0.15</span><span class="s2">, </span><span class="s3">0.475</span><span class="s2">, </span><span class="s4">&quot;There are 几个汉字 in between!&quot;</span><span class="s2">)</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">'metadata,error,message'</span><span class="s2">, [</span>
    <span class="s2">({</span><span class="s4">'Date'</span><span class="s2">: </span><span class="s3">1</span><span class="s2">}, </span><span class="s1">TypeError</span><span class="s2">, </span><span class="s4">&quot;Invalid type for Date metadata. Expected str&quot;</span><span class="s2">),</span>
    <span class="s2">({</span><span class="s4">'Date'</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">]}, </span><span class="s1">TypeError</span><span class="s2">,</span>
     <span class="s4">&quot;Invalid type for Date metadata. Expected iterable&quot;</span><span class="s2">),</span>
    <span class="s2">({</span><span class="s4">'Keywords'</span><span class="s2">: </span><span class="s3">1</span><span class="s2">}, </span><span class="s1">TypeError</span><span class="s2">,</span>
     <span class="s4">&quot;Invalid type for Keywords metadata. Expected str&quot;</span><span class="s2">),</span>
    <span class="s2">({</span><span class="s4">'Keywords'</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">]}, </span><span class="s1">TypeError</span><span class="s2">,</span>
     <span class="s4">&quot;Invalid type for Keywords metadata. Expected iterable&quot;</span><span class="s2">),</span>
    <span class="s2">({</span><span class="s4">'Creator'</span><span class="s2">: </span><span class="s3">1</span><span class="s2">}, </span><span class="s1">TypeError</span><span class="s2">,</span>
     <span class="s4">&quot;Invalid type for Creator metadata. Expected str&quot;</span><span class="s2">),</span>
    <span class="s2">({</span><span class="s4">'Creator'</span><span class="s2">: [</span><span class="s3">1</span><span class="s2">]}, </span><span class="s1">TypeError</span><span class="s2">,</span>
     <span class="s4">&quot;Invalid type for Creator metadata. Expected iterable&quot;</span><span class="s2">),</span>
    <span class="s2">({</span><span class="s4">'Title'</span><span class="s2">: </span><span class="s3">1</span><span class="s2">}, </span><span class="s1">TypeError</span><span class="s2">,</span>
     <span class="s4">&quot;Invalid type for Title metadata. Expected str&quot;</span><span class="s2">),</span>
    <span class="s2">({</span><span class="s4">'Format'</span><span class="s2">: </span><span class="s3">1</span><span class="s2">}, </span><span class="s1">TypeError</span><span class="s2">,</span>
     <span class="s4">&quot;Invalid type for Format metadata. Expected str&quot;</span><span class="s2">),</span>
    <span class="s2">({</span><span class="s4">'Foo'</span><span class="s2">: </span><span class="s4">'Bar'</span><span class="s2">}, </span><span class="s1">ValueError</span><span class="s2">, </span><span class="s4">&quot;Unknown metadata key&quot;</span><span class="s2">),</span>
    <span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_svg_incorrect_metadata</span><span class="s2">(</span><span class="s1">metadata</span><span class="s2">, </span><span class="s1">error</span><span class="s2">, </span><span class="s1">message</span><span class="s2">):</span>
    <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">error</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">message</span><span class="s2">), </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
        <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">, </span><span class="s1">metadata</span><span class="s2">=</span><span class="s1">metadata</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_svg_escape</span><span class="s2">():</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">fig</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s4">&quot;&lt;</span><span class="s0">\'\&quot;</span><span class="s4">&amp;&gt;&quot;</span><span class="s2">, </span><span class="s1">gid</span><span class="s2">=</span><span class="s4">&quot;&lt;</span><span class="s0">\'\&quot;</span><span class="s4">&amp;&gt;&quot;</span><span class="s2">)</span>
    <span class="s0">with </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">)</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">()</span>
        <span class="s0">assert </span><span class="s4">'&amp;lt;&amp;apos;&amp;quot;&amp;amp;&amp;gt;&quot;' </span><span class="s0">in </span><span class="s1">buf</span>


<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;font_str&quot;</span><span class="s2">, [</span>
    <span class="s4">&quot;'DejaVu Sans', 'WenQuanYi Zen Hei', 'Arial', sans-serif&quot;</span><span class="s2">,</span>
    <span class="s4">&quot;'DejaVu Serif', 'WenQuanYi Zen Hei', 'Times New Roman', serif&quot;</span><span class="s2">,</span>
    <span class="s4">&quot;'Arial', 'WenQuanYi Zen Hei', cursive&quot;</span><span class="s2">,</span>
    <span class="s4">&quot;'Impact', 'WenQuanYi Zen Hei', fantasy&quot;</span><span class="s2">,</span>
    <span class="s4">&quot;'DejaVu Sans Mono', 'WenQuanYi Zen Hei', 'Courier New', monospace&quot;</span><span class="s2">,</span>
    <span class="s5"># These do not work because the logic to get the font metrics will not find</span>
    <span class="s5"># WenQuanYi as the fallback logic stops with the first fallback font:</span>
    <span class="s5"># &quot;'DejaVu Sans Mono', 'Courier New', 'WenQuanYi Zen Hei', monospace&quot;,</span>
    <span class="s5"># &quot;'DejaVu Sans', 'Arial', 'WenQuanYi Zen Hei', sans-serif&quot;,</span>
    <span class="s5"># &quot;'DejaVu Serif', 'Times New Roman', 'WenQuanYi Zen Hei',  serif&quot;,</span>
<span class="s2">])</span>
<span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s4">&quot;include_generic&quot;</span><span class="s2">, [</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">])</span>
<span class="s0">def </span><span class="s1">test_svg_font_string</span><span class="s2">(</span><span class="s1">font_str</span><span class="s2">, </span><span class="s1">include_generic</span><span class="s2">):</span>
    <span class="s1">fp </span><span class="s2">= </span><span class="s1">fm</span><span class="s2">.</span><span class="s1">FontProperties</span><span class="s2">(</span><span class="s1">family</span><span class="s2">=[</span><span class="s4">&quot;WenQuanYi Zen Hei&quot;</span><span class="s2">])</span>
    <span class="s0">if </span><span class="s1">Path</span><span class="s2">(</span><span class="s1">fm</span><span class="s2">.</span><span class="s1">findfont</span><span class="s2">(</span><span class="s1">fp</span><span class="s2">)).</span><span class="s1">name </span><span class="s2">!= </span><span class="s4">&quot;wqy-zenhei.ttc&quot;</span><span class="s2">:</span>
        <span class="s1">pytest</span><span class="s2">.</span><span class="s1">skip</span><span class="s2">(</span><span class="s4">&quot;Font may be missing&quot;</span><span class="s2">)</span>

    <span class="s1">explicit</span><span class="s2">, *</span><span class="s1">rest</span><span class="s2">, </span><span class="s1">generic </span><span class="s2">= </span><span class="s1">map</span><span class="s2">(</span>
        <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">(</span><span class="s4">&quot;'&quot;</span><span class="s2">), </span><span class="s1">font_str</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s4">&quot;, &quot;</span><span class="s2">)</span>
    <span class="s2">)</span>
    <span class="s1">size </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">generic</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">include_generic</span><span class="s2">:</span>
        <span class="s1">rest </span><span class="s2">= </span><span class="s1">rest </span><span class="s2">+ [</span><span class="s1">generic</span><span class="s2">]</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">f&quot;font.</span><span class="s0">{</span><span class="s1">generic</span><span class="s0">}</span><span class="s4">&quot;</span><span class="s2">] = </span><span class="s1">rest</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">&quot;font.size&quot;</span><span class="s2">] = </span><span class="s1">size</span>
    <span class="s1">plt</span><span class="s2">.</span><span class="s1">rcParams</span><span class="s2">[</span><span class="s4">&quot;svg.fonttype&quot;</span><span class="s2">] = </span><span class="s4">&quot;none&quot;</span>

    <span class="s1">fig</span><span class="s2">, </span><span class="s1">ax </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">subplots</span><span class="s2">()</span>
    <span class="s0">if </span><span class="s1">generic </span><span class="s2">== </span><span class="s4">&quot;sans-serif&quot;</span><span class="s2">:</span>
        <span class="s1">generic_options </span><span class="s2">= [</span><span class="s4">&quot;sans&quot;</span><span class="s2">, </span><span class="s4">&quot;sans-serif&quot;</span><span class="s2">, </span><span class="s4">&quot;sans serif&quot;</span><span class="s2">]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">generic_options </span><span class="s2">= [</span><span class="s1">generic</span><span class="s2">]</span>

    <span class="s0">for </span><span class="s1">generic_name </span><span class="s0">in </span><span class="s1">generic_options</span><span class="s2">:</span>
        <span class="s5"># test that fallback works</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s4">&quot;There are 几个汉字 in between!&quot;</span><span class="s2">,</span>
                <span class="s1">family</span><span class="s2">=[</span><span class="s1">explicit</span><span class="s2">, </span><span class="s1">generic_name</span><span class="s2">], </span><span class="s1">ha</span><span class="s2">=</span><span class="s4">&quot;center&quot;</span><span class="s2">)</span>
        <span class="s5"># test deduplication works</span>
        <span class="s1">ax</span><span class="s2">.</span><span class="s1">text</span><span class="s2">(</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.1</span><span class="s2">, </span><span class="s4">&quot;There are 几个汉字 in between!&quot;</span><span class="s2">,</span>
                <span class="s1">family</span><span class="s2">=[</span><span class="s1">explicit</span><span class="s2">, *</span><span class="s1">rest</span><span class="s2">, </span><span class="s1">generic_name</span><span class="s2">], </span><span class="s1">ha</span><span class="s2">=</span><span class="s4">&quot;center&quot;</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">axis</span><span class="s2">(</span><span class="s4">&quot;off&quot;</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">&quot;svg&quot;</span><span class="s2">)</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">()</span>

    <span class="s1">tree </span><span class="s2">= </span><span class="s1">xml</span><span class="s2">.</span><span class="s1">etree</span><span class="s2">.</span><span class="s1">ElementTree</span><span class="s2">.</span><span class="s1">fromstring</span><span class="s2">(</span><span class="s1">buf</span><span class="s2">)</span>
    <span class="s1">ns </span><span class="s2">= </span><span class="s4">&quot;http://www.w3.org/2000/svg&quot;</span>
    <span class="s1">text_count </span><span class="s2">= </span><span class="s3">0</span>
    <span class="s0">for </span><span class="s1">text_element </span><span class="s0">in </span><span class="s1">tree</span><span class="s2">.</span><span class="s1">findall</span><span class="s2">(</span><span class="s4">f&quot;.//</span><span class="s0">{{{</span><span class="s1">ns</span><span class="s0">}}}</span><span class="s4">text&quot;</span><span class="s2">):</span>
        <span class="s1">text_count </span><span class="s2">+= </span><span class="s3">1</span>
        <span class="s1">font_info </span><span class="s2">= </span><span class="s1">dict</span><span class="s2">(</span>
            <span class="s1">map</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">(), </span><span class="s1">_</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">().</span><span class="s1">split</span><span class="s2">(</span><span class="s4">&quot;:&quot;</span><span class="s2">))</span>
            <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">dict</span><span class="s2">(</span><span class="s1">text_element</span><span class="s2">.</span><span class="s1">items</span><span class="s2">())[</span><span class="s4">&quot;style&quot;</span><span class="s2">].</span><span class="s1">split</span><span class="s2">(</span><span class="s4">&quot;;&quot;</span><span class="s2">)</span>
        <span class="s2">)[</span><span class="s4">&quot;font&quot;</span><span class="s2">]</span>

        <span class="s0">assert </span><span class="s1">font_info </span><span class="s2">== </span><span class="s4">f&quot;</span><span class="s0">{</span><span class="s1">size</span><span class="s0">}</span><span class="s4">px </span><span class="s0">{</span><span class="s1">font_str</span><span class="s0">}</span><span class="s4">&quot;</span>
    <span class="s0">assert </span><span class="s1">text_count </span><span class="s2">== </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ax</span><span class="s2">.</span><span class="s1">texts</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_annotationbbox_gid</span><span class="s2">():</span>
    <span class="s5"># Test that object gid appears in the AnnotationBbox</span>
    <span class="s5"># in output svg.</span>
    <span class="s1">fig </span><span class="s2">= </span><span class="s1">plt</span><span class="s2">.</span><span class="s1">figure</span><span class="s2">()</span>
    <span class="s1">ax </span><span class="s2">= </span><span class="s1">fig</span><span class="s2">.</span><span class="s1">add_subplot</span><span class="s2">()</span>
    <span class="s1">arr_img </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">((</span><span class="s3">32</span><span class="s2">, </span><span class="s3">32</span><span class="s2">))</span>
    <span class="s1">xy </span><span class="s2">= (</span><span class="s3">0.3</span><span class="s2">, </span><span class="s3">0.55</span><span class="s2">)</span>

    <span class="s1">imagebox </span><span class="s2">= </span><span class="s1">OffsetImage</span><span class="s2">(</span><span class="s1">arr_img</span><span class="s2">, </span><span class="s1">zoom</span><span class="s2">=</span><span class="s3">0.1</span><span class="s2">)</span>
    <span class="s1">imagebox</span><span class="s2">.</span><span class="s1">image</span><span class="s2">.</span><span class="s1">axes </span><span class="s2">= </span><span class="s1">ax</span>

    <span class="s1">ab </span><span class="s2">= </span><span class="s1">AnnotationBbox</span><span class="s2">(</span><span class="s1">imagebox</span><span class="s2">, </span><span class="s1">xy</span><span class="s2">,</span>
                        <span class="s1">xybox</span><span class="s2">=(</span><span class="s3">120.</span><span class="s2">, -</span><span class="s3">80.</span><span class="s2">),</span>
                        <span class="s1">xycoords</span><span class="s2">=</span><span class="s4">'data'</span><span class="s2">,</span>
                        <span class="s1">boxcoords</span><span class="s2">=</span><span class="s4">&quot;offset points&quot;</span><span class="s2">,</span>
                        <span class="s1">pad</span><span class="s2">=</span><span class="s3">0.5</span><span class="s2">,</span>
                        <span class="s1">arrowprops</span><span class="s2">=</span><span class="s1">dict</span><span class="s2">(</span>
                            <span class="s1">arrowstyle</span><span class="s2">=</span><span class="s4">&quot;-&gt;&quot;</span><span class="s2">,</span>
                            <span class="s1">connectionstyle</span><span class="s2">=</span><span class="s4">&quot;angle,angleA=0,angleB=90,rad=3&quot;</span><span class="s2">)</span>
                        <span class="s2">)</span>
    <span class="s1">ab</span><span class="s2">.</span><span class="s1">set_gid</span><span class="s2">(</span><span class="s4">&quot;a test for issue 20044&quot;</span><span class="s2">)</span>
    <span class="s1">ax</span><span class="s2">.</span><span class="s1">add_artist</span><span class="s2">(</span><span class="s1">ab</span><span class="s2">)</span>

    <span class="s0">with </span><span class="s1">BytesIO</span><span class="s2">() </span><span class="s0">as </span><span class="s1">fd</span><span class="s2">:</span>
        <span class="s1">fig</span><span class="s2">.</span><span class="s1">savefig</span><span class="s2">(</span><span class="s1">fd</span><span class="s2">, </span><span class="s1">format</span><span class="s2">=</span><span class="s4">'svg'</span><span class="s2">)</span>
        <span class="s1">buf </span><span class="s2">= </span><span class="s1">fd</span><span class="s2">.</span><span class="s1">getvalue</span><span class="s2">().</span><span class="s1">decode</span><span class="s2">(</span><span class="s4">'utf-8'</span><span class="s2">)</span>

    <span class="s1">expected </span><span class="s2">= </span><span class="s4">'&lt;g id=&quot;a test for issue 20044&quot;&gt;'</span>
    <span class="s0">assert </span><span class="s1">expected </span><span class="s0">in </span><span class="s1">buf</span>
</pre>
</body>
</html>