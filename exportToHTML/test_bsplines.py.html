<html>
<head>
<title>test_bsplines.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #7a7e85;}
.s4 { color: #2aacb8;}
.s5 { color: #6aab73;}
.s6 { color: #5f826b; font-style: italic;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_bsplines.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">operator</span>
<span class="s0">import </span><span class="s1">itertools</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy</span><span class="s2">.</span><span class="s1">testing </span><span class="s0">import </span><span class="s1">assert_equal</span><span class="s2">, </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">assert_</span>
<span class="s0">from </span><span class="s1">pytest </span><span class="s0">import </span><span class="s1">raises </span><span class="s0">as </span><span class="s1">assert_raises</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">interpolate </span><span class="s0">import </span><span class="s2">(</span>
        <span class="s1">BSpline</span><span class="s2">, </span><span class="s1">BPoly</span><span class="s2">, </span><span class="s1">PPoly</span><span class="s2">, </span><span class="s1">make_interp_spline</span><span class="s2">, </span><span class="s1">make_lsq_spline</span><span class="s2">, </span><span class="s1">_bspl</span><span class="s2">,</span>
        <span class="s1">splev</span><span class="s2">, </span><span class="s1">splrep</span><span class="s2">, </span><span class="s1">splprep</span><span class="s2">, </span><span class="s1">splder</span><span class="s2">, </span><span class="s1">splantider</span><span class="s2">, </span><span class="s1">sproot</span><span class="s2">, </span><span class="s1">splint</span><span class="s2">, </span><span class="s1">insert</span><span class="s2">,</span>
        <span class="s1">CubicSpline</span><span class="s2">, </span><span class="s1">NdBSpline</span><span class="s2">, </span><span class="s1">make_smoothing_spline</span><span class="s2">, </span><span class="s1">RegularGridInterpolator</span><span class="s2">,</span>
<span class="s2">)</span>
<span class="s0">import </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">linalg </span><span class="s0">as </span><span class="s1">sl</span>
<span class="s0">import </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">sparse</span><span class="s2">.</span><span class="s1">linalg </span><span class="s0">as </span><span class="s1">ssl</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">interpolate</span><span class="s2">.</span><span class="s1">_bsplines </span><span class="s0">import </span><span class="s2">(</span><span class="s1">_not_a_knot</span><span class="s2">, </span><span class="s1">_augknt</span><span class="s2">,</span>
                                        <span class="s1">_woodbury_algorithm</span><span class="s2">, </span><span class="s1">_periodic_knots</span><span class="s2">,</span>
                                         <span class="s1">_make_interp_per_full_matr</span><span class="s2">)</span>
<span class="s0">import </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">interpolate</span><span class="s2">.</span><span class="s1">_fitpack_impl </span><span class="s0">as </span><span class="s1">_impl</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">_lib</span><span class="s2">.</span><span class="s1">_util </span><span class="s0">import </span><span class="s1">AxisError</span>

<span class="s3"># XXX: move to the interpolate namespace</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">interpolate</span><span class="s2">.</span><span class="s1">_ndbspline </span><span class="s0">import </span><span class="s1">make_ndbspl</span>

<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">interpolate </span><span class="s0">import </span><span class="s1">_dfitpack </span><span class="s0">as </span><span class="s1">dfitpack</span>
<span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">interpolate </span><span class="s0">import </span><span class="s1">_bsplines </span><span class="s0">as </span><span class="s1">_b</span>


<span class="s0">class </span><span class="s1">TestBSpline</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_ctor</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># knots should be an ordered 1-D array of finite real numbers</span>
        <span class="s1">assert_raises</span><span class="s2">((</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">), </span><span class="s1">BSpline</span><span class="s2">,</span>
                <span class="s2">**</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">t</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.j</span><span class="s2">], </span><span class="s1">c</span><span class="s2">=[</span><span class="s4">1.</span><span class="s2">], </span><span class="s1">k</span><span class="s2">=</span><span class="s4">0</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">errstate</span><span class="s2">(</span><span class="s1">invalid</span><span class="s2">=</span><span class="s5">'ignore'</span><span class="s2">):</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">BSpline</span><span class="s2">, **</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">t</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">], </span><span class="s1">c</span><span class="s2">=[</span><span class="s4">1.</span><span class="s2">], </span><span class="s1">k</span><span class="s2">=</span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">BSpline</span><span class="s2">, **</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">t</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">], </span><span class="s1">c</span><span class="s2">=[</span><span class="s4">1.</span><span class="s2">], </span><span class="s1">k</span><span class="s2">=</span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">BSpline</span><span class="s2">, **</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">t</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">], </span><span class="s1">c</span><span class="s2">=[</span><span class="s4">1.</span><span class="s2">], </span><span class="s1">k</span><span class="s2">=</span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">BSpline</span><span class="s2">, **</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">t</span><span class="s2">=[[</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">1</span><span class="s2">]], </span><span class="s1">c</span><span class="s2">=[</span><span class="s4">1.</span><span class="s2">], </span><span class="s1">k</span><span class="s2">=</span><span class="s4">0</span><span class="s2">))</span>

        <span class="s3"># for n+k+1 knots and degree k need at least n coefficients</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">BSpline</span><span class="s2">, **</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">t</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">], </span><span class="s1">c</span><span class="s2">=[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">k</span><span class="s2">=</span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">BSpline</span><span class="s2">,</span>
                <span class="s2">**</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">t</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s1">c</span><span class="s2">=[</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">], </span><span class="s1">k</span><span class="s2">=</span><span class="s4">2</span><span class="s2">))</span>

        <span class="s3"># non-integer orders</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">BSpline</span><span class="s2">,</span>
                <span class="s2">**</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">t</span><span class="s2">=[</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">], </span><span class="s1">c</span><span class="s2">=[</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">], </span><span class="s1">k</span><span class="s2">=</span><span class="s5">&quot;cubic&quot;</span><span class="s2">))</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">BSpline</span><span class="s2">,</span>
                <span class="s2">**</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">t</span><span class="s2">=[</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">], </span><span class="s1">c</span><span class="s2">=[</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">], </span><span class="s1">k</span><span class="s2">=</span><span class="s4">2.5</span><span class="s2">))</span>

        <span class="s3"># basic interval cannot have measure zero (here: [1..1])</span>
        <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">BSpline</span><span class="s2">,</span>
                <span class="s2">**</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">t</span><span class="s2">=[</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">c</span><span class="s2">=[</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">k</span><span class="s2">=</span><span class="s4">2</span><span class="s2">))</span>

        <span class="s3"># tck vs self.tck</span>
        <span class="s1">n</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s4">11</span><span class="s2">, </span><span class="s4">3</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">+</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">k</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">k</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tck</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">_make_random_spline</span><span class="s2">()</span>
        <span class="s1">tck </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">tck</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">tck</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">k</span><span class="s2">, </span><span class="s1">tck</span><span class="s2">[</span><span class="s4">2</span><span class="s2">])</span>

        <span class="s3"># b.tck is read-only</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">AttributeError</span><span class="s2">):</span>
            <span class="s1">b</span><span class="s2">.</span><span class="s1">tck </span><span class="s2">= </span><span class="s5">'foo'</span>

    <span class="s0">def </span><span class="s1">test_degree_0</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">10</span><span class="s2">)</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">c</span><span class="s2">=[</span><span class="s4">3.</span><span class="s2">], </span><span class="s1">k</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s4">3</span><span class="s2">)</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.35</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">c</span><span class="s2">=[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">], </span><span class="s1">k</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">xx </span><span class="s2">&lt; </span><span class="s4">0.35</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_degree_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">t </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">c </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">1</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">c</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]*</span><span class="s1">B_012</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) + </span><span class="s1">c</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]*</span><span class="s1">B_012</span><span class="s2">(</span><span class="s1">x</span><span class="s2">-</span><span class="s4">1</span><span class="s2">) + </span><span class="s1">c</span><span class="s2">[</span><span class="s4">2</span><span class="s2">]*</span><span class="s1">B_012</span><span class="s2">(</span><span class="s1">x</span><span class="s2">-</span><span class="s4">2</span><span class="s2">),</span>
                        <span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">splev</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, (</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)), </span><span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_bernstein</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># a special knot vector: Bernstein polynomials</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">0</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">) + [</span><span class="s4">1</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">])</span>
        <span class="s1">bp </span><span class="s2">= </span><span class="s1">BPoly</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">bspl </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bp</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
                        <span class="s1">bspl</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s0">True</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">splev</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, (</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)),</span>
                        <span class="s1">bspl</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rndm_naive_eval</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test random coefficient spline *on the base interval*,</span>
        <span class="s3"># t[k] &lt;= x &lt; t[-k-1]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">_make_random_spline</span><span class="s2">()</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">], </span><span class="s1">t</span><span class="s2">[-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">y_b </span><span class="s2">= </span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">)</span>

        <span class="s1">y_n </span><span class="s2">= [</span><span class="s1">_naive_eval</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">xx</span><span class="s2">]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y_b</span><span class="s2">, </span><span class="s1">y_n</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s1">y_n2 </span><span class="s2">= [</span><span class="s1">_naive_eval_2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">xx</span><span class="s2">]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y_b</span><span class="s2">, </span><span class="s1">y_n2</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rndm_splev</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">_make_random_spline</span><span class="s2">()</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">], </span><span class="s1">t</span><span class="s2">[-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">splev</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, (</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rndm_splrep</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">20</span><span class="s2">))</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">20</span><span class="s2">)</span>

        <span class="s1">tck </span><span class="s2">= </span><span class="s1">splrep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(*</span><span class="s1">tck</span><span class="s2">)</span>

        <span class="s1">t</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">k</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">], </span><span class="s1">t</span><span class="s2">[-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">80</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">splev</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">tck</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_rndm_unity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">_make_random_spline</span><span class="s2">()</span>
        <span class="s1">b</span><span class="s2">.</span><span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones_like</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">)</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">[</span><span class="s1">b</span><span class="s2">.</span><span class="s1">k</span><span class="s2">], </span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">[-</span><span class="s1">b</span><span class="s2">.</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s4">1.</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_vectorization</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">n</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s4">22</span><span class="s2">, </span><span class="s4">3</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">tm</span><span class="s2">, </span><span class="s1">tp </span><span class="s2">= </span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">], </span><span class="s1">t</span><span class="s2">[-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">tm </span><span class="s2">+ (</span><span class="s1">tp </span><span class="s2">- </span><span class="s1">tm</span><span class="s2">) * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">).</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_len_c</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># for n+k+1 knots, only first n coefs are used.</span>
        <span class="s3"># and BTW this is consistent with FITPACK</span>
        <span class="s1">n</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s4">33</span><span class="s2">, </span><span class="s4">3</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">+</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>

        <span class="s3"># pad coefficients with random garbage</span>
        <span class="s1">c_pad </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s1">c</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)]</span>

        <span class="s1">b</span><span class="s2">, </span><span class="s1">b_pad </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">), </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c_pad</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">dt </span><span class="s2">= </span><span class="s1">t</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] - </span><span class="s1">t</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">t</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] - </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">t</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] + </span><span class="s1">dt</span><span class="s2">, </span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">b_pad</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">splev</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, (</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">splev</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, (</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c_pad</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_endpoints</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># base interval is closed</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">_make_random_spline</span><span class="s2">()</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span>
        <span class="s1">tm</span><span class="s2">, </span><span class="s1">tp </span><span class="s2">= </span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">], </span><span class="s1">t</span><span class="s2">[-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s0">for </span><span class="s1">extrap </span><span class="s0">in </span><span class="s2">(</span><span class="s0">True</span><span class="s2">, </span><span class="s0">False</span><span class="s2">):</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">([</span><span class="s1">tm</span><span class="s2">, </span><span class="s1">tp</span><span class="s2">], </span><span class="s1">extrap</span><span class="s2">),</span>
                            <span class="s1">b</span><span class="s2">([</span><span class="s1">tm </span><span class="s2">+ </span><span class="s4">1e-10</span><span class="s2">, </span><span class="s1">tp </span><span class="s2">- </span><span class="s4">1e-10</span><span class="s2">], </span><span class="s1">extrap</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-9</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_continuity</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># assert continuity at internal knots</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">_make_random_spline</span><span class="s2">()</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">:-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">] - </span><span class="s4">1e-10</span><span class="s2">), </span><span class="s1">b</span><span class="s2">(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">:-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">] + </span><span class="s4">1e-10</span><span class="s2">),</span>
                <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-9</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_extrap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">_make_random_spline</span><span class="s2">()</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span>
        <span class="s1">dt </span><span class="s2">= </span><span class="s1">t</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] - </span><span class="s1">t</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] - </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">t</span><span class="s2">[-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">] + </span><span class="s1">dt</span><span class="s2">, </span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">mask </span><span class="s2">= (</span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] &lt; </span><span class="s1">xx</span><span class="s2">) &amp; (</span><span class="s1">xx </span><span class="s2">&lt; </span><span class="s1">t</span><span class="s2">[-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">])</span>

        <span class="s3"># extrap has no effect within the base interval</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">[</span><span class="s1">mask</span><span class="s2">], </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
                        <span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">[</span><span class="s1">mask</span><span class="s2">], </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s0">False</span><span class="s2">))</span>

        <span class="s3"># extrapolated values agree with FITPACK</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s0">True</span><span class="s2">),</span>
                <span class="s1">splev</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, (</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">), </span><span class="s1">ext</span><span class="s2">=</span><span class="s4">0</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_default_extrap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># BSpline defaults to extrapolate=True</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">_make_random_spline</span><span class="s2">()</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span>
        <span class="s1">xx </span><span class="s2">= [</span><span class="s1">t</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] - </span><span class="s4">1</span><span class="s2">, </span><span class="s1">t</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] + </span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">yy </span><span class="s2">= </span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">yy</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">test_periodic_extrap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">8</span><span class="s2">))</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s5">'periodic'</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">t</span><span class="s2">.</span><span class="s1">size </span><span class="s2">- (</span><span class="s1">k </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">dt </span><span class="s2">= </span><span class="s1">t</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] - </span><span class="s1">t</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] - </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">t</span><span class="s2">[</span><span class="s1">n</span><span class="s2">] + </span><span class="s1">dt</span><span class="s2">, </span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">xy </span><span class="s2">= </span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] + (</span><span class="s1">xx </span><span class="s2">- </span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">]) % (</span><span class="s1">t</span><span class="s2">[</span><span class="s1">n</span><span class="s2">] - </span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">splev</span><span class="s2">(</span><span class="s1">xy</span><span class="s2">, (</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)))</span>

        <span class="s3"># Direct check</span>
        <span class="s1">xx </span><span class="s2">= [-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">xy </span><span class="s2">= </span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] + (</span><span class="s1">xx </span><span class="s2">- </span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">]) % (</span><span class="s1">t</span><span class="s2">[</span><span class="s1">n</span><span class="s2">] - </span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s5">'periodic'</span><span class="s2">), </span><span class="s1">b</span><span class="s2">(</span><span class="s1">xy</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s0">True</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_ppoly</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">_make_random_spline</span><span class="s2">()</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span>
        <span class="s1">pp </span><span class="s2">= </span><span class="s1">PPoly</span><span class="s2">.</span><span class="s1">from_spline</span><span class="s2">((</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">))</span>

        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">], </span><span class="s1">t</span><span class="s2">[-</span><span class="s1">k</span><span class="s2">], </span><span class="s4">100</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">pp</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_derivative_rndm</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">_make_random_spline</span><span class="s2">()</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">t</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">t</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">50</span><span class="s2">)</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">t</span><span class="s2">]</span>

        <span class="s0">for </span><span class="s1">der </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">):</span>
            <span class="s1">yd </span><span class="s2">= </span><span class="s1">splev</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, (</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">), </span><span class="s1">der</span><span class="s2">=</span><span class="s1">der</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">yd</span><span class="s2">, </span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=</span><span class="s1">der</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s3"># higher derivatives all vanish</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">), </span><span class="s4">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_derivative_jumps</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># example from de Boor, Chap IX, example (24)</span>
        <span class="s3"># NB: knots augmented &amp; corresp coefs are zeroed out</span>
        <span class="s3"># in agreement with the convention (29)</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">2</span>
        <span class="s1">t </span><span class="s2">= [-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">5</span><span class="s2">), </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s3"># b is continuous at x != 6 (triple knot)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">6</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">x </span><span class="s2">!= </span><span class="s4">6</span><span class="s2">] - </span><span class="s4">1e-10</span><span class="s2">),</span>
                        <span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">x </span><span class="s2">!= </span><span class="s4">6</span><span class="s2">] + </span><span class="s4">1e-10</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s4">6.</span><span class="s2">-</span><span class="s4">1e-10</span><span class="s2">), </span><span class="s1">b</span><span class="s2">(</span><span class="s4">6</span><span class="s2">+</span><span class="s4">1e-10</span><span class="s2">)))</span>

        <span class="s3"># 1st derivative jumps at double knots, 1 &amp; 6:</span>
        <span class="s1">x0 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">x0 </span><span class="s2">- </span><span class="s4">1e-10</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=</span><span class="s4">1</span><span class="s2">),</span>
                        <span class="s1">b</span><span class="s2">(</span><span class="s1">x0 </span><span class="s2">+ </span><span class="s4">1e-10</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=</span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">x1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">6</span><span class="s2">])</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">x1 </span><span class="s2">- </span><span class="s4">1e-10</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=</span><span class="s4">1</span><span class="s2">),</span>
                                       <span class="s1">b</span><span class="s2">(</span><span class="s1">x1 </span><span class="s2">+ </span><span class="s4">1e-10</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=</span><span class="s4">1</span><span class="s2">))))</span>

        <span class="s3"># 2nd derivative is not guaranteed to be continuous either</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s0">not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">all</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">x </span><span class="s2">- </span><span class="s4">1e-10</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=</span><span class="s4">2</span><span class="s2">),</span>
                                       <span class="s1">b</span><span class="s2">(</span><span class="s1">x </span><span class="s2">+ </span><span class="s4">1e-10</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=</span><span class="s4">2</span><span class="s2">))))</span>

    <span class="s0">def </span><span class="s1">test_basis_element_quadratic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">20</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">.</span><span class="s1">basis_element</span><span class="s2">(</span><span class="s1">t</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">),</span>
                        <span class="s1">splev</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, (</span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">k</span><span class="s2">)), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">),</span>
                        <span class="s1">B_0123</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">.</span><span class="s1">basis_element</span><span class="s2">(</span><span class="s1">t</span><span class="s2">=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">),</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">where</span><span class="s2">(</span><span class="s1">xx </span><span class="s2">&lt; </span><span class="s4">1</span><span class="s2">, </span><span class="s1">xx</span><span class="s2">*</span><span class="s1">xx</span><span class="s2">, (</span><span class="s4">2.</span><span class="s2">-</span><span class="s1">xx</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_basis_element_rndm</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">_make_random_spline</span><span class="s2">()</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">], </span><span class="s1">t</span><span class="s2">[-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">20</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">_sum_basis_elements</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_cmplx</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">_make_random_spline</span><span class="s2">()</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span>
        <span class="s1">cc </span><span class="s2">= </span><span class="s1">c </span><span class="s2">* (</span><span class="s4">1. </span><span class="s2">+ </span><span class="s4">3.j</span><span class="s2">)</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">cc</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">b_re </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">b_im </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">], </span><span class="s1">t</span><span class="s2">[-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">20</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">).</span><span class="s1">real</span><span class="s2">, </span><span class="s1">b_re</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">).</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">b_im</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_nan</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># nan in, nan out.</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">.</span><span class="s1">basis_element</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">)))</span>

    <span class="s0">def </span><span class="s1">test_derivative_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">_make_random_spline</span><span class="s2">(</span><span class="s1">k</span><span class="s2">=</span><span class="s4">5</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span>
        <span class="s1">b0 </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">], </span><span class="s1">t</span><span class="s2">[-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">20</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">k</span><span class="s2">):</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">derivative</span><span class="s2">()</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b0</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">j</span><span class="s2">), </span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-12</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-12</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_antiderivative_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">_make_random_spline</span><span class="s2">()</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">], </span><span class="s1">t</span><span class="s2">[-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">20</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">antiderivative</span><span class="s2">().</span><span class="s1">derivative</span><span class="s2">()(</span><span class="s1">xx</span><span class="s2">),</span>
                        <span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s3"># repeat with N-D array for c</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">c_</span><span class="s2">[</span><span class="s1">c</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">c</span><span class="s2">]</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dstack</span><span class="s2">((</span><span class="s1">c</span><span class="s2">, </span><span class="s1">c</span><span class="s2">))</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">antiderivative</span><span class="s2">().</span><span class="s1">derivative</span><span class="s2">()(</span><span class="s1">xx</span><span class="s2">),</span>
                        <span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_integral</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">.</span><span class="s1">basis_element</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])  </span><span class="s3"># x for x &lt; 1 else 2 - x</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s4">0.5</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), -</span><span class="s4">1 </span><span class="s2">* </span><span class="s4">0.5</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), -</span><span class="s4">0.5</span><span class="s2">)</span>

        <span class="s3"># extrapolate or zeros outside of [0, 2]; default is yes</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s0">True</span><span class="s2">), </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s0">False</span><span class="s2">), </span><span class="s4">0.5</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s0">False</span><span class="s2">), -</span><span class="s4">1 </span><span class="s2">* </span><span class="s4">0.5</span><span class="s2">)</span>

        <span class="s3"># Test ``_fitpack._splint()``</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s0">False</span><span class="s2">),</span>
                        <span class="s1">_impl</span><span class="s2">.</span><span class="s1">splint</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span><span class="s2">))</span>

        <span class="s3"># Test ``extrapolate='periodic'``.</span>
        <span class="s1">b</span><span class="s2">.</span><span class="s1">extrapolate </span><span class="s2">= </span><span class="s5">'periodic'</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">antiderivative</span><span class="s2">()</span>
        <span class="s1">period_int </span><span class="s2">= </span><span class="s1">i</span><span class="s2">(</span><span class="s4">2</span><span class="s2">) - </span><span class="s1">i</span><span class="s2">(</span><span class="s4">0</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), </span><span class="s1">period_int</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">), -</span><span class="s4">1 </span><span class="s2">* </span><span class="s1">period_int</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(-</span><span class="s4">9</span><span class="s2">, -</span><span class="s4">7</span><span class="s2">), </span><span class="s1">period_int</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(-</span><span class="s4">8</span><span class="s2">, -</span><span class="s4">4</span><span class="s2">), </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">period_int</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">), </span><span class="s1">i</span><span class="s2">(</span><span class="s4">1.5</span><span class="s2">) - </span><span class="s1">i</span><span class="s2">(</span><span class="s4">0.5</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">3</span><span class="s2">), </span><span class="s1">i</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) - </span><span class="s1">i</span><span class="s2">(</span><span class="s4">0</span><span class="s2">) + </span><span class="s1">i</span><span class="s2">(</span><span class="s4">2</span><span class="s2">) - </span><span class="s1">i</span><span class="s2">(</span><span class="s4">1.5</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(</span><span class="s4">1.5 </span><span class="s2">+ </span><span class="s4">12</span><span class="s2">, </span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">12</span><span class="s2">),</span>
                        <span class="s1">i</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) - </span><span class="s1">i</span><span class="s2">(</span><span class="s4">0</span><span class="s2">) + </span><span class="s1">i</span><span class="s2">(</span><span class="s4">2</span><span class="s2">) - </span><span class="s1">i</span><span class="s2">(</span><span class="s4">1.5</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">12</span><span class="s2">),</span>
                        <span class="s1">i</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) - </span><span class="s1">i</span><span class="s2">(</span><span class="s4">0</span><span class="s2">) + </span><span class="s1">i</span><span class="s2">(</span><span class="s4">2</span><span class="s2">) - </span><span class="s1">i</span><span class="s2">(</span><span class="s4">1.5</span><span class="s2">) + </span><span class="s4">6 </span><span class="s2">* </span><span class="s1">period_int</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">), </span><span class="s1">i</span><span class="s2">(</span><span class="s4">0</span><span class="s2">) - </span><span class="s1">i</span><span class="s2">(</span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(-</span><span class="s4">9</span><span class="s2">, -</span><span class="s4">10</span><span class="s2">), </span><span class="s1">i</span><span class="s2">(</span><span class="s4">0</span><span class="s2">) - </span><span class="s1">i</span><span class="s2">(</span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, -</span><span class="s4">9</span><span class="s2">), </span><span class="s1">i</span><span class="s2">(</span><span class="s4">1</span><span class="s2">) - </span><span class="s1">i</span><span class="s2">(</span><span class="s4">2</span><span class="s2">) - </span><span class="s4">4 </span><span class="s2">* </span><span class="s1">period_int</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_integrate_ppoly</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test .integrate method to be consistent with PPoly.integrate</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">b</span><span class="s2">.</span><span class="s1">extrapolate </span><span class="s2">= </span><span class="s5">'periodic'</span>
        <span class="s1">p </span><span class="s2">= </span><span class="s1">PPoly</span><span class="s2">.</span><span class="s1">from_spline</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">x0</span><span class="s2">, </span><span class="s1">x1 </span><span class="s0">in </span><span class="s2">[(-</span><span class="s4">5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">), (</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">), (-</span><span class="s4">4</span><span class="s2">, </span><span class="s4">13</span><span class="s2">)]:</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">),</span>
                            <span class="s1">p</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(</span><span class="s1">x0</span><span class="s2">, </span><span class="s1">x1</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_subclassing</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># classmethods should not decay to the base class</span>
        <span class="s0">class </span><span class="s1">B</span><span class="s2">(</span><span class="s1">BSpline</span><span class="s2">):</span>
            <span class="s0">pass</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">B</span><span class="s2">.</span><span class="s1">basis_element</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">])</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">derivative</span><span class="s2">().</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">antiderivative</span><span class="s2">().</span><span class="s1">__class__</span><span class="s2">, </span><span class="s1">B</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'axis'</span><span class="s2">, </span><span class="s1">range</span><span class="s2">(-</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_axis</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">):</span>
        <span class="s1">n</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s4">22</span><span class="s2">, </span><span class="s4">3</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">n </span><span class="s2">+ </span><span class="s1">k </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">sh </span><span class="s2">= [</span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">]</span>
        <span class="s3"># We need the positive axis for some of the indexing and slices used</span>
        <span class="s3"># in this test.</span>
        <span class="s1">pos_axis </span><span class="s2">= </span><span class="s1">axis </span><span class="s2">% </span><span class="s4">4</span>
        <span class="s1">sh</span><span class="s2">.</span><span class="s1">insert</span><span class="s2">(</span><span class="s1">pos_axis</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)   </span><span class="s3"># [22, 6, 7, 8] etc</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">sh</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">,</span>
                     <span class="s2">[</span><span class="s1">sh</span><span class="s2">[</span><span class="s1">pos_axis</span><span class="s2">],] + </span><span class="s1">sh</span><span class="s2">[:</span><span class="s1">pos_axis</span><span class="s2">] + </span><span class="s1">sh</span><span class="s2">[</span><span class="s1">pos_axis</span><span class="s2">+</span><span class="s4">1</span><span class="s2">:])</span>

        <span class="s1">xp </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">).</span><span class="s1">shape</span><span class="s2">,</span>
                     <span class="s1">sh</span><span class="s2">[:</span><span class="s1">pos_axis</span><span class="s2">] + </span><span class="s1">list</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">) + </span><span class="s1">sh</span><span class="s2">[</span><span class="s1">pos_axis</span><span class="s2">+</span><span class="s4">1</span><span class="s2">:])</span>

        <span class="s3"># -c.ndim &lt;= axis &lt; c.ndim</span>
        <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s2">[-</span><span class="s1">c</span><span class="s2">.</span><span class="s1">ndim </span><span class="s2">- </span><span class="s4">1</span><span class="s2">, </span><span class="s1">c</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">]:</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">AxisError</span><span class="s2">, </span><span class="s1">BSpline</span><span class="s2">,</span>
                          <span class="s2">**</span><span class="s1">dict</span><span class="s2">(</span><span class="s1">t</span><span class="s2">=</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">ax</span><span class="s2">))</span>

        <span class="s3"># derivative, antiderivative keeps the axis</span>
        <span class="s0">for </span><span class="s1">b1 </span><span class="s0">in </span><span class="s2">[</span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">).</span><span class="s1">derivative</span><span class="s2">(),</span>
                   <span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">).</span><span class="s1">derivative</span><span class="s2">(</span><span class="s4">2</span><span class="s2">),</span>
                   <span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">).</span><span class="s1">antiderivative</span><span class="s2">(),</span>
                   <span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s1">axis</span><span class="s2">).</span><span class="s1">antiderivative</span><span class="s2">(</span><span class="s4">2</span><span class="s2">)]:</span>
            <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b1</span><span class="s2">.</span><span class="s1">axis</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">axis</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_neg_axis</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">2</span>
        <span class="s1">t </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">], [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, -</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]])</span>

        <span class="s1">spl </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">spl0 </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">spl1 </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">spl</span><span class="s2">(</span><span class="s4">2.5</span><span class="s2">), [</span><span class="s1">spl0</span><span class="s2">(</span><span class="s4">2.5</span><span class="s2">), </span><span class="s1">spl1</span><span class="s2">(</span><span class="s4">2.5</span><span class="s2">)])</span>

    <span class="s0">def </span><span class="s1">test_design_matrix_bc_types</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">''' 
        Splines with different boundary conditions are built on different 
        types of vectors of knots. As far as design matrix depends only on 
        vector of knots, `k` and `x` it is useful to make tests for different 
        boundary conditions (and as following different vectors of knots). 
        '''</span>
        <span class="s0">def </span><span class="s1">run_design_matrix_tests</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">):</span>
            <span class="s6">''' 
            To avoid repetition of code the following function is provided. 
            '''</span>
            <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) * </span><span class="s4">40 </span><span class="s2">- </span><span class="s4">20</span><span class="s2">)</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) * </span><span class="s4">40 </span><span class="s2">- </span><span class="s4">20</span>
            <span class="s0">if </span><span class="s1">bc_type </span><span class="s2">== </span><span class="s5">&quot;periodic&quot;</span><span class="s2">:</span>
                <span class="s1">y</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s1">y</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]</span>

            <span class="s1">bspl </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s1">bc_type</span><span class="s2">)</span>

            <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">bspl</span><span class="s2">.</span><span class="s1">t</span><span class="s2">) - </span><span class="s1">k </span><span class="s2">- </span><span class="s4">1</span><span class="s2">)</span>
            <span class="s1">des_matr_def </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">bspl</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
            <span class="s1">des_matr_csr </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">.</span><span class="s1">design_matrix</span><span class="s2">(</span><span class="s1">x</span><span class="s2">,</span>
                                                 <span class="s1">bspl</span><span class="s2">.</span><span class="s1">t</span><span class="s2">,</span>
                                                 <span class="s1">k</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">des_matr_csr </span><span class="s2">@ </span><span class="s1">bspl</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">des_matr_def</span><span class="s2">, </span><span class="s1">des_matr_csr</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s3"># &quot;clamped&quot; and &quot;natural&quot; work only with `k = 3`</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">11</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s0">for </span><span class="s1">bc </span><span class="s0">in </span><span class="s2">[</span><span class="s5">&quot;clamped&quot;</span><span class="s2">, </span><span class="s5">&quot;natural&quot;</span><span class="s2">]:</span>
            <span class="s1">run_design_matrix_tests</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">bc</span><span class="s2">)</span>

        <span class="s3"># &quot;not-a-knot&quot; works with odd `k`</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">run_design_matrix_tests</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s5">&quot;not-a-knot&quot;</span><span class="s2">)</span>

        <span class="s3"># &quot;periodic&quot; works with any `k` (even more than `n`)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">5  </span><span class="s3"># smaller `n` to test `k &gt; n` case</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">7</span><span class="s2">):</span>
            <span class="s1">run_design_matrix_tests</span><span class="s2">(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s5">&quot;periodic&quot;</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'extrapolate'</span><span class="s2">, [</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">, </span><span class="s5">'periodic'</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'degree'</span><span class="s2">, </span><span class="s1">range</span><span class="s2">(</span><span class="s4">5</span><span class="s2">))</span>
    <span class="s0">def </span><span class="s1">test_design_matrix_same_as_BSpline_call</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Test that design_matrix(x) is equivalent to BSpline(..)(x).&quot;&quot;&quot;</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s4">10 </span><span class="s2">* (</span><span class="s1">degree </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">xmin</span><span class="s2">, </span><span class="s1">xmax </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">amin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">amax</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s1">degree</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">xmin </span><span class="s2">- </span><span class="s4">2</span><span class="s2">, </span><span class="s1">xmin </span><span class="s2">- </span><span class="s4">1</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">),</span>
                  <span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">xmin</span><span class="s2">, </span><span class="s1">xmax</span><span class="s2">, </span><span class="s4">2 </span><span class="s2">* (</span><span class="s1">degree </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)),</span>
                  <span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">xmax </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">, </span><span class="s1">xmax </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">, </span><span class="s1">degree</span><span class="s2">)]</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">eye</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">t</span><span class="s2">) - </span><span class="s1">k </span><span class="s2">- </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">bspline </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span>
            <span class="s1">bspline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">BSpline</span><span class="s2">.</span><span class="s1">design_matrix</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
        <span class="s2">)</span>

        <span class="s3"># extrapolation regime</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s1">xmin </span><span class="s2">- </span><span class="s4">10</span><span class="s2">, </span><span class="s1">xmin </span><span class="s2">- </span><span class="s4">1</span><span class="s2">, </span><span class="s1">xmax </span><span class="s2">+ </span><span class="s4">1.5</span><span class="s2">, </span><span class="s1">xmax </span><span class="s2">+ </span><span class="s4">10</span><span class="s2">])</span>
        <span class="s0">if not </span><span class="s1">extrapolate</span><span class="s2">:</span>
            <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
                <span class="s1">BSpline</span><span class="s2">.</span><span class="s1">design_matrix</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">)</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span>
                <span class="s1">bspline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">),</span>
                <span class="s1">BSpline</span><span class="s2">.</span><span class="s1">design_matrix</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
            <span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_design_matrix_x_shapes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test for different `x` shapes</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) * </span><span class="s4">40 </span><span class="s2">- </span><span class="s4">20</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) * </span><span class="s4">40 </span><span class="s2">- </span><span class="s4">20</span>

        <span class="s1">bspl </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">):</span>
            <span class="s1">xc </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[:</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s1">yc </span><span class="s2">= </span><span class="s1">y</span><span class="s2">[:</span><span class="s1">i</span><span class="s2">]</span>
            <span class="s1">des_matr_csr </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">.</span><span class="s1">design_matrix</span><span class="s2">(</span><span class="s1">xc</span><span class="s2">,</span>
                                                 <span class="s1">bspl</span><span class="s2">.</span><span class="s1">t</span><span class="s2">,</span>
                                                 <span class="s1">k</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">des_matr_csr </span><span class="s2">@ </span><span class="s1">bspl</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">yc</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_design_matrix_t_shapes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test for minimal possible `t` shape</span>
        <span class="s1">t </span><span class="s2">= [</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">]</span>
        <span class="s1">des_matr </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">.</span><span class="s1">design_matrix</span><span class="s2">(</span><span class="s4">2.</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s4">3</span><span class="s2">).</span><span class="s1">toarray</span><span class="s2">()</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">des_matr</span><span class="s2">,</span>
                        <span class="s2">[[</span><span class="s4">0.25</span><span class="s2">, </span><span class="s4">0.58333333</span><span class="s2">, </span><span class="s4">0.16666667</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">]],</span>
                        <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_design_matrix_asserts</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">10</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) * </span><span class="s4">40 </span><span class="s2">- </span><span class="s4">20</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) * </span><span class="s4">40 </span><span class="s2">- </span><span class="s4">20</span>
        <span class="s1">bspl </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>
        <span class="s3"># invalid vector of knots (should be a 1D non-descending array)</span>
        <span class="s3"># here the actual vector of knots is reversed, so it is invalid</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">BSpline</span><span class="s2">.</span><span class="s1">design_matrix</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">bspl</span><span class="s2">.</span><span class="s1">t</span><span class="s2">[::-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">2</span>
        <span class="s1">t </span><span class="s2">= [</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, </span><span class="s4">5.</span><span class="s2">]</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">]</span>
        <span class="s3"># out of bounds</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">BSpline</span><span class="s2">.</span><span class="s1">design_matrix</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'bc_type'</span><span class="s2">, [</span><span class="s5">'natural'</span><span class="s2">, </span><span class="s5">'clamped'</span><span class="s2">,</span>
                                         <span class="s5">'periodic'</span><span class="s2">, </span><span class="s5">'not-a-knot'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_from_power_basis</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">20</span><span class="s2">))</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">20</span><span class="s2">)</span>
        <span class="s0">if </span><span class="s1">bc_type </span><span class="s2">== </span><span class="s5">'periodic'</span><span class="s2">:</span>
            <span class="s1">y</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">y</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">cb </span><span class="s2">= </span><span class="s1">CubicSpline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s1">bc_type</span><span class="s2">)</span>
        <span class="s1">bspl </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">.</span><span class="s1">from_power_basis</span><span class="s2">(</span><span class="s1">cb</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s1">bc_type</span><span class="s2">)</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">20</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">cb</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">bspl</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">bspl_new </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s1">bc_type</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">bspl_new</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'bc_type'</span><span class="s2">, [</span><span class="s5">'natural'</span><span class="s2">, </span><span class="s5">'clamped'</span><span class="s2">,</span>
                                         <span class="s5">'periodic'</span><span class="s2">, </span><span class="s5">'not-a-knot'</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_from_power_basis_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">20</span><span class="s2">))</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">20</span><span class="s2">) + </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s4">20</span><span class="s2">) * </span><span class="s4">1j</span>
        <span class="s0">if </span><span class="s1">bc_type </span><span class="s2">== </span><span class="s5">'periodic'</span><span class="s2">:</span>
            <span class="s1">y</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">y</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">cb </span><span class="s2">= </span><span class="s1">CubicSpline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s1">bc_type</span><span class="s2">)</span>
        <span class="s1">bspl </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">.</span><span class="s1">from_power_basis</span><span class="s2">(</span><span class="s1">cb</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s1">bc_type</span><span class="s2">)</span>
        <span class="s1">bspl_new_real </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s1">bc_type</span><span class="s2">)</span>
        <span class="s1">bspl_new_imag </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s1">bc_type</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">bspl</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">dtype</span><span class="s2">, (</span><span class="s1">bspl_new_real</span><span class="s2">.</span><span class="s1">c</span>
                                    <span class="s2">+ </span><span class="s4">1j </span><span class="s2">* </span><span class="s1">bspl_new_imag</span><span class="s2">.</span><span class="s1">c</span><span class="s2">).</span><span class="s1">dtype</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">bspl_new_real</span><span class="s2">.</span><span class="s1">c</span>
                        <span class="s2">+ </span><span class="s4">1j </span><span class="s2">* </span><span class="s1">bspl_new_imag</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_from_power_basis_exmp</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">''' 
        For x = [0, 1, 2, 3, 4] and y = [1, 1, 1, 1, 1] 
        the coefficients of Cubic Spline in the power basis: 
 
        $[[0, 0, 0, 0, 0],\\$ 
        $[0, 0, 0, 0, 0],\\$ 
        $[0, 0, 0, 0, 0],\\$ 
        $[1, 1, 1, 1, 1]]$ 
 
        It could be shown explicitly that coefficients of the interpolating 
        function in B-spline basis are c = [1, 1, 1, 1, 1, 1, 1] 
        '''</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">bspl </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">.</span><span class="s1">from_power_basis</span><span class="s2">(</span><span class="s1">CubicSpline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'natural'</span><span class="s2">),</span>
                                        <span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'natural'</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_read_only</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># BSpline must work on read-only knots and coefficients.</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">3.0</span><span class="s2">])</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setflags</span><span class="s2">(</span><span class="s1">write</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">c</span><span class="s2">.</span><span class="s1">setflags</span><span class="s2">(</span><span class="s1">write</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">xx</span><span class="s2">.</span><span class="s1">setflags</span><span class="s2">(</span><span class="s1">write</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">=</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">=</span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s4">3</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestInsert</span><span class="s2">:</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'xval'</span><span class="s2">, [</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">, </span><span class="s4">7.0</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_insert</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xval</span><span class="s2">):</span>
        <span class="s3"># insert a knot, incl edges (0.0, 7.0) and exactly at an existing knot (4.0)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">8</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)**</span><span class="s4">3</span>
        <span class="s1">spl </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s1">spl_1f </span><span class="s2">= </span><span class="s1">insert</span><span class="s2">(</span><span class="s1">xval</span><span class="s2">, </span><span class="s1">spl</span><span class="s2">)     </span><span class="s3"># FITPACK</span>
        <span class="s1">spl_1 </span><span class="s2">= </span><span class="s1">spl</span><span class="s2">.</span><span class="s1">insert_knot</span><span class="s2">(</span><span class="s1">xval</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl_1</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">spl_1f</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl_1</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">spl_1f</span><span class="s2">.</span><span class="s1">c</span><span class="s2">[:-</span><span class="s1">spl</span><span class="s2">.</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

        <span class="s3"># knot insertion preserves values, unless multiplicity &gt;= k+1</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">x </span><span class="s0">if </span><span class="s1">xval </span><span class="s2">!= </span><span class="s1">x</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] </span><span class="s0">else </span><span class="s1">x</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s1">xx</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">*(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] + </span><span class="s1">x</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">])]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">spl_1</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

        <span class="s3"># ... repeat with ndim &gt; 1</span>
        <span class="s1">y1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)**</span><span class="s4">3</span>
        <span class="s1">spl_y1 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">spl_yy </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">c_</span><span class="s2">[</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y1</span><span class="s2">], </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">spl_yy1 </span><span class="s2">= </span><span class="s1">spl_yy</span><span class="s2">.</span><span class="s1">insert_knot</span><span class="s2">(</span><span class="s1">xval</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl_yy1</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">spl_1</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl_yy1</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">c_</span><span class="s2">[</span><span class="s1">spl</span><span class="s2">.</span><span class="s1">insert_knot</span><span class="s2">(</span><span class="s1">xval</span><span class="s2">).</span><span class="s1">c</span><span class="s2">,</span>
                                         <span class="s1">spl_y1</span><span class="s2">.</span><span class="s1">insert_knot</span><span class="s2">(</span><span class="s1">xval</span><span class="s2">).</span><span class="s1">c</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

        <span class="s1">xx </span><span class="s2">= </span><span class="s1">x </span><span class="s0">if </span><span class="s1">xval </span><span class="s2">!= </span><span class="s1">x</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] </span><span class="s0">else </span><span class="s1">x</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s1">xx</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">*(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] + </span><span class="s1">x</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">])]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl_yy</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">spl_yy1</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>


    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s5">'xval, m'</span><span class="s2">, [(</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">), (</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">5</span><span class="s2">), (</span><span class="s4">4</span><span class="s2">, </span><span class="s4">2</span><span class="s2">), (</span><span class="s4">7.0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)]</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_insert_multi</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xval</span><span class="s2">, </span><span class="s1">m</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">8</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)**</span><span class="s4">3</span>
        <span class="s1">spl </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s1">spl_1f </span><span class="s2">= </span><span class="s1">insert</span><span class="s2">(</span><span class="s1">xval</span><span class="s2">, </span><span class="s1">spl</span><span class="s2">, </span><span class="s1">m</span><span class="s2">=</span><span class="s1">m</span><span class="s2">)</span>
        <span class="s1">spl_1 </span><span class="s2">= </span><span class="s1">spl</span><span class="s2">.</span><span class="s1">insert_knot</span><span class="s2">(</span><span class="s1">xval</span><span class="s2">, </span><span class="s1">m</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl_1</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">spl_1f</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl_1</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">spl_1f</span><span class="s2">.</span><span class="s1">c</span><span class="s2">[:-</span><span class="s1">spl</span><span class="s2">.</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

        <span class="s1">xx </span><span class="s2">= </span><span class="s1">x </span><span class="s0">if </span><span class="s1">xval </span><span class="s2">!= </span><span class="s1">x</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] </span><span class="s0">else </span><span class="s1">x</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s1">xx</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">*(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] + </span><span class="s1">x</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">])]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">spl_1</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_insert_random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">n</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s4">11</span><span class="s2">, </span><span class="s4">3</span>

        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">n</span><span class="s2">+</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">spl </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">xv </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">], </span><span class="s1">high</span><span class="s2">=</span><span class="s1">t</span><span class="s2">[-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">spl_1 </span><span class="s2">= </span><span class="s1">spl</span><span class="s2">.</span><span class="s1">insert_knot</span><span class="s2">(</span><span class="s1">xv</span><span class="s2">)</span>

        <span class="s1">xx </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">], </span><span class="s1">high</span><span class="s2">=</span><span class="s1">t</span><span class="s2">[-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">size</span><span class="s2">=</span><span class="s4">33</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">spl_1</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'xv'</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">2.0</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">4.5</span><span class="s2">,      </span><span class="s3"># l.h. edge</span>
                                    <span class="s4">5.5</span><span class="s2">, </span><span class="s4">6.0</span><span class="s2">, </span><span class="s4">6.1</span><span class="s2">, </span><span class="s4">7.0</span><span class="s2">]         </span><span class="s3"># r.h. edge</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_insert_periodic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">xv</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">8</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)**</span><span class="s4">3</span>
        <span class="s1">tck </span><span class="s2">= </span><span class="s1">splrep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">spl </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(*</span><span class="s1">tck</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s5">&quot;periodic&quot;</span><span class="s2">)</span>

        <span class="s1">spl_1 </span><span class="s2">= </span><span class="s1">spl</span><span class="s2">.</span><span class="s1">insert_knot</span><span class="s2">(</span><span class="s1">xv</span><span class="s2">)</span>
        <span class="s1">tf</span><span class="s2">, </span><span class="s1">cf</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">insert</span><span class="s2">(</span><span class="s1">xv</span><span class="s2">, </span><span class="s1">spl</span><span class="s2">.</span><span class="s1">tck</span><span class="s2">, </span><span class="s1">per</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl_1</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">tf</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl_1</span><span class="s2">.</span><span class="s1">c</span><span class="s2">[:-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">cf</span><span class="s2">[:-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">).</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">high</span><span class="s2">=</span><span class="s4">7</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">41</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl_1</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">splev</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, (</span><span class="s1">tf</span><span class="s2">, </span><span class="s1">cf</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_insert_periodic_too_few_internal_knots</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># both FITPACK and spl.insert_knot raise when there's not enough</span>
        <span class="s3"># internal knots to make a periodic extension.</span>
        <span class="s3"># Below the internal knots are 2, 3,    , 4, 5 </span>
        <span class="s3">#                                     ^</span>
        <span class="s3">#                              2, 3, 3.5, 4, 5</span>
        <span class="s3">#   so two knots from each side from the new one, while need at least</span>
        <span class="s3">#   from either left or right.</span>
        <span class="s1">xv </span><span class="s2">= </span><span class="s4">3.5</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">) + [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">] + [</span><span class="s4">7</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">t</span><span class="s2">) - </span><span class="s1">k </span><span class="s2">- </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">spl </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s5">&quot;periodic&quot;</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">insert</span><span class="s2">(</span><span class="s1">xv</span><span class="s2">, (</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">), </span><span class="s1">per</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">spl</span><span class="s2">.</span><span class="s1">insert_knot</span><span class="s2">(</span><span class="s1">xv</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_insert_no_extrap</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">) + [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">] + [</span><span class="s4">7</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">t</span><span class="s2">) - </span><span class="s1">k </span><span class="s2">- </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">spl </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">spl</span><span class="s2">.</span><span class="s1">insert_knot</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">spl</span><span class="s2">.</span><span class="s1">insert_knot</span><span class="s2">(</span><span class="s4">8</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">spl</span><span class="s2">.</span><span class="s1">insert_knot</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s1">m</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">test_knots_multiplicity</span><span class="s2">():</span>
    <span class="s3"># Take a spline w/ random coefficients, throw in knots of varying</span>
    <span class="s3"># multiplicity.</span>

    <span class="s0">def </span><span class="s1">check_splev</span><span class="s2">(</span><span class="s1">b</span><span class="s2">, </span><span class="s1">j</span><span class="s2">, </span><span class="s1">der</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">):</span>
        <span class="s3"># check evaluations against FITPACK, incl extrapolations</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">unique</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s1">t</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]-</span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">*(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] + </span><span class="s1">x</span><span class="s2">[:</span><span class="s4">1</span><span class="s2">]), </span><span class="s1">t</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]+</span><span class="s4">0.1</span><span class="s2">]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">splev</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, (</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">), </span><span class="s1">der</span><span class="s2">), </span><span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">der</span><span class="s2">),</span>
                <span class="s1">atol</span><span class="s2">=</span><span class="s1">atol</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s1">rtol</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">=</span><span class="s5">f'der = </span><span class="s0">{</span><span class="s1">der</span><span class="s0">}  </span><span class="s5">k = </span><span class="s0">{</span><span class="s1">b</span><span class="s2">.</span><span class="s1">k</span><span class="s0">}</span><span class="s5">'</span><span class="s2">)</span>

    <span class="s3"># test loop itself</span>
    <span class="s3"># [the index `j` is for interpreting the traceback in case of a failure]</span>
    <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]:</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">_make_random_spline</span><span class="s2">(</span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">j</span><span class="s2">, </span><span class="s1">b1 </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">_make_multiples</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)):</span>
            <span class="s1">check_splev</span><span class="s2">(</span><span class="s1">b1</span><span class="s2">, </span><span class="s1">j</span><span class="s2">)</span>
            <span class="s0">for </span><span class="s1">der </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">):</span>
                <span class="s1">check_splev</span><span class="s2">(</span><span class="s1">b1</span><span class="s2">, </span><span class="s1">j</span><span class="s2">, </span><span class="s1">der</span><span class="s2">, </span><span class="s4">1e-12</span><span class="s2">, </span><span class="s4">1e-12</span><span class="s2">)</span>


<span class="s3">### stolen from @pv, verbatim</span>
<span class="s0">def </span><span class="s1">_naive_B</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">t</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Naive way to compute B-spline basis functions. Useful only for testing! 
    computes B(x; t[i],..., t[i+k+1]) 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">k </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s4">1.0 </span><span class="s0">if </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] &lt;= </span><span class="s1">x </span><span class="s2">&lt; </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">] </span><span class="s0">else </span><span class="s4">0.0</span>
    <span class="s0">if </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s1">k</span><span class="s2">] == </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]:</span>
        <span class="s1">c1 </span><span class="s2">= </span><span class="s4">0.0</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">c1 </span><span class="s2">= (</span><span class="s1">x </span><span class="s2">- </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])/(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s1">k</span><span class="s2">] - </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]) * </span><span class="s1">_naive_B</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">t</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]:</span>
        <span class="s1">c2 </span><span class="s2">= </span><span class="s4">0.0</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">c2 </span><span class="s2">= (</span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">] - </span><span class="s1">x</span><span class="s2">)/(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">] - </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]) * </span><span class="s1">_naive_B</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">, </span><span class="s1">t</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s2">(</span><span class="s1">c1 </span><span class="s2">+ </span><span class="s1">c2</span><span class="s2">)</span>


<span class="s3">### stolen from @pv, verbatim</span>
<span class="s0">def </span><span class="s1">_naive_eval</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; 
    Naive B-spline evaluation. Useful only for testing! 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">x </span><span class="s2">== </span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">]:</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">k</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">x</span><span class="s2">) - </span><span class="s4">1</span>
    <span class="s0">assert </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] &lt;= </span><span class="s1">x </span><span class="s2">&lt;= </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]</span>
    <span class="s0">assert </span><span class="s1">i </span><span class="s2">&gt;= </span><span class="s1">k </span><span class="s0">and </span><span class="s1">i </span><span class="s2">&lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">t</span><span class="s2">) - </span><span class="s1">k</span>
    <span class="s0">return </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">c</span><span class="s2">[</span><span class="s1">i</span><span class="s2">-</span><span class="s1">j</span><span class="s2">] * </span><span class="s1">_naive_B</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">i</span><span class="s2">-</span><span class="s1">j</span><span class="s2">, </span><span class="s1">t</span><span class="s2">) </span><span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">_naive_eval_2</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Naive B-spline evaluation, another way.&quot;&quot;&quot;</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">t</span><span class="s2">) - (</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">n </span><span class="s2">&gt;= </span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">c</span><span class="s2">) &gt;= </span><span class="s1">n</span>
    <span class="s0">assert </span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">] &lt;= </span><span class="s1">x </span><span class="s2">&lt;= </span><span class="s1">t</span><span class="s2">[</span><span class="s1">n</span><span class="s2">]</span>
    <span class="s0">return </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">c</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] * </span><span class="s1">_naive_B</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">t</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">_sum_basis_elements</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">):</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">t</span><span class="s2">) - (</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">assert </span><span class="s1">n </span><span class="s2">&gt;= </span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span>
    <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">c</span><span class="s2">) &gt;= </span><span class="s1">n</span>
    <span class="s1">s </span><span class="s2">= </span><span class="s4">0.</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">.</span><span class="s1">basis_element</span><span class="s2">(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">:</span><span class="s1">i</span><span class="s2">+</span><span class="s1">k</span><span class="s2">+</span><span class="s4">2</span><span class="s2">], </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">s </span><span class="s2">+= </span><span class="s1">c</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan_to_num</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)   </span><span class="s3"># zero out out-of-bounds elements</span>
    <span class="s0">return </span><span class="s1">s</span>


<span class="s0">def </span><span class="s1">B_012</span><span class="s2">(</span><span class="s1">x</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot; A linear B-spline function B(x | 0, 1, 2).&quot;&quot;&quot;</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">atleast_1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">np</span><span class="s2">.</span><span class="s1">piecewise</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, [(</span><span class="s1">x </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">) | (</span><span class="s1">x </span><span class="s2">&gt; </span><span class="s4">2</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s1">x </span><span class="s2">&gt;= </span><span class="s4">0</span><span class="s2">) &amp; (</span><span class="s1">x </span><span class="s2">&lt; </span><span class="s4">1</span><span class="s2">),</span>
                            <span class="s2">(</span><span class="s1">x </span><span class="s2">&gt;= </span><span class="s4">1</span><span class="s2">) &amp; (</span><span class="s1">x </span><span class="s2">&lt;= </span><span class="s4">2</span><span class="s2">)],</span>
                           <span class="s2">[</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s4">0.</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">, </span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s4">2.</span><span class="s2">-</span><span class="s1">x</span><span class="s2">])</span>


<span class="s0">def </span><span class="s1">B_0123</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">der</span><span class="s2">=</span><span class="s4">0</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;A quadratic B-spline function B(x | 0, 1, 2, 3).&quot;&quot;&quot;</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">atleast_1d</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
    <span class="s1">conds </span><span class="s2">= [</span><span class="s1">x </span><span class="s2">&lt; </span><span class="s4">1</span><span class="s2">, (</span><span class="s1">x </span><span class="s2">&gt; </span><span class="s4">1</span><span class="s2">) &amp; (</span><span class="s1">x </span><span class="s2">&lt; </span><span class="s4">2</span><span class="s2">), </span><span class="s1">x </span><span class="s2">&gt; </span><span class="s4">2</span><span class="s2">]</span>
    <span class="s0">if </span><span class="s1">der </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
        <span class="s1">funcs </span><span class="s2">= [</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">x</span><span class="s2">*</span><span class="s1">x</span><span class="s2">/</span><span class="s4">2.</span><span class="s2">,</span>
                 <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s4">3.</span><span class="s2">/</span><span class="s4">4 </span><span class="s2">- (</span><span class="s1">x</span><span class="s2">-</span><span class="s4">3.</span><span class="s2">/</span><span class="s4">2</span><span class="s2">)**</span><span class="s4">2</span><span class="s2">,</span>
                 <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: (</span><span class="s4">3.</span><span class="s2">-</span><span class="s1">x</span><span class="s2">)**</span><span class="s4">2 </span><span class="s2">/ </span><span class="s4">2</span><span class="s2">]</span>
    <span class="s0">elif </span><span class="s1">der </span><span class="s2">== </span><span class="s4">2</span><span class="s2">:</span>
        <span class="s1">funcs </span><span class="s2">= [</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">,</span>
                 <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: -</span><span class="s4">2.</span><span class="s2">,</span>
                 <span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s4">1.</span><span class="s2">]</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s5">'never be here: der=%s' </span><span class="s2">% </span><span class="s1">der</span><span class="s2">)</span>
    <span class="s1">pieces </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">piecewise</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">conds</span><span class="s2">, </span><span class="s1">funcs</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">pieces</span>


<span class="s0">def </span><span class="s1">_make_random_spline</span><span class="s2">(</span><span class="s1">n</span><span class="s2">=</span><span class="s4">35</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">):</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">123</span><span class="s2">)</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">+</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">))</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">BSpline</span><span class="s2">.</span><span class="s1">construct_fast</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">_make_multiples</span><span class="s2">(</span><span class="s1">b</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Increase knot multiplicity.&quot;&quot;&quot;</span>
    <span class="s1">c</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">k</span>

    <span class="s1">t1 </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">t1</span><span class="s2">[</span><span class="s4">17</span><span class="s2">:</span><span class="s4">19</span><span class="s2">] = </span><span class="s1">t1</span><span class="s2">[</span><span class="s4">17</span><span class="s2">]</span>
    <span class="s1">t1</span><span class="s2">[</span><span class="s4">22</span><span class="s2">] = </span><span class="s1">t1</span><span class="s2">[</span><span class="s4">21</span><span class="s2">]</span>
    <span class="s0">yield </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t1</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

    <span class="s1">t1 </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">t1</span><span class="s2">[:</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">t1</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
    <span class="s0">yield </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t1</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

    <span class="s1">t1 </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
    <span class="s1">t1</span><span class="s2">[-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">:] = </span><span class="s1">t1</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]</span>
    <span class="s0">yield </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t1</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestInterop</span><span class="s2">:</span>
    <span class="s3">#</span>
    <span class="s3"># Test that FITPACK-based spl* functions can deal with BSpline objects</span>
    <span class="s3">#</span>
    <span class="s0">def </span><span class="s1">setup_method</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">, </span><span class="s4">41</span><span class="s2">)</span>
        <span class="s1">yy </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">tck </span><span class="s2">= (</span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b </span><span class="s2">= </span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">b</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">xnew </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">, </span><span class="s4">21</span><span class="s2">)</span>

        <span class="s1">c2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">c_</span><span class="s2">[</span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">]</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">c2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dstack</span><span class="s2">((</span><span class="s1">c2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">))</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">b2 </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">c2</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">k</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_splev</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">xnew</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">b2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xnew</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b2</span>

        <span class="s3"># check that splev works with 1-D array of coefficients</span>
        <span class="s3"># for array and scalar `x`</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">splev</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">, </span><span class="s1">b</span><span class="s2">),</span>
                        <span class="s1">b</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">splev</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span><span class="s2">),</span>
                        <span class="s1">b</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">([</span><span class="s1">splev</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">xnew</span><span class="s2">],</span>
                        <span class="s1">b</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

        <span class="s3"># With N-D coefficients, there's a quirck:</span>
        <span class="s3"># splev(x, BSpline) is equivalent to BSpline(x)</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Calling splev.. with BSpline&quot;</span><span class="s2">):</span>
            <span class="s1">splev</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">)</span>

        <span class="s3"># However, splev(x, BSpline.tck) needs some transposes. This is because</span>
        <span class="s3"># BSpline interpolates along the first axis, while the legacy FITPACK</span>
        <span class="s3"># wrapper does list(map(...)) which effectively interpolates along the</span>
        <span class="s3"># last axis. Like so:</span>
        <span class="s1">sh </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">)) + (</span><span class="s4">0</span><span class="s2">,)   </span><span class="s3"># sh = (1, 2, 0)</span>
        <span class="s1">cc </span><span class="s2">= </span><span class="s1">b2</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s1">sh</span><span class="s2">)</span>
        <span class="s1">tck </span><span class="s2">= (</span><span class="s1">b2</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">cc</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">.</span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">splev</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">, </span><span class="s1">tck</span><span class="s2">),</span>
                        <span class="s1">b2</span><span class="s2">(</span><span class="s1">xnew</span><span class="s2">).</span><span class="s1">transpose</span><span class="s2">(</span><span class="s1">sh</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_splrep</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span>
        <span class="s3"># test that &quot;new&quot; splrep is equivalent to _impl.splrep</span>
        <span class="s1">tck </span><span class="s2">= </span><span class="s1">splrep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">_impl</span><span class="s2">.</span><span class="s1">splrep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">tck</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">t</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">tck</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">c</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">tck</span><span class="s2">[</span><span class="s4">2</span><span class="s2">], </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s3"># also cover the `full_output=True` branch</span>
        <span class="s1">tck_f</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">splrep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">full_output</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">tck_f</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">t</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">tck_f</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">c</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">tck_f</span><span class="s2">[</span><span class="s4">2</span><span class="s2">], </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s3"># test that the result of splrep roundtrips with splev:</span>
        <span class="s3"># evaluate the spline on the original `x` points</span>
        <span class="s1">yy </span><span class="s2">= </span><span class="s1">splev</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">tck</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

        <span class="s3"># ... and also it roundtrips if wrapped in a BSpline</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(*</span><span class="s1">tck</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_splrep_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test that both &quot;old&quot; and &quot;new&quot; splrep raise for an N-D ``y`` array</span>
        <span class="s3"># with n &gt; 1</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span>
        <span class="s1">y2 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">c_</span><span class="s2">[</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">splrep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">_impl</span><span class="s2">.</span><span class="s1">splrep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y2</span><span class="s2">)</span>

        <span class="s3"># input below minimum size</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;m &gt; k must hold&quot;</span><span class="s2">):</span>
            <span class="s1">splrep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[:</span><span class="s4">3</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[:</span><span class="s4">3</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;m &gt; k must hold&quot;</span><span class="s2">):</span>
            <span class="s1">_impl</span><span class="s2">.</span><span class="s1">splrep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[:</span><span class="s4">3</span><span class="s2">], </span><span class="s1">y</span><span class="s2">[:</span><span class="s4">3</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_splprep</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">15</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">))</span>
        <span class="s1">b</span><span class="s2">, </span><span class="s1">u </span><span class="s2">= </span><span class="s1">splprep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">tck</span><span class="s2">, </span><span class="s1">u1 </span><span class="s2">= </span><span class="s1">_impl</span><span class="s2">.</span><span class="s1">splprep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s3"># test the roundtrip with splev for both &quot;old&quot; and &quot;new&quot; output</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">u1</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">splev</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s1">x</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">splev</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">tck</span><span class="s2">), </span><span class="s1">x</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

        <span class="s3"># cover the ``full_output=True`` branch</span>
        <span class="s2">(</span><span class="s1">b_f</span><span class="s2">, </span><span class="s1">u_f</span><span class="s2">), </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">splprep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">s</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">full_output</span><span class="s2">=</span><span class="s0">True</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">u</span><span class="s2">, </span><span class="s1">u_f</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">splev</span><span class="s2">(</span><span class="s1">u_f</span><span class="s2">, </span><span class="s1">b_f</span><span class="s2">), </span><span class="s1">x</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_splprep_errors</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test that both &quot;old&quot; and &quot;new&quot; code paths raise for x.ndim &gt; 2</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">3</span><span class="s2">*</span><span class="s4">4</span><span class="s2">*</span><span class="s4">5</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">))</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;too many values to unpack&quot;</span><span class="s2">):</span>
            <span class="s1">splprep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;too many values to unpack&quot;</span><span class="s2">):</span>
            <span class="s1">_impl</span><span class="s2">.</span><span class="s1">splprep</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s3"># input below minimum size</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">40</span><span class="s2">, </span><span class="s1">num</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;m &gt; k must hold&quot;</span><span class="s2">):</span>
            <span class="s1">splprep</span><span class="s2">([</span><span class="s1">x</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;m &gt; k must hold&quot;</span><span class="s2">):</span>
            <span class="s1">_impl</span><span class="s2">.</span><span class="s1">splprep</span><span class="s2">([</span><span class="s1">x</span><span class="s2">])</span>

        <span class="s3"># automatically calculated parameters are non-increasing</span>
        <span class="s3"># see gh-7589</span>
        <span class="s1">x </span><span class="s2">= [-</span><span class="s4">50.49072266</span><span class="s2">, -</span><span class="s4">50.49072266</span><span class="s2">, -</span><span class="s4">54.49072266</span><span class="s2">, -</span><span class="s4">54.49072266</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Invalid inputs&quot;</span><span class="s2">):</span>
            <span class="s1">splprep</span><span class="s2">([</span><span class="s1">x</span><span class="s2">])</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Invalid inputs&quot;</span><span class="s2">):</span>
            <span class="s1">_impl</span><span class="s2">.</span><span class="s1">splprep</span><span class="s2">([</span><span class="s1">x</span><span class="s2">])</span>

        <span class="s3"># given non-increasing parameter values u</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">u </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.3</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Invalid inputs&quot;</span><span class="s2">):</span>
            <span class="s1">splprep</span><span class="s2">(*[[</span><span class="s1">x</span><span class="s2">], </span><span class="s0">None</span><span class="s2">, </span><span class="s1">u</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">test_sproot</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b</span><span class="s2">, </span><span class="s1">b2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b2</span>
        <span class="s1">roots </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">])*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span>
        <span class="s3"># sproot accepts a BSpline obj w/ 1-D coef array</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sproot</span><span class="s2">(</span><span class="s1">b</span><span class="s2">), </span><span class="s1">roots</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-7</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-7</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">sproot</span><span class="s2">((</span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">k</span><span class="s2">)), </span><span class="s1">roots</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-7</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-7</span><span class="s2">)</span>

        <span class="s3"># ... and deals with trailing dimensions if coef array is N-D</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Calling sproot.. with BSpline&quot;</span><span class="s2">):</span>
            <span class="s1">sproot</span><span class="s2">(</span><span class="s1">b2</span><span class="s2">, </span><span class="s1">mest</span><span class="s2">=</span><span class="s4">50</span><span class="s2">)</span>

        <span class="s3"># and legacy behavior is preserved for a tck tuple w/ N-D coef</span>
        <span class="s1">c2r </span><span class="s2">= </span><span class="s1">b2</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">rr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">sproot</span><span class="s2">((</span><span class="s1">b2</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c2r</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">.</span><span class="s1">k</span><span class="s2">), </span><span class="s1">mest</span><span class="s2">=</span><span class="s4">50</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">rr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">rr </span><span class="s2">- </span><span class="s1">roots</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-12</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_splint</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test that splint accepts BSpline objects</span>
        <span class="s1">b</span><span class="s2">, </span><span class="s1">b2 </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b2</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">splint</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">b</span><span class="s2">),</span>
                        <span class="s1">splint</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">tck</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">splint</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">b</span><span class="s2">),</span>
                        <span class="s1">b</span><span class="s2">.</span><span class="s1">integrate</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s3"># ... and deals with N-D arrays of coefficients</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Calling splint.. with BSpline&quot;</span><span class="s2">):</span>
            <span class="s1">splint</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">)</span>

        <span class="s3"># and the legacy behavior is preserved for a tck tuple w/ N-D coef</span>
        <span class="s1">c2r </span><span class="s2">= </span><span class="s1">b2</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">integr </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">splint</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, (</span><span class="s1">b2</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c2r</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">.</span><span class="s1">k</span><span class="s2">)))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">integr</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">integr</span><span class="s2">,</span>
                        <span class="s1">splint</span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_splder</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">b </span><span class="s0">in </span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">b</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b2</span><span class="s2">]:</span>
            <span class="s3"># pad the c array (FITPACK convention)</span>
            <span class="s1">ct </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">) - </span><span class="s1">len</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">ct </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s1">b</span><span class="s2">.</span><span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">ct</span><span class="s2">,) + </span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:])]</span>

            <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]:</span>
                <span class="s1">bd </span><span class="s2">= </span><span class="s1">splder</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
                <span class="s1">tck_d </span><span class="s2">= </span><span class="s1">_impl</span><span class="s2">.</span><span class="s1">splder</span><span class="s2">((</span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">k</span><span class="s2">))</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bd</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">tck_d</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bd</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">tck_d</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">bd</span><span class="s2">.</span><span class="s1">k</span><span class="s2">, </span><span class="s1">tck_d</span><span class="s2">[</span><span class="s4">2</span><span class="s2">])</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">bd</span><span class="s2">, </span><span class="s1">BSpline</span><span class="s2">))</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">tck_d</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">))  </span><span class="s3"># back-compat: tck in and out</span>

    <span class="s0">def </span><span class="s1">test_splantider</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">b </span><span class="s0">in </span><span class="s2">[</span><span class="s1">self</span><span class="s2">.</span><span class="s1">b</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b2</span><span class="s2">]:</span>
            <span class="s3"># pad the c array (FITPACK convention)</span>
            <span class="s1">ct </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">) - </span><span class="s1">len</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">)</span>
            <span class="s0">if </span><span class="s1">ct </span><span class="s2">&gt; </span><span class="s4">0</span><span class="s2">:</span>
                <span class="s1">b</span><span class="s2">.</span><span class="s1">c </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">ct</span><span class="s2">,) + </span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:])]</span>

            <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]:</span>
                <span class="s1">bd </span><span class="s2">= </span><span class="s1">splantider</span><span class="s2">(</span><span class="s1">b</span><span class="s2">)</span>
                <span class="s1">tck_d </span><span class="s2">= </span><span class="s1">_impl</span><span class="s2">.</span><span class="s1">splantider</span><span class="s2">((</span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">k</span><span class="s2">))</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bd</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">tck_d</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
                <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bd</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">tck_d</span><span class="s2">[</span><span class="s4">1</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
                <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">bd</span><span class="s2">.</span><span class="s1">k</span><span class="s2">, </span><span class="s1">tck_d</span><span class="s2">[</span><span class="s4">2</span><span class="s2">])</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">bd</span><span class="s2">, </span><span class="s1">BSpline</span><span class="s2">))</span>
                <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">tck_d</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">))  </span><span class="s3"># back-compat: tck in and out</span>

    <span class="s0">def </span><span class="s1">test_insert</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">, </span><span class="s1">xx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">b2</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span>

        <span class="s1">j </span><span class="s2">= </span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">.</span><span class="s1">size </span><span class="s2">// </span><span class="s4">2</span>
        <span class="s1">tn </span><span class="s2">= </span><span class="s4">0.5</span><span class="s2">*(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">[</span><span class="s1">j</span><span class="s2">] + </span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">[</span><span class="s1">j</span><span class="s2">+</span><span class="s4">1</span><span class="s2">])</span>

        <span class="s1">bn</span><span class="s2">, </span><span class="s1">tck_n </span><span class="s2">= </span><span class="s1">insert</span><span class="s2">(</span><span class="s1">tn</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s1">insert</span><span class="s2">(</span><span class="s1">tn</span><span class="s2">, (</span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b</span><span class="s2">.</span><span class="s1">k</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">splev</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">bn</span><span class="s2">),</span>
                        <span class="s1">splev</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">tck_n</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">bn</span><span class="s2">, </span><span class="s1">BSpline</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">tck_n</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">))   </span><span class="s3"># back-compat: tck in, tck out</span>

        <span class="s3"># for N-D array of coefficients, BSpline.c needs to be transposed</span>
        <span class="s3"># after that, the results are equivalent.</span>
        <span class="s1">sh </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">b2</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">ndim</span><span class="s2">))</span>
        <span class="s1">c_ </span><span class="s2">= </span><span class="s1">b2</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">transpose</span><span class="s2">(</span><span class="s1">sh</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] + (</span><span class="s4">0</span><span class="s2">,))</span>
        <span class="s1">tck_n2 </span><span class="s2">= </span><span class="s1">insert</span><span class="s2">(</span><span class="s1">tn</span><span class="s2">, (</span><span class="s1">b2</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c_</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">.</span><span class="s1">k</span><span class="s2">))</span>

        <span class="s1">bn2 </span><span class="s2">= </span><span class="s1">insert</span><span class="s2">(</span><span class="s1">tn</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">)</span>

        <span class="s3"># need a transpose for comparing the results, cf test_splev</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">splev</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">tck_n2</span><span class="s2">)).</span><span class="s1">transpose</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">),</span>
                        <span class="s1">bn2</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">bn2</span><span class="s2">, </span><span class="s1">BSpline</span><span class="s2">))</span>
        <span class="s1">assert_</span><span class="s2">(</span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">tck_n2</span><span class="s2">, </span><span class="s1">tuple</span><span class="s2">))   </span><span class="s3"># back-compat: tck in, tck out</span>


<span class="s0">class </span><span class="s1">TestInterp</span><span class="s2">:</span>
    <span class="s3">#</span>
    <span class="s3"># Test basic ways of constructing interpolating splines.</span>
    <span class="s3">#</span>
    <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">*</span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span><span class="s2">)</span>
    <span class="s1">yy </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_int_order</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">TypeError</span><span class="s2">):</span>
            <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">2.5</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_order_0</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_linear</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'k'</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_incompatible_x_y</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">k</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Shapes of x&quot;</span><span class="s2">):</span>
            <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'k'</span><span class="s2">, [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_broken_x</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">k</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]      </span><span class="s3"># duplicates</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;x to not have duplicates&quot;</span><span class="s2">):</span>
            <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]      </span><span class="s3"># unsorted</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Expect x to be a 1D strictly&quot;</span><span class="s2">):</span>
            <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">x</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">))     </span><span class="s3"># 1D</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Expect x to be a 1D strictly&quot;</span><span class="s2">):</span>
            <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_not_a_knot</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s2">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">]:</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_periodic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># k = 5 here for more derivatives</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'periodic'</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s3"># in periodic case it is expected equality of k-1 first</span>
        <span class="s3"># derivatives at the boundaries</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">):</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">nu</span><span class="s2">=</span><span class="s1">i</span><span class="s2">), </span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">nu</span><span class="s2">=</span><span class="s1">i</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-11</span><span class="s2">)</span>
        <span class="s3"># tests for axis=-1</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'periodic'</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">):</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">nu</span><span class="s2">=</span><span class="s1">i</span><span class="s2">), </span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">nu</span><span class="s2">=</span><span class="s1">i</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-11</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'k'</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_periodic_random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">k</span><span class="s2">):</span>
        <span class="s3"># tests for both cases (k &gt; n and k &lt;= n)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) * </span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) * </span><span class="s4">100</span>
        <span class="s1">y</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s1">y</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'periodic'</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">y</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_periodic_axis</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) * </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s4">0.</span>
        <span class="s1">x</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] = </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">pi</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">2</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">y</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">y</span><span class="s2">[</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'periodic'</span><span class="s2">, </span><span class="s1">axis</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">):</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]), </span><span class="s1">y</span><span class="s2">[:, </span><span class="s1">i</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]), </span><span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_periodic_points_exception</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># first and last points should match when periodic case expected</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">5</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">8</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">y</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s1">y</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] - </span><span class="s4">1  </span><span class="s3"># to be sure that they are not equal</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'periodic'</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_periodic_knots_exception</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># `periodic` case does not work with passed vector of knots</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">7</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">n </span><span class="s2">+ </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s5">'periodic'</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'k'</span><span class="s2">, [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_periodic_splev</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">k</span><span class="s2">):</span>
        <span class="s3"># comparison values of periodic b-spline with splev</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'periodic'</span><span class="s2">)</span>
        <span class="s1">tck </span><span class="s2">= </span><span class="s1">splrep</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">per</span><span class="s2">=</span><span class="s0">True</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">spl </span><span class="s2">= </span><span class="s1">splev</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">tck</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl</span><span class="s2">, </span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s3"># comparison derivatives of periodic b-spline with splev</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">k</span><span class="s2">):</span>
            <span class="s1">spl </span><span class="s2">= </span><span class="s1">splev</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">tck</span><span class="s2">, </span><span class="s1">der</span><span class="s2">=</span><span class="s1">i</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl</span><span class="s2">, </span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=</span><span class="s1">i</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-10</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_periodic_cubic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># comparison values of cubic periodic b-spline with CubicSpline</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'periodic'</span><span class="s2">)</span>
        <span class="s1">cub </span><span class="s2">= </span><span class="s1">CubicSpline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'periodic'</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">cub</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s3"># edge case: Cubic interpolation on 3 points</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) * </span><span class="s4">10</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) * </span><span class="s4">100</span>
        <span class="s1">y</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s1">y</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'periodic'</span><span class="s2">)</span>
        <span class="s1">cub </span><span class="s2">= </span><span class="s1">CubicSpline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'periodic'</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">cub</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_periodic_full_matrix</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># comparison values of cubic periodic b-spline with</span>
        <span class="s3"># solution of the system with full matrix</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'periodic'</span><span class="s2">)</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">_periodic_knots</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">_make_interp_per_full_matr</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">b1 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">vectorize</span><span class="s2">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s2">: </span><span class="s1">_naive_eval</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">b1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_quadratic_deriv</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">der </span><span class="s2">= [(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">8.</span><span class="s2">)]  </span><span class="s3"># order, value: f'(x) = 8.</span>

        <span class="s3"># derivative at right-hand edge</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s1">der</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">1</span><span class="s2">), </span><span class="s1">der</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s3"># derivative at left-hand edge</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s1">der</span><span class="s2">, </span><span class="s0">None</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s4">1</span><span class="s2">), </span><span class="s1">der</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_cubic_deriv</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>

        <span class="s3"># first derivatives at left &amp; right edges:</span>
        <span class="s1">der_l</span><span class="s2">, </span><span class="s1">der_r </span><span class="s2">= [(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">)], [(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">)]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s1">der_l</span><span class="s2">, </span><span class="s1">der_r</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">([</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s4">1</span><span class="s2">), </span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">1</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s1">der_l</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">], </span><span class="s1">der_r</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">]], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s3"># 'natural' cubic spline, zero out 2nd derivatives at the boundaries</span>
        <span class="s1">der_l</span><span class="s2">, </span><span class="s1">der_r </span><span class="s2">= [(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)], [(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s1">der_l</span><span class="s2">, </span><span class="s1">der_r</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_quintic_derivs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">k</span><span class="s2">, </span><span class="s1">n </span><span class="s2">= </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">der_l </span><span class="s2">= [(</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">12.</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)]</span>
        <span class="s1">der_r </span><span class="s2">= [(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">8.</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">)]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s1">der_l</span><span class="s2">, </span><span class="s1">der_r</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">y</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">([</span><span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s4">1</span><span class="s2">), </span><span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s4">2</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s1">val </span><span class="s0">for </span><span class="s2">(</span><span class="s1">nu</span><span class="s2">, </span><span class="s1">val</span><span class="s2">) </span><span class="s0">in </span><span class="s1">der_l</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">([</span><span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">1</span><span class="s2">), </span><span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">2</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s1">val </span><span class="s0">for </span><span class="s2">(</span><span class="s1">nu</span><span class="s2">, </span><span class="s1">val</span><span class="s2">) </span><span class="s0">in </span><span class="s1">der_r</span><span class="s2">])</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">xfail</span><span class="s2">(</span><span class="s1">reason</span><span class="s2">=</span><span class="s5">'unstable'</span><span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_cubic_deriv_unstable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># 1st and 2nd derivative at x[0], no derivative information at x[-1]</span>
        <span class="s3"># The problem is not that it fails [who would use this anyway],</span>
        <span class="s3"># the problem is that it fails *silently*, and I've no idea</span>
        <span class="s3"># how to detect this sort of instability.</span>
        <span class="s3"># In this particular case: it's OK for len(t) &lt; 20, goes haywire</span>
        <span class="s3"># at larger `len(t)`.</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">_augknt</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">der_l </span><span class="s2">= [(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">), (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">)]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s1">der_l</span><span class="s2">, </span><span class="s0">None</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_knots_not_data_sites</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Knots need not coincide with the data sites.</span>
        <span class="s3"># use a quadratic spline, knots are at data averages,</span>
        <span class="s3"># two additional constraints are zero 2nd derivatives at edges</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">2</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">[</span><span class="s4">0</span><span class="s2">],)*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">),</span>
                  <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:] + </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">[:-</span><span class="s4">1</span><span class="s2">]) / </span><span class="s4">2.</span><span class="s2">,</span>
                  <span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">],)*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">t</span><span class="s2">,</span>
                               <span class="s1">bc_type</span><span class="s2">=([(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)], [(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)]))</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">([</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s4">2</span><span class="s2">), </span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">2</span><span class="s2">)], [</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">],</span>
                <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_minimum_points_and_deriv</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># interpolation of f(x) = x**3 between 0 and 1. f'(x) = 3 * xx**2 and</span>
        <span class="s3"># f'(0) = 0, f'(1) = 3.</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">)], [(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">)]))</span>

        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">)</span>
        <span class="s1">yy </span><span class="s2">= </span><span class="s1">xx</span><span class="s2">**</span><span class="s4">3</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_deriv_spec</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># If one of the derivatives is omitted, the spline definition is</span>
        <span class="s3"># incomplete.</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">y </span><span class="s2">= [</span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=([(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">)], </span><span class="s0">None</span><span class="s2">))</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">))</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=[(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">)])</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s4">42</span><span class="s2">)</span>

        <span class="s3"># CubicSpline expects`bc_type=(left_pair, right_pair)`, while</span>
        <span class="s3"># here we expect `bc_type=(iterable, iterable)`.</span>
        <span class="s1">l</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s1">l</span><span class="s2">, </span><span class="s1">r</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_deriv_order_too_large</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">7</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">2</span>
        <span class="s1">l</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= [(</span><span class="s4">6</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)], [(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)]    </span><span class="s3"># 6th derivative = 0 at x[0] for k=3</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Bad boundary conditions at 0.&quot;</span><span class="s2">):</span>
            <span class="s3"># cannot fix 6th derivative at x[0]: does not segfault</span>
            <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s1">l</span><span class="s2">, </span><span class="s1">r</span><span class="s2">))</span>

        <span class="s1">l</span><span class="s2">, </span><span class="s1">r </span><span class="s2">= [(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)], [(-</span><span class="s4">6</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)]    </span><span class="s3"># derivative order &lt; 0 at x[-1]</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Bad boundary conditions at 6.&quot;</span><span class="s2">):</span>
            <span class="s3"># does not segfault</span>
            <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s1">l</span><span class="s2">, </span><span class="s1">r</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span>
        <span class="s1">yy </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy </span><span class="s2">+ </span><span class="s4">1.j</span><span class="s2">*</span><span class="s1">self</span><span class="s2">.</span><span class="s1">yy</span>

        <span class="s3"># first derivatives at left &amp; right edges:</span>
        <span class="s1">der_l</span><span class="s2">, </span><span class="s1">der_r </span><span class="s2">= [(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3.j</span><span class="s2">)], [(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">+</span><span class="s4">2.j</span><span class="s2">)]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s1">der_l</span><span class="s2">, </span><span class="s1">der_r</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">([</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s4">1</span><span class="s2">), </span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">1</span><span class="s2">)],</span>
                        <span class="s2">[</span><span class="s1">der_l</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">], </span><span class="s1">der_r</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">]], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s3"># also test zero and first order</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">):</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_int_xy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>

        <span class="s3"># Cython chokes on &quot;buffer type mismatch&quot; (construction) or</span>
        <span class="s3"># &quot;no matching signature found&quot; (evaluation)</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">):</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>
            <span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sliced_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Cython code chokes on non C contiguous arrays</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">100</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">xx</span><span class="s2">[::</span><span class="s4">5</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">xx</span><span class="s2">[::</span><span class="s4">5</span><span class="s2">]</span>

        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s2">(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">):</span>
            <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_check_finite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># check_finite defaults to True; nans and such trigger a ValueError</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">2</span>

        <span class="s0">for </span><span class="s1">z </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]:</span>
            <span class="s1">y</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">z</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">make_interp_spline</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'k'</span><span class="s2">, [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_list_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">k</span><span class="s2">):</span>
        <span class="s3"># regression test for gh-8714: TypeError for x, y being lists and k=2</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">list</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">10</span><span class="s2">))</span>
        <span class="s1">y </span><span class="s2">= [</span><span class="s1">a</span><span class="s2">**</span><span class="s4">2 </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">x</span><span class="s2">]</span>
        <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_multiple_rhs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">yy </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">c_</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">)]</span>
        <span class="s1">der_l </span><span class="s2">= [(</span><span class="s4">1</span><span class="s2">, [</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">])]</span>
        <span class="s1">der_r </span><span class="s2">= [(</span><span class="s4">1</span><span class="s2">, [</span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">])]</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s1">der_l</span><span class="s2">, </span><span class="s1">der_r</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s4">1</span><span class="s2">), </span><span class="s1">der_l</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">1</span><span class="s2">), </span><span class="s1">der_r</span><span class="s2">[</span><span class="s4">0</span><span class="s2">][</span><span class="s4">1</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_shapes</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">k</span><span class="s2">, </span><span class="s1">n </span><span class="s2">= </span><span class="s4">3</span><span class="s2">, </span><span class="s4">22</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">))</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">))</span>

        <span class="s3"># now throw in some derivatives</span>
        <span class="s1">d_l </span><span class="s2">= [(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">)))]</span>
        <span class="s1">d_r </span><span class="s2">= [(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">)))]</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s1">d_l</span><span class="s2">, </span><span class="s1">d_r</span><span class="s2">))</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">n </span><span class="s2">+ </span><span class="s1">k </span><span class="s2">- </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_string_aliases</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">yy </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">)</span>

        <span class="s3"># a single string is duplicated</span>
        <span class="s1">b1 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'natural'</span><span class="s2">)</span>
        <span class="s1">b2 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=([(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)], [(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)]))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b1</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

        <span class="s3"># two strings are handled</span>
        <span class="s1">b1 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
                                <span class="s1">bc_type</span><span class="s2">=(</span><span class="s5">'natural'</span><span class="s2">, </span><span class="s5">'clamped'</span><span class="s2">))</span>
        <span class="s1">b2 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
                                <span class="s1">bc_type</span><span class="s2">=([(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)], [(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)]))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b1</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

        <span class="s3"># one-sided BCs are OK</span>
        <span class="s1">b1 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, </span><span class="s5">'clamped'</span><span class="s2">))</span>
        <span class="s1">b2 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s0">None</span><span class="s2">, [(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0.0</span><span class="s2">)]))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b1</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

        <span class="s3"># 'not-a-knot' is equivalent to None</span>
        <span class="s1">b1 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'not-a-knot'</span><span class="s2">)</span>
        <span class="s1">b2 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s0">None</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b1</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

        <span class="s3"># unknown strings do not pass</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'typo'</span><span class="s2">)</span>

        <span class="s3"># string aliases are handled for 2D values</span>
        <span class="s1">yy </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">c_</span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cos</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">)]</span>
        <span class="s1">der_l </span><span class="s2">= [(</span><span class="s4">1</span><span class="s2">, [</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">])]</span>
        <span class="s1">der_r </span><span class="s2">= [(</span><span class="s4">2</span><span class="s2">, [</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">0.</span><span class="s2">])]</span>
        <span class="s1">b2 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s1">der_l</span><span class="s2">, </span><span class="s1">der_r</span><span class="s2">))</span>
        <span class="s1">b1 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">yy</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">,</span>
                                <span class="s1">bc_type</span><span class="s2">=(</span><span class="s5">'clamped'</span><span class="s2">, </span><span class="s5">'natural'</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b1</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

        <span class="s3"># ... and for N-D values:</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">k</span><span class="s2">, </span><span class="s1">n </span><span class="s2">= </span><span class="s4">3</span><span class="s2">, </span><span class="s4">22</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">))</span>

        <span class="s3"># now throw in some derivatives</span>
        <span class="s1">d_l </span><span class="s2">= [(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">)))]</span>
        <span class="s1">d_r </span><span class="s2">= [(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">)))]</span>
        <span class="s1">b1 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=(</span><span class="s1">d_l</span><span class="s2">, </span><span class="s1">d_r</span><span class="s2">))</span>
        <span class="s1">b2 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'clamped'</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b1</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b2</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_full_matrix</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">k</span><span class="s2">, </span><span class="s1">n </span><span class="s2">= </span><span class="s4">3</span><span class="s2">, </span><span class="s4">7</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">n</span><span class="s2">))</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">_not_a_knot</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">t</span><span class="s2">)</span>
        <span class="s1">cf </span><span class="s2">= </span><span class="s1">make_interp_full_matr</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">cf</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_woodbury</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">''' 
        Random elements in diagonal matrix with blocks in the 
        left lower and right upper corners checking the 
        implementation of Woodbury algorithm. 
        '''</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">201</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">32</span><span class="s2">, </span><span class="s4">2</span><span class="s2">):</span>
            <span class="s1">offset </span><span class="s2">= </span><span class="s1">int</span><span class="s2">((</span><span class="s1">k </span><span class="s2">- </span><span class="s4">1</span><span class="s2">) / </span><span class="s4">2</span><span class="s2">)</span>
            <span class="s1">a </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diagflat</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)))</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">offset </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">):</span>
                <span class="s1">a</span><span class="s2">[:-</span><span class="s1">i</span><span class="s2">, </span><span class="s1">i</span><span class="s2">:] += </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diagflat</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s1">n </span><span class="s2">- </span><span class="s1">i</span><span class="s2">)))</span>
                <span class="s1">a</span><span class="s2">[</span><span class="s1">i</span><span class="s2">:, :-</span><span class="s1">i</span><span class="s2">] += </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diagflat</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s1">n </span><span class="s2">- </span><span class="s1">i</span><span class="s2">)))</span>
            <span class="s1">ur </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s1">offset</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">))</span>
            <span class="s1">a</span><span class="s2">[:</span><span class="s1">offset</span><span class="s2">, -</span><span class="s1">offset</span><span class="s2">:] = </span><span class="s1">ur</span>
            <span class="s1">ll </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">((</span><span class="s1">offset</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">))</span>
            <span class="s1">a</span><span class="s2">[-</span><span class="s1">offset</span><span class="s2">:, :</span><span class="s1">offset</span><span class="s2">] = </span><span class="s1">ll</span>
            <span class="s1">d </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">k</span><span class="s2">, </span><span class="s1">n</span><span class="s2">))</span>
            <span class="s0">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s0">in </span><span class="s1">enumerate</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s1">offset</span><span class="s2">, -</span><span class="s1">offset </span><span class="s2">- </span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">)):</span>
                <span class="s0">if </span><span class="s1">j </span><span class="s2">&lt; </span><span class="s4">0</span><span class="s2">:</span>
                    <span class="s1">d</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, :</span><span class="s1">j</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diagonal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">=</span><span class="s1">j</span><span class="s2">)</span>
                <span class="s0">else</span><span class="s2">:</span>
                    <span class="s1">d</span><span class="s2">[</span><span class="s1">i</span><span class="s2">, </span><span class="s1">j</span><span class="s2">:] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">diagonal</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">offset</span><span class="s2">=</span><span class="s1">j</span><span class="s2">)</span>
            <span class="s1">b </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
            <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">_woodbury_algorithm</span><span class="s2">(</span><span class="s1">d</span><span class="s2">, </span><span class="s1">ur</span><span class="s2">, </span><span class="s1">ll</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">k</span><span class="s2">),</span>
                            <span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">solve</span><span class="s2">(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">make_interp_full_matr</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Assemble an spline order k with knots t to interpolate 
    y(x) using full matrices. 
    Not-a-knot BC only. 
 
    This routine is here for testing only (even though it's functional). 
    &quot;&quot;&quot;</span>
    <span class="s0">assert </span><span class="s1">x</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s1">y</span><span class="s2">.</span><span class="s1">size</span>
    <span class="s0">assert </span><span class="s1">t</span><span class="s2">.</span><span class="s1">size </span><span class="s2">== </span><span class="s1">x</span><span class="s2">.</span><span class="s1">size </span><span class="s2">+ </span><span class="s1">k </span><span class="s2">+ </span><span class="s4">1</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">size</span>

    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">):</span>
        <span class="s1">xval </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s1">j</span><span class="s2">]</span>
        <span class="s0">if </span><span class="s1">xval </span><span class="s2">== </span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">]:</span>
            <span class="s1">left </span><span class="s2">= </span><span class="s1">k</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">left </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">xval</span><span class="s2">) - </span><span class="s4">1</span>

        <span class="s3"># fill a row</span>
        <span class="s1">bb </span><span class="s2">= </span><span class="s1">_bspl</span><span class="s2">.</span><span class="s1">evaluate_all_bspl</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">xval</span><span class="s2">, </span><span class="s1">left</span><span class="s2">)</span>
        <span class="s1">A</span><span class="s2">[</span><span class="s1">j</span><span class="s2">, </span><span class="s1">left</span><span class="s2">-</span><span class="s1">k</span><span class="s2">:</span><span class="s1">left</span><span class="s2">+</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">bb</span>

    <span class="s1">c </span><span class="s2">= </span><span class="s1">sl</span><span class="s2">.</span><span class="s1">solve</span><span class="s2">(</span><span class="s1">A</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">c</span>


<span class="s0">def </span><span class="s1">make_lsq_full_matrix</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;Make the least-square spline, full matrices.&quot;&quot;&quot;</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">t </span><span class="s2">= </span><span class="s1">map</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">, (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">t</span><span class="s2">))</span>
    <span class="s1">m </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">size</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s1">t</span><span class="s2">.</span><span class="s1">size </span><span class="s2">- </span><span class="s1">k </span><span class="s2">- </span><span class="s4">1</span>

    <span class="s1">A </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">((</span><span class="s1">m</span><span class="s2">, </span><span class="s1">n</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">float64</span><span class="s2">)</span>

    <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">m</span><span class="s2">):</span>
        <span class="s1">xval </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[</span><span class="s1">j</span><span class="s2">]</span>
        <span class="s3"># find interval</span>
        <span class="s0">if </span><span class="s1">xval </span><span class="s2">== </span><span class="s1">t</span><span class="s2">[</span><span class="s1">k</span><span class="s2">]:</span>
            <span class="s1">left </span><span class="s2">= </span><span class="s1">k</span>
        <span class="s0">else</span><span class="s2">:</span>
            <span class="s1">left </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">xval</span><span class="s2">) - </span><span class="s4">1</span>

        <span class="s3"># fill a row</span>
        <span class="s1">bb </span><span class="s2">= </span><span class="s1">_bspl</span><span class="s2">.</span><span class="s1">evaluate_all_bspl</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">xval</span><span class="s2">, </span><span class="s1">left</span><span class="s2">)</span>
        <span class="s1">A</span><span class="s2">[</span><span class="s1">j</span><span class="s2">, </span><span class="s1">left</span><span class="s2">-</span><span class="s1">k</span><span class="s2">:</span><span class="s1">left</span><span class="s2">+</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">bb</span>

    <span class="s3"># have observation matrix, can solve the LSQ problem</span>
    <span class="s1">B </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">A</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">A</span><span class="s2">)</span>
    <span class="s1">Y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dot</span><span class="s2">(</span><span class="s1">A</span><span class="s2">.</span><span class="s1">T</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>
    <span class="s1">c </span><span class="s2">= </span><span class="s1">sl</span><span class="s2">.</span><span class="s1">solve</span><span class="s2">(</span><span class="s1">B</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>

    <span class="s0">return </span><span class="s1">c</span><span class="s2">, (</span><span class="s1">A</span><span class="s2">, </span><span class="s1">Y</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestLSQ</span><span class="s2">:</span>
    <span class="s3">#</span>
    <span class="s3"># Test make_lsq_spline</span>
    <span class="s3">#</span>
    <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
    <span class="s1">n</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s4">13</span><span class="s2">, </span><span class="s4">3</span>
    <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>
    <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
    <span class="s1">t </span><span class="s2">= </span><span class="s1">_augknt</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">7</span><span class="s2">), </span><span class="s1">k</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_lstsq</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># check LSQ construction vs a full matrix version</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">k</span>

        <span class="s1">c0</span><span class="s2">, </span><span class="s1">AY </span><span class="s2">= </span><span class="s1">make_lsq_full_matrix</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_lsq_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">c0</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">t</span><span class="s2">.</span><span class="s1">size </span><span class="s2">- </span><span class="s1">k </span><span class="s2">- </span><span class="s4">1</span><span class="s2">,))</span>

        <span class="s3"># also check against numpy.lstsq</span>
        <span class="s1">aa</span><span class="s2">, </span><span class="s1">yy </span><span class="s2">= </span><span class="s1">AY</span>
        <span class="s1">c1</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_ </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linalg</span><span class="s2">.</span><span class="s1">lstsq</span><span class="s2">(</span><span class="s1">aa</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">rcond</span><span class="s2">=-</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">c1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_weights</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># weights = 1 is same as None</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">k</span>
        <span class="s1">w </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones_like</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_lsq_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">b_w </span><span class="s2">= </span><span class="s1">make_lsq_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">w</span><span class="s2">=</span><span class="s1">w</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">b_w</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">b_w</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">k</span><span class="s2">, </span><span class="s1">b_w</span><span class="s2">.</span><span class="s1">k</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_multiple_rhs</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">n </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">k</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">n</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">))</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_lsq_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">assert_equal</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">, (</span><span class="s1">t</span><span class="s2">.</span><span class="s1">size</span><span class="s2">-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># cmplx-valued `y`</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">k</span>
        <span class="s1">yc </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y </span><span class="s2">* (</span><span class="s4">1. </span><span class="s2">+ </span><span class="s4">2.j</span><span class="s2">)</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">make_lsq_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">yc</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">b_re </span><span class="s2">= </span><span class="s1">make_lsq_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">yc</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">b_im </span><span class="s2">= </span><span class="s1">make_lsq_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">yc</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">b</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">b_re</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) + </span><span class="s4">1.j</span><span class="s2">*</span><span class="s1">b_im</span><span class="s2">(</span><span class="s1">x</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_int_xy</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">10</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">int</span><span class="s2">)</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">_augknt</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s3"># Cython chokes on &quot;buffer type mismatch&quot;</span>
        <span class="s1">make_lsq_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_sliced_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Cython code chokes on non C contiguous arrays</span>
        <span class="s1">xx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">100</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">xx</span><span class="s2">[::</span><span class="s4">3</span><span class="s2">]</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">xx</span><span class="s2">[::</span><span class="s4">3</span><span class="s2">]</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">_augknt</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">make_lsq_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_checkfinite</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># check_finite defaults to True; nans and such trigger a ValueError</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">12</span><span class="s2">).</span><span class="s1">astype</span><span class="s2">(</span><span class="s1">float</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">2</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">_augknt</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">z </span><span class="s0">in </span><span class="s2">[</span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">, -</span><span class="s1">np</span><span class="s2">.</span><span class="s1">inf</span><span class="s2">]:</span>
            <span class="s1">y</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">z</span>
            <span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">make_lsq_spline</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">t</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_read_only</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># Check that make_lsq_spline works with read only arrays</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">t </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">x</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">y</span><span class="s2">, </span><span class="s1">self</span><span class="s2">.</span><span class="s1">t</span>
        <span class="s1">x</span><span class="s2">.</span><span class="s1">setflags</span><span class="s2">(</span><span class="s1">write</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">y</span><span class="s2">.</span><span class="s1">setflags</span><span class="s2">(</span><span class="s1">write</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">t</span><span class="s2">.</span><span class="s1">setflags</span><span class="s2">(</span><span class="s1">write</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s1">make_lsq_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">=</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">=</span><span class="s1">y</span><span class="s2">, </span><span class="s1">t</span><span class="s2">=</span><span class="s1">t</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">data_file</span><span class="s2">(</span><span class="s1">basename</span><span class="s2">):</span>
    <span class="s0">return </span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">abspath</span><span class="s2">(</span><span class="s1">os</span><span class="s2">.</span><span class="s1">path</span><span class="s2">.</span><span class="s1">dirname</span><span class="s2">(</span><span class="s1">__file__</span><span class="s2">)),</span>
                        <span class="s5">'data'</span><span class="s2">, </span><span class="s1">basename</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestSmoothingSpline</span><span class="s2">:</span>
    <span class="s3">#</span>
    <span class="s3"># test make_smoothing_spline</span>
    <span class="s3">#</span>
    <span class="s0">def </span><span class="s1">test_invalid_input</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) * </span><span class="s4">4 </span><span class="s2">- </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s4">4 </span><span class="s2">* </span><span class="s1">x</span><span class="s2">) + </span><span class="s1">x</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>

        <span class="s3"># ``x`` and ``y`` should have same shapes (1-D array)</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">make_smoothing_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:])</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">make_smoothing_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:], </span><span class="s1">y</span><span class="s2">)</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">make_smoothing_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">1</span><span class="s2">, </span><span class="s1">n</span><span class="s2">), </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s3"># ``x`` should be an ascending array</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">make_smoothing_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[::-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s1">x_dupl </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">(</span><span class="s1">x</span><span class="s2">)</span>
        <span class="s1">x_dupl</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s1">x_dupl</span><span class="s2">[</span><span class="s4">1</span><span class="s2">]</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">make_smoothing_spline</span><span class="s2">(</span><span class="s1">x_dupl</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s3"># x and y length must be &gt;= 5</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s4">4</span><span class="s2">)</span>
        <span class="s1">exception_message </span><span class="s2">= </span><span class="s5">&quot;``x`` and ``y`` length must be at least 5&quot;</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s1">exception_message</span><span class="s2">):</span>
            <span class="s1">make_smoothing_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_compare_with_GCVSPL</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        Data is generated in the following way: 
        &gt;&gt;&gt; np.random.seed(1234) 
        &gt;&gt;&gt; n = 100 
        &gt;&gt;&gt; x = np.sort(np.random.random_sample(n) * 4 - 2) 
        &gt;&gt;&gt; y = np.sin(x) + np.random.normal(scale=.5, size=n) 
        &gt;&gt;&gt; np.savetxt('x.csv', x) 
        &gt;&gt;&gt; np.savetxt('y.csv', y) 
 
        We obtain the result of performing the GCV smoothing splines 
        package (by Woltring, gcvspl) on the sample data points 
        using its version for Octave (https://github.com/srkuberski/gcvspl). 
        In order to use this implementation, one should clone the repository 
        and open the folder in Octave. 
        In Octave, we load up ``x`` and ``y`` (generated from Python code 
        above): 
 
        &gt;&gt;&gt; x = csvread('x.csv'); 
        &gt;&gt;&gt; y = csvread('y.csv'); 
 
        Then, in order to access the implementation, we compile gcvspl files in 
        Octave: 
 
        &gt;&gt;&gt; mex gcvsplmex.c gcvspl.c 
        &gt;&gt;&gt; mex spldermex.c gcvspl.c 
 
        The first function computes the vector of unknowns from the dataset 
        (x, y) while the second one evaluates the spline in certain points 
        with known vector of coefficients. 
 
        &gt;&gt;&gt; c = gcvsplmex( x, y, 2 ); 
        &gt;&gt;&gt; y0 = spldermex( x, c, 2, x, 0 ); 
 
        If we want to compare the results of the gcvspl code, we can save 
        ``y0`` in csv file: 
 
        &gt;&gt;&gt; csvwrite('y0.csv', y0); 
 
        &quot;&quot;&quot;</span>
        <span class="s3"># load the data sample</span>
        <span class="s0">with </span><span class="s1">np</span><span class="s2">.</span><span class="s1">load</span><span class="s2">(</span><span class="s1">data_file</span><span class="s2">(</span><span class="s5">'gcvspl.npz'</span><span class="s2">)) </span><span class="s0">as </span><span class="s1">data</span><span class="s2">:</span>
            <span class="s3"># data points</span>
            <span class="s1">x </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s5">'x'</span><span class="s2">]</span>
            <span class="s1">y </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s5">'y'</span><span class="s2">]</span>

            <span class="s1">y_GCVSPL </span><span class="s2">= </span><span class="s1">data</span><span class="s2">[</span><span class="s5">'y_GCVSPL'</span><span class="s2">]</span>
        <span class="s1">y_compr </span><span class="s2">= </span><span class="s1">make_smoothing_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)(</span><span class="s1">x</span><span class="s2">)</span>

        <span class="s3"># such tolerance is explained by the fact that the spline is built</span>
        <span class="s3"># using an iterative algorithm for minimizing the GCV criteria. These</span>
        <span class="s3"># algorithms may vary, so the tolerance should be rather low.</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">y_compr</span><span class="s2">, </span><span class="s1">y_GCVSPL</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-4</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_regularized_case</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot; 
        In case the regularization parameter is 0, the resulting spline 
        is an interpolation spline with natural boundary conditions. 
        &quot;&quot;&quot;</span>
        <span class="s3"># create data sample</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) * </span><span class="s4">4 </span><span class="s2">- </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s4">4 </span><span class="s2">* </span><span class="s1">x</span><span class="s2">) + </span><span class="s1">x</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>

        <span class="s1">spline_GCV </span><span class="s2">= </span><span class="s1">make_smoothing_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">lam</span><span class="s2">=</span><span class="s4">0.</span><span class="s2">)</span>
        <span class="s1">spline_interp </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">bc_type</span><span class="s2">=</span><span class="s5">'natural'</span><span class="s2">)</span>

        <span class="s1">grid </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">linspace</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">], </span><span class="s4">2 </span><span class="s2">* </span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spline_GCV</span><span class="s2">(</span><span class="s1">grid</span><span class="s2">),</span>
                        <span class="s1">spline_interp</span><span class="s2">(</span><span class="s1">grid</span><span class="s2">),</span>
                        <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_weighted_smoothing_spline</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># create data sample</span>
        <span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">seed</span><span class="s2">(</span><span class="s4">1234</span><span class="s2">)</span>
        <span class="s1">n </span><span class="s2">= </span><span class="s4">100</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">random_sample</span><span class="s2">(</span><span class="s1">n</span><span class="s2">) * </span><span class="s4">4 </span><span class="s2">- </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">* </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sin</span><span class="s2">(</span><span class="s4">4 </span><span class="s2">* </span><span class="s1">x</span><span class="s2">) + </span><span class="s1">x</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">normal</span><span class="s2">(</span><span class="s4">0.</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s1">n</span><span class="s2">)</span>

        <span class="s1">spl </span><span class="s2">= </span><span class="s1">make_smoothing_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)</span>

        <span class="s3"># in order not to iterate over all of the indices, we select 10 of</span>
        <span class="s3"># them randomly</span>
        <span class="s0">for </span><span class="s1">ind </span><span class="s0">in </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">choice</span><span class="s2">(</span><span class="s1">range</span><span class="s2">(</span><span class="s4">100</span><span class="s2">), </span><span class="s1">size</span><span class="s2">=</span><span class="s4">10</span><span class="s2">):</span>
            <span class="s1">w </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">ones</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
            <span class="s1">w</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">] = </span><span class="s4">30.</span>
            <span class="s1">spl_w </span><span class="s2">= </span><span class="s1">make_smoothing_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">w</span><span class="s2">)</span>
            <span class="s3"># check that spline with weight in a certain point is closer to the</span>
            <span class="s3"># original point than the one without weights</span>
            <span class="s1">orig </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">spl</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">]) - </span><span class="s1">y</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">])</span>
            <span class="s1">weighted </span><span class="s2">= </span><span class="s1">abs</span><span class="s2">(</span><span class="s1">spl_w</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">]) - </span><span class="s1">y</span><span class="s2">[</span><span class="s1">ind</span><span class="s2">])</span>

            <span class="s0">if </span><span class="s1">orig </span><span class="s2">&lt; </span><span class="s1">weighted</span><span class="s2">:</span>
                <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s5">f'Spline with weights should be closer to the'</span>
                                 <span class="s5">f' points than the original one: </span><span class="s0">{</span><span class="s1">orig</span><span class="s0">:</span><span class="s5">.4</span><span class="s0">} </span><span class="s5">&lt; '</span>
                                 <span class="s5">f'</span><span class="s0">{</span><span class="s1">weighted</span><span class="s0">:</span><span class="s5">.4</span><span class="s0">}</span><span class="s5">'</span><span class="s2">)</span>


<span class="s3">################################</span>
<span class="s3"># NdBSpline tests</span>
<span class="s0">def </span><span class="s1">bspline2</span><span class="s2">(</span><span class="s1">xy</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">):</span>
    <span class="s6">&quot;&quot;&quot;A naive 2D tensort product spline evaluation.&quot;&quot;&quot;</span>
    <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">xy</span>
    <span class="s1">tx</span><span class="s2">, </span><span class="s1">ty </span><span class="s2">= </span><span class="s1">t</span>
    <span class="s1">nx </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">tx</span><span class="s2">) - </span><span class="s1">k </span><span class="s2">- </span><span class="s4">1</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">nx </span><span class="s2">&gt;= </span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s1">ny </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">ty</span><span class="s2">) - </span><span class="s1">k </span><span class="s2">- </span><span class="s4">1</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">ny </span><span class="s2">&gt;= </span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">c</span><span class="s2">[</span><span class="s1">ix</span><span class="s2">, </span><span class="s1">iy</span><span class="s2">] * </span><span class="s1">B</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">ix</span><span class="s2">, </span><span class="s1">tx</span><span class="s2">) * </span><span class="s1">B</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">iy</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">)</span>
               <span class="s0">for </span><span class="s1">ix </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">nx</span><span class="s2">) </span><span class="s0">for </span><span class="s1">iy </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">ny</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">B</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">t</span><span class="s2">):</span>
    <span class="s0">if </span><span class="s1">k </span><span class="s2">== </span><span class="s4">0</span><span class="s2">:</span>
        <span class="s0">return </span><span class="s4">1.0 </span><span class="s0">if </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] &lt;= </span><span class="s1">x </span><span class="s2">&lt; </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">] </span><span class="s0">else </span><span class="s4">0.0</span>
    <span class="s0">if </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s1">k</span><span class="s2">] == </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]:</span>
        <span class="s1">c1 </span><span class="s2">= </span><span class="s4">0.0</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">c1 </span><span class="s2">= (</span><span class="s1">x </span><span class="s2">- </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">])/(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s1">k</span><span class="s2">] - </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">]) * </span><span class="s1">B</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">t</span><span class="s2">)</span>
    <span class="s0">if </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">] == </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]:</span>
        <span class="s1">c2 </span><span class="s2">= </span><span class="s4">0.0</span>
    <span class="s0">else</span><span class="s2">:</span>
        <span class="s1">c2 </span><span class="s2">= (</span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">] - </span><span class="s1">x</span><span class="s2">)/(</span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">] - </span><span class="s1">t</span><span class="s2">[</span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">]) * </span><span class="s1">B</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">i</span><span class="s2">+</span><span class="s4">1</span><span class="s2">, </span><span class="s1">t</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">c1 </span><span class="s2">+ </span><span class="s1">c2</span>


<span class="s0">def </span><span class="s1">bspline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">):</span>
    <span class="s1">n </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">t</span><span class="s2">) - </span><span class="s1">k </span><span class="s2">- </span><span class="s4">1</span>
    <span class="s0">assert </span><span class="s2">(</span><span class="s1">n </span><span class="s2">&gt;= </span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">) </span><span class="s0">and </span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">c</span><span class="s2">) &gt;= </span><span class="s1">n</span><span class="s2">)</span>
    <span class="s0">return </span><span class="s1">sum</span><span class="s2">(</span><span class="s1">c</span><span class="s2">[</span><span class="s1">i</span><span class="s2">] * </span><span class="s1">B</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">i</span><span class="s2">, </span><span class="s1">t</span><span class="s2">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">n</span><span class="s2">))</span>


<span class="s0">class </span><span class="s1">NdBSpline0</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">__init__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">):</span>
        <span class="s6">&quot;&quot;&quot;Tensor product spline object. 
 
        c[i1, i2, ..., id] * B(x1, i1) * B(x2, i2) * ... * B(xd, id) 
 
        Parameters 
        ---------- 
        c : ndarray, shape (n1, n2, ..., nd, ...) 
            b-spline coefficients 
        t : tuple of 1D ndarrays 
            knot vectors in directions 1, 2, ... d 
            ``len(t[i]) == n[i] + k + 1`` 
        k : int or length-d tuple of integers 
            spline degrees. 
        &quot;&quot;&quot;</span>
        <span class="s1">ndim </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">t</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">ndim </span><span class="s2">&lt;= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">c</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">)</span>

        <span class="s0">try</span><span class="s2">:</span>
            <span class="s1">len</span><span class="s2">(</span><span class="s1">k</span><span class="s2">)</span>
        <span class="s0">except </span><span class="s1">TypeError</span><span class="s2">:</span>
            <span class="s3"># make k a tuple</span>
            <span class="s1">k </span><span class="s2">= (</span><span class="s1">k</span><span class="s2">,)*</span><span class="s1">ndim</span>

        <span class="s1">self</span><span class="s2">.</span><span class="s1">k </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">operator</span><span class="s2">.</span><span class="s1">index</span><span class="s2">(</span><span class="s1">ki</span><span class="s2">) </span><span class="s0">for </span><span class="s1">ki </span><span class="s0">in </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">t </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">ti</span><span class="s2">, </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">float</span><span class="s2">) </span><span class="s0">for </span><span class="s1">ti </span><span class="s0">in </span><span class="s1">t</span><span class="s2">)</span>
        <span class="s1">self</span><span class="s2">.</span><span class="s1">c </span><span class="s2">= </span><span class="s1">c</span>

    <span class="s0">def </span><span class="s1">__call__</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">x</span><span class="s2">):</span>
        <span class="s1">ndim </span><span class="s2">= </span><span class="s1">len</span><span class="s2">(</span><span class="s1">self</span><span class="s2">.</span><span class="s1">t</span><span class="s2">)</span>
        <span class="s3"># a single evaluation point: `x` is a 1D array_like, shape (ndim,)</span>
        <span class="s0">assert </span><span class="s1">len</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) == </span><span class="s1">ndim</span>

        <span class="s3"># get the indices in an ndim-dimensional vector</span>
        <span class="s1">i </span><span class="s2">= [</span><span class="s5">'none'</span><span class="s2">, ]*</span><span class="s1">ndim</span>
        <span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">ndim</span><span class="s2">):</span>
            <span class="s1">td</span><span class="s2">, </span><span class="s1">xd </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">t</span><span class="s2">[</span><span class="s1">d</span><span class="s2">], </span><span class="s1">x</span><span class="s2">[</span><span class="s1">d</span><span class="s2">]</span>
            <span class="s1">k </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">k</span><span class="s2">[</span><span class="s1">d</span><span class="s2">]</span>

            <span class="s3"># find the index for x[d]</span>
            <span class="s0">if </span><span class="s1">xd </span><span class="s2">== </span><span class="s1">td</span><span class="s2">[</span><span class="s1">k</span><span class="s2">]:</span>
                <span class="s1">i</span><span class="s2">[</span><span class="s1">d</span><span class="s2">] = </span><span class="s1">k</span>
            <span class="s0">else</span><span class="s2">:</span>
                <span class="s1">i</span><span class="s2">[</span><span class="s1">d</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">searchsorted</span><span class="s2">(</span><span class="s1">td</span><span class="s2">, </span><span class="s1">xd</span><span class="s2">) - </span><span class="s4">1</span>
            <span class="s0">assert </span><span class="s1">td</span><span class="s2">[</span><span class="s1">i</span><span class="s2">[</span><span class="s1">d</span><span class="s2">]] &lt;= </span><span class="s1">xd </span><span class="s2">&lt;= </span><span class="s1">td</span><span class="s2">[</span><span class="s1">i</span><span class="s2">[</span><span class="s1">d</span><span class="s2">]+</span><span class="s4">1</span><span class="s2">]</span>
            <span class="s0">assert </span><span class="s1">i</span><span class="s2">[</span><span class="s1">d</span><span class="s2">] &gt;= </span><span class="s1">k </span><span class="s0">and </span><span class="s1">i</span><span class="s2">[</span><span class="s1">d</span><span class="s2">] &lt; </span><span class="s1">len</span><span class="s2">(</span><span class="s1">td</span><span class="s2">) - </span><span class="s1">k</span>
        <span class="s1">i </span><span class="s2">= </span><span class="s1">tuple</span><span class="s2">(</span><span class="s1">i</span><span class="s2">)</span>

        <span class="s3"># iterate over the dimensions, form linear combinations of</span>
        <span class="s3"># products B(x_1) * B(x_2) * ... B(x_N) of (k+1)**N b-splines</span>
        <span class="s3"># which are non-zero at `i = (i_1, i_2, ..., i_N)`.</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s4">0</span>
        <span class="s1">iters </span><span class="s2">= [</span><span class="s1">range</span><span class="s2">(</span><span class="s1">i</span><span class="s2">[</span><span class="s1">d</span><span class="s2">] - </span><span class="s1">self</span><span class="s2">.</span><span class="s1">k</span><span class="s2">[</span><span class="s1">d</span><span class="s2">], </span><span class="s1">i</span><span class="s2">[</span><span class="s1">d</span><span class="s2">] + </span><span class="s4">1</span><span class="s2">) </span><span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">ndim</span><span class="s2">)]</span>
        <span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(*</span><span class="s1">iters</span><span class="s2">):</span>
            <span class="s1">term </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">c</span><span class="s2">[</span><span class="s1">idx</span><span class="s2">] * </span><span class="s1">np</span><span class="s2">.</span><span class="s1">prod</span><span class="s2">([</span><span class="s1">B</span><span class="s2">(</span><span class="s1">x</span><span class="s2">[</span><span class="s1">d</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">k</span><span class="s2">[</span><span class="s1">d</span><span class="s2">], </span><span class="s1">idx</span><span class="s2">[</span><span class="s1">d</span><span class="s2">], </span><span class="s1">self</span><span class="s2">.</span><span class="s1">t</span><span class="s2">[</span><span class="s1">d</span><span class="s2">])</span>
                                          <span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s1">ndim</span><span class="s2">)])</span>
            <span class="s1">result </span><span class="s2">+= </span><span class="s1">term</span>
        <span class="s0">return </span><span class="s1">result</span>


<span class="s0">class </span><span class="s1">TestNdBSpline</span><span class="s2">:</span>

    <span class="s0">def </span><span class="s1">test_1D</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test ndim=1 agrees with BSpline</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">n</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s4">11</span><span class="s2">, </span><span class="s4">3</span>
        <span class="s1">n_tr </span><span class="s2">= </span><span class="s4">7</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s1">n </span><span class="s2">+ </span><span class="s1">k </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">n</span><span class="s2">, </span><span class="s1">n_tr</span><span class="s2">))</span>

        <span class="s1">b </span><span class="s2">= </span><span class="s1">BSpline</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">nb </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">((</span><span class="s1">t</span><span class="s2">,), </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">xi </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">21</span><span class="s2">)</span>
        <span class="s3"># NdBSpline expects xi.shape=(npts, ndim)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">nb</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">]),</span>
                        <span class="s1">b</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">nb</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">]).</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">xi</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">], </span><span class="s1">c</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">1</span><span class="s2">])</span>

    <span class="s0">def </span><span class="s1">make_2d_case</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># make a 2D separable spline</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">6</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">3</span>
        <span class="s1">spl </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s1">y_1 </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">x</span>
        <span class="s1">spl_1 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y_1</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s1">t2 </span><span class="s2">= (</span><span class="s1">spl</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">spl_1</span><span class="s2">.</span><span class="s1">t</span><span class="s2">)</span>
        <span class="s1">c2 </span><span class="s2">= </span><span class="s1">spl</span><span class="s2">.</span><span class="s1">c</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">] * </span><span class="s1">spl_1</span><span class="s2">.</span><span class="s1">c</span><span class="s2">[</span><span class="s0">None</span><span class="s2">, :]</span>

        <span class="s0">return </span><span class="s1">t2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s4">3</span>

    <span class="s0">def </span><span class="s1">make_2d_mixed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># make a 2D separable spline w/ kx=3, ky=2</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">6</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">3</span>
        <span class="s1">spl </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">5</span><span class="s2">) + </span><span class="s4">1.5</span>
        <span class="s1">y_1 </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">x</span>
        <span class="s1">spl_1 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y_1</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">2</span><span class="s2">)</span>

        <span class="s1">t2 </span><span class="s2">= (</span><span class="s1">spl</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">spl_1</span><span class="s2">.</span><span class="s1">t</span><span class="s2">)</span>
        <span class="s1">c2 </span><span class="s2">= </span><span class="s1">spl</span><span class="s2">.</span><span class="s1">c</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">] * </span><span class="s1">spl_1</span><span class="s2">.</span><span class="s1">c</span><span class="s2">[</span><span class="s0">None</span><span class="s2">, :]</span>

        <span class="s0">return </span><span class="s1">t2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">spl</span><span class="s2">.</span><span class="s1">k</span><span class="s2">, </span><span class="s1">spl_1</span><span class="s2">.</span><span class="s1">k</span>

    <span class="s0">def </span><span class="s1">test_2D_separable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">xi </span><span class="s2">= [(</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">), (</span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">)]</span>
        <span class="s1">t2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_2d_case</span><span class="s2">()</span>
        <span class="s1">target </span><span class="s2">= [</span><span class="s1">x</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">* (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">) </span><span class="s0">for </span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) </span><span class="s0">in </span><span class="s1">xi</span><span class="s2">]</span>

        <span class="s3"># sanity check: bspline2 gives the product as constructed</span>
        <span class="s1">assert_allclose</span><span class="s2">([</span><span class="s1">bspline2</span><span class="s2">(</span><span class="s1">xy</span><span class="s2">, </span><span class="s1">t2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) </span><span class="s0">for </span><span class="s1">xy </span><span class="s0">in </span><span class="s1">xi</span><span class="s2">],</span>
                        <span class="s1">target</span><span class="s2">,</span>
                        <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s3"># check evaluation on a 2D array: the 1D array of 2D points</span>
        <span class="s1">bspl2 </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">(</span><span class="s1">t2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">bspl2</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">).</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">len</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), )</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl2</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">),</span>
                        <span class="s1">target</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s3"># now check on a multidim xi</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">xi </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)) * </span><span class="s4">5</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">bspl2</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">4</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)</span>

        <span class="s3"># also check the values</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s2">= </span><span class="s1">xi</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">((-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)).</span><span class="s1">T</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(),</span>
                        <span class="s1">x</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">* (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_2D_separable_2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test `c` with trailing dimensions, i.e. c.ndim &gt; ndim</span>
        <span class="s1">ndim </span><span class="s2">= </span><span class="s4">2</span>
        <span class="s1">xi </span><span class="s2">= [(</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">), (</span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">)]</span>
        <span class="s1">target </span><span class="s2">= [</span><span class="s1">x</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">* (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">) </span><span class="s0">for </span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) </span><span class="s0">in </span><span class="s1">xi</span><span class="s2">]</span>

        <span class="s1">t2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_2d_case</span><span class="s2">()</span>
        <span class="s1">c2_4 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dstack</span><span class="s2">((</span><span class="s1">c2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">))   </span><span class="s3"># c22.shape = (6, 6, 4)</span>

        <span class="s1">xy </span><span class="s2">= (</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2.5</span><span class="s2">)</span>
        <span class="s1">bspl2_4 </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">(</span><span class="s1">t2</span><span class="s2">, </span><span class="s1">c2_4</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">bspl2_4</span><span class="s2">(</span><span class="s1">xy</span><span class="s2">)</span>
        <span class="s1">val_single </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">(</span><span class="s1">t2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)(</span><span class="s1">xy</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">4</span><span class="s2">,)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">result</span><span class="s2">,</span>
                        <span class="s2">[</span><span class="s1">val_single</span><span class="s2">, ]*</span><span class="s4">4</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s3"># now try the array xi : the output.shape is (3, 4) where 3</span>
        <span class="s3"># is the number of points in xi and 4 is the trailing dimension of c</span>
        <span class="s0">assert </span><span class="s1">bspl2_4</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">).</span><span class="s1">shape </span><span class="s2">== </span><span class="s1">np</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">)[:-</span><span class="s4">1</span><span class="s2">] + </span><span class="s1">bspl2_4</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s1">ndim</span><span class="s2">:]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl2_4</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">) - </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">target</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">],</span>
                        <span class="s4">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">5e-14</span><span class="s2">)</span>

        <span class="s3"># two trailing dimensions</span>
        <span class="s1">c2_22 </span><span class="s2">= </span><span class="s1">c2_4</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">((</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">bspl2_22 </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">(</span><span class="s1">t2</span><span class="s2">, </span><span class="s1">c2_22</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">bspl2_22</span><span class="s2">(</span><span class="s1">xy</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">result</span><span class="s2">,</span>
                        <span class="s2">[[</span><span class="s1">val_single</span><span class="s2">, </span><span class="s1">val_single</span><span class="s2">],</span>
                         <span class="s2">[</span><span class="s1">val_single</span><span class="s2">, </span><span class="s1">val_single</span><span class="s2">]], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s3"># now try the array xi : the output shape is (3, 2, 2)</span>
        <span class="s3"># for 3 points in xi and c trailing dimensions being (2, 2)</span>
        <span class="s0">assert </span><span class="s2">(</span><span class="s1">bspl2_22</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">).</span><span class="s1">shape </span><span class="s2">==</span>
                <span class="s1">np</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">)[:-</span><span class="s4">1</span><span class="s2">] + </span><span class="s1">bspl2_22</span><span class="s2">.</span><span class="s1">c</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s1">ndim</span><span class="s2">:])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl2_22</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">) - </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">target</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">],</span>
                        <span class="s4">0</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">5e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_2D_random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">tx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">7</span><span class="s2">)) * </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]</span>
        <span class="s1">ty </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">8</span><span class="s2">)) * </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">tx</span><span class="s2">.</span><span class="s1">size</span><span class="s2">-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">.</span><span class="s1">size</span><span class="s2">-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">))</span>

        <span class="s1">spl </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">((</span><span class="s1">tx</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">), </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">xi </span><span class="s2">= (</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">),</span>
                        <span class="s1">bspline2</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, (</span><span class="s1">tx</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">), </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s1">xi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">c_</span><span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">1.6</span><span class="s2">, </span><span class="s4">2.1</span><span class="s2">]]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">),</span>
                        <span class="s2">[</span><span class="s1">bspline2</span><span class="s2">(</span><span class="s1">xy</span><span class="s2">, (</span><span class="s1">tx</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">), </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) </span><span class="s0">for </span><span class="s1">xy </span><span class="s0">in </span><span class="s1">xi</span><span class="s2">],</span>
                        <span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_2D_mixed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">t2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">kx</span><span class="s2">, </span><span class="s1">ky </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_2d_mixed</span><span class="s2">()</span>
        <span class="s1">xi </span><span class="s2">= [(</span><span class="s4">1.4</span><span class="s2">, </span><span class="s4">4.5</span><span class="s2">), (</span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">2.4</span><span class="s2">), (</span><span class="s4">4.5</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">)]</span>
        <span class="s1">target </span><span class="s2">= [</span><span class="s1">x</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">* (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">) </span><span class="s0">for </span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">) </span><span class="s0">in </span><span class="s1">xi</span><span class="s2">]</span>
        <span class="s1">bspl2 </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">(</span><span class="s1">t2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=(</span><span class="s1">kx</span><span class="s2">, </span><span class="s1">ky</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">bspl2</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">).</span><span class="s1">shape </span><span class="s2">== (</span><span class="s1">len</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), )</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl2</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">),</span>
                        <span class="s1">target</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_2D_derivative</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">t2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">kx</span><span class="s2">, </span><span class="s1">ky </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_2d_mixed</span><span class="s2">()</span>
        <span class="s1">xi </span><span class="s2">= [(</span><span class="s4">1.4</span><span class="s2">, </span><span class="s4">4.5</span><span class="s2">), (</span><span class="s4">2.5</span><span class="s2">, </span><span class="s4">2.4</span><span class="s2">), (</span><span class="s4">4.5</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">)]</span>
        <span class="s1">bspl2 </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">(</span><span class="s1">t2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=(</span><span class="s1">kx</span><span class="s2">, </span><span class="s1">ky</span><span class="s2">))</span>

        <span class="s1">der </span><span class="s2">= </span><span class="s1">bspl2</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">der</span><span class="s2">,</span>
                        <span class="s2">[</span><span class="s4">3</span><span class="s2">*</span><span class="s1">x</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">* (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">xi</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s1">der </span><span class="s2">= </span><span class="s1">bspl2</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">der</span><span class="s2">,</span>
                        <span class="s2">[</span><span class="s4">3</span><span class="s2">*</span><span class="s1">x</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">* (</span><span class="s4">2</span><span class="s2">*</span><span class="s1">y </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">xi</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s1">der </span><span class="s2">= </span><span class="s1">bspl2</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">der</span><span class="s2">,</span>
                        <span class="s2">[</span><span class="s1">x</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">* (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">) </span><span class="s0">for </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">xi</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s3"># all(nu &gt;= 0)</span>
            <span class="s1">der </span><span class="s2">= </span><span class="s1">bspl2</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">))</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s3"># len(nu) == ndim</span>
            <span class="s1">der </span><span class="s2">= </span><span class="s1">bspl2</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=(-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_2D_mixed_random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">kx</span><span class="s2">, </span><span class="s1">ky </span><span class="s2">= </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span>
        <span class="s1">tx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">7</span><span class="s2">)) * </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]</span>
        <span class="s1">ty </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">8</span><span class="s2">)) * </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">tx</span><span class="s2">.</span><span class="s1">size </span><span class="s2">- </span><span class="s1">kx </span><span class="s2">- </span><span class="s4">1</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">.</span><span class="s1">size </span><span class="s2">- </span><span class="s1">ky </span><span class="s2">- </span><span class="s4">1</span><span class="s2">))</span>

        <span class="s1">xi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">c_</span><span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">1.6</span><span class="s2">, </span><span class="s4">2.1</span><span class="s2">]]</span>

        <span class="s1">bspl2 </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">((</span><span class="s1">tx</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">), </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=(</span><span class="s1">kx</span><span class="s2">, </span><span class="s1">ky</span><span class="s2">))</span>
        <span class="s1">bspl2_0 </span><span class="s2">= </span><span class="s1">NdBSpline0</span><span class="s2">((</span><span class="s1">tx</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">), </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=(</span><span class="s1">kx</span><span class="s2">, </span><span class="s1">ky</span><span class="s2">))</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl2</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">),</span>
                        <span class="s2">[</span><span class="s1">bspl2_0</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">) </span><span class="s0">for </span><span class="s1">xp </span><span class="s0">in </span><span class="s1">xi</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_tx_neq_ty</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># 2D separable spline w/ len(tx) != len(ty)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">6</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">7</span><span class="s2">) + </span><span class="s4">1.5</span>

        <span class="s1">spl_x </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">**</span><span class="s4">3</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">spl_y </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">cc </span><span class="s2">= </span><span class="s1">spl_x</span><span class="s2">.</span><span class="s1">c</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">] * </span><span class="s1">spl_y</span><span class="s2">.</span><span class="s1">c</span><span class="s2">[</span><span class="s0">None</span><span class="s2">, :]</span>
        <span class="s1">bspl </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">((</span><span class="s1">spl_x</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">spl_y</span><span class="s2">.</span><span class="s1">t</span><span class="s2">), </span><span class="s1">cc</span><span class="s2">, (</span><span class="s1">spl_x</span><span class="s2">.</span><span class="s1">k</span><span class="s2">, </span><span class="s1">spl_y</span><span class="s2">.</span><span class="s1">k</span><span class="s2">))</span>

        <span class="s1">values </span><span class="s2">= (</span><span class="s1">x</span><span class="s2">**</span><span class="s4">3</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">] * (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">)[</span><span class="s0">None</span><span class="s2">, :]</span>
        <span class="s1">rgi </span><span class="s2">= </span><span class="s1">RegularGridInterpolator</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">values</span><span class="s2">)</span>

        <span class="s1">xi </span><span class="s2">= [(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)]</span>
        <span class="s1">bxi </span><span class="s2">= </span><span class="s1">bspl</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">)</span>

        <span class="s0">assert not </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">bxi</span><span class="s2">).</span><span class="s1">any</span><span class="s2">()</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bxi</span><span class="s2">, </span><span class="s1">rgi</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bxi</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s1">values</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">), </span><span class="s1">values</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">make_3d_case</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># make a 3D separable spline</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">6</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">3</span>
        <span class="s1">spl </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s1">y_1 </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">x</span>
        <span class="s1">spl_1 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y_1</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s1">y_2 </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">3</span><span class="s2">*</span><span class="s1">x </span><span class="s2">+ </span><span class="s4">1</span>
        <span class="s1">spl_2 </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y_2</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s1">t2 </span><span class="s2">= (</span><span class="s1">spl</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">spl_1</span><span class="s2">.</span><span class="s1">t</span><span class="s2">, </span><span class="s1">spl_2</span><span class="s2">.</span><span class="s1">t</span><span class="s2">)</span>
        <span class="s1">c2 </span><span class="s2">= (</span><span class="s1">spl</span><span class="s2">.</span><span class="s1">c</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">] *</span>
              <span class="s1">spl_1</span><span class="s2">.</span><span class="s1">c</span><span class="s2">[</span><span class="s0">None</span><span class="s2">, :, </span><span class="s0">None</span><span class="s2">] *</span>
              <span class="s1">spl_2</span><span class="s2">.</span><span class="s1">c</span><span class="s2">[</span><span class="s0">None</span><span class="s2">, </span><span class="s0">None</span><span class="s2">, :])</span>

        <span class="s0">return </span><span class="s1">t2</span><span class="s2">, </span><span class="s1">c2</span><span class="s2">, </span><span class="s4">3</span>

    <span class="s0">def </span><span class="s1">test_3D_separable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">11</span><span class="s2">)) * </span><span class="s4">5</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">* (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">) * (</span><span class="s1">z</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">3</span><span class="s2">*</span><span class="s1">z </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_3d_case</span><span class="s2">()</span>
        <span class="s1">bspl3 </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">(</span><span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s1">xi </span><span class="s2">= [</span><span class="s1">_ </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)]</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">bspl3</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">11</span><span class="s2">,)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_3D_derivative</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_3d_case</span><span class="s2">()</span>
        <span class="s1">bspl3 </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">(</span><span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">11</span><span class="s2">)) * </span><span class="s4">5</span>
        <span class="s1">xi </span><span class="s2">= [</span><span class="s1">_ </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)]</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl3</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)),</span>
                        <span class="s4">3</span><span class="s2">*</span><span class="s1">x</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">* (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">) * (</span><span class="s1">z</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">3</span><span class="s2">*</span><span class="s1">z </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl3</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)),</span>
                        <span class="s4">6</span><span class="s2">*</span><span class="s1">x </span><span class="s2">* (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">) * (</span><span class="s1">z</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">3</span><span class="s2">*</span><span class="s1">z </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl3</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">)),</span>
                        <span class="s4">6</span><span class="s2">*</span><span class="s1">x </span><span class="s2">* (</span><span class="s4">3</span><span class="s2">*</span><span class="s1">y</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">) * (</span><span class="s1">z</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">3</span><span class="s2">*</span><span class="s1">z </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl3</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)),</span>
                        <span class="s4">6</span><span class="s2">*</span><span class="s1">x </span><span class="s2">* (</span><span class="s4">3</span><span class="s2">*</span><span class="s1">y</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">) * (</span><span class="s4">6</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl3</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">nu</span><span class="s2">=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)),</span>
                        <span class="s1">np</span><span class="s2">.</span><span class="s1">zeros</span><span class="s2">(</span><span class="s1">len</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">)), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_3D_random</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">tx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">7</span><span class="s2">)) * </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]</span>
        <span class="s1">ty </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">8</span><span class="s2">)) * </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">tz </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">8</span><span class="s2">)) * </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">tx</span><span class="s2">.</span><span class="s1">size</span><span class="s2">-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">.</span><span class="s1">size</span><span class="s2">-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">.</span><span class="s1">size</span><span class="s2">-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">))</span>

        <span class="s1">spl </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">((</span><span class="s1">tx</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">), </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">spl_0 </span><span class="s2">= </span><span class="s1">NdBSpline0</span><span class="s2">((</span><span class="s1">tx</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">), </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">xi </span><span class="s2">= (</span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1.</span><span class="s2">, </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">spl_0</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s1">xi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">c_</span><span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">1.6</span><span class="s2">, </span><span class="s4">2.1</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s4">0.9</span><span class="s2">, </span><span class="s4">1.4</span><span class="s2">, </span><span class="s4">1.9</span><span class="s2">]]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), [</span><span class="s1">spl_0</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">) </span><span class="s0">for </span><span class="s1">xp </span><span class="s0">in </span><span class="s1">xi</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_3D_random_complex</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">tx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">7</span><span class="s2">)) * </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]</span>
        <span class="s1">ty </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">8</span><span class="s2">)) * </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">tz </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">8</span><span class="s2">)) * </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s1">c </span><span class="s2">= (</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">tx</span><span class="s2">.</span><span class="s1">size</span><span class="s2">-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">.</span><span class="s1">size</span><span class="s2">-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">.</span><span class="s1">size</span><span class="s2">-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">)) +</span>
             <span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">tx</span><span class="s2">.</span><span class="s1">size</span><span class="s2">-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">.</span><span class="s1">size</span><span class="s2">-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">.</span><span class="s1">size</span><span class="s2">-</span><span class="s1">k</span><span class="s2">-</span><span class="s4">1</span><span class="s2">))*</span><span class="s4">1j</span><span class="s2">)</span>

        <span class="s1">spl </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">((</span><span class="s1">tx</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">), </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">spl_re </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">((</span><span class="s1">tx</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">), </span><span class="s1">c</span><span class="s2">.</span><span class="s1">real</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">spl_im </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">((</span><span class="s1">tx</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, </span><span class="s1">tz</span><span class="s2">), </span><span class="s1">c</span><span class="s2">.</span><span class="s1">imag</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">xi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">c_</span><span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">1.6</span><span class="s2">, </span><span class="s4">2.1</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s4">0.9</span><span class="s2">, </span><span class="s4">1.4</span><span class="s2">, </span><span class="s4">1.9</span><span class="s2">]]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">spl</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">),</span>
                        <span class="s1">spl_re</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">) + </span><span class="s4">1j</span><span class="s2">*</span><span class="s1">spl_im</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'cls_extrap'</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'call_extrap'</span><span class="s2">, [</span><span class="s0">None</span><span class="s2">, </span><span class="s0">True</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_extrapolate_3D_separable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">cls_extrap</span><span class="s2">, </span><span class="s1">call_extrap</span><span class="s2">):</span>
        <span class="s3"># test that extrapolate=True does extrapolate</span>
        <span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_3d_case</span><span class="s2">()</span>
        <span class="s1">bspl3 </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">(</span><span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s1">cls_extrap</span><span class="s2">)</span>

        <span class="s3"># evaluate out of bounds</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= [-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">7</span><span class="s2">], [-</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">], [-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">7.5</span><span class="s2">]</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">map</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">, (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">))</span>
        <span class="s1">xi </span><span class="s2">= [</span><span class="s1">_ </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)]</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">* (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">) * (</span><span class="s1">z</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">3</span><span class="s2">*</span><span class="s1">z </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">bspl3</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s1">call_extrap</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'extrap'</span><span class="s2">, [(</span><span class="s0">False</span><span class="s2">, </span><span class="s0">True</span><span class="s2">), (</span><span class="s0">True</span><span class="s2">, </span><span class="s0">None</span><span class="s2">)])</span>
    <span class="s0">def </span><span class="s1">test_extrapolate_3D_separable_2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">extrap</span><span class="s2">):</span>
        <span class="s3"># test that call(..., extrapolate=None) defers to self.extrapolate,</span>
        <span class="s3"># otherwise supersedes self.extrapolate</span>
        <span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_3d_case</span><span class="s2">()</span>
        <span class="s1">cls_extrap</span><span class="s2">, </span><span class="s1">call_extrap </span><span class="s2">= </span><span class="s1">extrap</span>
        <span class="s1">bspl3 </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">(</span><span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s1">cls_extrap</span><span class="s2">)</span>

        <span class="s3"># evaluate out of bounds</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= [-</span><span class="s4">2</span><span class="s2">, -</span><span class="s4">1</span><span class="s2">, </span><span class="s4">7</span><span class="s2">], [-</span><span class="s4">3</span><span class="s2">, -</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">], [-</span><span class="s4">1</span><span class="s2">, -</span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">7.5</span><span class="s2">]</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">map</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">, (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">))</span>
        <span class="s1">xi </span><span class="s2">= [</span><span class="s1">_ </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)]</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">* (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">) * (</span><span class="s1">z</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">3</span><span class="s2">*</span><span class="s1">z </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">bspl3</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s1">call_extrap</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_extrapolate_false_3D_separable</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test that extrapolate=False produces nans for out-of-bounds values</span>
        <span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_3d_case</span><span class="s2">()</span>
        <span class="s1">bspl3 </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">(</span><span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s3"># evaluate out of bounds and inside</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= [-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">7</span><span class="s2">], [-</span><span class="s4">3</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">], [-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">7.5</span><span class="s2">]</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">map</span><span class="s2">(</span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">, (</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">))</span>
        <span class="s1">xi </span><span class="s2">= [</span><span class="s1">_ </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)]</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">* (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">) * (</span><span class="s1">z</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">3</span><span class="s2">*</span><span class="s1">z </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">bspl3</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">extrapolate</span><span class="s2">=</span><span class="s0">False</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">result</span><span class="s2">[</span><span class="s4">0</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">result</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">])</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">result</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">target</span><span class="s2">[</span><span class="s4">1</span><span class="s2">:-</span><span class="s4">1</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_x_nan_3D</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test that spline(nan) is nan</span>
        <span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_3d_case</span><span class="s2">()</span>
        <span class="s1">bspl3 </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">(</span><span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s3"># evaluate out of bounds and inside</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([-</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([-</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">])</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([-</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span><span class="s2">, </span><span class="s4">7.5</span><span class="s2">, </span><span class="s4">7.5</span><span class="s2">])</span>
        <span class="s1">xi </span><span class="s2">= [</span><span class="s1">_ </span><span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">zip</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)]</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">x</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">* (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">) * (</span><span class="s1">z</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">3</span><span class="s2">*</span><span class="s1">z </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">mask </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">x</span><span class="s2">) | </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">y</span><span class="s2">) | </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">z</span><span class="s2">)</span>
        <span class="s1">target</span><span class="s2">[</span><span class="s1">mask</span><span class="s2">] = </span><span class="s1">np</span><span class="s2">.</span><span class="s1">nan</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">bspl3</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">np</span><span class="s2">.</span><span class="s1">isnan</span><span class="s2">(</span><span class="s1">result</span><span class="s2">[</span><span class="s1">mask</span><span class="s2">]).</span><span class="s1">all</span><span class="s2">()</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">result</span><span class="s2">, </span><span class="s1">target</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_non_c_contiguous</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># check that non C-contiguous inputs are OK</span>
        <span class="s1">rng </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">12345</span><span class="s2">)</span>
        <span class="s1">kx</span><span class="s2">, </span><span class="s1">ky </span><span class="s2">= </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span>
        <span class="s1">tx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">high</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">16</span><span class="s2">))</span>
        <span class="s1">tx </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[(</span><span class="s1">tx</span><span class="s2">[</span><span class="s4">0</span><span class="s2">],)*</span><span class="s1">kx</span><span class="s2">, </span><span class="s1">tx</span><span class="s2">, (</span><span class="s1">tx</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">],)*</span><span class="s1">kx</span><span class="s2">]</span>
        <span class="s1">ty </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">sort</span><span class="s2">(</span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s4">0</span><span class="s2">, </span><span class="s1">high</span><span class="s2">=</span><span class="s4">4</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=</span><span class="s4">16</span><span class="s2">))</span>
        <span class="s1">ty </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">r_</span><span class="s2">[(</span><span class="s1">ty</span><span class="s2">[</span><span class="s4">0</span><span class="s2">],)*</span><span class="s1">ky</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">, (</span><span class="s1">ty</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">],)*</span><span class="s1">ky</span><span class="s2">]</span>

        <span class="s0">assert not </span><span class="s1">tx</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">].</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>
        <span class="s0">assert not </span><span class="s1">ty</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">].</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>

        <span class="s1">c </span><span class="s2">= </span><span class="s1">rng</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s1">tx</span><span class="s2">.</span><span class="s1">size</span><span class="s2">//</span><span class="s4">2 </span><span class="s2">- </span><span class="s1">kx </span><span class="s2">- </span><span class="s4">1</span><span class="s2">, </span><span class="s1">ty</span><span class="s2">.</span><span class="s1">size</span><span class="s2">//</span><span class="s4">2 </span><span class="s2">- </span><span class="s1">ky </span><span class="s2">- </span><span class="s4">1</span><span class="s2">))</span>
        <span class="s1">c </span><span class="s2">= </span><span class="s1">c</span><span class="s2">.</span><span class="s1">T</span>
        <span class="s0">assert not </span><span class="s1">c</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">c_contiguous</span>

        <span class="s1">xi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">c_</span><span class="s2">[[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.5</span><span class="s2">, </span><span class="s4">2</span><span class="s2">],</span>
                   <span class="s2">[</span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">1.6</span><span class="s2">, </span><span class="s4">2.1</span><span class="s2">]]</span>

        <span class="s1">bspl2 </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">((</span><span class="s1">tx</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">], </span><span class="s1">ty</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">]), </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=(</span><span class="s1">kx</span><span class="s2">, </span><span class="s1">ky</span><span class="s2">))</span>
        <span class="s1">bspl2_0 </span><span class="s2">= </span><span class="s1">NdBSpline0</span><span class="s2">((</span><span class="s1">tx</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">], </span><span class="s1">ty</span><span class="s2">[::</span><span class="s4">2</span><span class="s2">]), </span><span class="s1">c</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=(</span><span class="s1">kx</span><span class="s2">, </span><span class="s1">ky</span><span class="s2">))</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl2</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">),</span>
                        <span class="s2">[</span><span class="s1">bspl2_0</span><span class="s2">(</span><span class="s1">xp</span><span class="s2">) </span><span class="s0">for </span><span class="s1">xp </span><span class="s0">in </span><span class="s1">xi</span><span class="s2">], </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_readonly</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_3d_case</span><span class="s2">()</span>
        <span class="s1">bspl3 </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">(</span><span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range</span><span class="s2">(</span><span class="s4">3</span><span class="s2">):</span>
            <span class="s1">t3</span><span class="s2">[</span><span class="s1">i</span><span class="s2">].</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable </span><span class="s2">= </span><span class="s0">False</span>
        <span class="s1">c3</span><span class="s2">.</span><span class="s1">flags</span><span class="s2">.</span><span class="s1">writeable </span><span class="s2">= </span><span class="s0">False</span>

        <span class="s1">bspl3_ </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">(</span><span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">bspl3</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">)) == </span><span class="s1">bspl3_</span><span class="s2">((</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>

    <span class="s0">def </span><span class="s1">test_design_matrix</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">make_3d_case</span><span class="s2">()</span>

        <span class="s1">xi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">]])</span>
        <span class="s1">dm </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">(</span><span class="s1">t3</span><span class="s2">, </span><span class="s1">c3</span><span class="s2">, </span><span class="s1">k</span><span class="s2">).</span><span class="s1">design_matrix</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">t3</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>
        <span class="s1">dm1 </span><span class="s2">= </span><span class="s1">NdBSpline</span><span class="s2">.</span><span class="s1">design_matrix</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">, </span><span class="s1">t3</span><span class="s2">, [</span><span class="s1">k</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">k</span><span class="s2">])</span>
        <span class="s0">assert </span><span class="s1">dm</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] == </span><span class="s1">xi</span><span class="s2">.</span><span class="s1">shape</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">dm</span><span class="s2">.</span><span class="s1">todense</span><span class="s2">(), </span><span class="s1">dm1</span><span class="s2">.</span><span class="s1">todense</span><span class="s2">(), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-16</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">):</span>
            <span class="s1">NdBSpline</span><span class="s2">.</span><span class="s1">design_matrix</span><span class="s2">([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">], </span><span class="s1">t3</span><span class="s2">, [</span><span class="s1">k</span><span class="s2">]*</span><span class="s4">3</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Data and knots*&quot;</span><span class="s2">):</span>
            <span class="s1">NdBSpline</span><span class="s2">.</span><span class="s1">design_matrix</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]], </span><span class="s1">t3</span><span class="s2">, [</span><span class="s1">k</span><span class="s2">]*</span><span class="s4">3</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestMakeND</span><span class="s2">:</span>
    <span class="s0">def </span><span class="s1">test_2D_separable_simple</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">6</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">6</span><span class="s2">) + </span><span class="s4">0.5</span>
        <span class="s1">values </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">]**</span><span class="s4">3 </span><span class="s2">* (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">)[</span><span class="s0">None</span><span class="s2">, :]</span>
        <span class="s1">xi </span><span class="s2">= [(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)]</span>

        <span class="s1">bspl </span><span class="s2">= </span><span class="s1">make_ndbspl</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">values</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">values</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

        <span class="s3"># test the coefficients vs outer product of 1D coefficients</span>
        <span class="s1">spl_x </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">x</span><span class="s2">**</span><span class="s4">3</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">spl_y </span><span class="s2">= </span><span class="s1">make_interp_spline</span><span class="s2">(</span><span class="s1">y</span><span class="s2">, </span><span class="s1">y</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">cc </span><span class="s2">= </span><span class="s1">spl_x</span><span class="s2">.</span><span class="s1">c</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">] * </span><span class="s1">spl_y</span><span class="s2">.</span><span class="s1">c</span><span class="s2">[</span><span class="s0">None</span><span class="s2">, :]</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">cc</span><span class="s2">, </span><span class="s1">bspl</span><span class="s2">.</span><span class="s1">c</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-11</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">0</span><span class="s2">)</span>

        <span class="s3"># test against RGI</span>
        <span class="s0">from </span><span class="s1">scipy</span><span class="s2">.</span><span class="s1">interpolate </span><span class="s0">import </span><span class="s1">RegularGridInterpolator </span><span class="s0">as </span><span class="s1">RGI</span>
        <span class="s1">rgi </span><span class="s2">= </span><span class="s1">RGI</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">values</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'linear'</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">rgi</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">bspl</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_2D_separable_trailing_dims</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># test `c` with trailing dimensions, i.e. c.ndim &gt; ndim</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">6</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">6</span><span class="s2">)</span>
        <span class="s1">xi </span><span class="s2">= [(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)]</span>

        <span class="s3"># make values4.shape = (6, 6, 4)</span>
        <span class="s1">values </span><span class="s2">= </span><span class="s1">x</span><span class="s2">[:, </span><span class="s0">None</span><span class="s2">]**</span><span class="s4">3 </span><span class="s2">* (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">3 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">)[</span><span class="s0">None</span><span class="s2">, :]</span>
        <span class="s1">values4 </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dstack</span><span class="s2">((</span><span class="s1">values</span><span class="s2">, </span><span class="s1">values</span><span class="s2">, </span><span class="s1">values</span><span class="s2">, </span><span class="s1">values</span><span class="s2">))</span>
        <span class="s1">bspl </span><span class="s2">= </span><span class="s1">make_ndbspl</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">values4</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">=</span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">spsolve</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">bspl</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">)</span>
        <span class="s1">target </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dstack</span><span class="s2">((</span><span class="s1">values</span><span class="s2">, </span><span class="s1">values</span><span class="s2">, </span><span class="s1">values</span><span class="s2">, </span><span class="s1">values</span><span class="s2">))</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">36</span><span class="s2">, </span><span class="s4">4</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">4</span><span class="s2">),</span>
                        <span class="s1">target</span><span class="s2">, </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

        <span class="s3"># now two trailing dimensions</span>
        <span class="s1">values22 </span><span class="s2">= </span><span class="s1">values4</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">((</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">))</span>
        <span class="s1">bspl </span><span class="s2">= </span><span class="s1">make_ndbspl</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">values22</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">=</span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">spsolve</span><span class="s2">)</span>

        <span class="s1">result </span><span class="s2">= </span><span class="s1">bspl</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">)</span>
        <span class="s0">assert </span><span class="s1">result</span><span class="s2">.</span><span class="s1">shape </span><span class="s2">== (</span><span class="s4">36</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">result</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">),</span>
                        <span class="s1">target</span><span class="s2">.</span><span class="s1">reshape</span><span class="s2">((</span><span class="s4">6</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">)), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'k'</span><span class="s2">, [(</span><span class="s4">3</span><span class="s2">, </span><span class="s4">3</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">1</span><span class="s2">), (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">), (</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s2">)])</span>
    <span class="s0">def </span><span class="s1">test_2D_mixed</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">k</span><span class="s2">):</span>
        <span class="s3"># make a 2D separable spline w/ len(tx) != len(ty)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">6</span><span class="s2">)</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">7</span><span class="s2">) + </span><span class="s4">1.5</span>
        <span class="s1">xi </span><span class="s2">= [(</span><span class="s1">a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">) </span><span class="s0">for </span><span class="s1">a</span><span class="s2">, </span><span class="s1">b </span><span class="s0">in </span><span class="s1">itertools</span><span class="s2">.</span><span class="s1">product</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">)]</span>

        <span class="s1">values </span><span class="s2">= (</span><span class="s1">x</span><span class="s2">**</span><span class="s4">3</span><span class="s2">)[:, </span><span class="s0">None</span><span class="s2">] * (</span><span class="s1">y</span><span class="s2">**</span><span class="s4">2 </span><span class="s2">+ </span><span class="s4">2</span><span class="s2">*</span><span class="s1">y</span><span class="s2">)[</span><span class="s0">None</span><span class="s2">, :]</span>
        <span class="s1">bspl </span><span class="s2">= </span><span class="s1">make_ndbspl</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">values</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">=</span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">spsolve</span><span class="s2">)</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">values</span><span class="s2">.</span><span class="s1">ravel</span><span class="s2">(), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-15</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">_get_sample_2d_data</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># from test_rgi.py::TestIntepN</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">.5</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, </span><span class="s4">5.5</span><span class="s2">, </span><span class="s4">6.</span><span class="s2">])</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([</span><span class="s4">.5</span><span class="s2">, </span><span class="s4">2.</span><span class="s2">, </span><span class="s4">3.</span><span class="s2">, </span><span class="s4">4.</span><span class="s2">, </span><span class="s4">5.5</span><span class="s2">, </span><span class="s4">6.</span><span class="s2">])</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">(</span>
            <span class="s2">[</span>
                <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
                <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">],</span>
            <span class="s2">]</span>
        <span class="s2">)</span>
        <span class="s0">return </span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span>

    <span class="s0">def </span><span class="s1">test_2D_vs_RGI_linear</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_sample_2d_data</span><span class="s2">()</span>
        <span class="s1">bspl </span><span class="s2">= </span><span class="s1">make_ndbspl</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">z</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">rgi </span><span class="s2">= </span><span class="s1">RegularGridInterpolator</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">z</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'linear'</span><span class="s2">)</span>

        <span class="s1">xi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2.3</span><span class="s2">, </span><span class="s4">5.3</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">3.3</span><span class="s2">, </span><span class="s4">1.2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3.3</span><span class="s2">, </span><span class="s4">1.2</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">5.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]).</span><span class="s1">T</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">rgi</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_2D_vs_RGI_cubic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_sample_2d_data</span><span class="s2">()</span>
        <span class="s1">bspl </span><span class="s2">= </span><span class="s1">make_ndbspl</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">z</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">=</span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">spsolve</span><span class="s2">)</span>
        <span class="s1">rgi </span><span class="s2">= </span><span class="s1">RegularGridInterpolator</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">z</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'cubic_legacy'</span><span class="s2">)</span>

        <span class="s1">xi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2.3</span><span class="s2">, </span><span class="s4">5.3</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">3.3</span><span class="s2">, </span><span class="s4">1.2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3.3</span><span class="s2">, </span><span class="s4">1.2</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">5.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]).</span><span class="s1">T</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">rgi</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span><span class="s5">'solver'</span><span class="s2">, [</span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">gmres</span><span class="s2">, </span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">gcrotmk</span><span class="s2">])</span>
    <span class="s0">def </span><span class="s1">test_2D_vs_RGI_cubic_iterative</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">):</span>
        <span class="s3"># same as `test_2D_vs_RGI_cubic`, only with an iterative solver.</span>
        <span class="s3"># Note the need to add an explicit `rtol` solver_arg to achieve the</span>
        <span class="s3"># target accuracy of 1e-14. (the relation between solver atol/rtol</span>
        <span class="s3"># and the accuracy of the final result is not direct and needs experimenting)</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_sample_2d_data</span><span class="s2">()</span>
        <span class="s1">bspl </span><span class="s2">= </span><span class="s1">make_ndbspl</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">z</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">=</span><span class="s1">solver</span><span class="s2">, </span><span class="s1">rtol</span><span class="s2">=</span><span class="s4">1e-6</span><span class="s2">)</span>
        <span class="s1">rgi </span><span class="s2">= </span><span class="s1">RegularGridInterpolator</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">z</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'cubic_legacy'</span><span class="s2">)</span>

        <span class="s1">xi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2.3</span><span class="s2">, </span><span class="s4">5.3</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">3.3</span><span class="s2">, </span><span class="s4">1.2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3.3</span><span class="s2">, </span><span class="s4">1.2</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">5.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]).</span><span class="s1">T</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">rgi</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_2D_vs_RGI_quintic</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_sample_2d_data</span><span class="s2">()</span>
        <span class="s1">bspl </span><span class="s2">= </span><span class="s1">make_ndbspl</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">z</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">5</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">=</span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">spsolve</span><span class="s2">)</span>
        <span class="s1">rgi </span><span class="s2">= </span><span class="s1">RegularGridInterpolator</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">z</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s5">'quintic_legacy'</span><span class="s2">)</span>

        <span class="s1">xi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">array</span><span class="s2">([[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2.3</span><span class="s2">, </span><span class="s4">5.3</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">3.3</span><span class="s2">, </span><span class="s4">1.2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">],</span>
                       <span class="s2">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">3.3</span><span class="s2">, </span><span class="s4">1.2</span><span class="s2">, </span><span class="s4">4.0</span><span class="s2">, </span><span class="s4">5.0</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">]]).</span><span class="s1">T</span>

        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">rgi</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s2">@</span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">mark</span><span class="s2">.</span><span class="s1">parametrize</span><span class="s2">(</span>
        <span class="s5">'k, meth'</span><span class="s2">, [(</span><span class="s4">1</span><span class="s2">, </span><span class="s5">'linear'</span><span class="s2">), (</span><span class="s4">3</span><span class="s2">, </span><span class="s5">'cubic_legacy'</span><span class="s2">), (</span><span class="s4">5</span><span class="s2">, </span><span class="s5">'quintic_legacy'</span><span class="s2">)]</span>
    <span class="s2">)</span>
    <span class="s0">def </span><span class="s1">test_3D_random_vs_RGI</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">k</span><span class="s2">, </span><span class="s1">meth</span><span class="s2">):</span>
        <span class="s1">rndm </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">default_rng</span><span class="s2">(</span><span class="s4">123456</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cumsum</span><span class="s2">(</span><span class="s1">rndm</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">6</span><span class="s2">))</span>
        <span class="s1">y </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cumsum</span><span class="s2">(</span><span class="s1">rndm</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">7</span><span class="s2">))</span>
        <span class="s1">z </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">cumsum</span><span class="s2">(</span><span class="s1">rndm</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=</span><span class="s4">8</span><span class="s2">))</span>
        <span class="s1">values </span><span class="s2">= </span><span class="s1">rndm</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">size</span><span class="s2">=(</span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">))</span>

        <span class="s1">bspl </span><span class="s2">= </span><span class="s1">make_ndbspl</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">), </span><span class="s1">values</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s1">k</span><span class="s2">, </span><span class="s1">solver</span><span class="s2">=</span><span class="s1">ssl</span><span class="s2">.</span><span class="s1">spsolve</span><span class="s2">)</span>
        <span class="s1">rgi </span><span class="s2">= </span><span class="s1">RegularGridInterpolator</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z</span><span class="s2">), </span><span class="s1">values</span><span class="s2">, </span><span class="s1">method</span><span class="s2">=</span><span class="s1">meth</span><span class="s2">)</span>

        <span class="s1">xi </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">random</span><span class="s2">.</span><span class="s1">uniform</span><span class="s2">(</span><span class="s1">low</span><span class="s2">=</span><span class="s4">0.7</span><span class="s2">, </span><span class="s1">high</span><span class="s2">=</span><span class="s4">2.1</span><span class="s2">, </span><span class="s1">size</span><span class="s2">=(</span><span class="s4">11</span><span class="s2">, </span><span class="s4">3</span><span class="s2">))</span>
        <span class="s1">assert_allclose</span><span class="s2">(</span><span class="s1">bspl</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">rgi</span><span class="s2">(</span><span class="s1">xi</span><span class="s2">), </span><span class="s1">atol</span><span class="s2">=</span><span class="s4">1e-14</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_solver_err_not_converged</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">, </span><span class="s1">z </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">_get_sample_2d_data</span><span class="s2">()</span>
        <span class="s1">solver_args </span><span class="s2">= {</span><span class="s5">'maxiter'</span><span class="s2">: </span><span class="s4">1</span><span class="s2">}</span>
        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'solver'</span><span class="s2">):</span>
            <span class="s1">make_ndbspl</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">z</span><span class="s2">, </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, **</span><span class="s1">solver_args</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">assert_raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">'solver'</span><span class="s2">):</span>
            <span class="s1">make_ndbspl</span><span class="s2">((</span><span class="s1">x</span><span class="s2">, </span><span class="s1">y</span><span class="s2">), </span><span class="s1">np</span><span class="s2">.</span><span class="s1">dstack</span><span class="s2">((</span><span class="s1">z</span><span class="s2">, </span><span class="s1">z</span><span class="s2">)), </span><span class="s1">k</span><span class="s2">=</span><span class="s4">3</span><span class="s2">, **</span><span class="s1">solver_args</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">TestFpchec</span><span class="s2">:</span>
    <span class="s3"># https://github.com/scipy/scipy/blob/main/scipy/interpolate/fitpack/fpchec.f</span>

    <span class="s0">def </span><span class="s1">test_1D_x_t</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">1</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">12</span><span class="s2">).</span><span class="s1">reshape</span><span class="s2">(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">6</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s4">12</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;1D sequence&quot;</span><span class="s2">):</span>
            <span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;1D sequence&quot;</span><span class="s2">):</span>
            <span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">t</span><span class="s2">, </span><span class="s1">x</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_condition_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># c      1) k+1 &lt;= n-k-1 &lt;= m</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">n  </span><span class="s2">= </span><span class="s4">2</span><span class="s2">*(</span><span class="s1">k </span><span class="s2">+ </span><span class="s4">1</span><span class="s2">) - </span><span class="s4">1    </span><span class="s3"># not OK</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">n </span><span class="s2">+ </span><span class="s4">11            </span><span class="s3"># OK</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">m</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">10</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Need k+1*&quot;</span><span class="s2">):</span>
            <span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">n </span><span class="s2">= </span><span class="s4">2</span><span class="s2">*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">) + </span><span class="s4">1   </span><span class="s3"># OK</span>
        <span class="s1">m </span><span class="s2">= </span><span class="s1">n </span><span class="s2">- </span><span class="s1">k </span><span class="s2">- </span><span class="s4">2     </span><span class="s3"># not OK</span>
        <span class="s1">t </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">n</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">arange</span><span class="s2">(</span><span class="s1">m</span><span class="s2">)</span>

        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">10</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Need k+1*&quot;</span><span class="s2">):</span>
            <span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_condition_2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># c      2) t(1) &lt;= t(2) &lt;= ... &lt;= t(k+1)</span>
        <span class="s3"># c         t(n-k) &lt;= t(n-k+1) &lt;= ... &lt;= t(n)</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">t </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">) + [</span><span class="s4">2</span><span class="s2">] + [</span><span class="s4">5</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)   </span><span class="s3"># this is OK</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4.5</span><span class="s2">]</span>

        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">0</span>
        <span class="s0">assert </span><span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) </span><span class="s0">is None    </span><span class="s3"># does not raise</span>

        <span class="s1">tt </span><span class="s2">= </span><span class="s1">t</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">tt</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">tt</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]   </span><span class="s3"># not OK</span>
        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">tt</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">20</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Last k knots*&quot;</span><span class="s2">):</span>
            <span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">tt</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">tt </span><span class="s2">= </span><span class="s1">t</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">tt</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s1">tt</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">]   </span><span class="s3"># not OK</span>
        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">tt</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">20</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;First k knots*&quot;</span><span class="s2">):</span>
            <span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">tt</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_condition_3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># c      3) t(k+1) &lt; t(k+2) &lt; ... &lt; t(n-k)</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">t </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">) + [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">] + [</span><span class="s4">5</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)   </span><span class="s3"># this is OK</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4.5</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">0</span>
        <span class="s0">assert </span><span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) </span><span class="s0">is None</span>

        <span class="s1">t </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">) + [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">] + [</span><span class="s4">5</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)   </span><span class="s3"># this is not OK</span>
        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">30</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Internal knots*&quot;</span><span class="s2">):</span>
            <span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_condition_4</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># c      4) t(k+1) &lt;= x(i) &lt;= t(n-k)</span>
        <span class="s3"># NB: FITPACK's fpchec only checks x[0] &amp; x[-1], so we follow.</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">t </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">) + [</span><span class="s4">5</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">3.5</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">4.5</span><span class="s2">]      </span><span class="s3"># this is OK</span>
        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">0</span>
        <span class="s0">assert </span><span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) </span><span class="s0">is None</span>

        <span class="s1">xx </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">xx</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s1">t</span><span class="s2">[</span><span class="s4">0</span><span class="s2">]    </span><span class="s3"># still OK</span>
        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">0</span>
        <span class="s0">assert </span><span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) </span><span class="s0">is None</span>

        <span class="s1">xx </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">xx</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] = </span><span class="s1">t</span><span class="s2">[</span><span class="s4">0</span><span class="s2">] - </span><span class="s4">1    </span><span class="s3"># not OK</span>
        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">40</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Out of bounds*&quot;</span><span class="s2">):</span>
            <span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">xx </span><span class="s2">= </span><span class="s1">x</span><span class="s2">.</span><span class="s1">copy</span><span class="s2">()</span>
        <span class="s1">xx</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] = </span><span class="s1">t</span><span class="s2">[-</span><span class="s4">1</span><span class="s2">] + </span><span class="s4">1    </span><span class="s3"># not OK</span>
        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">40</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Out of bounds*&quot;</span><span class="s2">):</span>
            <span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">xx</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

    <span class="s3"># ### Test the S-W condition (no 5)</span>
    <span class="s3"># c      5) the conditions specified by schoenberg and whitney must hold</span>
    <span class="s3"># c         for at least one subset of data points, i.e. there must be a</span>
    <span class="s3"># c         subset of data points y(j) such that</span>
    <span class="s3"># c             t(j) &lt; y(j) &lt; t(j+k+1), j=1,2,...,n-k-1</span>
    <span class="s0">def </span><span class="s1">test_condition_5_x1xm</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># x(1).ge.t(k2) .or. x(m).le.t(nk1)</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">1</span>
        <span class="s1">t </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">2</span><span class="s2">]</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">1.1</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">50</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Schoenberg-Whitney*&quot;</span><span class="s2">):</span>
            <span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">x </span><span class="s2">= [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">50</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Schoenberg-Whitney*&quot;</span><span class="s2">):</span>
            <span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_condition_5_k1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># special case nk3 (== n - k - 2) &lt; 2</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">1</span>
        <span class="s1">t </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">]</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.6</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">0</span>
        <span class="s0">assert </span><span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) </span><span class="s0">is None</span>

    <span class="s0">def </span><span class="s1">test_condition_5_1</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># basically, there can't be an interval of t[j]..t[j+k+1] with no x</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">t </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">) + [</span><span class="s4">2</span><span class="s2">] + [</span><span class="s4">5</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">3</span><span class="s2">]*</span><span class="s4">5</span>
        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">50</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Schoenberg-Whitney*&quot;</span><span class="s2">):</span>
            <span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s1">t </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">) + [</span><span class="s4">2</span><span class="s2">] + [</span><span class="s4">5</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">]*</span><span class="s4">5</span>
        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">50</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Schoenberg-Whitney*&quot;</span><span class="s2">):</span>
            <span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

    <span class="s0">def </span><span class="s1">test_condition_5_2</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># same as _5_1, only the empty interval is in the middle</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">3</span>
        <span class="s1">t </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">) + [</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">] + [</span><span class="s4">5</span><span class="s2">]*(</span><span class="s1">k</span><span class="s2">+</span><span class="s4">1</span><span class="s2">)</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">1.1</span><span class="s2">]*</span><span class="s4">5 </span><span class="s2">+ [</span><span class="s4">4</span><span class="s2">]</span>

        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">50</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Schoenberg-Whitney*&quot;</span><span class="s2">):</span>
            <span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

        <span class="s3"># and this one is OK</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">1.1</span><span class="s2">]*</span><span class="s4">4 </span><span class="s2">+ [</span><span class="s4">4</span><span class="s2">, </span><span class="s4">4</span><span class="s2">]</span>
        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">0</span>
        <span class="s0">assert </span><span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) </span><span class="s0">is None</span>

    <span class="s0">def </span><span class="s1">test_condition_5_3</span><span class="s2">(</span><span class="s1">self</span><span class="s2">):</span>
        <span class="s3"># similar to _5_2, covers a different failure branch</span>
        <span class="s1">k </span><span class="s2">= </span><span class="s4">1</span>
        <span class="s1">t </span><span class="s2">= [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">7</span><span class="s2">]</span>
        <span class="s1">x </span><span class="s2">= [</span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5.2</span><span class="s2">, </span><span class="s4">5.2</span><span class="s2">, </span><span class="s4">5.2</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">]</span>

        <span class="s0">assert </span><span class="s1">dfitpack</span><span class="s2">.</span><span class="s1">fpchec</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">) == </span><span class="s4">50</span>
        <span class="s0">with </span><span class="s1">pytest</span><span class="s2">.</span><span class="s1">raises</span><span class="s2">(</span><span class="s1">ValueError</span><span class="s2">, </span><span class="s1">match</span><span class="s2">=</span><span class="s5">&quot;Schoenberg-Whitney*&quot;</span><span class="s2">):</span>
            <span class="s1">_b</span><span class="s2">.</span><span class="s1">fpcheck</span><span class="s2">(</span><span class="s1">x</span><span class="s2">, </span><span class="s1">t</span><span class="s2">, </span><span class="s1">k</span><span class="s2">)</span>

</pre>
</body>
</html>